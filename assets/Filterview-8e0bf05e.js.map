{"version":3,"file":"Filterview-8e0bf05e.js","sources":["../../src/UI/BigComponents/FilterviewWithFields.svelte","../../src/UI/BigComponents/Filterview.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import FilteredLayer from \"../../Models/FilteredLayer\"\n  import type { FilterConfigOption } from \"../../Models/ThemeConfig/FilterConfig\"\n  import Locale from \"../i18n/Locale\"\n  import ValidatedInput from \"../InputElement/ValidatedInput.svelte\"\n  import { UIEventSource } from \"../../Logic/UIEventSource\"\n  import { onDestroy } from \"svelte\"\n  import { Utils } from \"../../Utils\"\n  import type { ValidatorType } from \"../InputElement/Validators\"\n  import InputHelper from \"../InputElement/InputHelper.svelte\"\n\n  export let filteredLayer: FilteredLayer\n  export let option: FilterConfigOption\n  export let id: string\n  let parts: ({ message: string } | { subs: string })[]\n  let language = Locale.language\n  $: {\n    const template = option.question.textFor($language)\n    parts = Utils.splitIntoSubstitutionParts(template)\n  }\n  let fieldValues: Record<string, UIEventSource<string>> = {}\n  let fieldTypes: Record<string, ValidatorType> = {}\n  let appliedFilter = <UIEventSource<string>>filteredLayer.appliedFilters.get(id)\n  let initialState: Record<string, string> = JSON.parse(appliedFilter?.data ?? \"{}\")\n\n  function setFields() {\n    const properties: Record<string, string> = {}\n    for (const key in fieldValues) {\n      const v = fieldValues[key].data\n      if (v === undefined) {\n        properties[key] = undefined\n      } else {\n        properties[key] = v\n      }\n    }\n    appliedFilter?.setData(FilteredLayer.fieldsToString(properties))\n  }\n\n  let firstValue : UIEventSource<string>\n  for (const field of option.fields) {\n    // A bit of cheating: the 'parts' will have '}' suffixed for fields\n    const src = new UIEventSource<string>(initialState[field.name] ?? \"\")\n    firstValue ??= src\n    fieldTypes[field.name] = field.type\n    console.log(field.name, \"-->\", field.type)\n    fieldValues[field.name] = src\n    onDestroy(\n      src.stabilized(200).addCallback(() => {\n        setFields()\n      }),\n    )\n  }\n</script>\n\n<div class=\"low-interaction p-1 rounded-2xl px-3\" class:interactive={$firstValue?.length > 0}>\n  {#each parts as part, i}\n    {#if part[\"subs\"]}\n      <!-- This is a field! -->\n      <span class=\"mx-1\">\n        <InputHelper value={fieldValues[part[\"subs\"]]} type={fieldTypes[part[\"subs\"]]}>\n          <ValidatedInput slot=\"fallback\" value={fieldValues[part[\"subs\"]]} type={fieldTypes[part[\"subs\"]]} />\n        </InputHelper>\n      </span>\n    {:else}\n      {@html part[\"message\"]}\n    {/if}\n  {/each}\n</div>\n","<script lang=\"ts\">\n  /**\n   * The FilterView shows the various options to enable/disable a single layer or to only show a subset of the data.\n   */\n  import type FilteredLayer from \"../../Models/FilteredLayer\"\n  import LayerConfig from \"../../Models/ThemeConfig/LayerConfig\"\n  import ToSvelte from \"../Base/ToSvelte.svelte\"\n  import Checkbox from \"../Base/Checkbox.svelte\"\n  import FilterConfig from \"../../Models/ThemeConfig/FilterConfig\"\n  import Dropdown from \"../Base/Dropdown.svelte\"\n  import { ImmutableStore, Store, UIEventSource } from \"../../Logic/UIEventSource\"\n  import FilterviewWithFields from \"./FilterviewWithFields.svelte\"\n  import Tr from \"../Base/Tr.svelte\"\n  import Translations from \"../i18n/Translations\"\n\n  export let filteredLayer: FilteredLayer\n  export let highlightedLayer: Store<string | undefined> = new ImmutableStore(undefined)\n  export let zoomlevel: Store<number> = new ImmutableStore(22)\n  let layer: LayerConfig = filteredLayer.layerDef\n  let isDisplayed: UIEventSource<boolean> = filteredLayer.isDisplayed\n\n  /**\n   * Gets a UIEventSource as boolean for the given option, to be used with a checkbox\n   */\n  function getBooleanStateFor(option: FilterConfig): UIEventSource<boolean> {\n    const state = filteredLayer.appliedFilters.get(option.id)\n    return state.sync(\n      (f) => f === 0,\n      [],\n      (b) => (b ? 0 : undefined)\n    )\n  }\n\n  /**\n   * Gets a UIEventSource as number for the given option, to be used with a dropdown or radiobutton\n   */\n  function getStateFor(option: FilterConfig): UIEventSource<number | string> {\n    return filteredLayer.appliedFilters.get(option.id)\n  }\n</script>\n\n{#if filteredLayer.layerDef.name}\n  <div class:focus={$highlightedLayer === filteredLayer.layerDef.id} class=\"mb-1.5\">\n    <Checkbox selected={isDisplayed}>\n      <div class=\"no-image-background block h-6 w-6\" class:opacity-50={!$isDisplayed}>\n        <ToSvelte construct={() => layer.defaultIcon()} />\n      </div>\n\n      <Tr t={filteredLayer.layerDef.name} />\n\n      {#if $zoomlevel < layer.minzoom}\n        <span class=\"alert\">\n          <Tr t={Translations.t.general.layerSelection.zoomInToSeeThisLayer} />\n        </span>\n      {/if}\n    </Checkbox>\n\n    {#if $isDisplayed && filteredLayer.layerDef.filters?.length > 0}\n      <div id=\"subfilters\" class=\"ml-4 flex flex-col gap-y-1\">\n        {#each filteredLayer.layerDef.filters as filter}\n          <div>\n            <!-- There are three (and a half) modes of filters: a single checkbox, a radio button/dropdown or with searchable fields -->\n            {#if filter.options.length === 1 && filter.options[0].fields.length === 0}\n              <Checkbox selected={getBooleanStateFor(filter)}>\n                <Tr t={filter.options[0].question} />\n              </Checkbox>\n            {/if}\n\n            {#if filter.options.length === 1 && filter.options[0].fields.length > 0}\n              <FilterviewWithFields id={filter.id} {filteredLayer} option={filter.options[0]} />\n            {/if}\n\n            {#if filter.options.length > 1}\n              <Dropdown value={getStateFor(filter)}>\n                {#each filter.options as option, i}\n                  <option value={i}>\n                    <Tr t={option.question} />\n                  </option>\n                {/each}\n              </Dropdown>\n            {/if}\n          </div>\n        {/each}\n      </div>\n    {/if}\n  </div>\n{/if}\n"],"names":["raw_value","ctx","dirty","html_tag","insert","target","span","anchor","_a","div","i","each_blocks","filteredLayer","$$props","option","id","parts","language","Locale","fieldValues","fieldTypes","appliedFilter","initialState","setFields","properties","key","v","FilteredLayer","firstValue","field","src","UIEventSource","$$subscribe_firstValue","onDestroy","template","$language","$$invalidate","Utils","create_if_block_1","toggle_class","Translations","create_if_block_5","checkbox_changes","tr_changes","filterviewwithfields_changes","dropdown_changes","each_value_1","if_block0","create_if_block_4","if_block1","create_if_block_3","if_block2","create_if_block_2","create_if_block","highlightedLayer","ImmutableStore","zoomlevel","layer","isDisplayed","getBooleanStateFor","f","b","getStateFor","func"],"mappings":"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"}