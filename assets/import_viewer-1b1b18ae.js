var N=Object.defineProperty;var E=(b,e,t)=>e in b?N(b,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):b[e]=t;var O=(b,e,t)=>(E(b,typeof e!="symbol"?e+"":e,t),t);import{C as f,S as h,F as C,W as G,U as k,V as v,Q as V,J as L,T as U}from"./SvelteUIElement-a9888989.js";/* empty css                        */import{d as J,j as Q,V as W,s as I,L as z,U as q}from"./ChartJs-38bd94a7.js";import{a as T,T as y,C as j,D as H}from"./List-e42e7133.js";import{L as R,S as P,a as M}from"./SubtleButton-14198bf3.js";import{T as Y,A as Z,L as K}from"./LeftIndex-368e46a1.js";import{T as X}from"./TableOfContents-766130f4.js";import"./BBox-40ecb6b8.js";import"./_commonjsHelpers-edff4021.js";import"./defineProperty-bf1f4e26.js";import"./BackToIndex-d2fad3c7.js";class $ extends P{constructor(e){super(h.statistics_svg(),"Download statistics"),this.onClick(()=>{const t=[].concat(...e),a=["id","status","theme","date_created","date_closed","days_open","intro","...comments"],l=t.map(o=>{var n,s;return[o.props.id+"",o.status,o.theme,(n=o.props.date_created)==null?void 0:n.substr(0,o.props.date_created.length-3),((s=o.props.closed_at)==null?void 0:s.substr(0,o.props.closed_at.length-3))??"",JSON.stringify(o.intro),...o.props.comments.map(c=>JSON.stringify(c.user)+": "+JSON.stringify(c.text))]});L.offerContentsAsDownloadableFile([a,...l].map(o=>o.join(", ")).join(`
`),"mapcomplete_import_notes_overview.csv",{mimetype:"text/csv"})})}}class ee extends f{constructor(e,t){const a=W.ForType("text").ConstructInputElement(),l=new H("On which notes should an action be performed?",[{value:void 0,shown:"Pick an option..."},{value:{predicate:s=>s.status==="open",action:async s=>{const c=a.GetValue().data;e.osmConnection.closeNote(s.id,c)}},shown:"Add comment to every open note and close all notes"},{value:{predicate:s=>s.status==="open",action:async s=>{const c=a.GetValue().data;e.osmConnection.addCommentToNote(s.id,c)}},shown:"Add comment to every open note"}]),o=new k(void 0),n=new P(h.checkmark_svg(),"Apply action").onClick(async()=>{const{predicate:s,action:c}=l.GetValue().data;for(let r=0;r<t.length;r++){o.setData(r);const p=t[r];s(p)&&await c(p)}o.setData(t.length)});super([l,a.SetClass("w-full border border-black"),new y(new y(n,new y(new M(new v(o.map(s=>s===t.length?"All done!":"Handling note "+(s+1)+" out of "+t.length))),new f([h.checkmark_svg().SetClass("h-8"),"All done!"]).SetClass("thanks flex p-4"),o.map(s=>s<t.length)),o.map(s=>s===void 0)),new v(a.GetValue().map(s=>"Type a text of at least 15 characters to apply the action. Currently, there are "+((s==null?void 0:s.length)??0)+" characters")).SetClass("alert"),l.GetValue().map(s=>{var c,r;return s!==void 0&&((r=(c=a.GetValue())==null?void 0:c.data)==null?void 0:r.length)>15},[a.GetValue()])),new y(new C("Testmode enable").SetClass("alert"),void 0,e.featureSwitchIsTesting)])}}class w extends f{static r(){return Math.floor(Math.random()*256)}static randomColour(){return"rgba("+w.r()+","+w.r()+","+w.r()+")"}static CreatePieByAuthor(e){const t=Object.keys(e);return t.sort((a,l)=>e[l].at(-1)-e[a].at(-1)),new I({type:"doughnut",data:{labels:t,datasets:[{label:"Closed by",data:t.map(a=>e[a].at(-1)),backgroundColor:t.map(a=>w.randomColour())}]}})}static CreateStatePie(e){const t={imported:"#0aa323",already_mapped:"#00bbff",invalid:"#ff0000",closed:"#000000",not_found:"#ff6d00",open:"#626262",has_comments:"#a8a8a8"},a=Object.keys(t),l=a.map(o=>e.filter(n=>n.status===o).length);return new I({type:"doughnut",data:{labels:a.map((o,n)=>o+" "+Math.floor(100*l[n]/e.length)+"%"),datasets:[{label:"Status by",data:l,backgroundColor:a.map(o=>t[o])}]}})}constructor(e){if(e.length===0){super([]);return}let t=new Date(e[0].dateStr);for(const r of e){const p=new Date(r.dateStr);p<t&&(t=p)}const l=(new Date().getTime()-t.getTime())/(1e3*60*60*24),o={dates:[],is_open:[]},n={};for(const r of e){const p=r.props.comments.at(-1).user;n[p]===void 0&&(n[p]=[])}for(let r=-1;r<l;r++){const p=new Date(t.getTime()+864e5*r);let d=0;for(const i in n)n[i].push(0);for(const i of e)if(!(new Date(i.dateStr)>p))if(i.props.closed_at===void 0)d++;else if(new Date(i.props.closed_at.substring(0,10)).getTime()>p.getTime())d++;else{const u=i.props.comments.at(-1).user,g=n[u];g[g.length-1]+=1}o.dates.push(new Date(t.getTime()+r*1e3*60*60*24).toISOString().substring(0,10)),o.is_open.push(d)}const c={labels:o.dates.map(r=>""+r),datasets:[{label:"Total open",data:o.is_open,fill:!1,borderColor:"rgb(75, 192, 192)",tension:.1}]};for(const r in n)n[r].at(-1)<=10||c.datasets.push({label:"Closed by "+r,data:n[r],fill:!1,borderColor:w.randomColour(),tension:.1});super([new I({type:"line",data:c,options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}}),new f([w.CreatePieByAuthor(n),w.CreateStatePie(e)]).SetClass("flex w-full h-32").SetStyle("width: 40rem")]),this.SetClass("block w-full h-64 border border-red")}}const B=class extends f{constructor(e,t){const a=e[0].props.comments[0].html,l=new J(["id","status","last comment","last modified by","actions"],e.map(o=>B.noteField(o,t)),{sortable:!0}).SetClass("zebra-table link-underline");super([new T("Mass apply an action on "+e.length+" notes below"),t!==void 0?new ee(t,e.map(o=>o.props)).SetClass("block"):void 0,l,new T("Example note",4),new C(a).SetClass("literal-code link-underline")]),this.SetClass("flex flex-col")}static noteField(e,t){var m;const a=new G(""+e.props.id,"https://openstreetmap.org/note/"+e.props.id,!0);let l="";const o=e.props.comments[e.props.comments.length-1],n=e.props.comments[e.props.comments.length-2];e.props.comments.length>1&&(l=o.text,l===void 0&&(n==null?void 0:n.uid)===o.uid&&(l=n.text));const s=x.icons[e.status]().SetClass("h-4 w-4 shrink-0"),c=new k(!1),r=new k(void 0),p=new R(()=>new f(this.individualActions.map(([u,g])=>u().onClick(async()=>{e.props.status==="closed"&&await t.osmConnection.reopenNote(e.props.id),await t.osmConnection.closeNote(e.props.id,g),r.setData(g)}).SetClass("h-8 w-8"))).SetClass("flex")),d=new v(r.map(u=>u===void 0?p:u)),i=y.If((m=t==null?void 0:t.osmConnection)==null?void 0:m.isLoggedIn,()=>new j(d,new Q("edit...",()=>{console.log("Enabling..."),c.setData(!0)}),c));return[a,new f([s,e.status]).SetClass("flex"),l,new G(o.user,"https://www.openstreetmap.org/user/"+o.user,!0),i]}};let _=B;O(_,"individualActions",[[h.not_found_svg,"This feature does not exist"],[h.addSmall_svg,"imported"],[h.duplicate_svg,"Already mapped"]]);const S=class extends Y{constructor(e,t){e.sort((d,i)=>d.props.id-i.props.id);const{theme:a,intro:l,dateStr:o}=e[0],n=new Map;for(const d of e){const i=d.status,m=n.get(i)??0;n.set(i,m+1)}const s=(n.get("open")??0)+(n.get("has_comments")??0),c=[new C(o).SetClass("literal-code rounded-full"),new C(e.length+" total").SetClass("literal-code rounded-full ml-1 border-4 border-gray").onClick(()=>r.setData(void 0)),s===0?new f([h.party_svg().SetClass("h-6 m-1"),"All done!"]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border border-black"):new C(Math.round(100-100*s/e.length)+"%").SetClass("literal-code rounded-full ml-1")],r=new k(void 0);Object.keys(S.icons).forEach(d=>{const i=n.get(d);if(i===void 0)return;const m=new f([S.icons[d]().SetClass("h-6 m-1"),i+" "+d]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border border-black"),u=new f([S.icons[d]().SetClass("h-6 m-1"),i+" "+d]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border-4 border-black animate-pulse"),g=new j(u,m,r.sync(D=>D===d,[],(D,F)=>{if(D)return d;if(F!==d)return F})).ToggleOnClick();c.push(g)});const p=new f([new _(e,t),new w(e)]);super(new f([new T(a+": "+l,2),new f(c).SetClass("flex flex-wrap")]),new v(r.map(d=>{if(d===void 0)return p;const i=e.filter(m=>m.status===d);return new f([new _(i,t),new w(i)])})),{closeOnClick:!1})}};let x=S;O(x,"icons",{open:h.compass_svg,has_comments:h.speech_bubble_svg,imported:h.addSmall_svg,already_mapped:h.checkmark_svg,not_found:h.not_found_svg,closed:h.close_svg,invalid:h.invalid_svg});class A extends v{constructor(e,t){let a;e.uid!==void 0?a="https://api.openstreetmap.org/api/0.6/notes/search.json?user="+e.uid+"&closed=730&limit=10000&sort=created_at&q=%23import":(a="https://api.openstreetmap.org/api/0.6/notes/search.json?display_name="+encodeURIComponent(e.display_name)+"&limit=10000&closed=730&sort=created_at&q=",e.search!==""?a+=e.search:a+="#import");const l=k.FromPromiseWithErr(L.downloadJson(a));super(l.map(o=>{var i,m;if(o===void 0)return new M("Loading notes which mention '#import'");if(o.error!==void 0)return new C("Something went wrong: "+o.error).SetClass("alert");let n=o.success.features.map(u=>u.properties);if(e.uid&&(n=n.filter(u=>u.comments[0].uid===e.uid)),e.display_name!==void 0){const u=e.display_name;n=n.filter(g=>g.comments[0].user===u)}const s=Array.from(A.SplitNotesIntoBatches(n).values()),c=s.map(u=>new x(u,t)),r=new Z(c);let p=[];(m=(i=t==null?void 0:t.osmConnection)==null?void 0:i.isLoggedIn)!=null&&m.data&&(p=[new T(U.t.importInspector.title,1),new P(void 0,"Create a new batch of imports",{url:"import_helper.html"})]),p.push(r),p.push(new f([new T("Statistics for all notes"),new w([].concat(...s))]));const d=new f(p);return new K([new X(d,{noTopLevel:!0,maxDepth:1}).SetClass("subtle"),new $(s)],d)}))}static SplitNotesIntoBatches(e){const t=new Map,a="https://mapcomplete.osm.be/";for(const l of e){let o=function(m,u){return m.some(g=>u.toLowerCase().indexOf(g)>=0)};const n=l.comments[0].text.split(`
`),s=n.findIndex(m=>m.startsWith(a)&&m.endsWith("#import"));if(s<0)continue;let c=n[s].substr(a.length);c=c.substr(0,c.indexOf("."));const r=L.ParseDate(l.date_created),p=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate(),d=c+n[0]+p;t.has(d)||t.set(d,[]);let i="open";if(l.closed_at!==void 0){const m=l.comments[l.comments.length-1].text.toLowerCase();o(["does not exist","bestaat niet","geen"],m)?i="not_found":o(["already mapped","reeds","dubbele note","stond er al","stonden er al","staat er al","staan er al","stond al","stonden al","staat al","staan al"],m)?i="already_mapped":m.indexOf("invalid")>=0||m.indexOf("incorrect")>=0?i="invalid":o(["imported","erbij","toegevoegd","added","gemapped","gemapt","mapped","done","openstreetmap.org/changeset"],m)?i="imported":i="closed"}else l.comments.length>1&&(i="has_comments");t.get(d).push({props:l,intro:n[0],theme:c,dateStr:p,status:i})}return t}}class te extends z{constructor(){const e=new q(void 0),t=V.GetQueryParameter("user","","The username of the person whom you want to see the notes for"),a=V.GetQueryParameter("search","","A text that should be included in the first comment of the note to be shown");super(new v(e.osmConnection.userDetails.map(l=>{const o=t.data,n=a.data;return o!==""||n!==""?new A({display_name:o,search:n},void 0):new A(l,e)},[t,a])),"Login to inspect your import flows",e)}}new te().AttachTo("main");
