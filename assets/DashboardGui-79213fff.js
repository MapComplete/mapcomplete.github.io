var Te=Object.defineProperty;var Me=(f,e,t)=>e in f?Te(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var T=(f,e,t)=>(Me(f,typeof e!="symbol"?e+"":e,t),t);import{M as _e,S as q,F as Y,a as fe}from"./MoreScreen-2044a034.js";import{V as G,S as x,I as ae,F as P,C as S,T as D,a as I,U as M,b as pe,H as ee,c as Ae,Q as J}from"./Translations-a3655295.js";import{L as me}from"./LanguagePicker-acbd0a35.js";import{T as _,C as Ie}from"./DropDown-d19a1a50.js";import{S as O,L as $,a as Ge,U as Ee}from"./SubtleButton-7fd01f68.js";import{L as he,H as z,T as le,M as Pe,B as Oe,V as Re,A as Ue}from"./ChartJs-382f3983.js";import{A as Be,E as Fe,F as we,U as Ne}from"./UserInformation-73ad6bf5.js";import{C as j,S as B,a as Ve,b as Z,c as ze,d as ge,e as We,f as ve,g as je,h as $e,T as He,i as qe}from"./theme_overview-11be4217.js";import{C as F,G as ye,B as X,S as Je,T as Se,R as Ze,O as Qe,a as ce,l as Ke}from"./UserRelatedState-909a15f7.js";import{T as E}from"./List-9adf5546.js";import{B as Xe}from"./BackToIndex-d5869f42.js";class Ye extends G{constructor(e,t){t=t??{};let n="w-8 h-8 mr-2";t.size=="medium"?n="w-16 h-16 mr-4":t.size=="large"&&(n="w-32 h-32 mr-6"),super(e.userDetails.mapD(o=>{let s=x.person_svg().SetClass("rounded-full border border-black overflow-hidden");o.img&&(s=new ae(o.img));let a=new P(o.name).SetClass("font-bold");return t!=null&&t.firstLine&&(a=new S([t.firstLine,a]).SetClass("flex flex-col")),new S([s.SetClass("rounded-full "+n),a]).SetClass("flex items-center")}))}}class et extends S{constructor(e,t,n,o){var u;const s=D.t.general,a=n.layoutToUse,l=new me(a.language,s.pickLanguage.Clone()),c=new O(void 0,s.openTheMap.Clone().SetClass("text-xl font-bold w-full text-center")).onClick(()=>{e.setData(!1)}).SetClass("only-on-mobile"),r=new Ye(n.osmConnection,{firstLine:D.t.general.welcomeBack.Clone()});o!=null&&o.userInfoIsOpened&&r.onClick(()=>{o.userInfoIsOpened.setData(!0)});const d=new _(new he(r,new S([D.t.general.loginWithOpenStreetMap.SetClass("text-xl font-bold"),D.t.general.loginOnlyNeededToEdit.Clone().SetClass("font-bold")]).SetClass("flex flex-col"),n),void 0,n.featureSwitchUserbadge),i=a.layers.some(h=>{var v;return((v=h.presets)==null?void 0:v.length)>0});super([a.description.Clone().SetClass("block mb-4"),new S([s.welcomeExplanation.general,i?_.If(n.featureSwitchAddNew,()=>s.welcomeExplanation.addNew):void 0]).SetClass("flex flex-col mt-2"),c,d.SetClass("block mt-6 pt-2 md:border-t-2 border-dotted border-gray-400"),(u=a.descriptionTail)==null?void 0:u.Clone().SetClass("block mt-4"),l==null?void 0:l.SetClass("block mt-4 pb-8 border-b-2 border-dotted border-gray-400"),new Be(n),...a.CustomCodeSnippets()]),this.SetClass("link-underline")}}var te={},tt={get exports(){return te},set exports(f){te=f}};(function(f){var e=function(){var t=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",s={};function a(c,r){if(!s[c]){s[c]={};for(var d=0;d<c.length;d++)s[c][c.charAt(d)]=d}return s[c][r]}var l={compressToBase64:function(c){if(c==null)return"";var r=l._compress(c,6,function(d){return n.charAt(d)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(c){return c==null?"":c==""?null:l._decompress(c.length,32,function(r){return a(n,c.charAt(r))})},compressToUTF16:function(c){return c==null?"":l._compress(c,15,function(r){return t(r+32)})+" "},decompressFromUTF16:function(c){return c==null?"":c==""?null:l._decompress(c.length,16384,function(r){return c.charCodeAt(r)-32})},compressToUint8Array:function(c){for(var r=l.compress(c),d=new Uint8Array(r.length*2),i=0,u=r.length;i<u;i++){var h=r.charCodeAt(i);d[i*2]=h>>>8,d[i*2+1]=h%256}return d},decompressFromUint8Array:function(c){if(c==null)return l.decompress(c);for(var r=new Array(c.length/2),d=0,i=r.length;d<i;d++)r[d]=c[d*2]*256+c[d*2+1];var u=[];return r.forEach(function(h){u.push(t(h))}),l.decompress(u.join(""))},compressToEncodedURIComponent:function(c){return c==null?"":l._compress(c,6,function(r){return o.charAt(r)})},decompressFromEncodedURIComponent:function(c){return c==null?"":c==""?null:(c=c.replace(/ /g,"+"),l._decompress(c.length,32,function(r){return a(o,c.charAt(r))}))},compress:function(c){return l._compress(c,16,function(r){return t(r)})},_compress:function(c,r,d){if(c==null)return"";var i,u,h={},v={},C="",A="",b="",L=2,k=3,w=2,y=[],p=0,g=0,m;for(m=0;m<c.length;m+=1)if(C=c.charAt(m),Object.prototype.hasOwnProperty.call(h,C)||(h[C]=k++,v[C]=!0),A=b+C,Object.prototype.hasOwnProperty.call(h,A))b=A;else{if(Object.prototype.hasOwnProperty.call(v,b)){if(b.charCodeAt(0)<256){for(i=0;i<w;i++)p=p<<1,g==r-1?(g=0,y.push(d(p)),p=0):g++;for(u=b.charCodeAt(0),i=0;i<8;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1}else{for(u=1,i=0;i<w;i++)p=p<<1|u,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=0;for(u=b.charCodeAt(0),i=0;i<16;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1}L--,L==0&&(L=Math.pow(2,w),w++),delete v[b]}else for(u=h[b],i=0;i<w;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1;L--,L==0&&(L=Math.pow(2,w),w++),h[A]=k++,b=String(C)}if(b!==""){if(Object.prototype.hasOwnProperty.call(v,b)){if(b.charCodeAt(0)<256){for(i=0;i<w;i++)p=p<<1,g==r-1?(g=0,y.push(d(p)),p=0):g++;for(u=b.charCodeAt(0),i=0;i<8;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1}else{for(u=1,i=0;i<w;i++)p=p<<1|u,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=0;for(u=b.charCodeAt(0),i=0;i<16;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1}L--,L==0&&(L=Math.pow(2,w),w++),delete v[b]}else for(u=h[b],i=0;i<w;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1;L--,L==0&&(L=Math.pow(2,w),w++)}for(u=2,i=0;i<w;i++)p=p<<1|u&1,g==r-1?(g=0,y.push(d(p)),p=0):g++,u=u>>1;for(;;)if(p=p<<1,g==r-1){y.push(d(p));break}else g++;return y.join("")},decompress:function(c){return c==null?"":c==""?null:l._decompress(c.length,32768,function(r){return c.charCodeAt(r)})},_decompress:function(c,r,d){var i=[],u=4,h=4,v=3,C="",A=[],b,L,k,w,y,p,g,m={val:d(0),position:r,index:1};for(b=0;b<3;b+=1)i[b]=b;for(k=0,y=Math.pow(2,2),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=r,m.val=d(m.index++)),k|=(w>0?1:0)*p,p<<=1;switch(k){case 0:for(k=0,y=Math.pow(2,8),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=r,m.val=d(m.index++)),k|=(w>0?1:0)*p,p<<=1;g=t(k);break;case 1:for(k=0,y=Math.pow(2,16),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=r,m.val=d(m.index++)),k|=(w>0?1:0)*p,p<<=1;g=t(k);break;case 2:return""}for(i[3]=g,L=g,A.push(g);;){if(m.index>c)return"";for(k=0,y=Math.pow(2,v),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=r,m.val=d(m.index++)),k|=(w>0?1:0)*p,p<<=1;switch(g=k){case 0:for(k=0,y=Math.pow(2,8),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=r,m.val=d(m.index++)),k|=(w>0?1:0)*p,p<<=1;i[h++]=t(k),g=h-1,u--;break;case 1:for(k=0,y=Math.pow(2,16),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=r,m.val=d(m.index++)),k|=(w>0?1:0)*p,p<<=1;i[h++]=t(k),g=h-1,u--;break;case 2:return A.join("")}if(u==0&&(u=Math.pow(2,v),v++),i[g])C=i[g];else if(g===h)C=L+L.charAt(0);else return null;A.push(C),i[h++]=L+C.charAt(0),u--,L=C,u==0&&(u=Math.pow(2,v),v++)}}};return l}();f!=null&&(f.exports=e)})(tt);class nt extends S{constructor(e){const t=e==null?void 0:e.layoutToUse,n=D.t.general.sharescreen,o=[],s=[],a=new j(n.fsIncludeCurrentLocation,!0);o.push(a);const l=e.locationControl;s.push(a.GetValue().map(w=>{var y,p,g;return l===void 0?null:w?[["z",(y=l.data)==null?void 0:y.zoom],["lat",(p=l.data)==null?void 0:p.lat],["lon",(g=l.data)==null?void 0:g.lon]].filter(m=>m[1]!==void 0).map(m=>m[0]+"="+m[1]).join("&"):null},[l]));function c(w){return w.isDisplayed.data?null:"layer-"+w.layerDef.id+"="+w.isDisplayed.data}const r=e.backgroundLayer,d=new G(r.map(w=>n.fsIncludeCurrentBackgroundMap.Subs({name:(w==null?void 0:w.name)??""}))),i=new j(d,!0);o.push(i),s.push(i.GetValue().map(w=>{var y;return w?"background="+((y=r.data)==null?void 0:y.id):null},[r]));const u=new j(n.fsIncludeCurrentLayers,!0);o.push(u),s.push(u.GetValue().map(w=>w?I.NoNull(e.filteredLayers.data.map(c)).join("&"):null,e.filteredLayers.data.map(w=>w.isDisplayed)));const h=[{urlName:"fs-userbadge",human:n.fsUserbadge},{urlName:"fs-search",human:n.fsSearch},{urlName:"fs-welcome-message",human:n.fsWelcomeMessage},{urlName:"fs-layers",human:n.fsLayers},{urlName:"fs-add-new",human:n.fsAddNew},{urlName:"fs-geolocation",human:n.fsGeolocation}];for(const w of h){const y=new j(D.W(w.human));o.push(y),s.push(y.GetValue().map(p=>p?null:`${w.urlName}=false`))}t.definitionRaw!==void 0&&s.push(new M("userlayout="+(t.definedAtUrl??t.id)));const v=new S(o).SetClass("flex flex-col"),C=(l??new M(void 0)).map(()=>{const w=window.location.host;let y=window.location.pathname;y=y.substr(0,y.lastIndexOf("/"));let p=t.id.toLowerCase();t.definitionRaw!==void 0&&(p="theme.html");let g=`https://${w}${y}/${p}`,m="";t.definedAtUrl===void 0&&t.definitionRaw!==void 0&&(m="#"+te.compressToBase64(I.MinifyJSON(t.definitionRaw)));const N=I.NoEmpty(I.NoNull(s.map(Le=>Le.data)));return N.length===0?g+m:g+"?"+N.join("&")+m},s),A=new G(C.map(w=>{var y;return`<span class='literal-code iframe-code-block'>
                         &lt;iframe src="${w}" allow="geolocation" width="100%" height="100%" style="min-width: 250px; min-height: 250px" title="${((y=t.title)==null?void 0:y.txt)??"MapComplete"} with MapComplete"&gt;&lt;/iframe&gt
                    </span>`})),b=new M(""),L=new G(C.map(w=>`<input type="text" value=" ${w}" id="code-link--copyable" style="width:90%">`)).onClick(async()=>{var p,g;const w={title:((p=D.W(t.title))==null?void 0:p.ConstructElement().textContent)??"",text:((g=D.W(t.description))==null?void 0:g.ConstructElement().textContent)??"",url:C.data};function y(){const m=document.getElementById("code-link--copyable");m.select(),m.setSelectionRange(0,99999),document.execCommand("copy");const N=n.copiedToClipboard.Clone();N.SetClass("thanks"),b.setData(N)}try{navigator.share(w).then(()=>{const m=n.thanksForSharing.Clone();m.SetClass("thanks"),b.setData(m)},y).catch(y)}catch{y()}});let k;if(t.definitionRaw!==void 0){const w=new O(x.download_svg(),new S([n.downloadCustomTheme,n.downloadCustomThemeHelp.SetClass("subtle")]).onClick(()=>{I.offerContentsAsDownloadableFile(t.definitionRaw,t.id+".mapcomplete-theme-definition.json",{mimetype:"application/json"})}).SetClass("flex flex-col"));let y;if(t.definedAtUrl===void 0){const p=JSON.parse(t.definitionRaw);p.language=Object.keys(p.title),y=new O(x.pencil_svg(),"Edit this theme on the custom theme generator",{url:`https://pietervdvn.github.io/mc/legacy/070/customGenerator.html#${btoa(JSON.stringify(p))}`})}k=new S([w,y]).SetClass("flex flex-col")}super([n.intro,L,new G(b),k,n.addToHomeScreen,n.embedIntro,v,A]),this.SetClass("flex flex-col link-underline")}}class ot extends S{constructor(){const e=D.t.privacy;super([new E(e.title,2),e.intro,new E(e.trackingTitle),e.tracking,new E(e.geodataTitle),e.geodata,new E(e.editingTitle),e.editing,new E(e.miscCookiesTitle),e.miscCookies,new E(e.whileYoureHere),e.surveillance]),this.SetClass("link-underline")}}const V=class extends B{constructor(e,t,n,o){const s=n.layoutToUse;super(()=>s.title.Clone(),()=>V.GenerateContents(n,t,e,o),"welcome",e)}static ConstructBaseTabs(e,t,n,o){const s=[{header:`<img src='${e.layoutToUse.icon}'>`,content:new et(t,n,e,o)}];e.featureSwitchMoreQuests.data&&s.push({header:x.add_img,content:new S([D.t.general.morescreen.intro,new _e(e)]).SetClass("flex flex-col")}),e.featureSwitchShareScreen.data&&s.push({header:x.share_img,content:new nt(e)});const a={header:x.eye_svg(),content:new ot};return s.push(a),s}static GenerateContents(e,t,n,o){const s=V.ConstructBaseTabs(e,n,t,o),a=[...V.ConstructBaseTabs(e,n,t,o)];return a.push({header:x.help,content:new S([D.t.general.aboutMapcomplete.Subs({osmcha_link:I.OsmChaLinkFor(7)}),"<br/>Version "+F.vNumber,z.generateDocumentationDynamic()]).SetClass("link-underline")}),s.forEach(l=>l.content.SetClass("p-4")),a.forEach(l=>l.content.SetClass("p-4")),new _(new le(a,t),new le(s,t),e.osmConnection.userDetails.map(l=>l.loggedIn&&l.csCount>=F.userJourney.mapCompleteHelpUnlock))}};let H=V;T(H,"MoreThemesTabIndex",1);class R extends S{constructor(e,t){super([e]),t!=null&&t.dontStyle||(e.SetClass("mapcontrol p-1"),this.SetClass("p-1")),this.SetClass("relative block rounded-full w-10 h-10 pointer-events-auto z-above-map subtle-background m-0.5 md:m-1"),this.SetStyle("box-shadow: 0 0 10px var(--shadow-color);")}}var at=function(f,e){var t={};return Object.keys(f).forEach(function(n){t[n]=f[n]}),Object.keys(e).forEach(function(n){t[n]=e[n]}),t},ne={},st={get exports(){return ne},set exports(f){ne=f}};(function(f){(function(){var e=["Point","LineString","Polygon"],t=["MultiPoint","MultiLineString","MultiPolygon"];function n(a){return t.indexOf(a.type)>-1?a.coordinates.map(function(l){var c={};return c.type=a.type.replace("Multi",""),c.coordinates=l,a.crs&&(c.crs=a.crs),c}):!1}function o(a){var l=a.every(function(i){return e.indexOf(i.type)>-1}),c=a[0].crs||0,r=a.every(function(i){var u=i.crs||0;return u==c});if(l&&r){var d={};return d.type="Multi"+a[0].type,d.coordinates=[],c!=0&&(d.crs=c),a.forEach(function(i){d.coordinates.push(i.coordinates)}),d}else return!1}var s={explode:n,implode:o};f.exports?f.exports=s:window&&(window.multigeojson=s)})()})(st);var se=ne;function Q(f,e,t,n){var o=f.map(function(a){return[(a[0]-t.x)/e,(t.y-a[1])/e]}),s=o.map(function(a){return n?a[0].toFixed(n)+","+a[1].toFixed(n):a[0]+","+a[1]});return s.join(" ")}function Ce(f,e,t,n){var o=n&&n.r?n.r:1,s=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1,a=Q([f.coordinates],e,t,n.precision);return s?[a]:["M"+a+" m"+-o+",0 a"+o+","+o+" 0 1,1 "+2*o+","+0+" a"+o+","+o+" 0 1,1 "+-2*o+","+0]}function it(f,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,s=se.explode(f).map(function(a){return Ce(a,e,t,n)[0]});return o?s:[s.join(" ")]}function xe(f,e,t,n){var o=Q(f.coordinates,e,t,n.precision),s="M"+o;return[s]}function rt(f,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,s=se.explode(f).map(function(a){return xe(a,e,t,n)[0]});return o?s:[s.join(" ")]}function be(f,e,t,n){var o,s;o=Q(f.coordinates[0],e,t,n.precision),f.coordinates.length>1&&(s=f.coordinates.slice(1,f.coordinates.length));var a="M"+o;if(s)for(var l=0;l<s.length;l++)a+=" M"+Q(s[l],e,t,n.precision);return a+="Z",[a]}function lt(f,e,t,n){var o=n.hasOwnProperty("explode")?n.explode:!1,s=se.explode(f).map(function(a){return be(a,e,t,n)[0]});return o?s:[s.join(" ").replace(/Z/g,"")+"Z"]}var ct={Point:Ce,MultiPoint:it,LineString:xe,MultiLineString:rt,Polygon:be,MultiPolygon:lt},ie=at,oe=ct,W=function(f){this.options=f||{},this.viewportSize=this.options.viewportSize||{width:256,height:256},this.mapExtent=this.options.mapExtent||{left:-20037508342789244e-9,right:20037508342789244e-9,bottom:-20037508342789244e-9,top:20037508342789244e-9},this.res=this.calResolution(this.mapExtent,this.viewportSize,this.options.fitTo)};W.prototype.calResolution=function(f,e,t){var n=(f.right-f.left)/e.width,o=(f.top-f.bottom)/e.height;if(t){if(t.toLowerCase()==="width")return n;if(t.toLowerCase()==="height")return o;throw new Error('"fitTo" option should be "width" or "height" ')}else return Math.max(n,o)};W.prototype.convert=function(f,e){var t=ie(this.options,e||{}),n=[];if(f.type=="FeatureCollection")for(var o=0;o<f.features.length;o++)n=n.concat(this.convertFeature(f.features[o],t));else if(f.type=="Feature")n=this.convertFeature(f,t);else if(f.type=="GeometryCollection")for(var o=0;o<f.geometries.length;o++)n=n.concat(this.convertGeometry(f.geometries[o],t));else if(oe[f.type])n=this.convertGeometry(f,t);else return;return t.callback&&t.callback.call(this,n),n};W.prototype.convertFeature=function(f,e){if(!(!f&&!f.geometry)){var t=ie(this.options,e||{});if(t.attributes&&t.attributes instanceof Array){var n=t.attributes;t.attributes=n.reduce(function(s,a){if(typeof a=="string"){var l,c=a.split(".").pop();try{l=de(f,a)}catch{l=!1}l&&(s[c]=l)}else if(typeof a=="object"&&a.type&&a.property)if(a.type==="dynamic"){var l,c=a.key?a.key:a.property.split(".").pop();try{l=de(f,a.property)}catch{l=!1}l&&(s[c]=l)}else a.type==="static"&&a.value&&(s[a.property]=a.value);return s},{})}else t.attributes=t.attributes||{};var o=t.attributes.id||f.id||(f.properties&&f.properties.id?f.properties.id:null);return o&&(t.attributes.id=o),this.convertGeometry(f.geometry,t)}};W.prototype.convertGeometry=function(f,e){if(oe[f.type]){var t=ie(this.options,e||{}),n=t.output||"svg",o=oe[f.type].call(this,f,this.res,{x:this.mapExtent.left,y:this.mapExtent.top},t),s,a;return n.toLowerCase()=="svg"?(s=o.map(function(l){return dt(l,f.type,t.attributes,t)}),a=s.map(function(l){return ut(l,f.type,t)}),a):o}else return};function dt(f,e,t,n){var o={},s=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1;(e=="Point"||e=="MultiPoint")&&s?(o.cx=f.split(",")[0],o.cy=f.split(",")[1],o.r=n&&n.r?n.r:"1"):(o={d:f},(e=="Polygon"||e=="MultiPolygon")&&o["fill-rule"]=="evenodd");for(var a in t)o[a]=t[a];return o}function ut(f,e,t){var n=t&&t.hasOwnProperty("pointAsCircle")?t.pointAsCircle:!1,o="<path";(e=="Point"||e=="MultiPoint")&&n&&(o="<circle");for(var s in f)o+=" "+s+'="'+f[s]+'"';return o+="/>",o}function de(f,e){function t(n,o,s,a){if(n.hasOwnProperty(o))return n[o];throw new Error(a.slice(0,s+1).join(".")+" is not a valid property path")}return e.split(".").reduce(t,f)}var ft=W,pt=ft,mt=function(f){return new pt(f)},ht=mt;class U extends _{constructor(e){const t=D.t.general.download,n=e.layoutToUse.id,o=new Ve([t.includeMetaData]),s=o.GetValue().map(d=>d.length>0),a=new O(x.floppy_ui(),new S([t.downloadGeojson.SetClass("font-bold"),t.downloadGeoJsonHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const d=U.getCleanGeoJson(e,s.data);I.offerContentsAsDownloadableFile(JSON.stringify(d,null,"  "),`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.geojson`,{mimetype:"application/vnd.geo+json"})}),l=new O(x.floppy_ui(),new S([t.downloadCSV.SetClass("font-bold"),t.downloadCSVHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const d=U.getCleanGeoJson(e,s.data),i=ye.toCSV(d.features);I.offerContentsAsDownloadableFile(i,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.csv`,{mimetype:"text/csv"})}),c=new O(x.floppy_ui(),new S([t.downloadAsSvg.SetClass("font-bold"),t.downloadAsSvgHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const d=U.getCleanGeoJsonPerLayer(e,s.data),i=document.getElementById("leafletDiv"),u=U.asSvg(d,{layers:e.filteredLayers.data.map(h=>h.layerDef),mapExtent:e.currentBounds.data,width:i.offsetWidth,height:i.offsetHeight});I.offerContentsAsDownloadableFile(u,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.svg`,{mimetype:"image/svg+xml"})}),r=new S([new E(t.title),a,l,c,o,t.licenseInfo.SetClass("link-underline")]).SetClass("w-full flex flex-col border-4 border-gray-300 rounded-3xl p-4");super(r,t.noDataLoaded,e.featurePipeline.somethingLoaded)}static asSvg(e,t){var r,d,i;t=t??{};const n=t.width??1e3,o=t.height??1e3,s=t.unit??"px",a={left:-180,bottom:-90,right:180,top:90};if(t.mapExtent!==void 0){const u=t.mapExtent;a.left=u.minLon,a.right=u.maxLon,a.bottom=u.minLat,a.top=u.maxLat}const l=[];for(const u of Array.from(e.keys())){const h=e.get(u);if(h.length===0)continue;const v=(r=t==null?void 0:t.layers)==null?void 0:r.find(k=>k.id===u),C=v==null?void 0:v.lineRendering[0],A=ht({viewportSize:{width:n,height:o},mapExtent:a,output:"svg",attributes:[{property:"style",type:"static",value:"fill:none;stroke-width:1"},{property:"properties.stroke",type:"dynamic",key:"stroke"}]});for(const k of h){const w=((i=(d=C==null?void 0:C.color)==null?void 0:d.GetRenderValue(k.properties))==null?void 0:i.txt)??"#ff0000",y=I.colorAsHex(I.color(w));k.properties.stroke=y}const b=A.convert({type:"FeatureCollection",features:h}),L=`    <g id="${u}" inkscape:groupmode="layer" inkscape:label="${u}">
`+b.map(k=>"        "+k).join(`
`)+`
    </g>`;l.push(L)}return`<svg width="${n}${s}" height="${o}${s}" viewBox="0 0 ${n} ${o}">`+`
`+l.join(`
`)+`
</svg>`}static getCleanGeoJson(e,t){const n=U.getCleanGeoJsonPerLayer(e,t);return{type:"FeatureCollection",features:[].concat(...Array.from(n.values()))}}static getCleanGeoJsonPerLayer(e,t){const n=new Map,o=e.filteredLayers.data.map(l=>l.layerDef.id),s=e.currentBounds.data,a=e.featurePipeline.GetAllFeaturesAndMetaWithin(s,new Set(o));for(const l of a){if(F.priviliged_layers.indexOf(l.layer)>=0)continue;const c=e.filteredLayers.data.find(i=>i.layerDef.id===l.layer);n.has(l.layer)||n.set(l.layer,[]);const r=n.get(l.layer),d=c.appliedFilters.data;e:for(const i of l.features){if(!s.overlapsWith(X.get(i)))continue;if(d!==void 0)for(let v of Array.from(d.keys())){const C=d.get(v);if((C==null?void 0:C.currentFilter)!==void 0&&!C.currentFilter.matchesProperties(i.properties))continue e}const u={type:i.type,geometry:{...i.geometry},properties:{...i.properties}};if(!t)for(const v in u.properties)v==="_lon"||v==="_lat"||v.startsWith("_")&&delete i.properties[v];const h=[].concat(Je.metatags.filter(v=>v.includesDates).map(v=>v.keys));for(const v of h)delete i.properties[v];r.push(u)}}return n}}class wt{constructor(e){T(this,"isRunning",new M(!0));T(this,"mapW",297);T(this,"mapH",210);T(this,"scaling",2);T(this,"freeDivId");T(this,"_layout");T(this,"_screenhotTaken",!1);this.freeDivId=e.freeDivId,this._layout=e.layout;const t=this,n=e.location.data,o={lat:n.lat,lon:n.lon,zoom:n.zoom+1},s=Pe.createMiniMap({location:new M(o),background:e.background,allowMoving:!1,onFullyLoaded:a=>window.setTimeout(()=>{if(!t._screenhotTaken)try{t.CreatePdf(s).then(()=>t.cleanup()).catch(()=>t.cleanup())}catch(l){console.error(l),t.cleanup()}},500)});s.SetStyle(`width: ${this.mapW*this.scaling}mm; height: ${this.mapH*this.scaling}mm;`),s.AttachTo(e.freeDivId),s.leafletMap.addCallbackAndRunD(a=>{const l=X.fromLeafletBounds(a.getBounds().pad(.2));e.features.GetTilesPerLayerWithin(l,c=>{c.layer.layerDef.minzoom>n.zoom||c.layer.layerDef.id.startsWith("note_import")||new Z({features:c,leafletMap:s.leafletMap,layerToShow:c.layer.layerDef,doShowLayer:c.layer.isDisplayed,state:void 0})})}),q.state.AddAllOverlaysToMap(s.leafletMap)}cleanup(){new P("Screenshot taken!").AttachTo(this.freeDivId),this._screenhotTaken=!0}async CreatePdf(e){console.log("PDF creation started");const t=D.t.general.pdf,n=this._layout;let o=new Fe("landscape");const s=await e.TakeScreenshot();o.addImage(s,"PNG",0,0,this.mapW,this.mapH),o.setDrawColor(255,255,255),o.setFillColor(255,255,255),o.roundedRect(12,10,145,25,5,5,"FD"),o.setFontSize(20),o.textWithLink(n.title.txt,40,18.5,{maxWidth:125,url:window.location.href}),o.setFontSize(10),o.text(t.generatedWith.txt,40,23,{maxWidth:125});const a=q.state.backgroundLayer.data,l=new P(a.layer().getAttribution()??a.name).ConstructElement().textContent;o.textWithLink(t.attr.txt,40,26.5,{maxWidth:125,url:"https://www.openstreetmap.org/copyright"}),o.text(t.attrBackground.Subs({background:l}).txt,40,30);let c=new Date().toISOString().substr(0,16);o.setFontSize(7),o.text(t.versionInfo.Subs({version:F.vNumber,date:c}).txt,40,34,{maxWidth:125});let r=document.createElement("img");const d=n.icon,i=d.substring(d.lastIndexOf(".")+1);if(r.src=d,i.toLowerCase()==="svg"){new P("").AttachTo(this.freeDivId);const u=document.createElement("canvas"),h=u.getContext("2d");u.width=500,u.height=500,r.style.width="100%",r.style.height="100%",h.drawImage(r,0,0,500,500);const v=u.toDataURL("image/png");o.addImage(v,"png",15,12,20,20)}else try{o.addImage(r,i,15,12,20,20)}catch(u){console.error(u)}o.save(`MapComplete_${n.title.txt}_${c}.pdf`),this.isRunning.setData(!1)}}class K extends B{constructor(e,t){super(K.GenTitle,()=>K.GeneratePanel(t),"downloads",e)}static GenTitle(){return D.t.general.download.title.Clone().SetClass("text-2xl break-words font-bold p-2")}static GeneratePanel(e){const t=new M(!1,"Pdf-is-exporting"),n=()=>{t.setData(!0),new wt({freeDivId:"belowmap",background:e.backgroundLayer,location:e.locationControl,features:e.featurePipeline,layout:e.layoutToUse}).isRunning.addCallbackAndRun(d=>t.setData(d))},o=x.loading_svg().SetClass("animate-rotate"),s=D.t.general.download,a=new _(o,x.floppy_ui(),t),l=new _(s.exporting.Clone(),new S([s.downloadAsPdf.Clone().SetClass("font-bold"),s.downloadAsPdfHelper.Clone()]).SetClass("flex flex-col").onClick(()=>{n()}),t),c=new _(new O(a,l),void 0,e.featureSwitchExportAsPdf),r=new _(new U(e),void 0,e.featureSwitchEnableExport);return new S([c,r]).SetClass("flex flex-col")}}class gt extends S{constructor(e,t){var d,i;const n=(d=e.currentView)==null?void 0:d.layer,o=new _(new $(()=>{const u=e.currentView.features.map(v=>{var C;return(C=v[0])==null?void 0:C.feature}),h=new G(u.map(v=>{var L;const C=x.checkbox_empty_svg();if(v===void 0)return C;const A={...v.properties,button:"yes"},b=(L=n.layerDef.mapRendering[0])==null?void 0:L.GetSimpleIcon(new M(A));return b===void 0?C:b})).SetClass("inline-block w-full h-full");return u.map(v=>{if(v===void 0)return;const C=e.allElements.getEventSourceById(v.properties.id);return new Y(C,n.layerDef,e,{hashToShow:"currentview",isShown:t.currentViewControlIsOpened})}),new R(h)}).onClick(()=>{t.currentViewControlIsOpened.setData(!0)}),void 0,new M(n!==void 0&&((i=n==null?void 0:n.layerDef)==null?void 0:i.tagRenderings)!==null));new K(t.downloadControlIsOpened,e);const s=new R(x.download_svg()).onClick(()=>t.downloadControlIsOpened.setData(!0)),a=new _(s,void 0,e.featureSwitchEnableExport.map(u=>u||e.featureSwitchExportAsPdf.data,[e.featureSwitchExportAsPdf]));new B(()=>D.t.general.layerSelection.title.Clone(),()=>new we(e.filteredLayers,e.overlayToggles,e).SetClass("block p-1"),"filters",t.filterViewIsOpened);const l=new R(x.layers_svg()).onClick(()=>t.filterViewIsOpened.setData(!0));e.featureSwitchFilter.addCallbackAndRun(u=>{z.RegisterHotkey({nomod:"B"},D.t.hotkeyDocumentation.openLayersPanel,()=>{t.filterViewIsOpened.setData(!t.filterViewIsOpened.data)})});const c=new _(l,void 0,e.featureSwitchFilter),r=new _(new Oe(e,e.backgroundLayer,{enableHotkeys:!0}),void 0,e.featureSwitchBackgroundSelection);super([o,c,a,r]),this.SetClass("flex flex-col")}}class re extends G{constructor(t,n){const o=(n==null?void 0:n.value)??new M("0");super(t.map(s=>{const a=Object.keys(s);return a.sort((l,c)=>{const r=Number(l),d=Number(c);return isNaN(r)||isNaN(d)?l<c?-1:1:r-d}),re.constructPicker(a,o)}));T(this,"_value");this._value=o}static constructPicker(t,n){let o=new ze(0,t.length-1,{vertical:!0});const s="flex border-2 border-blue-500 w-10 h-10 place-content-center items-center border-box";o.SetClass("flex elevator w-10").SetStyle(`height: ${2.5*t.length}rem; background: #00000000`);const a=t.map((c,r)=>new Ie(new P(c).SetClass("font-bold active bg-subtle "+s),new P(c).SetClass("normal-background "+s),o.GetValue().sync(d=>d===r,[],d=>d?r:o.GetValue().data)).ToggleOnClick().SetClass("flex w-10 h-10"));a.reverse();const l=new S([new S(a),o]);return l.SetClass("flex flex-row overflow-hidden"),o.GetValue().addCallbackD(c=>{t!==void 0&&t[c]!=null&&n.setData(t[c])}),n.addCallbackAndRunD(c=>{const r=t.findIndex(d=>d===c);o.GetValue().setData(r)}),l}GetValue(){return this._value}IsValid(t){return!1}}class vt extends S{constructor(e){const t=e.currentBounds.map(a=>{if(a===void 0)return{};const r=[].concat(...e.featurePipeline.GetAllFeaturesAndMetaWithin(a).map(i=>i.features)).filter(i=>X.get(i).overlapsWith(a)).map(i=>i.properties.level),d={0:0};for(const i of r){i===void 0&&d[0]++;for(const u of Se.LevelsParser(i))d[u]=(d[u]??0)+1}return d}),n=new re(t);e.globalFilters.data.push({filter:{currentFilter:void 0,state:void 0},id:"level",onNewPoint:void 0});const o=t.map(a=>!(e.locationControl.data.zoom<=16||Object.keys(a).length==1),[e.locationControl]);function s(){console.log("Updating levels filter to ",n.GetValue().data," is shown:",o.data);const a=e.globalFilters.data.find(d=>d.id==="level");if(!o.data){a.filter={state:"*",currentFilter:void 0},a.onNewPoint=void 0,e.globalFilters.ping();return}const l=n.GetValue().data;if(l===void 0)return;let c=new Ze("level",new RegExp("(^|;)"+l+"(;|$)"));l==="0"&&(c=new Qe([c,new ce("level","")])),a.filter={state:l,currentFilter:c};const r=D.t.general.levelSelection;a.onNewPoint={confirmAddNew:r.confirmLevel.PartialSubs({level:l}),safetyCheck:r.addNewOnLevel.Subs({level:l}),tags:[new ce("level",l)]},e.globalFilters.ping()}o.addCallbackAndRun(a=>{console.log("Is level selector shown?",a),s(),a?n.RemoveClass("invisible"):n.SetClass("invisible")}),t.addCallbackAndRun(a=>{if(!o.data)return;const l=n.GetValue();if(!(a[l.data]===void 0||a[l.data]===0))return;let c=0,r;for(const d in a){const i=a[d];(r===void 0||c<i)&&(r=d,c=i)}console.log("Force switching to a different level:",r,"as it has",c,"elements on that floor",a,"(old level: "+l.data+")"),l.setData(r)}),n.GetValue().addCallback(a=>s()),super([n])}}class yt extends G{constructor(e,t){var c;const n=new M(void 0);n.addCallbackD(r=>{e.geolocationState.requestMoment.setData(r)});const o=n.map(r=>r===void 0?!1:(new Date().getTime()-r.getTime())/1e3<=3),s=e.geolocationState.requestMoment.map(r=>{if(r===void 0)return!1;const d=(new Date().getTime()-r.getTime())/1e3;return console.log("Timediff",d),d<=F.zoomToLocationTimeout}),a=e==null?void 0:e.geolocationState;super((c=a==null?void 0:a.permission)==null?void 0:c.map(r=>r==="denied"?x.location_refused_svg():a.isLocked.data?x.location_locked_svg():a.currentGPSLocation.data===void 0?r==="prompt"?x.location_empty_svg():(!e.mapHasMoved.data||s.data?x.location_svg():x.location_empty_svg()).SetClass("cursor-wait").SetStyle("animation: spin 4s linear infinite;"):o.data?x.location_unlocked_svg():x.location_svg(),[a.currentGPSLocation,a.isLocked,e.mapHasMoved,o,s]));async function l(){if(a.permission.data!=="granted"&&a.currentGPSLocation.data===void 0&&(n.setData(new Date),a.requestMoment.setData(new Date),await a.requestPermission()),a.isLocked.data===!0){a.isLocked.setData(!1);return}if(a.currentGPSLocation.data===void 0){n.setData(new Date);return}const r=a.currentGPSLocation.data,d=t.currentBounds.data.contains([r.longitude,r.latitude]);if(e.MoveMapToCurrentLocation(),d){const i=t.locationControl.data;t.locationControl.setData({...i,zoom:i.zoom+3})}if(o.data){a.isLocked.setData(!0),n.setData(void 0);return}n.setData(new Date)}this.onClick(l),z.RegisterHotkey({nomod:"L"},D.t.hotkeyDocumentation.geolocate,l),n.addCallbackAndRunD(r=>{window.setTimeout(()=>{o.data&&n.ping()},500)}),e.geolocationState.requestMoment.addCallbackAndRunD(r=>{window.setTimeout(()=>{s.data&&e.geolocationState.requestMoment.ping()},500)})}}class St extends S{constructor(e,t){const n=_.If(e.featureSwitchGeolocation,()=>new R(new yt(t,e),{dontStyle:!0}).SetClass("p-1")),o=new R(x.plus_svg()).onClick(()=>{e.locationControl.data.zoom++,e.locationControl.ping()}),s=new R(x.min_svg()).onClick(()=>{e.locationControl.data.zoom--,e.locationControl.ping()}),a=new vt(e);super([a,o,s,n].map(l=>l.SetClass("m-0.5 md:m-1"))),this.SetClass("flex flex-col items-center")}}class Ct extends G{constructor(e){const t=e.featurePipeline,n=D.t.centerMessage,o=t.runningQuery.map(s=>s?{el:new Ge(n.loadingData)}:t.sufficientlyZoomed.data?t.timeout.data>0?{el:n.retrying.Subs({count:""+t.timeout.data})}:{el:n.ready,isDone:!0}:{el:n.zoomIn},[t.timeout,t.sufficientlyZoomed,e.locationControl]);super(o.map(s=>s.el)),this.SetClass("flex justify-center rounded-3xl bg-white text-xl font-bold pointer-events-none p-4"),this.SetStyle("transition: opacity 750ms linear"),o.addCallbackAndRun(s=>{s.isDone??!1?this.SetStyle("transition: opacity 750ms linear; opacity: 0"):this.SetStyle("transition: opacity 750ms linear; opacity: 0.75")})}}const xt="home_location",bt="Meta layer showing the home location of the user. The home location can be set in the [profile settings](https://www.openstreetmap.org/profile/edit) of OpenStreetMap.",kt=0,Dt={osmTags:"user:home=yes",maxCacheAge:0},Lt=[{icon:{render:"circle:white;./assets/svg/home.svg"},iconSize:{render:"20,20,center"},location:["point","centroid"]}],ke={id:xt,description:bt,minzoom:kt,source:Dt,mapRendering:Lt};class Tt extends _{constructor(e,t,n){var d;const o=D.t.notes,s=new M(!1);n.LastClickLocation.addCallbackAndRun(i=>s.setData(!1));const a=Re.ForType("text").ConstructInputElement({value:pe.Get("note-text")});a.SetClass("border rounded-sm border-grey-500");const l=new O(x.addSmall_svg().SetClass("max-h-7"),o.createNote);l.OnClickWithLoading(o.creating,async()=>{var C,A,b,L,k,w,y,p,g,m;let i=a.GetValue().data;if(i===void 0||i==="")return;i+=`

 #MapComplete #`+((C=n==null?void 0:n.layoutToUse)==null?void 0:C.id);const u=n.LastClickLocation.data,h=await((A=n==null?void 0:n.osmConnection)==null?void 0:A.openNote(u.lat,u.lon,i)),v={type:"Feature",geometry:{type:"Point",coordinates:[u.lon,u.lat]},properties:{id:""+h.id,date_created:new Date().toISOString(),_first_comment:i,comments:JSON.stringify([{text:i,html:i,user:(k=(L=(b=n.osmConnection)==null?void 0:b.userDetails)==null?void 0:L.data)==null?void 0:k.name,uid:(p=(y=(w=n.osmConnection)==null?void 0:w.userDetails)==null?void 0:y.data)==null?void 0:p.uid}])}};(g=n==null?void 0:n.featurePipeline)==null||g.InjectNewPoint(v),(m=n.selectedElement)==null||m.setData(v),ee.hash.setData(v.properties.id),a.GetValue().setData(""),s.setData(!0)});const c=new S([new E(o.createNoteTitle),o.createNoteIntro,a,new S([new _(void 0,o.warnAnonymous.SetClass("block alert"),(d=n==null?void 0:n.osmConnection)==null?void 0:d.isLoggedIn),new _(l,o.textNeeded.SetClass("block alert"),a.GetValue().map(i=>(i==null?void 0:i.length)>3))]).SetClass("flex justify-end items-center")]).SetClass("flex flex-col border-2 border-black rounded-xl p-4"),r=new _(new _(o.isCreated.SetClass("thanks"),c,s),void 0,new M(!0));super(new _(new S([o.noteLayerHasFilters.SetClass("alert"),new O(x.filter_svg(),o.disableAllNoteFilters).onClick(()=>{const i=e.appliedFilters.data;for(const u of Array.from(i.keys()))i.set(u,void 0);e.appliedFilters.ping(),t.setData(!1)})]).SetClass("flex flex-col"),r,e.appliedFilters.map(i=>(console.log("Applied filters for notes are: ",i),Array.from(i.values()).some(u=>(u==null?void 0:u.currentFilter)!==void 0)))),new S([o.noteLayerNotEnabled.SetClass("alert"),new O(x.layers_svg(),o.noteLayerDoEnable).onClick(()=>{e.isDisplayed.setData(!0),t.setData(!1)})]).SetClass("flex flex-col"),e.isDisplayed)}}class Mt extends S{constructor(e){const t=new G(e.map(o=>{const s=[];let a;for(const c of o){const r=c.layerDef;if(!(r.name===void 0&&!c.isDisplayed.data))for(const d of c.layerDef.presets){const i=Se.KVtoProperties(d.tags),u=r.mapRendering[0].GenerateLeafletStyle(new M(i),!1).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;");s.push(u),a===void 0&&(a=r.mapRendering[0].GenerateLeafletStyle(new M(i),!1).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;"))}}if(s.length===0)return;if(s.length===1)return s[0];s.push(a);const l=new S(s).SetClass("flex");return l.SetClass("slide min-w-min").SetStyle("animation: slide "+s.length+"s linear infinite;"),l})),n=D.t.general.add.addNewMapLabel.Clone().SetClass("block center absolute text-sm min-w-min pl-1 pr-1 bg-gray-400 rounded-3xl text-white opacity-65 whitespace-nowrap").SetStyle("top: 65px; transform: translateX(-50%)");super([new S([x.add_pin_svg().SetClass("absolute").SetStyle("width: 50px; filter: drop-shadow(grey 0 0 10px"),new S([t]).SetStyle("width: 50px").SetClass("absolute p-1 rounded-full overflow-hidden"),x.addSmall_svg().SetClass("absolute animate-pulse").SetStyle("width: 30px; left: 30px; top: 35px;")]).SetClass("absolute"),new S([n]).SetStyle("position: absolute; left: 50%")]),this.SetClass("block relative")}}class ue extends Ee{constructor(t,n){super();T(this,"_config");T(this,"state");this.state=t,this._config=n}InnerRender(){var d,i,u,h,v;if(this._config===void 0)return;const t=this._config,n=window!==window.top;if((d=t.requirements)!=null&&d.has("iframe")&&!n||(i=t.requirements)!=null&&i.has("no-iframe")&&n)return;let o;const s=((u=this.state.layoutToUse)==null?void 0:u.id)??"",a=window.location.host,l=this.state.locationControl.map(C=>{const A={...C,theme:s,basepath:a,language:Ae.language.data};return I.SubstituteKeys(t.href,A)});let c=x.pop_out_ui();t.icon!==void 0&&(c=new ae(t.icon).SetClass("h-6"));let r;return t.text===void 0?r=D.t.general.screenToSmall.Subs({theme:this.state.layoutToUse.title}):r=t.text.Clone(),o=new O(c,r,{url:l,newTab:t.newTab}),(h=t.requirements)!=null&&h.has("no-welcome-message")&&(o=new _(void 0,o,this.state.featureSwitchWelcomeMessage)),(v=t.requirements)!=null&&v.has("welcome-message")&&(o=new _(o,void 0,this.state.featureSwitchWelcomeMessage)),o}}class _t{constructor(e,t){T(this,"geolocationState");T(this,"_state");T(this,"mapHasMoved",new M(!1));this.geolocationState=e,this._state=t;const n=t.locationControl;let o=this,s=new Date;n.addCallbackD(l=>{if(!(new Date().getTime()-s.getTime()<250))return o.mapHasMoved.setData(!0),!0}),(J.wasInitialized("lat")||J.wasInitialized("lon"))&&this.mapHasMoved.setData(!0),this.geolocationState.currentGPSLocation.addCallbackAndRunD(l=>{var r;const c=(new Date().getTime()-((r=e.requestMoment.data)==null?void 0:r.getTime()))/1e3;if(this.mapHasMoved.data||o.MoveMapToCurrentLocation(),c<F.zoomToLocationTimeout&&o.MoveMapToCurrentLocation(),this.geolocationState.isLocked.data){o.MoveMapToCurrentLocation();return}}),e.isLocked.map(l=>{var c,r,d,i,u,h;l?(d=(r=(c=t.leafletMap)==null?void 0:c.data)==null?void 0:r.dragging)==null||d.disable():(h=(u=(i=t.leafletMap)==null?void 0:i.data)==null?void 0:u.dragging)==null||h.enable()},[t.leafletMap]),this.CopyGeolocationIntoMapstate()}MoveMapToCurrentLocation(){const e=this.geolocationState.currentGPSLocation.data,t=this._state.locationControl,n=this._state;if(n.selectedElement.data!==void 0)return;if(e.latitude===0&&e.longitude===0){console.debug("Not moving to GPS-location: it is null island");return}const o=n.layoutToUse.lockLocation;o&&o!==!0&&!new X(o).contains([e.longitude,e.latitude])||(t.setData({zoom:Math.max(t.data.zoom,16),lon:e.longitude,lat:e.latitude}),this.mapHasMoved.setData(!0),this.geolocationState.requestMoment.setData(void 0))}CopyGeolocationIntoMapstate(){const e=this._state;this.geolocationState.currentGPSLocation.addCallbackAndRun(t=>{var o,s;if(t===void 0)return;const n={type:"Feature",properties:{id:"gps","user:location":"yes",date:new Date().toISOString(),...t},geometry:{type:"Point",coordinates:[t.longitude,t.latitude]}};(s=(o=e.currentUserLocation)==null?void 0:o.features)==null||s.setData([{feature:n,freshness:new Date}])})}}class At{constructor(){T(this,"permission",new M("prompt"));T(this,"requestMoment",new M(void 0));T(this,"isLocked",new M(!1));T(this,"currentGPSLocation",new M(void 0));T(this,"_previousLocationGrant",pe.Get("geolocation-permissions"));T(this,"_grantedThisSession",new M(!1));const e=this;this.permission.addCallbackAndRunD(async t=>{t==="granted"&&(e._previousLocationGrant.setData("true"),e._grantedThisSession.setData(!0)),t==="prompt"&&e._grantedThisSession.data&&(e._previousLocationGrant.setData("false"),e.permission.setData("denied"),e.currentGPSLocation.setData(void 0),console.warn("Detected a downgrade in permissions!")),t==="denied"&&e._previousLocationGrant.setData("false")}),console.log("Previous location grant:",this._previousLocationGrant.data),this._previousLocationGrant.data==="true"&&(this._previousLocationGrant.setData("false"),console.log("Requesting access to GPS as this was previously granted"),J.wasInitialized("lat")||J.wasInitialized("lon")||this.requestMoment.setData(new Date),this.requestPermission()),window.geolocation_state=this}async startWatching(){const e=this;navigator.geolocation.watchPosition(function(t){e.currentGPSLocation.setData(t.coords),e._previousLocationGrant.setData("true")},function(){console.warn("Could not get location with navigator.geolocation")},{enableHighAccuracy:!0})}requestPermission(){var e;if(typeof navigator>"u"){this.permission.setData("denied");return}if(!(this.permission.data!=="prompt"&&this.permission.data!=="requested")){this.permission.setData("requested");try{(e=navigator==null?void 0:navigator.permissions)==null||e.query({name:"geolocation"}).then(t=>{console.log("Status update: received geolocation permission is ",t.state),this.permission.setData(t.state);const n=this;t.onchange=function(){n.permission.setData(t.state)},this.permission.setData("requested"),n.startWatching()}).catch(t=>console.error("Could not get geopermission",t))}catch(t){console.error("Could not get permission:",t)}}}}class Wt{constructor(e,t){T(this,"guiState");T(this,"state");T(this,"geolocationHandler");this.state=e,this.guiState=t,this.state.featureSwitchGeolocation.data&&(this.geolocationHandler=new _t(new At,e))}setup(){this.SetupUIElements(),this.SetupMap(),B.ActivateCurrent(),this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&I.LoadCustomCss(this.state.layoutToUse.customCss),z.RegisterHotkey({shift:"O"},D.t.hotkeyDocumentation.selectMapnik,()=>{this.state.backgroundLayer.setData(Ue.osmCarto)}),I.downloadJson("./service-worker-version").then(e=>console.log("Service worker",e)).catch(e=>console.log("Service worker not active"))}setupClickDialogOnMap(e,t){const n=t.layoutToUse.layers.some(l=>l.presets.length>0),o=t.filteredLayers.data.filter(l=>l.layerDef.id==="note")[0];let s;o!==void 0&&(s=l=>new Tt(o,l,t));function a(){if(!n&&s===void 0)return;const l=new M(!1),c=new B(()=>n?D.t.general.add.title:D.t.notes.createNoteTitle,({resetScrollSignal:d})=>{let i;n&&(i=new ve(l,d,e,t));let u;return o!==void 0&&(u=s(l)),new S([i,u]).SetClass("flex flex-col font-lg text-lg")},"new",l);c.isShown.addCallback(d=>{d||t.LastClickLocation.setData(void 0)});let r;!n&&s!==void 0&&(r=new S([x.note_svg().SetClass("absolute bottom-0").SetStyle("height: 40px"),x.addSmall_svg().SetClass("absolute w-6 animate-pulse").SetStyle("right: 10px; bottom: -8px;")]).SetClass("block relative h-full").SetStyle("left: calc( 50% - 15px )")),je.construct(t,c,n?new Mt(t.filteredLayers):r),t.LastClickLocation.addCallbackAndRunD(d=>{B.collapse()})}o!==void 0?a():t.featureSwitchAddNew.addCallbackAndRunD(l=>{if(l)return a(),!0})}SetupMap(){if(I.runningFromConsole)return;const e=this.state,t=this.guiState;e.mainMapObject.SetClass("w-full h-full").AttachTo("leafletDiv"),this.setupClickDialogOnMap(t.filterViewIsOpened,e),new Z({leafletMap:e.leafletMap,layerToShow:new ge(ke,"home_location",!0),features:e.homeLocation,state:e});const n=e.filteredLayers.data.filter(o=>o.layerDef.id==="selected_element")[0];new Z({leafletMap:e.leafletMap,layerToShow:n.layerDef,features:e.selectedElementsLayer,state:e}),e.leafletMap.addCallbackAndRunD(o=>(e.selectedElement.ping(),q.state.locationControl.ping(),!0))}SetupUIElements(){var r,d;const e=this.state,t=this.guiState,n=this,o=_.If(e.featureSwitchUserbadge,()=>{new Ne(e,{isOpened:t.userInfoIsOpened,userInfoFocusedQuestion:t.userInfoFocusedQuestion});const i=new R(new G(e.osmConnection.userDetails.map(u=>(u==null?void 0:u.img)===void 0?x.person_ui().SetClass("mt-1 block"):new ae(u==null?void 0:u.img))).SetClass("block rounded-full overflow-hidden"),{dontStyle:!0}).onClick(()=>{n.guiState.userInfoIsOpened.setData(!0)});return new he(i,D.t.general.loginWithOpenStreetMap,e)}),s=_.If(e.featureSwitchExtraLinkEnabled,()=>new ue(e,e.layoutToUse.extraLink)),a=_.If(e.featureSwitchWelcomeMessage,()=>n.InitWelcomeMessage()),l=_.If(e.featureSwitchIsTesting,()=>new P("TESTING").SetClass("alert m-2 border-2 border-black"));new B(()=>D.t.general.attribution.attributionTitle,()=>new We(e),"copyright",t.copyrightViewIsOpened);const c=new R(x.copyright_svg()).onClick(()=>t.copyrightViewIsOpened.setData(!0));new S([a,o,c,s,l]).SetClass("flex flex-col").AttachTo("top-left"),new S([new ue(e,{...e.layoutToUse.extraLink,newTab:!0,requirements:new Set})]).SetClass("flex items-center justify-center normal-background h-full").AttachTo("on-small-screen"),new S([_.If(e.featureSwitchSearch,()=>{const i=new fe(e).SetClass("shadow rounded-full h-min w-full overflow-hidden sm:max-w-sm pointer-events-auto");return z.RegisterHotkey({ctrl:"F"},D.t.hotkeyDocumentation.selectSearch,()=>{i.focus()}),i})]).AttachTo("top-right"),new gt(e,t).AttachTo("bottom-left"),new St(e,this.geolocationHandler).AttachTo("bottom-right"),new Ct(e).AttachTo("centermessage"),(d=(r=document==null?void 0:document.getElementById("centermessage"))==null?void 0:r.classList)==null||d.add("pointer-events-none")}InitWelcomeMessage(){const e=this.guiState.welcomeMessageIsOpened;new H(e,this.guiState.welcomeMessageOpenedTab,this.state,this.guiState);const t=new R(x.help_svg());t.onClick(()=>e.setData(!0));const n=new Date().getTime();return this.state.locationControl.addCallback(()=>{if(!(new Date().getTime()-n<15*1e3))return e.setData(!1),!0}),this.state.selectedElement.addCallbackAndRunD(o=>{e.setData(!1)}),t.SetClass("pointer-events-auto")}}class De{static Implement(){$e.implementation=De.AddToMap}static AddToMap(e,t,n=void 0){t.map(o=>{if(o===void 0)return;const s=Ke.tileLayer(e.source,{attribution:"",maxZoom:e.maxzoom,minZoom:e.minzoom,wmts:!1});n===void 0&&s.addTo(o),n==null||n.addCallbackAndRunD(a=>{a?s.addTo(o):o.removeLayer(s)})})}}class jt{constructor(e,t){T(this,"state");T(this,"currentView",new M(void 0));T(this,"singleElementCache",{});this.state=e}viewSelector(e,t,n,o){const s=this.currentView,a={title:t,contents:n};return e.SetClass("pl-1 pr-1 rounded-md"),e.onClick(()=>{s.setData(a)}),ee.hash.addCallbackAndRunD(l=>{l===o&&s.setData(a)}),s.addCallbackAndRunD(l=>{l==a?(e.SetClass("bg-unsubtle"),ee.hash.setData(o)):e.RemoveClass("bg-unsubtle")}),e}singleElementView(e,t,n){if(this.singleElementCache[e.properties.id]!==void 0)return this.singleElementCache[e.properties.id];const o=this.state.allElements.getEventSourceById(e.properties.id),s=new S([new E(new He(o,t.title,this.state),4),n<900?Math.floor(n)+"m away":I.Round(n/1e3)+"km away"]).SetClass("flex justify-between");return this.singleElementCache[e.properties.id]=this.viewSelector(s,new $(()=>Y.GenerateTitleBar(o,t,this.state)),new $(()=>Y.GenerateContent(o,t,this.state)))}mainElementsView(e){const t=this;return e===void 0?new P("Initializing"):e.length==0?new P("No elements in view"):new S(e.map(n=>t.singleElementView(n.element,n.layer,n.distance)))}documentationButtonFor(e){var t,n;return this.viewSelector(D.W(((t=e.name)==null?void 0:t.Clone())??e.id),new S(["Documentation about ",((n=e.name)==null?void 0:n.Clone())??e.id]),e.GenerateDocumentation([]),"documentation-"+e.id)}allDocumentationButtons(){const e=this.state.layoutToUse.layers.filter(t=>F.priviliged_layers.indexOf(t.id)<0).filter(t=>!t.id.startsWith("note_import_"));return e.length===1?this.documentationButtonFor(e[0]):this.viewSelector(new P("Documentation"),"Documentation",new S(e.map(t=>this.documentationButtonFor(t).SetClass("flex flex-col"))))}setup(){const e=this.state;this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&I.LoadCustomCss(this.state.layoutToUse.customCss);const t=this.SetupMap();I.downloadJson("./service-worker-version").then(h=>console.log("Service worker",h)).catch(h=>console.log("Service worker not active")),document.getElementById("centermessage").classList.add("hidden");const n={};for(const h of e.layoutToUse.layers)n[h.id]=h;const o=this,s=new M([]);function a(){const h=[o.state.locationControl.data.lon,o.state.locationControl.data.lon],v=o.state.featurePipeline.getAllVisibleElementsWithmeta(o.state.currentBounds.data).map(C=>{const A=ye.distanceBetween(C.center,h);return{...C,distance:A}});v.sort((C,A)=>C.distance-A.distance),s.setData(v)}t.bounds.addCallbackAndRun(a),e.featurePipeline.newDataLoadedSignal.addCallback(a),e.filteredLayers.addCallbackAndRun(h=>{for(const v of h)v.isDisplayed.addCallback(a),v.appliedFilters.addCallback(a)});const l=new $(()=>new we(e.filteredLayers,e.overlayToggles,e)),c=new S([e.layoutToUse.description,e.layoutToUse.descriptionTail]);o.currentView.setData({title:e.layoutToUse.title,contents:c});const r=new M(!1);r.addCallback(h=>o.currentView.setData({title:"filters",contents:l}));const d=new M(!1),i=new ve(new M(!0),new M(void 0),r,e,e.locationControl),u="Add a missing point";this.currentView.addCallbackAndRunD(h=>{d.setData(h.contents===i)}),d.addCallbackAndRun(h=>{h?o.currentView.data.contents!==i&&o.currentView.setData({title:u,contents:i}):o.currentView.data.contents===i&&o.currentView.setData(void 0)}),new S([new S([this.viewSelector(new E(e.layoutToUse.title.Clone(),2),e.layoutToUse.title.Clone(),c,"welcome"),t.SetClass("w-full h-64 shrink-0 rounded-lg"),new fe(e),this.viewSelector(new E(new G(s.map(h=>"There are "+(h==null?void 0:h.length)+" elements in view"))),"Statistics",new qe(s,this.state),"statistics"),this.viewSelector(new P("Filter"),"Filters",l,"filters"),this.viewSelector(new S(["Add a missing point"]),u,i),new G(s.map(h=>this.mainElementsView(h).SetClass("block m-2"))).SetClass("block shrink-2 overflow-x-auto h-full border-2 border-subtle rounded-lg"),this.allDocumentationButtons(),new me(Object.keys(e.layoutToUse.title.translations)).SetClass("mt-2"),new Xe]).SetClass("w-1/2 lg:w-1/4 m-4 flex flex-col shrink-0 grow-0"),new G(this.currentView.map(({title:h,contents:v})=>new S([new E(D.W(h),2).SetClass("shrink-0 border-b-4 border-subtle"),D.W(v).SetClass("shrink-2 overflow-y-auto block")]).SetClass("flex flex-col h-full"))).SetClass("w-1/2 lg:w-3/4 m-4 p-2 border-2 border-subtle rounded-xl m-4 ml-0 mr-8 shrink-0 grow-0")]).SetClass("flex h-full").AttachTo("leafletDiv")}SetupMap(){const e=this.state;return new Z({leafletMap:e.leafletMap,layerToShow:new ge(ke,"home_location",!0),features:e.homeLocation,state:e}),e.leafletMap.addCallbackAndRunD(t=>(e.selectedElement.ping(),q.state.locationControl.ping(),!0)),e.mainMapObject}}export{jt as D,De as S,Wt as a,te as l};
