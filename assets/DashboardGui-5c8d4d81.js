var Re=Object.defineProperty;var Ue=(p,e,t)=>e in p?Re(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var L=(p,e,t)=>(Ue(p,typeof e!="symbol"?e+"":e,t),t);import{M as He,S as Z,F as te,a as be}from"./MoreScreen-7008c021.js";import{V as I,S as b,A as ce,F as P,C as y,T as x,J as A,U as T,L as ke,K as ne,M as Be,Q as K,a as Ne,i as je,s as Ve,h as $e,D as oe,j as me,b as We,E as ae,m as he,t as B,z as ze,c as j,d as qe,G as re,N as Je,O as Ze,y as Ke,H as Qe}from"./SvelteUIElement-7f97ca15.js";import{L as Me}from"./LanguagePicker-8791ffcf.js";import{T as O,a as G,C as Ye}from"./List-07cd593f.js";import{S as E,L as q,a as Xe,U as et}from"./SubtleButton-74d1c735.js";import{L as xe,H as $,T as ge,S as tt,M as nt,B as ot,a as De,R as at,O as rt,b as we,V as st,A as it}from"./ChartJs-6c59ad15.js";import{A as lt,E as ct,F as Te,U as dt}from"./UserInformation-cde3818b.js";import{C as z,S as R,a as ut,b as Q,c as pt,d as Le,e as ft,f as Oe,g as mt,h as ht,l as gt,T as wt,i as St}from"./theme_overview-3f19a4c5.js";import{C as H,G as de,B as ee,T as vt}from"./BBox-c9a2fa1b.js";import{C as _e}from"./ContactLink-82ce1a1e.js";import{T as yt}from"./ToSvelte-a102890b.js";import{B as Ct}from"./BackToIndex-357b2d0b.js";class bt extends I{constructor(e,t){t=t??{};let n="w-8 h-8 mr-2";t.size=="medium"?n="w-16 h-16 mr-4":t.size=="large"&&(n="w-32 h-32 mr-6"),super(e.userDetails.mapD(o=>{let r=b.person_svg().SetClass("rounded-full border border-black overflow-hidden");o.img&&(r=new ce(o.img));let a=new P(o.name).SetClass("font-bold");return t!=null&&t.firstLine&&(a=new y([t.firstLine,a]).SetClass("flex flex-col")),new y([r.SetClass("rounded-full "+n),a]).SetClass("flex items-center")}))}}class kt extends y{constructor(e,t,n,o){var u;const r=x.t.general,a=n.layoutToUse,c=new Me(a.language,r.pickLanguage.Clone()),s=new E(void 0,r.openTheMap.Clone().SetClass("text-xl font-bold w-full text-center")).onClick(()=>{e.setData(!1)}).SetClass("only-on-mobile"),d=new bt(n.osmConnection,{firstLine:x.t.general.welcomeBack.Clone()});o!=null&&o.userInfoIsOpened&&d.onClick(()=>{o.userInfoIsOpened.setData(!0)});const i=new O(new xe(d,new y([x.t.general.loginWithOpenStreetMap.SetClass("text-xl font-bold"),x.t.general.loginOnlyNeededToEdit.Clone().SetClass("font-bold")]).SetClass("flex flex-col"),n),void 0,n.featureSwitchUserbadge),l=a.layers.some(m=>{var S;return((S=m.presets)==null?void 0:S.length)>0});super([a.description.Clone().SetClass("block mb-4"),new y([r.welcomeExplanation.general,l?O.If(n.featureSwitchAddNew,()=>r.welcomeExplanation.addNew):void 0]).SetClass("flex flex-col mt-2"),s,i.SetClass("block mt-6 pt-2 md:border-t-2 border-dotted border-gray-400"),(u=a.descriptionTail)==null?void 0:u.Clone().SetClass("block mt-4"),c==null?void 0:c.SetClass("block mt-4 pb-8 border-b-2 border-dotted border-gray-400"),new lt(n),...a.CustomCodeSnippets()]),this.SetClass("link-underline")}}var se={},Mt={get exports(){return se},set exports(p){se=p}};(function(p){var e=function(){var t=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",r={};function a(s,d){if(!r[s]){r[s]={};for(var i=0;i<s.length;i++)r[s][s.charAt(i)]=i}return r[s][d]}var c={compressToBase64:function(s){if(s==null)return"";var d=c._compress(s,6,function(i){return n.charAt(i)});switch(d.length%4){default:case 0:return d;case 1:return d+"===";case 2:return d+"==";case 3:return d+"="}},decompressFromBase64:function(s){return s==null?"":s==""?null:c._decompress(s.length,32,function(d){return a(n,s.charAt(d))})},compressToUTF16:function(s){return s==null?"":c._compress(s,15,function(d){return t(d+32)})+" "},decompressFromUTF16:function(s){return s==null?"":s==""?null:c._decompress(s.length,16384,function(d){return s.charCodeAt(d)-32})},compressToUint8Array:function(s){for(var d=c.compress(s),i=new Uint8Array(d.length*2),l=0,u=d.length;l<u;l++){var m=d.charCodeAt(l);i[l*2]=m>>>8,i[l*2+1]=m%256}return i},decompressFromUint8Array:function(s){if(s==null)return c.decompress(s);for(var d=new Array(s.length/2),i=0,l=d.length;i<l;i++)d[i]=s[i*2]*256+s[i*2+1];var u=[];return d.forEach(function(m){u.push(t(m))}),c.decompress(u.join(""))},compressToEncodedURIComponent:function(s){return s==null?"":c._compress(s,6,function(d){return o.charAt(d)})},decompressFromEncodedURIComponent:function(s){return s==null?"":s==""?null:(s=s.replace(/ /g,"+"),c._decompress(s.length,32,function(d){return a(o,s.charAt(d))}))},compress:function(s){return c._compress(s,16,function(d){return t(d)})},_compress:function(s,d,i){if(s==null)return"";var l,u,m={},S={},C="",_="",k="",D=2,M=3,g=2,v=[],f=0,w=0,h;for(h=0;h<s.length;h+=1)if(C=s.charAt(h),Object.prototype.hasOwnProperty.call(m,C)||(m[C]=M++,S[C]=!0),_=k+C,Object.prototype.hasOwnProperty.call(m,_))k=_;else{if(Object.prototype.hasOwnProperty.call(S,k)){if(k.charCodeAt(0)<256){for(l=0;l<g;l++)f=f<<1,w==d-1?(w=0,v.push(i(f)),f=0):w++;for(u=k.charCodeAt(0),l=0;l<8;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1}else{for(u=1,l=0;l<g;l++)f=f<<1|u,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=0;for(u=k.charCodeAt(0),l=0;l<16;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1}D--,D==0&&(D=Math.pow(2,g),g++),delete S[k]}else for(u=m[k],l=0;l<g;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1;D--,D==0&&(D=Math.pow(2,g),g++),m[_]=M++,k=String(C)}if(k!==""){if(Object.prototype.hasOwnProperty.call(S,k)){if(k.charCodeAt(0)<256){for(l=0;l<g;l++)f=f<<1,w==d-1?(w=0,v.push(i(f)),f=0):w++;for(u=k.charCodeAt(0),l=0;l<8;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1}else{for(u=1,l=0;l<g;l++)f=f<<1|u,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=0;for(u=k.charCodeAt(0),l=0;l<16;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1}D--,D==0&&(D=Math.pow(2,g),g++),delete S[k]}else for(u=m[k],l=0;l<g;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1;D--,D==0&&(D=Math.pow(2,g),g++)}for(u=2,l=0;l<g;l++)f=f<<1|u&1,w==d-1?(w=0,v.push(i(f)),f=0):w++,u=u>>1;for(;;)if(f=f<<1,w==d-1){v.push(i(f));break}else w++;return v.join("")},decompress:function(s){return s==null?"":s==""?null:c._decompress(s.length,32768,function(d){return s.charCodeAt(d)})},_decompress:function(s,d,i){var l=[],u=4,m=4,S=3,C="",_=[],k,D,M,g,v,f,w,h={val:i(0),position:d,index:1};for(k=0;k<3;k+=1)l[k]=k;for(M=0,v=Math.pow(2,2),f=1;f!=v;)g=h.val&h.position,h.position>>=1,h.position==0&&(h.position=d,h.val=i(h.index++)),M|=(g>0?1:0)*f,f<<=1;switch(M){case 0:for(M=0,v=Math.pow(2,8),f=1;f!=v;)g=h.val&h.position,h.position>>=1,h.position==0&&(h.position=d,h.val=i(h.index++)),M|=(g>0?1:0)*f,f<<=1;w=t(M);break;case 1:for(M=0,v=Math.pow(2,16),f=1;f!=v;)g=h.val&h.position,h.position>>=1,h.position==0&&(h.position=d,h.val=i(h.index++)),M|=(g>0?1:0)*f,f<<=1;w=t(M);break;case 2:return""}for(l[3]=w,D=w,_.push(w);;){if(h.index>s)return"";for(M=0,v=Math.pow(2,S),f=1;f!=v;)g=h.val&h.position,h.position>>=1,h.position==0&&(h.position=d,h.val=i(h.index++)),M|=(g>0?1:0)*f,f<<=1;switch(w=M){case 0:for(M=0,v=Math.pow(2,8),f=1;f!=v;)g=h.val&h.position,h.position>>=1,h.position==0&&(h.position=d,h.val=i(h.index++)),M|=(g>0?1:0)*f,f<<=1;l[m++]=t(M),w=m-1,u--;break;case 1:for(M=0,v=Math.pow(2,16),f=1;f!=v;)g=h.val&h.position,h.position>>=1,h.position==0&&(h.position=d,h.val=i(h.index++)),M|=(g>0?1:0)*f,f<<=1;l[m++]=t(M),w=m-1,u--;break;case 2:return _.join("")}if(u==0&&(u=Math.pow(2,S),S++),l[w])C=l[w];else if(w===m)C=D+D.charAt(0);else return null;_.push(C),l[m++]=D+C.charAt(0),u--,D=C,u==0&&(u=Math.pow(2,S),S++)}}};return c}();p!=null&&(p.exports=e)})(Mt);class xt extends y{constructor(e){const t=e==null?void 0:e.layoutToUse,n=x.t.general.sharescreen,o=[],r=[],a=new z(n.fsIncludeCurrentLocation,!0);o.push(a);const c=e.locationControl;r.push(a.GetValue().map(g=>{var v,f,w;return c===void 0?null:g?[["z",(v=c.data)==null?void 0:v.zoom],["lat",(f=c.data)==null?void 0:f.lat],["lon",(w=c.data)==null?void 0:w.lon]].filter(h=>h[1]!==void 0).map(h=>h[0]+"="+h[1]).join("&"):null},[c]));function s(g){return g.isDisplayed.data?null:"layer-"+g.layerDef.id+"="+g.isDisplayed.data}const d=e.backgroundLayer,i=new I(d.map(g=>n.fsIncludeCurrentBackgroundMap.Subs({name:(g==null?void 0:g.name)??""}))),l=new z(i,!0);o.push(l),r.push(l.GetValue().map(g=>{var v;return g?"background="+((v=d.data)==null?void 0:v.id):null},[d]));const u=new z(n.fsIncludeCurrentLayers,!0);o.push(u),r.push(u.GetValue().map(g=>g?A.NoNull(e.filteredLayers.data.map(s)).join("&"):null,e.filteredLayers.data.map(g=>g.isDisplayed)));const m=[{urlName:"fs-userbadge",human:n.fsUserbadge},{urlName:"fs-search",human:n.fsSearch},{urlName:"fs-welcome-message",human:n.fsWelcomeMessage},{urlName:"fs-layers",human:n.fsLayers},{urlName:"fs-add-new",human:n.fsAddNew},{urlName:"fs-geolocation",human:n.fsGeolocation}];for(const g of m){const v=new z(x.W(g.human));o.push(v),r.push(v.GetValue().map(f=>f?null:`${g.urlName}=false`))}t.definitionRaw!==void 0&&r.push(new T("userlayout="+(t.definedAtUrl??t.id)));const S=new y(o).SetClass("flex flex-col"),C=(c??new T(void 0)).map(()=>{const g=window.location.host;let v=window.location.pathname;v=v.substr(0,v.lastIndexOf("/"));let f=t.id.toLowerCase();t.definitionRaw!==void 0&&(f="theme.html");let w=`https://${g}${v}/${f}`,h="";t.definedAtUrl===void 0&&t.definitionRaw!==void 0&&(h="#"+se.compressToBase64(A.MinifyJSON(t.definitionRaw)));const N=A.NoEmpty(A.NoNull(r.map(Fe=>Fe.data)));return N.length===0?w+h:w+"?"+N.join("&")+h},r),_=new I(C.map(g=>{var v;return`<span class='literal-code iframe-code-block'>
                         &lt;iframe src="${g}" allow="geolocation" width="100%" height="100%" style="min-width: 250px; min-height: 250px" title="${((v=t.title)==null?void 0:v.txt)??"MapComplete"} with MapComplete"&gt;&lt;/iframe&gt
                    </span>`})),k=new T(""),D=new I(C.map(g=>`<input type="text" value=" ${g}" id="code-link--copyable" style="width:90%">`)).onClick(async()=>{var f,w;const g={title:((f=x.W(t.title))==null?void 0:f.ConstructElement().textContent)??"",text:((w=x.W(t.description))==null?void 0:w.ConstructElement().textContent)??"",url:C.data};function v(){const h=document.getElementById("code-link--copyable");h.select(),h.setSelectionRange(0,99999),document.execCommand("copy");const N=n.copiedToClipboard.Clone();N.SetClass("thanks"),k.setData(N)}try{navigator.share(g).then(()=>{const h=n.thanksForSharing.Clone();h.SetClass("thanks"),k.setData(h)},v).catch(v)}catch{v()}});let M;if(t.definitionRaw!==void 0){const g=new E(b.download_svg(),new y([n.downloadCustomTheme,n.downloadCustomThemeHelp.SetClass("subtle")]).onClick(()=>{A.offerContentsAsDownloadableFile(t.definitionRaw,t.id+".mapcomplete-theme-definition.json",{mimetype:"application/json"})}).SetClass("flex flex-col"));let v;if(t.definedAtUrl===void 0){const f=JSON.parse(t.definitionRaw);f.language=Object.keys(f.title),v=new E(b.pencil_svg(),"Edit this theme on the custom theme generator",{url:`https://pietervdvn.github.io/mc/legacy/070/customGenerator.html#${btoa(JSON.stringify(f))}`})}M=new y([g,v]).SetClass("flex flex-col")}super([n.intro,D,new I(k),M,n.addToHomeScreen,n.embedIntro,S,_]),this.SetClass("flex flex-col link-underline")}}class Dt extends y{constructor(){const e=x.t.privacy;super([new G(e.title,2),e.intro,new G(e.trackingTitle),e.tracking,new G(e.geodataTitle),e.geodata,new G(e.editingTitle),e.editing,new G(e.miscCookiesTitle),e.miscCookies,new G(e.whileYoureHere),e.surveillance]),this.SetClass("link-underline")}}const V=class extends R{constructor(e,t,n,o){const r=n.layoutToUse;super(()=>r.title.Clone(),()=>V.GenerateContents(n,t,e,o),"welcome",e)}static ConstructBaseTabs(e,t,n,o){const r=[{header:`<img src='${e.layoutToUse.icon}'>`,content:new kt(t,n,e,o)}];e.featureSwitchMoreQuests.data&&r.push({header:b.add_img,content:new y([x.t.general.morescreen.intro,new He(e)]).SetClass("flex flex-col")}),e.featureSwitchShareScreen.data&&r.push({header:b.share_img,content:new xt(e)});const a={header:b.eye_svg(),content:new Dt};return r.push(a),r}static GenerateContents(e,t,n,o){const r=V.ConstructBaseTabs(e,n,t,o),a=[...V.ConstructBaseTabs(e,n,t,o)];return a.push({header:b.help,content:new y([x.t.general.aboutMapcomplete.Subs({osmcha_link:A.OsmChaLinkFor(7)}),"<br/>Version "+H.vNumber,$.generateDocumentationDynamic()]).SetClass("link-underline")}),r.forEach(c=>c.content.SetClass("p-4")),a.forEach(c=>c.content.SetClass("p-4")),new O(new ge(a,t),new ge(r,t),e.osmConnection.userDetails.map(c=>c.loggedIn&&c.csCount>=H.userJourney.mapCompleteHelpUnlock))}};let J=V;L(J,"MoreThemesTabIndex",1);class F extends y{constructor(e,t){super([e]),t!=null&&t.dontStyle||(e.SetClass("mapcontrol p-1"),this.SetClass("p-1")),this.SetClass("relative block rounded-full w-10 h-10 pointer-events-auto z-above-map subtle-background m-0.5 md:m-1"),this.SetStyle("box-shadow: 0 0 10px var(--shadow-color);")}}var Tt=function(p,e){var t={};return Object.keys(p).forEach(function(n){t[n]=p[n]}),Object.keys(e).forEach(function(n){t[n]=e[n]}),t},ie={},Lt={get exports(){return ie},set exports(p){ie=p}};(function(p){(function(){var e=["Point","LineString","Polygon"],t=["MultiPoint","MultiLineString","MultiPolygon"];function n(a){return t.indexOf(a.type)>-1?a.coordinates.map(function(c){var s={};return s.type=a.type.replace("Multi",""),s.coordinates=c,a.crs&&(s.crs=a.crs),s}):!1}function o(a){var c=a.every(function(l){return e.indexOf(l.type)>-1}),s=a[0].crs||0,d=a.every(function(l){var u=l.crs||0;return u==s});if(c&&d){var i={};return i.type="Multi"+a[0].type,i.coordinates=[],s!=0&&(i.crs=s),a.forEach(function(l){i.coordinates.push(l.coordinates)}),i}else return!1}var r={explode:n,implode:o};p.exports?p.exports=r:window&&(window.multigeojson=r)})()})(Lt);var ue=ie;function Y(p,e,t,n){var o=p.map(function(a){return[(a[0]-t.x)/e,(t.y-a[1])/e]}),r=o.map(function(a){return n?a[0].toFixed(n)+","+a[1].toFixed(n):a[0]+","+a[1]});return r.join(" ")}function Ae(p,e,t,n){var o=n&&n.r?n.r:1,r=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1,a=Y([p.coordinates],e,t,n.precision);return r?[a]:["M"+a+" m"+-o+",0 a"+o+","+o+" 0 1,1 "+2*o+","+0+" a"+o+","+o+" 0 1,1 "+-2*o+","+0]}function Ot(p,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,r=ue.explode(p).map(function(a){return Ae(a,e,t,n)[0]});return o?r:[r.join(" ")]}function Ie(p,e,t,n){var o=Y(p.coordinates,e,t,n.precision),r="M"+o;return[r]}function _t(p,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,r=ue.explode(p).map(function(a){return Ie(a,e,t,n)[0]});return o?r:[r.join(" ")]}function Ge(p,e,t,n){var o,r;o=Y(p.coordinates[0],e,t,n.precision),p.coordinates.length>1&&(r=p.coordinates.slice(1,p.coordinates.length));var a="M"+o;if(r)for(var c=0;c<r.length;c++)a+=" M"+Y(r[c],e,t,n.precision);return a+="Z",[a]}function At(p,e,t,n){var o=n.hasOwnProperty("explode")?n.explode:!1,r=ue.explode(p).map(function(a){return Ge(a,e,t,n)[0]});return o?r:[r.join(" ").replace(/Z/g,"")+"Z"]}var It={Point:Ae,MultiPoint:Ot,LineString:Ie,MultiLineString:_t,Polygon:Ge,MultiPolygon:At},pe=Tt,le=It,W=function(p){this.options=p||{},this.viewportSize=this.options.viewportSize||{width:256,height:256},this.mapExtent=this.options.mapExtent||{left:-20037508342789244e-9,right:20037508342789244e-9,bottom:-20037508342789244e-9,top:20037508342789244e-9},this.res=this.calResolution(this.mapExtent,this.viewportSize,this.options.fitTo)};W.prototype.calResolution=function(p,e,t){var n=(p.right-p.left)/e.width,o=(p.top-p.bottom)/e.height;if(t){if(t.toLowerCase()==="width")return n;if(t.toLowerCase()==="height")return o;throw new Error('"fitTo" option should be "width" or "height" ')}else return Math.max(n,o)};W.prototype.convert=function(p,e){var t=pe(this.options,e||{}),n=[];if(p.type=="FeatureCollection")for(var o=0;o<p.features.length;o++)n=n.concat(this.convertFeature(p.features[o],t));else if(p.type=="Feature")n=this.convertFeature(p,t);else if(p.type=="GeometryCollection")for(var o=0;o<p.geometries.length;o++)n=n.concat(this.convertGeometry(p.geometries[o],t));else if(le[p.type])n=this.convertGeometry(p,t);else return;return t.callback&&t.callback.call(this,n),n};W.prototype.convertFeature=function(p,e){if(!(!p&&!p.geometry)){var t=pe(this.options,e||{});if(t.attributes&&t.attributes instanceof Array){var n=t.attributes;t.attributes=n.reduce(function(r,a){if(typeof a=="string"){var c,s=a.split(".").pop();try{c=Se(p,a)}catch{c=!1}c&&(r[s]=c)}else if(typeof a=="object"&&a.type&&a.property)if(a.type==="dynamic"){var c,s=a.key?a.key:a.property.split(".").pop();try{c=Se(p,a.property)}catch{c=!1}c&&(r[s]=c)}else a.type==="static"&&a.value&&(r[a.property]=a.value);return r},{})}else t.attributes=t.attributes||{};var o=t.attributes.id||p.id||(p.properties&&p.properties.id?p.properties.id:null);return o&&(t.attributes.id=o),this.convertGeometry(p.geometry,t)}};W.prototype.convertGeometry=function(p,e){if(le[p.type]){var t=pe(this.options,e||{}),n=t.output||"svg",o=le[p.type].call(this,p,this.res,{x:this.mapExtent.left,y:this.mapExtent.top},t),r,a;return n.toLowerCase()=="svg"?(r=o.map(function(c){return Gt(c,p.type,t.attributes,t)}),a=r.map(function(c){return Pt(c,p.type,t)}),a):o}else return};function Gt(p,e,t,n){var o={},r=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1;(e=="Point"||e=="MultiPoint")&&r?(o.cx=p.split(",")[0],o.cy=p.split(",")[1],o.r=n&&n.r?n.r:"1"):(o={d:p},(e=="Polygon"||e=="MultiPolygon")&&o["fill-rule"]=="evenodd");for(var a in t)o[a]=t[a];return o}function Pt(p,e,t){var n=t&&t.hasOwnProperty("pointAsCircle")?t.pointAsCircle:!1,o="<path";(e=="Point"||e=="MultiPoint")&&n&&(o="<circle");for(var r in p)o+=" "+r+'="'+p[r]+'"';return o+="/>",o}function Se(p,e){function t(n,o,r,a){if(n.hasOwnProperty(o))return n[o];throw new Error(a.slice(0,r+1).join(".")+" is not a valid property path")}return e.split(".").reduce(t,p)}var Et=W,Ft=Et,Rt=function(p){return new Ft(p)},Ut=Rt;class U extends O{constructor(e){const t=x.t.general.download,n=e.layoutToUse.id,o=new ut([t.includeMetaData]),r=o.GetValue().map(i=>i.length>0),a=new E(b.floppy_ui(),new y([t.downloadGeojson.SetClass("font-bold"),t.downloadGeoJsonHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const i=U.getCleanGeoJson(e,r.data);A.offerContentsAsDownloadableFile(JSON.stringify(i,null,"  "),`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.geojson`,{mimetype:"application/vnd.geo+json"})}),c=new E(b.floppy_ui(),new y([t.downloadCSV.SetClass("font-bold"),t.downloadCSVHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const i=U.getCleanGeoJson(e,r.data),l=de.toCSV(i.features);A.offerContentsAsDownloadableFile(l,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.csv`,{mimetype:"text/csv"})}),s=new E(b.floppy_ui(),new y([t.downloadAsSvg.SetClass("font-bold"),t.downloadAsSvgHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const i=U.getCleanGeoJsonPerLayer(e,r.data),l=document.getElementById("leafletDiv"),u=U.asSvg(i,{layers:e.filteredLayers.data.map(m=>m.layerDef),mapExtent:e.currentBounds.data,width:l.offsetWidth,height:l.offsetHeight});A.offerContentsAsDownloadableFile(u,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.svg`,{mimetype:"image/svg+xml"})}),d=new y([new G(t.title),a,c,s,o,t.licenseInfo.SetClass("link-underline")]).SetClass("w-full flex flex-col border-4 border-gray-300 rounded-3xl p-4");super(d,t.noDataLoaded,e.featurePipeline.somethingLoaded)}static asSvg(e,t){var d,i,l;t=t??{};const n=t.width??1e3,o=t.height??1e3,r=t.unit??"px",a={left:-180,bottom:-90,right:180,top:90};if(t.mapExtent!==void 0){const u=t.mapExtent;a.left=u.minLon,a.right=u.maxLon,a.bottom=u.minLat,a.top=u.maxLat}const c=[];for(const u of Array.from(e.keys())){const m=e.get(u);if(m.length===0)continue;const S=(d=t==null?void 0:t.layers)==null?void 0:d.find(M=>M.id===u),C=S==null?void 0:S.lineRendering[0],_=Ut({viewportSize:{width:n,height:o},mapExtent:a,output:"svg",attributes:[{property:"style",type:"static",value:"fill:none;stroke-width:1"},{property:"properties.stroke",type:"dynamic",key:"stroke"}]});for(const M of m){const g=((l=(i=C==null?void 0:C.color)==null?void 0:i.GetRenderValue(M.properties))==null?void 0:l.txt)??"#ff0000",v=A.colorAsHex(A.color(g));M.properties.stroke=v}const k=_.convert({type:"FeatureCollection",features:m}),D=`    <g id="${u}" inkscape:groupmode="layer" inkscape:label="${u}">
`+k.map(M=>"        "+M).join(`
`)+`
    </g>`;c.push(D)}return`<svg width="${n}${r}" height="${o}${r}" viewBox="0 0 ${n} ${o}">`+`
`+c.join(`
`)+`
</svg>`}static getCleanGeoJson(e,t){const n=U.getCleanGeoJsonPerLayer(e,t);return{type:"FeatureCollection",features:[].concat(...Array.from(n.values()))}}static getCleanGeoJsonPerLayer(e,t){const n=new Map,o=e.filteredLayers.data.map(c=>c.layerDef.id),r=e.currentBounds.data,a=e.featurePipeline.GetAllFeaturesAndMetaWithin(r,new Set(o));for(const c of a){if(H.priviliged_layers.indexOf(c.layer)>=0)continue;const s=e.filteredLayers.data.find(l=>l.layerDef.id===c.layer);n.has(c.layer)||n.set(c.layer,[]);const d=n.get(c.layer),i=s.appliedFilters.data;e:for(const l of c.features){if(!r.overlapsWith(ee.get(l)))continue;if(i!==void 0)for(let S of Array.from(i.keys())){const C=i.get(S);if((C==null?void 0:C.currentFilter)!==void 0&&!C.currentFilter.matchesProperties(l.properties))continue e}const u={type:l.type,geometry:{...l.geometry},properties:{...l.properties}};if(!t)for(const S in u.properties)S==="_lon"||S==="_lat"||S.startsWith("_")&&delete l.properties[S];const m=[].concat(tt.metatags.filter(S=>S.includesDates).map(S=>S.keys));for(const S of m)delete l.properties[S];d.push(u)}}return n}}class Ht{constructor(e){L(this,"isRunning",new T(!0));L(this,"mapW",297);L(this,"mapH",210);L(this,"scaling",2);L(this,"freeDivId");L(this,"_layout");L(this,"_screenhotTaken",!1);this.freeDivId=e.freeDivId,this._layout=e.layout;const t=this,n=e.location.data,o={lat:n.lat,lon:n.lon,zoom:n.zoom+1},r=nt.createMiniMap({location:new T(o),background:e.background,allowMoving:!1,onFullyLoaded:a=>window.setTimeout(()=>{if(!t._screenhotTaken)try{t.CreatePdf(r).then(()=>t.cleanup()).catch(()=>t.cleanup())}catch(c){console.error(c),t.cleanup()}},500)});r.SetStyle(`width: ${this.mapW*this.scaling}mm; height: ${this.mapH*this.scaling}mm;`),r.AttachTo(e.freeDivId),r.leafletMap.addCallbackAndRunD(a=>{const c=ee.fromLeafletBounds(a.getBounds().pad(.2));e.features.GetTilesPerLayerWithin(c,s=>{s.layer.layerDef.minzoom>n.zoom||s.layer.layerDef.id.startsWith("note_import")||new Q({features:s,leafletMap:r.leafletMap,layerToShow:s.layer.layerDef,doShowLayer:s.layer.isDisplayed,state:void 0})})}),Z.state.AddAllOverlaysToMap(r.leafletMap)}cleanup(){new P("Screenshot taken!").AttachTo(this.freeDivId),this._screenhotTaken=!0}async CreatePdf(e){console.log("PDF creation started");const t=x.t.general.pdf,n=this._layout;let o=new ct("landscape");const r=await e.TakeScreenshot();o.addImage(r,"PNG",0,0,this.mapW,this.mapH),o.setDrawColor(255,255,255),o.setFillColor(255,255,255),o.roundedRect(12,10,145,25,5,5,"FD"),o.setFontSize(20),o.textWithLink(n.title.txt,40,18.5,{maxWidth:125,url:window.location.href}),o.setFontSize(10),o.text(t.generatedWith.txt,40,23,{maxWidth:125});const a=Z.state.backgroundLayer.data,c=new P(a.layer().getAttribution()??a.name).ConstructElement().textContent;o.textWithLink(t.attr.txt,40,26.5,{maxWidth:125,url:"https://www.openstreetmap.org/copyright"}),o.text(t.attrBackground.Subs({background:c}).txt,40,30);let s=new Date().toISOString().substr(0,16);o.setFontSize(7),o.text(t.versionInfo.Subs({version:H.vNumber,date:s}).txt,40,34,{maxWidth:125});let d=document.createElement("img");const i=n.icon,l=i.substring(i.lastIndexOf(".")+1);if(d.src=i,l.toLowerCase()==="svg"){new P("").AttachTo(this.freeDivId);const u=document.createElement("canvas"),m=u.getContext("2d");u.width=500,u.height=500,d.style.width="100%",d.style.height="100%",m.drawImage(d,0,0,500,500);const S=u.toDataURL("image/png");o.addImage(S,"png",15,12,20,20)}else try{o.addImage(d,l,15,12,20,20)}catch(u){console.error(u)}o.save(`MapComplete_${n.title.txt}_${s}.pdf`),this.isRunning.setData(!1)}}class X extends R{constructor(e,t){super(X.GenTitle,()=>X.GeneratePanel(t),"downloads",e)}static GenTitle(){return x.t.general.download.title.Clone().SetClass("text-2xl break-words font-bold p-2")}static GeneratePanel(e){const t=new T(!1,"Pdf-is-exporting"),n=()=>{t.setData(!0),new Ht({freeDivId:"belowmap",background:e.backgroundLayer,location:e.locationControl,features:e.featurePipeline,layout:e.layoutToUse}).isRunning.addCallbackAndRun(i=>t.setData(i))},o=b.loading_svg().SetClass("animate-rotate"),r=x.t.general.download,a=new O(o,b.floppy_ui(),t),c=new O(r.exporting.Clone(),new y([r.downloadAsPdf.Clone().SetClass("font-bold"),r.downloadAsPdfHelper.Clone()]).SetClass("flex flex-col").onClick(()=>{n()}),t),s=new O(new E(a,c),void 0,e.featureSwitchExportAsPdf),d=new O(new U(e),void 0,e.featureSwitchEnableExport);return new y([s,d]).SetClass("flex flex-col")}}class Bt extends y{constructor(e,t){var i,l;const n=(i=e.currentView)==null?void 0:i.layer,o=new O(new q(()=>{const u=e.currentView.features.map(S=>{var C;return(C=S[0])==null?void 0:C.feature}),m=new I(u.map(S=>{var D;const C=b.checkbox_empty_svg();if(S===void 0)return C;const _={...S.properties,button:"yes"},k=(D=n.layerDef.mapRendering[0])==null?void 0:D.GetSimpleIcon(new T(_));return k===void 0?C:k})).SetClass("inline-block w-full h-full");return u.map(S=>{if(S===void 0)return;const C=e.allElements.getEventSourceById(S.properties.id);return new te(C,n.layerDef,e,{hashToShow:"currentview",isShown:t.currentViewControlIsOpened})}),new F(m)}).onClick(()=>{t.currentViewControlIsOpened.setData(!0)}),void 0,new T(n!==void 0&&((l=n==null?void 0:n.layerDef)==null?void 0:l.tagRenderings)!==null));new X(t.downloadControlIsOpened,e);const r=new F(b.download_svg()).onClick(()=>t.downloadControlIsOpened.setData(!0)),a=new O(r,void 0,e.featureSwitchEnableExport.map(u=>u||e.featureSwitchExportAsPdf.data,[e.featureSwitchExportAsPdf]));new R(()=>x.t.general.layerSelection.title.Clone(),()=>new Te(e.filteredLayers,e.overlayToggles,e).SetClass("block p-1"),"filters",t.filterViewIsOpened);const c=new F(b.layers_svg()).onClick(()=>t.filterViewIsOpened.setData(!0));e.featureSwitchFilter.addCallbackAndRun(u=>{$.RegisterHotkey({nomod:"B"},x.t.hotkeyDocumentation.openLayersPanel,()=>{t.filterViewIsOpened.setData(!t.filterViewIsOpened.data)})});const s=new O(c,void 0,e.featureSwitchFilter),d=new O(new ot(e,e.backgroundLayer,{enableHotkeys:!0}),void 0,e.featureSwitchBackgroundSelection);super([o,s,a,d]),this.SetClass("flex flex-col")}}class fe extends I{constructor(t,n){const o=(n==null?void 0:n.value)??new T("0");super(t.map(r=>{const a=Object.keys(r);return a.sort((c,s)=>{const d=Number(c),i=Number(s);return isNaN(d)||isNaN(i)?c<s?-1:1:d-i}),fe.constructPicker(a,o)}));L(this,"_value");this._value=o}static constructPicker(t,n){let o=new pt(0,t.length-1,{vertical:!0});const r="flex border-2 border-blue-500 w-10 h-10 place-content-center items-center border-box";o.SetClass("flex elevator w-10").SetStyle(`height: ${2.5*t.length}rem; background: #00000000`);const a=t.map((s,d)=>new Ye(new P(s).SetClass("font-bold active bg-subtle "+r),new P(s).SetClass("normal-background "+r),o.GetValue().sync(i=>i===d,[],i=>i?d:o.GetValue().data)).ToggleOnClick().SetClass("flex w-10 h-10"));a.reverse();const c=new y([new y(a),o]);return c.SetClass("flex flex-row overflow-hidden"),o.GetValue().addCallbackD(s=>{t!==void 0&&t[s]!=null&&n.setData(t[s])}),n.addCallbackAndRunD(s=>{const d=t.findIndex(i=>i===s);o.GetValue().setData(d)}),c}GetValue(){return this._value}IsValid(t){return!1}}class Nt extends y{constructor(e){const t=e.currentBounds.map(a=>{if(a===void 0)return{};const d=[].concat(...e.featurePipeline.GetAllFeaturesAndMetaWithin(a).map(l=>l.features)).filter(l=>ee.get(l).overlapsWith(a)).map(l=>l.properties.level),i={0:0};for(const l of d){l===void 0&&i[0]++;for(const u of De.LevelsParser(l))i[u]=(i[u]??0)+1}return i}),n=new fe(t);e.globalFilters.data.push({filter:{currentFilter:void 0,state:void 0},id:"level",onNewPoint:void 0});const o=t.map(a=>!(e.locationControl.data.zoom<=16||Object.keys(a).length==1),[e.locationControl]);function r(){console.log("Updating levels filter to ",n.GetValue().data," is shown:",o.data);const a=e.globalFilters.data.find(i=>i.id==="level");if(!o.data){a.filter={state:"*",currentFilter:void 0},a.onNewPoint=void 0,e.globalFilters.ping();return}const c=n.GetValue().data;if(c===void 0)return;let s=new at("level",new RegExp("(^|;)"+c+"(;|$)"));c==="0"&&(s=new rt([s,new we("level","")])),a.filter={state:c,currentFilter:s};const d=x.t.general.levelSelection;a.onNewPoint={confirmAddNew:d.confirmLevel.PartialSubs({level:c}),safetyCheck:d.addNewOnLevel.Subs({level:c}),tags:[new we("level",c)]},e.globalFilters.ping()}o.addCallbackAndRun(a=>{console.log("Is level selector shown?",a),r(),a?n.RemoveClass("invisible"):n.SetClass("invisible")}),t.addCallbackAndRun(a=>{if(!o.data)return;const c=n.GetValue();if(!(a[c.data]===void 0||a[c.data]===0))return;let s=0,d;for(const i in a){const l=a[i];(d===void 0||s<l)&&(d=i,s=l)}console.log("Force switching to a different level:",d,"as it has",s,"elements on that floor",a,"(old level: "+c.data+")"),c.setData(d)}),n.GetValue().addCallback(a=>r()),super([n])}}class jt extends I{constructor(e,t){var s;const n=new T(void 0);n.addCallbackD(d=>{e.geolocationState.requestMoment.setData(d)});const o=n.map(d=>d===void 0?!1:(new Date().getTime()-d.getTime())/1e3<=3),r=e.geolocationState.requestMoment.map(d=>{if(d===void 0)return!1;const i=(new Date().getTime()-d.getTime())/1e3;return console.log("Timediff",i),i<=H.zoomToLocationTimeout}),a=e==null?void 0:e.geolocationState;super((s=a==null?void 0:a.permission)==null?void 0:s.map(d=>d==="denied"?b.location_refused_svg():a.isLocked.data?b.location_locked_svg():a.currentGPSLocation.data===void 0?d==="prompt"?b.location_empty_svg():(!e.mapHasMoved.data||r.data?b.location_svg():b.location_empty_svg()).SetClass("cursor-wait").SetStyle("animation: spin 4s linear infinite;"):o.data?b.location_unlocked_svg():b.location_svg(),[a.currentGPSLocation,a.isLocked,e.mapHasMoved,o,r]));async function c(){if(a.permission.data!=="granted"&&a.currentGPSLocation.data===void 0&&(n.setData(new Date),a.requestMoment.setData(new Date),await a.requestPermission()),a.isLocked.data===!0){a.isLocked.setData(!1);return}if(a.currentGPSLocation.data===void 0){n.setData(new Date);return}const d=a.currentGPSLocation.data,i=t.currentBounds.data.contains([d.longitude,d.latitude]);if(e.MoveMapToCurrentLocation(),i){const l=t.locationControl.data;t.locationControl.setData({...l,zoom:l.zoom+3})}if(o.data){a.isLocked.setData(!0),n.setData(void 0);return}n.setData(new Date)}this.onClick(c),$.RegisterHotkey({nomod:"L"},x.t.hotkeyDocumentation.geolocate,c),n.addCallbackAndRunD(d=>{window.setTimeout(()=>{o.data&&n.ping()},500)}),e.geolocationState.requestMoment.addCallbackAndRunD(d=>{window.setTimeout(()=>{r.data&&e.geolocationState.requestMoment.ping()},500)})}}class Vt extends y{constructor(e,t){const n=O.If(e.featureSwitchGeolocation,()=>new F(new jt(t,e),{dontStyle:!0}).SetClass("p-1")),o=new F(b.plus_svg()).onClick(()=>{e.locationControl.data.zoom++,e.locationControl.ping()}),r=new F(b.min_svg()).onClick(()=>{e.locationControl.data.zoom--,e.locationControl.ping()}),a=new Nt(e);super([a,o,r,n].map(c=>c.SetClass("m-0.5 md:m-1"))),this.SetClass("flex flex-col items-center")}}class $t extends I{constructor(e){const t=e.featurePipeline,n=x.t.centerMessage,o=t.runningQuery.map(r=>r?{el:new Xe(n.loadingData)}:t.sufficientlyZoomed.data?t.timeout.data>0?{el:n.retrying.Subs({count:""+t.timeout.data})}:{el:n.ready,isDone:!0}:{el:n.zoomIn},[t.timeout,t.sufficientlyZoomed,e.locationControl]);super(o.map(r=>r.el)),this.SetClass("flex justify-center rounded-3xl bg-white text-xl font-bold pointer-events-none p-4"),this.SetStyle("transition: opacity 750ms linear"),o.addCallbackAndRun(r=>{r.isDone??!1?this.SetStyle("transition: opacity 750ms linear; opacity: 0"):this.SetStyle("transition: opacity 750ms linear; opacity: 0.75")})}}const Wt="home_location",zt="Meta layer showing the home location of the user. The home location can be set in the [profile settings](https://www.openstreetmap.org/profile/edit) of OpenStreetMap.",qt=0,Jt={osmTags:"user:home=yes",maxCacheAge:0},Zt=[{icon:{render:"circle:white;./assets/svg/home.svg"},iconSize:{render:"20,20,center"},location:["point","centroid"]}],Pe={id:Wt,description:zt,minzoom:qt,source:Jt,mapRendering:Zt};class Kt extends O{constructor(e,t,n){var i;const o=x.t.notes,r=new T(!1);n.LastClickLocation.addCallbackAndRun(l=>r.setData(!1));const a=st.ForType("text").ConstructInputElement({value:ke.Get("note-text")});a.SetClass("border rounded-sm border-grey-500");const c=new E(b.addSmall_svg().SetClass("max-h-7"),o.createNote);c.OnClickWithLoading(o.creating,async()=>{var C,_,k,D,M,g,v,f,w,h;let l=a.GetValue().data;if(l===void 0||l==="")return;l+=`

 #MapComplete #`+((C=n==null?void 0:n.layoutToUse)==null?void 0:C.id);const u=n.LastClickLocation.data,m=await((_=n==null?void 0:n.osmConnection)==null?void 0:_.openNote(u.lat,u.lon,l)),S={type:"Feature",geometry:{type:"Point",coordinates:[u.lon,u.lat]},properties:{id:""+m.id,date_created:new Date().toISOString(),_first_comment:l,comments:JSON.stringify([{text:l,html:l,user:(M=(D=(k=n.osmConnection)==null?void 0:k.userDetails)==null?void 0:D.data)==null?void 0:M.name,uid:(f=(v=(g=n.osmConnection)==null?void 0:g.userDetails)==null?void 0:v.data)==null?void 0:f.uid}])}};(w=n==null?void 0:n.featurePipeline)==null||w.InjectNewPoint(S),(h=n.selectedElement)==null||h.setData(S),ne.hash.setData(S.properties.id),a.GetValue().setData(""),r.setData(!0)});const s=new y([new G(o.createNoteTitle),o.createNoteIntro,a,new y([new O(void 0,o.warnAnonymous.SetClass("block alert"),(i=n==null?void 0:n.osmConnection)==null?void 0:i.isLoggedIn),new O(c,o.textNeeded.SetClass("block alert"),a.GetValue().map(l=>(l==null?void 0:l.length)>3))]).SetClass("flex justify-end items-center")]).SetClass("flex flex-col border-2 border-black rounded-xl p-4"),d=new O(new O(o.isCreated.SetClass("thanks"),s,r),void 0,new T(!0));super(new O(new y([o.noteLayerHasFilters.SetClass("alert"),new E(b.filter_svg(),o.disableAllNoteFilters).onClick(()=>{const l=e.appliedFilters.data;for(const u of Array.from(l.keys()))l.set(u,void 0);e.appliedFilters.ping(),t.setData(!1)})]).SetClass("flex flex-col"),d,e.appliedFilters.map(l=>(console.log("Applied filters for notes are: ",l),Array.from(l.values()).some(u=>(u==null?void 0:u.currentFilter)!==void 0)))),new y([o.noteLayerNotEnabled.SetClass("alert"),new E(b.layers_svg(),o.noteLayerDoEnable).onClick(()=>{e.isDisplayed.setData(!0),t.setData(!1)})]).SetClass("flex flex-col"),e.isDisplayed)}}class Qt extends y{constructor(e){const t=new I(e.map(o=>{const r=[];let a;for(const s of o){const d=s.layerDef;if(!(d.name===void 0&&!s.isDisplayed.data))for(const i of s.layerDef.presets){const l=De.KVtoProperties(i.tags),u=d.mapRendering[0].GenerateLeafletStyle(new T(l),!1,{noSize:!0}).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;");r.push(u),a===void 0&&(a=d.mapRendering[0].GenerateLeafletStyle(new T(l),!1,{noSize:!0}).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;"))}}if(r.length===0)return;if(r.length===1)return r[0];r.push(a);const c=new y(r).SetClass("flex");return c.SetClass("slide min-w-min").SetStyle("animation: slide "+r.length+"s linear infinite;"),c})),n=x.t.general.add.addNewMapLabel.Clone().SetClass("block center absolute text-sm min-w-min pl-1 pr-1 bg-gray-400 rounded-3xl text-white opacity-65 whitespace-nowrap").SetStyle("top: 65px; transform: translateX(-50%)");super([new y([b.add_pin_svg().SetClass("absolute").SetStyle("width: 50px; filter: drop-shadow(grey 0 0 10px"),new y([t]).SetStyle("width: 50px").SetClass("absolute p-1 rounded-full overflow-hidden"),b.addSmall_svg().SetClass("absolute animate-pulse").SetStyle("width: 30px; left: 30px; top: 35px;")]).SetClass("absolute"),new y([n]).SetStyle("position: absolute; left: 50%")]),this.SetClass("block relative")}}class ve extends et{constructor(t,n){super();L(this,"_config");L(this,"state");this.state=t,this._config=n}InnerRender(){var i,l,u,m,S;if(this._config===void 0)return;const t=this._config,n=window!==window.top;if((i=t.requirements)!=null&&i.has("iframe")&&!n||(l=t.requirements)!=null&&l.has("no-iframe")&&n)return;let o;const r=((u=this.state.layoutToUse)==null?void 0:u.id)??"",a=window.location.host,c=this.state.locationControl.map(C=>{const _={...C,theme:r,basepath:a,language:Be.language.data};return A.SubstituteKeys(t.href,_)});let s=b.pop_out_ui();t.icon!==void 0&&(s=new ce(t.icon).SetClass("h-6"));let d;return t.text===void 0?d=x.t.general.screenToSmall.Subs({theme:this.state.layoutToUse.title}):d=t.text.Clone(),o=new E(s,d,{url:c,newTab:t.newTab}),(m=t.requirements)!=null&&m.has("no-welcome-message")&&(o=new O(void 0,o,this.state.featureSwitchWelcomeMessage)),(S=t.requirements)!=null&&S.has("welcome-message")&&(o=new O(o,void 0,this.state.featureSwitchWelcomeMessage)),o}}class Yt{constructor(e,t){L(this,"geolocationState");L(this,"_state");L(this,"mapHasMoved",new T(!1));this.geolocationState=e,this._state=t;const n=t.locationControl;let o=this,r=new Date;n.addCallbackD(c=>{if(!(new Date().getTime()-r.getTime()<250))return o.mapHasMoved.setData(!0),!0}),(K.wasInitialized("lat")||K.wasInitialized("lon"))&&this.mapHasMoved.setData(!0),this.geolocationState.currentGPSLocation.addCallbackAndRunD(c=>{var d;const s=(new Date().getTime()-((d=e.requestMoment.data)==null?void 0:d.getTime()))/1e3;if(this.mapHasMoved.data||o.MoveMapToCurrentLocation(),s<H.zoomToLocationTimeout&&o.MoveMapToCurrentLocation(),this.geolocationState.isLocked.data){o.MoveMapToCurrentLocation();return}}),e.isLocked.map(c=>{var s,d,i,l,u,m;c?(i=(d=(s=t.leafletMap)==null?void 0:s.data)==null?void 0:d.dragging)==null||i.disable():(m=(u=(l=t.leafletMap)==null?void 0:l.data)==null?void 0:u.dragging)==null||m.enable()},[t.leafletMap]),this.CopyGeolocationIntoMapstate()}MoveMapToCurrentLocation(){const e=this.geolocationState.currentGPSLocation.data,t=this._state.locationControl,n=this._state;if(n.selectedElement.data!==void 0)return;if(e.latitude===0&&e.longitude===0){console.debug("Not moving to GPS-location: it is null island");return}const o=n.layoutToUse.lockLocation;o&&o!==!0&&!new ee(o).contains([e.longitude,e.latitude])||(t.setData({zoom:Math.max(t.data.zoom,16),lon:e.longitude,lat:e.latitude}),this.mapHasMoved.setData(!0),this.geolocationState.requestMoment.setData(void 0))}CopyGeolocationIntoMapstate(){const e=this._state,t=["speed","accuracy","altitude","altitudeAccuracy","heading"];this.geolocationState.currentGPSLocation.addCallbackAndRun(n=>{var r,a;if(n===void 0)return;const o={type:"Feature",properties:{id:"gps","user:location":"yes",date:new Date().toISOString(),...n},geometry:{type:"Point",coordinates:[n.longitude,n.latitude]}};for(const c of t)n[c]!==null&&(o.properties[c]=n[c]);(a=(r=e.currentUserLocation)==null?void 0:r.features)==null||a.setData([{feature:o,freshness:new Date}])})}}class Xt{constructor(){L(this,"permission",new T("prompt"));L(this,"requestMoment",new T(void 0));L(this,"isLocked",new T(!1));L(this,"currentGPSLocation",new T(void 0));L(this,"_previousLocationGrant",ke.Get("geolocation-permissions"));L(this,"_grantedThisSession",new T(!1));const e=this;this.permission.addCallbackAndRunD(async t=>{t==="granted"&&(e._previousLocationGrant.setData("true"),e._grantedThisSession.setData(!0)),t==="prompt"&&e._grantedThisSession.data&&(e._previousLocationGrant.setData("false"),e.permission.setData("denied"),e.currentGPSLocation.setData(void 0),console.warn("Detected a downgrade in permissions!")),t==="denied"&&e._previousLocationGrant.setData("false")}),console.log("Previous location grant:",this._previousLocationGrant.data),this._previousLocationGrant.data==="true"&&(this._previousLocationGrant.setData("false"),console.log("Requesting access to GPS as this was previously granted"),K.wasInitialized("lat")||K.wasInitialized("lon")||this.requestMoment.setData(new Date),this.requestPermission()),window.geolocation_state=this}async startWatching(){const e=this;navigator.geolocation.watchPosition(function(t){e.currentGPSLocation.setData(t.coords),e._previousLocationGrant.setData("true")},function(){console.warn("Could not get location with navigator.geolocation")},{enableHighAccuracy:!0})}requestPermission(){var e;if(typeof navigator>"u"){this.permission.setData("denied");return}if(!(this.permission.data!=="prompt"&&this.permission.data!=="requested")){this.permission.setData("requested");try{(e=navigator==null?void 0:navigator.permissions)==null||e.query({name:"geolocation"}).then(t=>{console.log("Status update: received geolocation permission is ",t.state),this.permission.setData(t.state);const n=this;t.onchange=function(){n.permission.setData(t.state)},this.permission.setData("requested"),n.startWatching()}).catch(t=>console.error("Could not get geopermission",t))}catch(t){console.error("Could not get permission:",t)}}}}const en={id:"OSMF",type:"osm-lc",locationSet:{include:["001"]},languageCodes:["en","fr","it","ja","nl","ru"],order:10,strings:{name:"OpenStreetMap Foundation",description:"OSMF is a UK-based not-for-profit that supports the OpenStreetMap Project",extendedDescription:"OSMF supports the OpenStreetMap project by fundraising, maintaining the servers which power OSM, organizing the annual State of the Map conference, and coordinating the volunteers who keep OSM running. You can show your support and have a voice in the direction of OpenStreetMap by joining as an OSMF member here: {signupUrl}",signupUrl:"https://join.osmfoundation.org/",url:"https://wiki.osmfoundation.org/wiki/Main_Page"},contacts:[{name:"OSMF Board",email:"board@osmfoundation.org"}],resolved:{name:"OpenStreetMap Foundation",url:"https://wiki.osmfoundation.org/wiki/Main_Page",signupUrl:"https://join.osmfoundation.org/",description:"OSMF is a UK-based not-for-profit that supports the OpenStreetMap Project",extendedDescription:"OSMF supports the OpenStreetMap project by fundraising, maintaining the servers which power OSM, organizing the annual State of the Map conference, and coordinating the volunteers who keep OSM running. You can show your support and have a voice in the direction of OpenStreetMap by joining as an OSMF member here: https://join.osmfoundation.org/",nameHTML:'<a target="_blank" href="https://wiki.osmfoundation.org/wiki/Main_Page">OpenStreetMap Foundation</a>',urlHTML:'<a target="_blank" href="https://wiki.osmfoundation.org/wiki/Main_Page">https://wiki.osmfoundation.org/wiki/Main_Page</a>',signupUrlHTML:'<a target="_blank" href="https://join.osmfoundation.org/">https://join.osmfoundation.org/</a>',descriptionHTML:"OSMF is a UK-based not-for-profit that supports the OpenStreetMap Project",extendedDescriptionHTML:'OSMF supports the OpenStreetMap project by fundraising, maintaining the servers which power OSM, organizing the annual State of the Map conference, and coordinating the volunteers who keep OSM running. You can show your support and have a voice in the direction of OpenStreetMap by joining as an OSMF member here: <a target="_blank" href="https://join.osmfoundation.org/">https://join.osmfoundation.org/</a>'}},tn={"OSM-Discord":{id:"OSM-Discord",type:"discord",account:"openstreetmap",locationSet:{include:["001"]},languageCodes:["de","en","es","fr","it","pt-BR","ro","tr"],order:6,strings:{name:"OpenStreetMap World Discord"},contacts:[{name:"Austin Harrison",email:"jaustinharrison@gmail.com"}],resolved:{name:"OpenStreetMap World Discord",url:"https://discord.gg/openstreetmap",description:"Get in touch with other mappers on Discord",nameHTML:'<a target="_blank" href="https://discord.gg/openstreetmap">OpenStreetMap World Discord</a>',urlHTML:'<a target="_blank" href="https://discord.gg/openstreetmap">https://discord.gg/openstreetmap</a>',descriptionHTML:"Get in touch with other mappers on Discord"}},"OSM-Discourse":{id:"OSM-Discourse",type:"discourse",locationSet:{include:["001"]},languageCodes:["de","en","es","nl","pl","pt-BR"],order:7,strings:{name:"OpenStreetMap Discourse",description:"A shared place for conversations about OpenStreetMap",url:"https://community.openstreetmap.org/"},contacts:[{name:"Grant Slater",email:"osmfuture@firefishy.com"},{name:"Rubén Martín",email:"nukeador@protonmail.com"}],resolved:{name:"OpenStreetMap Discourse",url:"https://community.openstreetmap.org/",description:"A shared place for conversations about OpenStreetMap",nameHTML:'<a target="_blank" href="https://community.openstreetmap.org/">OpenStreetMap Discourse</a>',urlHTML:'<a target="_blank" href="https://community.openstreetmap.org/">https://community.openstreetmap.org/</a>',descriptionHTML:"A shared place for conversations about OpenStreetMap"}},"OSM-Facebook":{id:"OSM-Facebook",type:"facebook",account:"OpenStreetMap",locationSet:{include:["001"]},languageCodes:["en"],order:3,strings:{community:"OpenStreetMap",communityID:"openstreetmap",description:"Like us on Facebook for news and updates about OpenStreetMap."},contacts:[{name:"Harry Wood",email:"mail@harrywood.co.uk"}],resolved:{name:"OpenStreetMap on Facebook",url:"https://www.facebook.com/OpenStreetMap",description:"Like us on Facebook for news and updates about OpenStreetMap.",nameHTML:'<a target="_blank" href="https://www.facebook.com/OpenStreetMap">OpenStreetMap on Facebook</a>',urlHTML:'<a target="_blank" href="https://www.facebook.com/OpenStreetMap">https://www.facebook.com/OpenStreetMap</a>',descriptionHTML:"Like us on Facebook for news and updates about OpenStreetMap."}},"OSM-help":{id:"OSM-help",type:"forum",locationSet:{include:["001"]},languageCodes:["en"],order:-2,strings:{name:"OpenStreetMap Help",description:"Ask a question and get answers on OSM's community-driven question and answer site.",extendedDescription:"{url} is for everyone who needs help with OpenStreetMap.  Whether you are a beginner mapper or have a technical question, we're here to help!",url:"https://help.openstreetmap.org/"},contacts:[{name:"OSMF Operations",email:"operations@osmfoundation.org"}],resolved:{name:"OpenStreetMap Help",url:"https://help.openstreetmap.org/",description:"Ask a question and get answers on OSM's community-driven question and answer site.",extendedDescription:"https://help.openstreetmap.org/ is for everyone who needs help with OpenStreetMap.  Whether you are a beginner mapper or have a technical question, we're here to help!",nameHTML:'<a target="_blank" href="https://help.openstreetmap.org/">OpenStreetMap Help</a>',urlHTML:'<a target="_blank" href="https://help.openstreetmap.org/">https://help.openstreetmap.org/</a>',descriptionHTML:"Ask a question and get answers on OSM's community-driven question and answer site.",extendedDescriptionHTML:`<a target="_blank" href="https://help.openstreetmap.org/">https://help.openstreetmap.org/</a> is for everyone who needs help with OpenStreetMap.  Whether you are a beginner mapper or have a technical question, we're here to help!`}},"OSM-IRC":{id:"OSM-IRC",type:"irc",account:"osm",locationSet:{include:["001"]},languageCodes:["en"],order:-4,strings:{community:"OpenStreetMap",communityID:"openstreetmap"},contacts:[{name:"Harry Wood",email:"mail@harrywood.co.uk"}],resolved:{name:"OpenStreetMap on IRC",url:"https://webchat.oftc.net/?channels=osm",description:"Join #osm on irc.oftc.net (port 6667)",nameHTML:'<a target="_blank" href="https://webchat.oftc.net/?channels=osm">OpenStreetMap on IRC</a>',urlHTML:'<a target="_blank" href="https://webchat.oftc.net/?channels=osm">https://webchat.oftc.net/?channels=osm</a>',descriptionHTML:"Join #osm on irc.oftc.net (port 6667)"}},"OSM-Mastodon":{id:"OSM-Mastodon",type:"mastodon",account:"openstreetmap",locationSet:{include:["001"]},languageCodes:["en"],order:3,strings:{community:"OpenStreetMap",communityID:"openstreetmap",url:"https://en.osm.town/@openstreetmap"},contacts:[{name:"Harry Wood",email:"mail@harrywood.co.uk"}],resolved:{name:"OpenStreetMap Mastodon Account",url:"https://en.osm.town/@openstreetmap",description:"The official Mastodon account for OpenStreetMap",nameHTML:'<a target="_blank" href="https://en.osm.town/@openstreetmap">OpenStreetMap Mastodon Account</a>',urlHTML:'<a target="_blank" href="https://en.osm.town/@openstreetmap">https://en.osm.town/@openstreetmap</a>',descriptionHTML:"The official Mastodon account for OpenStreetMap"}},"OSM-Reddit":{id:"OSM-Reddit",type:"reddit",account:"openstreetmap",locationSet:{include:["001"]},languageCodes:["en"],order:2,strings:{community:"OpenStreetMap",communityID:"openstreetmap",description:"/r/{account} is a great place to learn more about OpenStreetMap.  Ask us anything!"},contacts:[{name:"Serge Wroclawski",email:"emacsen@gmail.com"}],resolved:{name:"OpenStreetMap on Reddit",url:"https://www.reddit.com/r/openstreetmap",description:"/r/openstreetmap is a great place to learn more about OpenStreetMap.  Ask us anything!",nameHTML:'<a target="_blank" href="https://www.reddit.com/r/openstreetmap">OpenStreetMap on Reddit</a>',urlHTML:'<a target="_blank" href="https://www.reddit.com/r/openstreetmap">https://www.reddit.com/r/openstreetmap</a>',descriptionHTML:'<a target="_blank" href="https://www.reddit.com/r/openstreetmap">/r/openstreetmap</a> is a great place to learn more about OpenStreetMap.  Ask us anything!'}},"OSM-Telegram":{id:"OSM-Telegram",type:"telegram",account:"OpenStreetMapOrg",locationSet:{include:["001"]},languageCodes:["en"],order:5,strings:{community:"OpenStreetMap",communityID:"openstreetmap",description:"Join the OpenStreetMap Telegram global supergroup at {url}"},contacts:[{name:"Max N",email:"abonnements@revolwear.com"}],resolved:{name:"OpenStreetMap Telegram",url:"https://t.me/OpenStreetMapOrg",description:"Join the OpenStreetMap Telegram global supergroup at https://t.me/OpenStreetMapOrg",nameHTML:'<a target="_blank" href="https://t.me/OpenStreetMapOrg">OpenStreetMap Telegram</a>',urlHTML:'<a target="_blank" href="https://t.me/OpenStreetMapOrg">https://t.me/OpenStreetMapOrg</a>',descriptionHTML:'Join the OpenStreetMap Telegram global supergroup at <a target="_blank" href="https://t.me/OpenStreetMapOrg">https://t.me/OpenStreetMapOrg</a>'}},"OSM-Twitter":{id:"OSM-Twitter",type:"twitter",account:"openstreetmap",locationSet:{include:["001"]},languageCodes:["en"],order:4,strings:{community:"OpenStreetMap",communityID:"openstreetmap"},contacts:[{name:"Harry Wood",email:"mail@harrywood.co.uk"}],resolved:{name:"OpenStreetMap on Twitter",url:"https://twitter.com/openstreetmap",description:"Follow us on Twitter",nameHTML:'<a target="_blank" href="https://twitter.com/openstreetmap">OpenStreetMap on Twitter</a>',urlHTML:'<a target="_blank" href="https://twitter.com/openstreetmap">https://twitter.com/openstreetmap</a>',descriptionHTML:"Follow us on Twitter"}},OSMF:en};function ye(p,e,t){const n=p.slice();return n[6]=e[t],n}function Ce(p){let e,t;return e=new _e({props:{country:p[6].properties}}),{c(){oe(e.$$.fragment)},m(n,o){ae(e,n,o),t=!0},p(n,o){const r={};o&1&&(r.country=n[6].properties),e.$set(r)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){re(e,n)}}}function nn(p){let e,t,n,o,r,a;t=new yt({props:{construct:p[1].intro}});let c=p[0],s=[];for(let i=0;i<c.length;i+=1)s[i]=Ce(ye(p,c,i));const d=i=>j(s[i],1,1,()=>{s[i]=null});return r=new _e({props:{country:{resources:tn,nameEn:"Global resources"}}}),{c(){e=$e("div"),oe(t.$$.fragment),n=me();for(let i=0;i<s.length;i+=1)s[i].c();o=me(),oe(r.$$.fragment)},m(i,l){We(i,e,l),ae(t,e,null),he(e,n);for(let u=0;u<s.length;u+=1)s[u].m(e,null);he(e,o),ae(r,e,null),a=!0},p(i,[l]){if(l&1){c=i[0];let u;for(u=0;u<c.length;u+=1){const m=ye(i,c,u);s[u]?(s[u].p(m,l),B(s[u],1)):(s[u]=Ce(m),s[u].c(),B(s[u],1),s[u].m(e,o))}for(Ke(),u=c.length;u<s.length;u+=1)d(u);ze()}},i(i){if(!a){B(t.$$.fragment,i);for(let l=0;l<c.length;l+=1)B(s[l]);B(r.$$.fragment,i),a=!0}},o(i){j(t.$$.fragment,i),s=s.filter(Boolean);for(let l=0;l<s.length;l+=1)j(s[l]);j(r.$$.fragment,i),a=!1},d(i){i&&qe(e),re(t),Je(s,i),re(r)}}}function on(p,e,t){let n,{locationControl:o}=e;const r=o.mapD(d=>{const i=vt.embedded_tile(d.lat,d.lon,6);return`https://raw.githubusercontent.com/pietervdvn/MapComplete-data/main/community_index/tile_${i.z}_${i.x}_${i.y}.geojson`}),a=x.t.communityIndex,c=new T([]);r.addCallbackAndRun(async d=>{const i=await A.downloadJsonCached(d,86400);i!==void 0&&c.setData(i.features)});const s=c.map(d=>d.filter(i=>de.inside([o.data.lon,o.data.lat],i)),[o]);return Ze(p,s,d=>t(0,n=d)),p.$$set=d=>{"locationControl"in d&&t(3,o=d.locationControl)},[n,a,s,o]}class an extends Ne{constructor(e){super(),je(this,e,on,nn,Ve,{locationControl:3})}}class vn{constructor(e,t){L(this,"guiState");L(this,"state");L(this,"geolocationHandler");this.state=e,this.guiState=t,this.state.featureSwitchGeolocation.data&&(this.geolocationHandler=new Yt(new Xt,e))}setup(){this.SetupUIElements(),this.SetupMap(),R.ActivateCurrent(),this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&A.LoadCustomCss(this.state.layoutToUse.customCss),$.RegisterHotkey({shift:"O"},x.t.hotkeyDocumentation.selectMapnik,()=>{this.state.backgroundLayer.setData(it.osmCarto)}),A.downloadJson("./service-worker-version").then(e=>console.log("Service worker",e)).catch(e=>console.log("Service worker not active"))}setupClickDialogOnMap(e,t){const n=t.layoutToUse.layers.some(c=>c.presets.length>0),o=t.filteredLayers.data.filter(c=>c.layerDef.id==="note")[0];let r;o!==void 0&&(r=c=>new Kt(o,c,t));function a(){if(!n&&r===void 0)return;const c=new T(!1),s=new R(()=>n?x.t.general.add.title:x.t.notes.createNoteTitle,({resetScrollSignal:i})=>{let l;n&&(l=new Oe(c,i,e,t));let u;return o!==void 0&&(u=r(c)),new y([l,u]).SetClass("flex flex-col font-lg text-lg")},"new",c);s.isShown.addCallback(i=>{i||t.LastClickLocation.setData(void 0)});let d;!n&&r!==void 0&&(d=new y([b.note_svg().SetClass("absolute bottom-0").SetStyle("height: 40px"),b.addSmall_svg().SetClass("absolute w-6 animate-pulse").SetStyle("right: 10px; bottom: -8px;")]).SetClass("block relative h-full").SetStyle("left: calc( 50% - 15px )")),mt.construct(t,s,n?new Qt(t.filteredLayers):d),t.LastClickLocation.addCallbackAndRunD(i=>{R.collapse()})}o!==void 0?a():t.featureSwitchAddNew.addCallbackAndRunD(c=>{if(c)return a(),!0})}SetupMap(){if(A.runningFromConsole)return;const e=this.state,t=this.guiState;e.mainMapObject.SetClass("w-full h-full").AttachTo("leafletDiv"),this.setupClickDialogOnMap(t.filterViewIsOpened,e),new Q({leafletMap:e.leafletMap,layerToShow:new Le(Pe,"home_location",!0),features:e.homeLocation,state:e});const n=e.filteredLayers.data.filter(o=>o.layerDef.id==="selected_element")[0];new Q({leafletMap:e.leafletMap,layerToShow:n.layerDef,features:e.selectedElementsLayer,state:e}),e.leafletMap.addCallbackAndRunD(o=>(e.selectedElement.ping(),Z.state.locationControl.ping(),!0))}SetupUIElements(){var i,l;const e=this.state,t=this.guiState,n=this,o=O.If(e.featureSwitchUserbadge,()=>{new dt(e,{isOpened:t.userInfoIsOpened,userInfoFocusedQuestion:t.userInfoFocusedQuestion});const u=new F(new I(e.osmConnection.userDetails.map(m=>(m==null?void 0:m.img)===void 0?b.person_ui().SetClass("mt-1 block"):new ce(m==null?void 0:m.img))).SetClass("block rounded-full overflow-hidden"),{dontStyle:!0}).onClick(()=>{n.guiState.userInfoIsOpened.setData(!0)});return new xe(u,x.t.general.loginWithOpenStreetMap,e)}),r=O.If(e.featureSwitchExtraLinkEnabled,()=>new ve(e,e.layoutToUse.extraLink)),a=O.If(e.featureSwitchWelcomeMessage,()=>n.InitWelcomeMessage()),c=O.If(e.featureSwitchCommunityIndex,()=>{const u=new F(b.community_svg()),m=new R(()=>x.t.communityIndex.title,()=>new Qe(an,{...e}),"community_index");return u.onClick(()=>{m.Activate()}),u}),s=O.If(e.featureSwitchIsTesting,()=>new P("TESTING").SetClass("alert m-2 border-2 border-black"));new R(()=>x.t.general.attribution.attributionTitle,()=>new ft(e),"copyright",t.copyrightViewIsOpened);const d=new F(b.copyright_svg()).onClick(()=>t.copyrightViewIsOpened.setData(!0));new y([a,o,d,c,r,s]).SetClass("flex flex-col").AttachTo("top-left"),new y([new ve(e,{...e.layoutToUse.extraLink,newTab:!0,requirements:new Set})]).SetClass("flex items-center justify-center normal-background h-full").AttachTo("on-small-screen"),new y([O.If(e.featureSwitchSearch,()=>{const u=new be(e).SetClass("shadow rounded-full h-min w-full overflow-hidden sm:max-w-sm pointer-events-auto");return $.RegisterHotkey({ctrl:"F"},x.t.hotkeyDocumentation.selectSearch,()=>{u.focus()}),u})]).AttachTo("top-right"),new Bt(e,t).AttachTo("bottom-left"),new Vt(e,this.geolocationHandler).AttachTo("bottom-right"),new $t(e).AttachTo("centermessage"),(l=(i=document==null?void 0:document.getElementById("centermessage"))==null?void 0:i.classList)==null||l.add("pointer-events-none")}InitWelcomeMessage(){const e=this.guiState.welcomeMessageIsOpened;new J(e,this.guiState.welcomeMessageOpenedTab,this.state,this.guiState);const t=new F(b.help_svg());t.onClick(()=>e.setData(!0));const n=new Date().getTime();return this.state.locationControl.addCallback(()=>{if(!(new Date().getTime()-n<15*1e3))return e.setData(!1),!0}),this.state.selectedElement.addCallbackAndRunD(o=>{e.setData(!1)}),t.SetClass("pointer-events-auto")}}class Ee{static Implement(){ht.implementation=Ee.AddToMap}static AddToMap(e,t,n=void 0){t.map(o=>{if(o===void 0)return;const r=gt.tileLayer(e.source,{attribution:"",maxZoom:e.maxzoom,minZoom:e.minzoom,wmts:!1});n===void 0&&r.addTo(o),n==null||n.addCallbackAndRunD(a=>{a?r.addTo(o):o.removeLayer(r)})})}}class yn{constructor(e,t){L(this,"state");L(this,"currentView",new T(void 0));L(this,"singleElementCache",{});this.state=e}viewSelector(e,t,n,o){const r=this.currentView,a={title:t,contents:n};return e.SetClass("pl-1 pr-1 rounded-md"),e.onClick(()=>{r.setData(a)}),ne.hash.addCallbackAndRunD(c=>{c===o&&r.setData(a)}),r.addCallbackAndRunD(c=>{c==a?(e.SetClass("bg-unsubtle"),ne.hash.setData(o)):e.RemoveClass("bg-unsubtle")}),e}singleElementView(e,t,n){if(this.singleElementCache[e.properties.id]!==void 0)return this.singleElementCache[e.properties.id];const o=this.state.allElements.getEventSourceById(e.properties.id),r=new y([new G(new wt(o,t.title,this.state),4),n<900?Math.floor(n)+"m away":A.Round(n/1e3)+"km away"]).SetClass("flex justify-between");return this.singleElementCache[e.properties.id]=this.viewSelector(r,new q(()=>te.GenerateTitleBar(o,t,this.state)),new q(()=>te.GenerateContent(o,t,this.state)))}mainElementsView(e){const t=this;return e===void 0?new P("Initializing"):e.length==0?new P("No elements in view"):new y(e.map(n=>t.singleElementView(n.element,n.layer,n.distance)))}documentationButtonFor(e){var t,n;return this.viewSelector(x.W(((t=e.name)==null?void 0:t.Clone())??e.id),new y(["Documentation about ",((n=e.name)==null?void 0:n.Clone())??e.id]),e.GenerateDocumentation([]),"documentation-"+e.id)}allDocumentationButtons(){const e=this.state.layoutToUse.layers.filter(t=>H.priviliged_layers.indexOf(t.id)<0).filter(t=>!t.id.startsWith("note_import_"));return e.length===1?this.documentationButtonFor(e[0]):this.viewSelector(new P("Documentation"),"Documentation",new y(e.map(t=>this.documentationButtonFor(t).SetClass("flex flex-col"))))}setup(){const e=this.state;this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&A.LoadCustomCss(this.state.layoutToUse.customCss);const t=this.SetupMap();A.downloadJson("./service-worker-version").then(m=>console.log("Service worker",m)).catch(m=>console.log("Service worker not active")),document.getElementById("centermessage").classList.add("hidden");const n={};for(const m of e.layoutToUse.layers)n[m.id]=m;const o=this,r=new T([]);function a(){const m=[o.state.locationControl.data.lon,o.state.locationControl.data.lon],S=o.state.featurePipeline.getAllVisibleElementsWithmeta(o.state.currentBounds.data).map(C=>{const _=de.distanceBetween(C.center,m);return{...C,distance:_}});S.sort((C,_)=>C.distance-_.distance),r.setData(S)}t.bounds.addCallbackAndRun(a),e.featurePipeline.newDataLoadedSignal.addCallback(a),e.filteredLayers.addCallbackAndRun(m=>{for(const S of m)S.isDisplayed.addCallback(a),S.appliedFilters.addCallback(a)});const c=new q(()=>new Te(e.filteredLayers,e.overlayToggles,e)),s=new y([e.layoutToUse.description,e.layoutToUse.descriptionTail]);o.currentView.setData({title:e.layoutToUse.title,contents:s});const d=new T(!1);d.addCallback(m=>o.currentView.setData({title:"filters",contents:c}));const i=new T(!1),l=new Oe(new T(!0),new T(void 0),d,e,e.locationControl),u="Add a missing point";this.currentView.addCallbackAndRunD(m=>{i.setData(m.contents===l)}),i.addCallbackAndRun(m=>{m?o.currentView.data.contents!==l&&o.currentView.setData({title:u,contents:l}):o.currentView.data.contents===l&&o.currentView.setData(void 0)}),new y([new y([this.viewSelector(new G(e.layoutToUse.title.Clone(),2),e.layoutToUse.title.Clone(),s,"welcome"),t.SetClass("w-full h-64 shrink-0 rounded-lg"),new be(e),this.viewSelector(new G(new I(r.map(m=>"There are "+(m==null?void 0:m.length)+" elements in view"))),"Statistics",new St(r,this.state),"statistics"),this.viewSelector(new P("Filter"),"Filters",c,"filters"),this.viewSelector(new y(["Add a missing point"]),u,l),new I(r.map(m=>this.mainElementsView(m).SetClass("block m-2"))).SetClass("block shrink-2 overflow-x-auto h-full border-2 border-subtle rounded-lg"),this.allDocumentationButtons(),new Me(Object.keys(e.layoutToUse.title.translations)).SetClass("mt-2"),new Ct]).SetClass("w-1/2 lg:w-1/4 m-4 flex flex-col shrink-0 grow-0"),new I(this.currentView.map(({title:m,contents:S})=>new y([new G(x.W(m),2).SetClass("shrink-0 border-b-4 border-subtle"),x.W(S).SetClass("shrink-2 overflow-y-auto block")]).SetClass("flex flex-col h-full"))).SetClass("w-1/2 lg:w-3/4 m-4 p-2 border-2 border-subtle rounded-xl m-4 ml-0 mr-8 shrink-0 grow-0")]).SetClass("flex h-full").AttachTo("leafletDiv")}SetupMap(){const e=this.state;return new Q({leafletMap:e.leafletMap,layerToShow:new Le(Pe,"home_location",!0),features:e.homeLocation,state:e}),e.leafletMap.addCallbackAndRunD(t=>(e.selectedElement.ping(),Z.state.locationControl.ping(),!0)),e.mainMapObject}}export{yn as D,Ee as S,vn as a,se as l};
