var U=Object.defineProperty;var x=(r,e,t)=>e in r?U(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var c=(r,e,t)=>(x(r,typeof e!="symbol"?e+"":e,t),t);import{a as y,U as m,S as P}from"./UIEventSource-f39c8b5a.js";import{L as S}from"./LocalStorageSource-0ef3f4e1.js";import{C as O}from"./Constants-45bfc0a2.js";function E(r){var e={},t=null;try{t=window.localStorage}catch{var n=new Map;t={isMocked:!0,hasItem:o=>n.has(o),getItem:o=>n.get(o),setItem:(o,l)=>n.set(o,l),removeItem:o=>n.delete(o),clear:()=>n.clear()}}function a(i,o){var l=r.url+i;if(arguments.length===1){var h=t.getItem(l)||"";return h.replace(/"/g,"")}else if(arguments.length===2)return o?t.setItem(l,o):t.removeItem(l)}e.authenticated=function(){return!!a("oauth2_access_token")},e.logout=function(){return a("oauth2_access_token",""),a("oauth_token",""),a("oauth_token_secret",""),a("oauth_request_token_secret",""),e},e.authenticate=function(i){if(e.authenticated()){i(null,e);return}e.logout(),s(function(o,l){o?i(o):A(function(h){u(h,l,i)})})},e.authenticateAsync=function(){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise((i,o)=>{var l=(h,g)=>{h?o(h):i(g)};s((h,g)=>{h?l(h):A(p=>u(p,g,l))})}))};function s(i){if(r.singlepage){i(null,void 0);return}var o=550,l=610,h=[["width",o],["height",l],["left",window.screen.width/2-o/2],["top",window.screen.height/2-l/2]].map(function(f){return f.join("=")}).join(","),g=window.open("about:blank","oauth_window",h);if(g)i(null,g);else{var p=new Error("Popup was blocked");p.status="popup-blocked",i(p)}}function u(i,o,l){var h=L(),g=r.url+"/oauth2/authorize?"+D({client_id:r.client_id,redirect_uri:r.redirect_uri,response_type:"code",scope:r.scope,state:h,code_challenge:i.code_challenge,code_challenge_method:i.code_challenge_method,locale:r.locale||""});if(r.singlepage){if(t.isMocked){var p=new Error("localStorage unavailable, but required in singlepage mode");p.status="pkce-localstorage-unavailable",l(p);return}var f=I(window.location.search.slice(1));f.code?e.bootstrapToken(f.code,l):(a("oauth2_state",h),a("oauth2_pkce_code_verifier",i.code_verifier),window.location=g)}else e.popupWindow=o,o.location=g;window.authComplete=function(_){var v=I(_.split("?")[1]);if(v.state!==h){var b=new Error("Invalid state");b.status="invalid-state",l(b);return}d(v.code,i.code_verifier,w),delete window.authComplete};function w(_,v){if(r.done(),_){l(_);return}var b=JSON.parse(v.response);a("oauth2_access_token",b.access_token),l(null,e)}}function d(i,o,l){var h=r.url+"/oauth2/token?"+D({client_id:r.client_id,redirect_uri:r.redirect_uri,grant_type:"authorization_code",code:i,code_verifier:o});e.rawxhr("POST",h,null,null,null,l),r.loading()}return e.bringPopupWindowToFront=function(){var i=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),i=!0)}catch{}return i},e.bootstrapToken=function(i,o){var l=a("oauth2_state");a("oauth2_state","");var h=I(window.location.search.slice(1));if(h.state!==l){var g=new Error("Invalid state");g.status="invalid-state",o(g);return}var p=a("oauth2_pkce_code_verifier");a("oauth2_pkce_code_verifier",""),d(i,p,f);function f(w,_){if(r.done(),w){o(w);return}var v=JSON.parse(_.response);a("oauth2_access_token",v.access_token),o(null,e)}},e.fetch=function(i,o){if(e.authenticated())return l();return r.auto?e.authenticateAsync().then(l):Promise.reject(new Error("not authenticated"));function l(){return o=o||{},o.headers||(o.headers={"Content-Type":"application/x-www-form-urlencoded"}),o.headers.Authorization="Bearer "+a("oauth2_access_token"),fetch(i,o)}},e.xhr=function(i,o){if(e.authenticated())return l();if(r.auto){e.authenticate(l);return}else{o("not authenticated",null);return}function l(){var g=i.prefix!==!1?r.apiUrl+i.path:i.path;return e.rawxhr(i.method,g,a("oauth2_access_token"),i.content,i.headers,h)}function h(g,p){g?o(g):p.responseXML?o(g,p.responseXML):o(g,p.response)}},e.rawxhr=function(i,o,l,h,g,p){g=g||{"Content-Type":"application/x-www-form-urlencoded"},l&&(g.Authorization="Bearer "+l);var f=new XMLHttpRequest;f.onreadystatechange=function(){f.readyState===4&&f.status!==0&&(/^20\d$/.test(f.status)?p(null,f):p(f,null))},f.onerror=function(_){p(_,null)},f.open(i,o,!0);for(var w in g)f.setRequestHeader(w,g[w]);return f.send(h),f},e.preauth=function(i){return i&&i.access_token&&a("oauth2_access_token",i.access_token),e},e.options=function(i){return arguments.length?(r=i,r.apiUrl=r.apiUrl||"https://api.openstreetmap.org",r.url=r.url||"https://www.openstreetmap.org",r.auto=r.auto||!1,r.singlepage=r.singlepage||!1,r.loading=r.loading||function(){},r.done=r.done||function(){},e.preauth(r)):r},e.options(r),e}function D(r){return Object.keys(r).filter(function(e){return r[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")}function I(r){for(var e=0;e<r.length&&(r[e]==="?"||r[e]==="#");)e++;return r=r.slice(e),r.split("&").reduce(function(t,n){var a=n.split("=");return a.length===2&&(t[a[0]]=decodeURIComponent(a[1])),t},{})}function k(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function A(r){var e;if(k()){var t=window.crypto.getRandomValues(new Uint8Array(32));e=T(t.buffer);var n=Uint8Array.from(Array.from(e).map(function(u){return u.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",n).then(function(u){var d=T(u);r({code_challenge:d,code_verifier:e,code_challenge_method:"S256"})})}else{var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var s=0;s<64;s++)e+=a[Math.floor(Math.random()*a.length)];r({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function L(){var r;if(k()){var e=window.crypto.getRandomValues(new Uint8Array(32));r=T(e.buffer)}else{var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";r="";for(var n=0;n<64;n++)r+=t[Math.floor(Math.random()*t.length)]}return r}function T(r){return btoa(String.fromCharCode.apply(null,new Uint8Array(r))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}class C{constructor(e,t,n=!1){c(this,"preferences",{});c(this,"localStorageInited",new Set);c(this,"seenKeys",[]);c(this,"_allPreferences",new y({}));c(this,"allPreferences",this._allPreferences);c(this,"_fakeUser");c(this,"auth");c(this,"osmConnection");this.auth=e,this._fakeUser=n,this.osmConnection=t,t.OnLoggedIn(()=>(this.loadBulkPreferences(),!0))}setPreferencesAll(e,t){this._allPreferences.data[e]!==t&&(this._allPreferences.data[e]=t,this._allPreferences.ping())}initPreference(e,t=void 0){if(this.preferences[e]!==void 0)return t!==void 0&&this.preferences[e].set(t),this.preferences[e];const n=this.preferences[e]=new y(t,"preference: "+e);return t&&this.setPreferencesAll(e,t),n.addCallback(a=>{this.uploadKvSplit(e,a),this.setPreferencesAll(e,a)}),n}async loadBulkPreferences(){const e=await this.getPreferencesDictDirectly();this.seenKeys=Object.keys(e);const t=C.getLegacyCombinedItems(e),n=C.mergeDict(e);for(const a in n)this.initPreference(a,e[a]);for(const a in t)this.initPreference(a,t[a])}getPreference(e,t=void 0,n){return this.getPreferenceSeedFromlocal(e,t,{prefix:n})}getPreferenceSeedFromlocal(e,t=void 0,n){n!=null&&n.prefix&&(e=n.prefix+e),e=e.replace(/[:/"' {}.%\\]/g,"");const a=S.Get(e);(a.data==="null"||a.data==="undefined")&&a.set(void 0);const s=this.initPreference(e,a.data??t);return this.localStorageInited.has(e)||(((n==null?void 0:n.saveToLocalStorage)??!0)&&s.addCallback(u=>a.set(u)),this.localStorageInited.add(e)),s}ClearPreferences(){console.log("Starting to remove all preferences"),this.removeAllWithPrefix("")}static mergeDict(e){const t={},n=Object.keys(e),a=n.filter(s=>!s.match(/[a-z-_0-9A-Z]*:[0-9]+/));for(const s of a){if(s.match(/-combined-[0-9]*$/)||s.match(/-combined-length$/))continue;const d=C.keysStartingWith(n,s).map(i=>e[i]);t[s]=d.join("")}return t}static getLegacyCombinedItems(e){const t={},n=Object.keys(e),a=m.NoNullInplace(m.Dedup(n.map(s=>{var u;return(u=s.match(/(.*)-combined-[0-9]+$/))==null?void 0:u[1]})));for(const s of a){let u=0,d="",i;do i=e[s+"-combined-"+u],d+=i??"",u++;while(i!==void 0);t[s]=d}return t}getPreferencesDictDirectly(){return new Promise((e,t)=>{this.auth.xhr({method:"GET",path:"/api/0.6/user/preferences"},(n,a)=>{if(n){console.log("Could not load preferences",n),t(n);return}const s=a.getElementsByTagName("preference"),u={};for(let d=0;d<s.length;d++){const i=s[d],o=i.getAttribute("k");u[o]=i.getAttribute("v")}e(u)})})}static keysStartingWith(e,t){const n=e.filter(a=>a===t||a.match(new RegExp(t+":[0-9]+")));return n.sort(),n}async uploadKvSplit(e,t){if(t==null||t===""||t==="undefined"||t==="null"){const a=C.keysStartingWith(this.seenKeys,e);await Promise.all(a.map(s=>this.deleteKeyDirectly(s)));return}await this.uploadKeyDirectly(e,t.slice(0,255)),t=t.slice(255);let n=0;for(;t.length>0;)await this.uploadKeyDirectly(`${e}:${n}`,t.slice(0,255)),t=t.slice(255)}deleteKeyDirectly(e){if(!this.osmConnection.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(!this._fakeUser)return new Promise((t,n)=>{this.auth.xhr({method:"DELETE",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),headers:{"Content-Type":"text/plain"}},a=>{if(a){console.warn("Could not remove preference",a),n(a);return}console.debug("Preference ",e,"removed!"),t()})})}async uploadKeyDirectly(e,t){if(!this.osmConnection.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(!this._fakeUser){if(t===void 0||t===""||t===null){await this.deleteKeyDirectly(e);return}if(t.length>255)throw console.error("Preference too long, max 255 chars",{k:e,v:t}),"Preference too long, at most 255 characters are supported";return new Promise((n,a)=>{this.auth.xhr({method:"PUT",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),headers:{"Content-Type":"text/plain"},content:t},s=>{if(s){console.warn(`Could not set preference "${e}"'`,s),a(s);return}n()})})}}async removeAllWithPrefix(e){const t=this.seenKeys;for(const n in t)await this.deleteKeyDirectly(n)}getExistingPreference(e,t,n){return n&&(e=n+e),e=e.replace(/[:/"' {}.%\\]/g,""),this.preferences[e]}}class M{constructor(e){c(this,"loggedIn",!1);c(this,"name","Not logged in");c(this,"uid");c(this,"csCount",0);c(this,"img");c(this,"unreadMessages",0);c(this,"totalMessages",0);c(this,"home");c(this,"backend");c(this,"account_created");c(this,"tracesCount",0);c(this,"description");c(this,"languages");this.backend=e}}class N{constructor(e){c(this,"auth");c(this,"userDetails");c(this,"isLoggedIn");c(this,"gpxServiceIsOnline",new y("unknown"));c(this,"apiIsOnline",new y("unknown"));c(this,"loadingStatus",new y("not-attempted"));c(this,"preferencesHandler");c(this,"_oauth_config");c(this,"_dryRun");c(this,"fakeUser");c(this,"_onLoggedIn",[]);c(this,"_iframeMode");c(this,"_singlePage");c(this,"isChecking",!1);c(this,"_doCheckRegularly");c(this,"_userInfoCache",{});var t;if(e??(e={}),this.fakeUser=(e==null?void 0:e.fakeUser)??!1,this._singlePage=(e==null?void 0:e.singlePage)??!0,this._oauth_config=O.osmAuthConfig,this._doCheckRegularly=(e==null?void 0:e.checkOnlineRegularly)??!0,console.debug("Using backend",this._oauth_config.url),this._iframeMode=m.runningFromConsole?!1:window!==window.top,{}.VITE_OSM_OAUTH_CLIENT_ID!==void 0&&{}.VITE_OSM_OAUTH_SECRET!==void 0&&(console.debug("Using environment variables for oauth config"),this._oauth_config.oauth_client_id={}.VITE_OSM_OAUTH_CLIENT_ID,this._oauth_config.oauth_secret={}.VITE_OSM_OAUTH_SECRET),this.userDetails=new y(new M(this._oauth_config.url),"userDetails"),e.fakeUser){const n=this.userDetails.data;n.csCount=5678,n.uid=42,n.loggedIn=!0,n.unreadMessages=0,n.name="Fake user",n.totalMessages=42,n.languages=["en"],n.description="The 'fake-user' is a URL-parameter which allows to test features without needing an OSM account or even internet connection.",this.loadingStatus.setData("logged-in")}this.UpdateCapabilities(),this.isLoggedIn=this.userDetails.map(n=>n.loggedIn&&(this.apiIsOnline.data==="unknown"||this.apiIsOnline.data==="online"),[this.apiIsOnline]),this.isLoggedIn.addCallback(n=>{this.userDetails.data.loggedIn==!1&&n==!0&&this.AttemptLogin()}),this._dryRun=e.dryRun??new y(!1),this.updateAuthObject(),this.fakeUser||this.CheckForMessagesContinuously(),this.preferencesHandler=new C(this.auth,this,this.fakeUser),((t=e.oauth_token)==null?void 0:t.data)!==void 0&&(this.auth.bootstrapToken(e.oauth_token.data,(n,a)=>{console.log("Bootstrap token called back",n,a),this.AttemptLogin()}),e.oauth_token.setData(void 0)),!m.runningFromConsole&&this.auth.authenticated()&&e.attemptLogin!==!1?this.AttemptLogin():console.log("Not authenticated")}GetPreference(e,t=void 0,n){const a=(n==null?void 0:n.prefix)??"mapcomplete-";return this.preferencesHandler.getPreference(e,t,a)}getPreference(e,t=void 0,n="mapcomplete-"){return this.preferencesHandler.getPreference(e,t,n)}OnLoggedIn(e){this._onLoggedIn.push(e)}LogOut(){this.auth.logout(),this.userDetails.data.loggedIn=!1,this.userDetails.data.csCount=0,this.userDetails.data.name="",this.userDetails.ping(),console.log("Logged out"),this.loadingStatus.setData("not-attempted")}Backend(){return this._oauth_config.url}AttemptLogin(){if(this.UpdateCapabilities(),this.loadingStatus.data!=="logged-in"&&this.loadingStatus.setData("loading"),this.fakeUser){this.loadingStatus.setData("logged-in"),console.log("AttemptLogin called, but ignored as fakeUser is set");return}console.log("Trying to log in..."),this.updateAuthObject(),S.Get("location_before_login").setData(m.runningFromConsole?void 0:window.location.href),this.auth.xhr({method:"GET",path:"/api/0.6/user/details"},(e,t)=>{var o;if(e!=null){console.log("Could not login due to:",e),this.loadingStatus.setData("error"),e.status==401?(console.log("Clearing tokens..."),this.auth.logout(),this.LogOut()):(console.log("Other error. Status:",e.status),this.apiIsOnline.setData("unreachable"));return}if(t==null){this.loadingStatus.setData("error");return}const n=t.getElementsByTagName("user")[0],a=this.userDetails.data;a.loggedIn=!0,console.log("Login completed, userinfo is ",n),a.name=n.getAttribute("display_name"),a.account_created=n.getAttribute("account_created"),a.uid=Number(n.getAttribute("id")),a.languages=Array.from(n.getElementsByTagName("languages")[0].getElementsByTagName("lang")).map(l=>l.textContent),a.csCount=Number.parseInt(n.getElementsByTagName("changesets")[0].getAttribute("count")??"0"),a.tracesCount=Number.parseInt(n.getElementsByTagName("traces")[0].getAttribute("count")??"0"),a.img=void 0;const s=n.getElementsByTagName("img");s!==void 0&&s[0]!==void 0&&(a.img=s[0].getAttribute("href"));const u=n.getElementsByTagName("description");u!==void 0&&u[0]!==void 0&&(a.description=(o=u[0])==null?void 0:o.innerHTML);const d=n.getElementsByTagName("home");if(d!==void 0&&d[0]!==void 0){const l=parseFloat(d[0].getAttribute("lat")),h=parseFloat(d[0].getAttribute("lon"));a.home={lat:l,lon:h}}this.loadingStatus.setData("logged-in");const i=n.getElementsByTagName("messages")[0].getElementsByTagName("received")[0];a.unreadMessages=parseInt(i.getAttribute("unread")),a.totalMessages=parseInt(i.getAttribute("count")),this.userDetails.ping();for(const l of this._onLoggedIn)l(this.userDetails.data);this._onLoggedIn=[]})}async interact(e,t,n,a,s=!1){const u=this.auth;if(s&&!this.auth.authenticated()){const d=await m.downloadAdvanced(`${this.Backend()}/api/0.6/${e}`,n,t,a);if(d.content)return d.content;throw console.error(d),"Could not interact with OSM:"+d.error}return new Promise((d,i)=>{u.xhr({method:t,headers:n,content:a,path:`/api/0.6/${e}`},function(o,l){o!==null?i(o):d(l)})})}async post(e,t,n,a=!1){return await this.interact(e,"POST",n,t,a)}async put(e,t,n){return await this.interact(e,"PUT",n,t)}async get(e,t,n=!1){return await this.interact(e,"GET",t,void 0,n)}closeNote(e,t){let n="";return(t??"")!==""&&(n="?text="+encodeURIComponent(t)),this._dryRun.data?(console.warn("Dryrun enabled - not actually closing note ",e," with text ",t),new Promise(a=>{a("")})):this.post(`notes/${e}/close${n}`)}reopenNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually reopening note ",e," with text ",t),new Promise(a=>{a("")});let n="";return(t??"")!==""&&(n="?text="+encodeURIComponent(t)),this.post(`notes/${e}/reopen${n}`)}async openNote(e,t,n){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually opening note with text ",n),new Promise(i=>{window.setTimeout(()=>i({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const a=`lat=${e}&lon=${t}&text=${encodeURIComponent(n)}`,s=await this.post("notes.json",a,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},!0),u=JSON.parse(s);console.log("Got result:",u);const d=u.properties;return console.log("OPENED NOTE",d),d}async uploadGpxTrack(e,t){var o;if(this._dryRun.data)return console.warn("Dryrun enabled - not actually uploading GPX ",e),new Promise(l=>{window.setTimeout(()=>l({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const n={file:e,description:t.description,tags:((o=t.labels)==null?void 0:o.join(","))??"",visibility:t.visibility};if(!n.description)throw"The description of a GPS-trace cannot be the empty string, undefined or null";const a={file:'; filename="'+(t.filename??"gpx_track_mapcomplete_"+new Date().toISOString())+`"\r
Content-Type: application/gpx+xml`},s="987654";let u="";for(const l in n)u+="--"+s+`\r
`,u+='Content-Disposition: form-data; name="'+l+'"',a[l]!==void 0&&(u+=a[l]),u+=`\r
\r
`,u+=n[l]+`\r
`;u+="--"+s+`--\r
`;const d=await this.post("gpx/create",u,{"Content-Type":"multipart/form-data; boundary="+s,"Content-Length":""+u.length}),i=JSON.parse(d);return console.log("Uploaded GPX track",i),{id:i}}addCommentToNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually adding comment ",t,"to  note ",e),m.waitFor(1e3);if((t??"")==="")throw"Invalid text!";return new Promise((n,a)=>{this.auth.xhr({method:"POST",path:`/api/0.6/notes/${e}/comment?text=${encodeURIComponent(t)}`},function(s){s!==null?a(s):n()})})}finishLogin(e){this.auth.authenticate(function(){console.log("Authentication successful!");const t=S.Get("location_before_login");e(t.data)})}updateAuthObject(){this.auth=new E({client_id:this._oauth_config.oauth_client_id,url:this._oauth_config.url,scope:"read_prefs write_prefs write_api write_gpx write_notes openid",redirect_uri:m.runningFromConsole?"https://mapcomplete.org/land.html":window.location.protocol+"//"+window.location.host+"/land.html",singlepage:!0,auto:!0,apiUrl:this._oauth_config.api_url??this._oauth_config.url})}CheckForMessagesContinuously(){this.isChecking||(P.Chronic(3*1e3).addCallback(()=>{if(this.apiIsOnline.data==="unreachable"||this.apiIsOnline.data==="offline")try{console.log("Api is offline - trying to reconnect..."),this.AttemptLogin()}catch(e){console.log("Could not login due to",e)}}),this.isChecking=!0,this._doCheckRegularly&&P.Chronic(60*5*1e3).addCallback(()=>{if(this.isLoggedIn.data)try{this.AttemptLogin()}catch(e){console.log("Could not login due to",e)}}))}UpdateCapabilities(){this.fakeUser||this.FetchCapabilities().then(({api:e,gpx:t})=>{this.apiIsOnline.setData(e),this.gpxServiceIsOnline.setData(t)})}async getInformationAboutUser(e){if(e===void 0)return;if(this._userInfoCache[e])return this._userInfoCache[e];const t=await this.get("user/"+e+".json",{accepts:"application/json"},!0),n=JSON.parse(t).user;return this._userInfoCache[e]=n,n}async FetchCapabilities(){if(m.runningFromConsole)return{api:"online",gpx:"online"};const e=await m.downloadAdvanced(this.Backend()+"/api/0.6/capabilities");if(e.content===void 0)return console.log("Something went wrong:",e),{api:"unreachable",gpx:"unreachable"};const t=e.content,a=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("status")[0],s=a.getAttribute("api"),u=a.getAttribute("gpx");return{api:s,gpx:u}}}c(N,"GpxTrackVisibility",["private","public","trackable","identifiable"]);export{N as O};
//# sourceMappingURL=OsmConnection-aa66c185.js.map
