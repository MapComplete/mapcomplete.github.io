var xt=Object.defineProperty;var Mt=(c,t,s)=>t in c?xt(c,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[t]=s;var m=(c,t,s)=>(Mt(c,typeof t!="symbol"?t+"":t,s),s);import{j as De,d as dt,b as ke,k as ft,O as xe,m as Pe,n as $e,R as Ft,S as ht,o as $t,p as Ot,T as X,q as ge,E as Rt,r as At,s as Bt,F as Pt,t as mt}from"./theme_overview-765d7c4f.js";import{T as Z,B as U,G as $,C as ce}from"./BBox-f2a49e53.js";import{U as I,V as E,T,C,J as de,S as O,M as Te,K as pt,a as ee,i as te,s as ne,h as x,j as W,D as P,_ as D,b as M,m as R,E as L,a0 as Lt,t as y,c as S,d as F,G as N,v as H,y as V,z as Q,w as Le,e as Me,R as Ie,a1 as He,a2 as Ae,a3 as Be,I as gt,f as Nt,u as Et,p as jt,q as Gt,N as wt,O as _t,X as qt,a4 as Wt,H as Oe}from"./SvelteUIElement-f5ca9fa6.js";import{e as z,c as bt,b as ae,L as Ne,F as Je,j as Ze,M as zt,i as yt,A as Ut,S as Vt}from"./ChartJs-1c26f275.js";import{L as vt,S as q,b as pe}from"./SubtleButton-ce700735.js";import{T as B,a as ue,L as we}from"./List-f0fc6763.js";import{T as Ee}from"./ToSvelte-6f7a6342.js";const re=class{constructor(t,s,e,n,o){m(this,"totalValue",0);m(this,"showCount",0);m(this,"hiddenCount",0);m(this,"features",new I(re.empty));m(this,"name");m(this,"_parent");m(this,"_root");m(this,"_z");m(this,"_x");m(this,"_y");m(this,"_tileIndex");m(this,"_counter");m(this,"_subtiles",[void 0,void 0,void 0,void 0]);m(this,"featuresStatic",[]);m(this,"featureProperties");m(this,"_state");m(this,"updateSignal",new I(void 0));this._parent=t,this._state=s,this._root=(t==null?void 0:t._root)??this,this._z=e,this._x=n,this._y=o,this._tileIndex=Z.tile_index(e,n,o),this.name="Count("+this._tileIndex+")";const i={id:""+this._tileIndex,tileId:""+this._tileIndex,count:"0",kilocount:"0",showCount:"0",totalCount:"0"};this.featureProperties=i;const u=new Date,a={type:"Feature",properties:i,geometry:{type:"Point",coordinates:Z.centerPointOf(e,n,o)}};this.featuresStatic.push({feature:a,freshness:u});const r=U.fromTile(e,n,o),l={type:"Feature",properties:i,geometry:{type:"Polygon",coordinates:[[[r.minLon,r.minLat],[r.minLon,r.maxLat],[r.maxLon,r.maxLat],[r.maxLon,r.minLat],[r.minLon,r.minLat]]]}};this.featuresStatic.push({feature:l,freshness:u})}static createHierarchy(t){return new re(void 0,t,0,0,0)}getTile(t){var a;if(t===this._tileIndex)return this;let[s,e,n]=Z.tile_from_index(t);for(;s-1>this._z;)e=Math.floor(e/2),n=Math.floor(n/2),s--;const o=e-2*this._x,u=(n-2*this._y)*2+o;return(a=this._subtiles[u])==null?void 0:a.getTile(t)}addTile(t){const s=this;if(t.tileIndex===this._tileIndex)this._counter===void 0&&(this._counter=new Qt(this._tileIndex),this._counter.countsPerLayer.addCallbackAndRun(e=>s.update())),this._counter.addTileCount(t);else{let[e,n,o]=Z.tile_from_index(t.tileIndex);for(;e-1>this._z;)n=Math.floor(n/2),o=Math.floor(o/2),e--;const i=n-2*this._x,a=(o-2*this._y)*2+i;this._subtiles[a]===void 0&&(this._subtiles[a]=new re(this,this._state,e,n,o)),this._subtiles[a].addTile(t)}this.updateSignal.setData(t)}getCountsForZoom(t,s,e=0){const n=this,o=[],i=s.map(u=>u.zoom).map(u=>{if(u-1>t.maxZoom)return o;const a=[];return n.visitSubTiles(r=>r.showCount<e?!1:r._z===u?(a.push(...r.features.data),!1):r._z<=u),a},[this.updateSignal.stabilized(500)]);return new De(i)}update(){var i,u,a,r;const t=new Map;let s=0,e=0,n=0,o=new Map;for(const l of this._state.filteredLayers.data)o.set(l.layerDef.id,l);(a=(u=(i=this==null?void 0:this._counter)==null?void 0:i.countsPerLayer)==null?void 0:u.data)==null||a.forEach((l,f)=>{t.set("layer:"+f,l),s+=l,this.featureProperties["direct_layer:"+f]=l;const d=o.get(f);d.isDisplayed.data&&this._z>=d.layerDef.minzoom?n+=l:e+=l});for(const l of this._subtiles)if(l!==void 0){s+=l.totalValue,n+=l.showCount,e+=l.hiddenCount;for(const f in l.featureProperties)f.startsWith("layer:")&&t.set(f,(t.get(f)??0)+Number(l.featureProperties[f]??0))}this.totalValue=s,this.showCount=n,this.hiddenCount=e,(r=this._parent)==null||r.update(),s===0?this.features.setData(re.empty):(this.featureProperties.count=""+s,this.featureProperties.kilocount=""+Math.floor(s/1e3),this.featureProperties.showCount=""+n,this.featureProperties.totalCount=""+s,t.forEach((l,f)=>{this.featureProperties[f]=""+l}),this.features.data=this.featuresStatic,this.features.ping())}visitSubTiles(t){t(this)&&this._subtiles.forEach(e=>e==null?void 0:e.visitSubTiles(t))}};let _e=re;m(_e,"empty",[]);class Qt{constructor(t){m(this,"bbox");m(this,"tileIndex");m(this,"countsPerLayer",new I(new Map));m(this,"z");m(this,"x");m(this,"y");m(this,"registeredLayers",new Map);this.tileIndex=t,this.bbox=U.fromTileIndex(t);const[s,e,n]=Z.tile_from_index(t);this.z=s,this.x=e,this.y=n}addTileCount(t){const s=t.layer.layerDef;this.registeredLayers.set(s.id,s);const e=this;t.features.map(n=>{const o=t.layer.isDisplayed.data;e.countsPerLayer.data.set(s.id,o?n.length:0),e.countsPerLayer.ping()},[t.layer.isDisplayed])}}const Ht="cluster_style",Jt="The style for the clustering in all themes. Enable `debug=true` to peak into clustered tiles",Zt={osmTags:"tileId~*"},Kt="Clustered data",Xt=["all_tags"],Yt=[{label:{render:"<div class='rounded-full text-xl font-bold' style='width: 2rem; height: 2rem; background: white'>{showCount}</div>",mappings:[{if:"showCount>1000",then:"<div class='rounded-full text-xl font-bold flex flex-col' style='width: 2.5rem; height: 2.5rem; background: white'>{kilocount}K</div>"}]},location:["point"]},{color:{render:"#3c3",mappings:[{if:"showCount>200",then:"#f33"},{if:"showCount>100",then:"#c93"},{if:"showCount>50",then:"#cc3"}]},width:{render:"1"}}],en={id:Ht,description:Jt,source:Zt,title:Kt,tagRenderings:Xt,mapRendering:Yt},We=class{constructor(t,s){const e=t.source,n=e.features.map(o=>{const i=e.bbox,[u,a,r]=Z.tile_from_index(e.tileIndex),l={type:"Feature",properties:{z:u,x:a,y:r,tileIndex:e.tileIndex,source:e.name,count:o.length,tileId:e.name+"/"+e.tileIndex},geometry:{type:"Polygon",coordinates:[[[i.minLon,i.minLat],[i.minLon,i.maxLat],[i.maxLon,i.maxLat],[i.maxLon,i.minLat],[i.minLon,i.minLat]]]}},f=$.centerpoint(l);return[l,f].map(d=>({feature:d,freshness:new Date}))});new ke({layerToShow:We.styling,features:new De(n),leafletMap:t.leafletMap,doShowLayer:t.doShowLayer,state:s})}};let be=We;m(be,"styling",new dt(en,"ShowTileInfo",!0));const ze=class{constructor(t,s){m(this,"hash");m(this,"state");this.hash=t,this.state=s;const e=this;t.addCallback(()=>e.setSelectedElementFromHash()),this.initialLoad()}initialLoad(){const t=this.hash.data;t===void 0||t===""||t.indexOf("-")>=0||ze._no_trigger_on.has(t)||(t.startsWith("node")||t.startsWith("way")||t.startsWith("relation"))&&z.DownloadObjectAsync(t).then(s=>{try{console.log("Downloaded selected object from OSM-API for initial load: ",t);const e=s.asGeoJson();this.state.allElements.addOrGetElement(e),this.state.selectedElement.setData(e),this.zoomToSelectedFeature()}catch(e){console.error(e)}})}setSelectedElementFromHash(){var e;const t=this.state,s=this.hash.data;if(s===void 0||s==="")t.selectedElement.setData(void 0);else{const n=t.allElements.ContainingFeatures.get(s);if(n===void 0)return;const o=t.selectedElement.data;if(o===void 0){t.selectedElement.setData(n);return}if(((e=o.properties)==null?void 0:e.id)===n.properties.id)return;t.selectedElement.setData(n)}}zoomToSelectedFeature(){var o,i;const t=this.state.selectedElement.data;if(t===void 0)return;const s=$.centerpointCoordinates(t),e=this.state.locationControl;e.data.lon=s[0],e.data.lat=s[1];const n=Math.max(14,...((i=(o=this.state.layoutToUse)==null?void 0:o.layers)==null?void 0:i.map(u=>u.minzoomVisible))??[]);e.data.zoom<n&&(e.data.zoom=n),e.ping()}};let ye=ze;m(ye,"_no_trigger_on",new Set(["welcome","copyright","layers","new","filters","location_track","",void 0]));class tn extends E{constructor(s,e){const n=new I([]),o=e.tagsSource,i=e.units;e.showAllQuestionsAtOnce=e.showAllQuestionsAtOnce??!1;const u=e.tagRenderings.filter(d=>d.question!==void 0).filter(d=>d.question!==null);let a=()=>{};const r=u.map((d,h)=>new vt(()=>new ft(o,d,s,{units:i,afterSave:()=>{n.ping(),a()},cancelButton:T.t.general.skip.Clone().SetClass("btn btn-secondary").onClick(()=>{n.data.push(h),n.ping(),a()})}))),l=T.t.general.skippedQuestions.onClick(()=>{n.setData([])});o.map(d=>{if(d!==void 0)for(let h=0;h<r.length;h++){let w=u[h];if(!(n.data.indexOf(h)>=0)&&!w.IsKnown(d)&&!(w.condition&&!w.condition.matchesProperties(d)))return h}},[n]);const f=o.map(d=>{if(d===void 0)return[];const h=[];for(let w=0;w<r.length;w++){let p=u[w];n.data.indexOf(w)>=0||p.IsKnown(d)||p.condition&&!p.condition.matchesProperties(d)||h.push(r[w])}return h},[n]);super(f.map(d=>{const h=s.osmConnection.apiIsOnline.data;if(h!=="online"&&h!=="unknown")return;const w=[];return e.showAllQuestionsAtOnce===!0||e.showAllQuestionsAtOnce.data?w.push(...f.data):w.push(d[0]),n.data.length>0&&w.push(l),new C(w).SetClass("block mb-8")},[s.osmConnection.apiIsOnline]));m(this,"skippedQuestions");m(this,"restingQuestions");this.skippedQuestions=n,this.restingQuestions=f,a=()=>this.ScrollIntoView()}}class nn extends xe{constructor(s,e,n,o){var i;super(s,!0);m(this,"_softDeletionTags");m(this,"meta");m(this,"_id");m(this,"_hardDelete");this._id=s,this._hardDelete=o,this.meta={...n,changeType:"deletion"},((i=e==null?void 0:e.usedKeys())==null?void 0:i.indexOf("fixme"))>=0?this._softDeletionTags=e:this._softDeletionTags=new bt(de.NoNull([e,new ae("fixme",`A mapcomplete user marked this feature to be deleted (${n.specialMotivation})`)]))}async CreateChangeDescriptions(s,e){const n=e??await z.DownloadObjectAsync(this._id);return this._hardDelete?[{meta:this.meta,doDelete:!0,type:n.type,id:n.id}]:await new Pe(this._id,this._softDeletionTags,n.tags,{...this.meta,changeType:"soft-delete"}).CreateChangeDescriptions(s)}}class he extends B{constructor(t,s,e){const n=new sn(t,s,e.neededChangesets),o=s.allElements.getEventSourceById(t),i=new I(!1),u=!!e.softDeletionTags,a=new I(!1);function r(_){var A,b,K;let k;_.retagTo!==void 0?k=new Pe(t,_.retagTo,o.data,{theme:((A=s==null?void 0:s.layoutToUse)==null?void 0:A.id)??"unkown",changeType:"special-delete"}):k=new nn(t,e.softDeletionTags,{theme:((b=s==null?void 0:s.layoutToUse)==null?void 0:b.id)??"unkown",specialMotivation:_.deleteReason},n.canBeDeleted.data.canBeDeleted),(K=s.changes)==null||K.applyAction(k),i.setData(!0)}const l=T.t.delete,f=l.cancel.SetClass("block btn btn-secondary").onClick(()=>a.setData(!1)),d=new q(O.delete_icon_svg().SetStyle("width: 1.5rem; height: 1.5rem;"),l.delete).onClick(()=>{n.CheckDeleteability(!0),a.setData(!0)}),h=o.map(_=>_.id.indexOf("-")<0),w=he.constructMultipleChoice(e,o,s),p=new C([new ue(new $e(l.whyDelete,o,s).SetClass("question-text"),3),w,new C([he.constructExplanation(w.GetValue(),n,o,s),new C([f,he.constructConfirmButton(w.GetValue()).onClick(()=>r(w.GetValue().data))]).SetClass("flex justify-end flex-wrap-reverse")]).SetClass("flex mt-2 justify-between")]).SetClass("question"),v=new B(new B(new B(p,new q(O.envelope_ui(),l.readMessages),s.osmConnection.userDetails.map(_=>_.csCount>ce.userJourney.addNewPointWithUnreadMessagesUnlock||_.unreadMessages==0)),d,a),new E(n.canBeDeleted.map(_=>new C([O.delete_not_allowed_svg().SetStyle("height: 2rem; width: auto").SetClass("mr-2"),new C([l.cannotBeDeleted,_.reason.SetClass("subtle"),l.useSomethingElse.SetClass("subtle")]).SetClass("flex flex-col")]).SetClass("flex m-2 p-2 rounded-lg bg-gray-200 bg-gray-200"))),n.canBeDeleted.map(_=>u||_.canBeDeleted!==!1));super(new B(new C([O.delete_icon_svg().SetClass("h-16 w-16 p-2 m-2 block bg-gray-300 rounded-full"),l.isDeleted]).SetClass("flex m-2 rounded-full"),new Ne(v,void 0,s),i),void 0,h);const g=this;a.addCallbackAndRunD(_=>{_&&g.ScrollIntoView()})}static constructConfirmButton(t){const s=T.t.delete,e=new C([O.delete_icon_ui().SetClass("w-6 h-6 mr-3 block"),s.delete]).SetClass("flex btn bg-red-500"),n=new C([O.delete_icon_ui().SetClass("w-6 h-6 mr-3 block"),s.delete]).SetClass("flex btn btn-disabled bg-red-200");return new B(e,n,t.map(o=>o!==void 0))}static constructExplanation(t,s,e,n){const o=T.t.delete;return new E(t.map(i=>{if(i===void 0)return o.explanations.selectReason.SetClass("subtle");const u=i.retagTo;if(u!==void 0)return new C([o.explanations.retagNoOtherThemes,ft.CreateTagExplanation(new I(u),e,n).SetClass("subtle")]);if(i.deleteReason!==void 0)return new E(s.canBeDeleted.map(({canBeDeleted:r,reason:l})=>r?o.explanations.hardDelete:o.explanations.softDelete.Subs({reason:l})))},[s.canBeDeleted])).SetClass("block")}static constructMultipleChoice(t,s,e){const n=[];for(const o of t.nonDeleteMappings)n.push(new Je(new $e(o.then,s,e),{retagTo:o.if}));for(const o of t.deleteReasons??[])n.push(new Je(new $e(o.explanation,s,e),{deleteReason:o.changesetMessage}));return new Ft(n,{selectFirstAsDefault:!1})}}class sn{constructor(t,s,e){m(this,"canBeDeleted");m(this,"_id");m(this,"_allowDeletionAtChangesetCount");m(this,"_state");this._id=t,this._state=s,this._allowDeletionAtChangesetCount=e??Number.MAX_VALUE,this.canBeDeleted=new I({canBeDeleted:void 0,reason:T.t.delete.loading}),this.CheckDeleteability(!1)}CheckDeleteability(t){const s=T.t.delete,e=this._id,n=this.canBeDeleted,o=this;if(!e.startsWith("node")){this.canBeDeleted.setData({canBeDeleted:!1,reason:s.isntAPoint});return}const i=this._state.osmConnection.userDetails.map(h=>{if(h!==void 0)return h.loggedIn?h.csCount>=Math.min(ce.userJourney.deletePointsOfOthersUnlock,this._allowDeletionAtChangesetCount):!1}),u=new I(void 0),a=u.map(h=>{if(h==null)return null;const w=o._state.osmConnection.userDetails.data.uid;return!h.some(p=>p!==w)},[o._state.osmConnection.userDetails]),r=i.map(h=>{if(h===void 0)return!1;if(h===!0||(a.data===null&&t&&z.DownloadHistory(e).map(p=>p.map(v=>Number(v.tags["_last_edit:contributor:uid"]))).addCallbackAndRunD(p=>u.setData(p)),a.data===!0))return!0;if(a.data===!1)return!1},[a]),l=new I(null),f=new I(null);r.addCallbackAndRunD(h=>{if(h===!1)return n.setData({canBeDeleted:!1,reason:s.notEnoughExperience}),!0;if(t)return z.DownloadReferencingRelations(e).then(w=>{l.setData(w.length>0)}),z.DownloadReferencingWays(e).then(w=>{f.setData(w.length>0)}),!0}),l.map(h=>h===!0||f.data===!0?!0:f.data===null||h===null?null:f.data===!1&&h===!1?!1:null,[f]).addCallbackAndRun(h=>{h!=null&&(h?n.setData({canBeDeleted:!1,reason:s.partOfOthers}):n.setData({canBeDeleted:!0,reason:a.data===!0?s.onlyEditedByLoggedInUser:s.safeDelete}))})}}class je extends xe{constructor(s,e){super("relation/"+s.relation.id,!1);m(this,"_input");m(this,"_theme");this._input=s,this._theme=e}async targetNodeAt(s,e){const n=this._input.relation.members[s];if(n!==void 0){if(n.type==="node")return n.ref;if(n.type==="way"){const i=(await z.DownloadObjectAsync("way/"+n.ref)).nodes;return e?i[0]:i[i.length-1]}n.type}}}class on extends je{constructor(t,s){super(t,s)}async CreateChangeDescriptions(t){return this._input.relation.tags.type==="restriction"?new an(this._input,this._theme).CreateChangeDescriptions(t):new Ct(this._input,this._theme).CreateChangeDescriptions(t)}}class an extends je{constructor(t,s){super(t,s)}async CreateChangeDescriptions(t){const s=this._input.relation,e=s.members,n=e.filter(d=>d.type==="way"&&d.ref===this._input.originalWayId);n.length>1&&console.warn("Detected a turn restriction where this way has multiple occurances. This is an error");const o=n[0];if(o.role==="via")return new Ct(this._input,this._theme).CreateChangeDescriptions(t);let i=await this.targetNodeAt(e.indexOf(o),!0),u=await this.targetNodeAt(e.indexOf(o),!1),a=i??u;const r=this._input.allWaysNodesInOrder.map((d,h)=>({nodes:d,id:this._input.allWayIdsInOrder[h]})).filter(d=>{const h=d.nodes;return h[0]==a||h[h.length-1]==a})[0];if(r===void 0)return console.error("No common point found, this was a broken turn restriction!",s.id),[];const l=this._input.originalWayId;if(r.id===l)return console.log("Turn_restriction fixer: the original ID can be kept, nothing to do"),[];const f=s.members.map(d=>d.type==="way"&&d.ref===l?{ref:r.id,type:"way",role:d.role}:d);return[{type:"relation",id:s.id,changes:{members:f},meta:{theme:this._theme,changeType:"relation-fix:turn_restriction"}}]}}class Ct extends je{constructor(t,s){super(t,s)}async CreateChangeDescriptions(t){const s=this._input.originalWayId,e=this._input.relation,n=e.members,o=this._input.originalNodes,i=o[0],u=o[o.length-1],a=[];for(let r=0;r<n.length;r++){const l=n[r];if(l.type!=="way"||l.ref!==s){a.push(l);continue}const f=await this.targetNodeAt(r-1,!1),d=await this.targetNodeAt(r+1,!0);if((f===void 0||f===i)&&(d===void 0||d===u)){for(const g of this._input.allWayIdsInOrder)a.push({ref:g,type:"way",role:l.role});continue}if(f===void 0||f===u||(d===void 0||d===i)){for(let g=this._input.allWayIdsInOrder.length-1;g>=0;g--){const _=this._input.allWayIdsInOrder[g];a.push({ref:_,type:"way",role:l.role})}continue}for(const g of this._input.allWayIdsInOrder)a.push({ref:g,type:"way",role:l.role})}return[{id:e.id,type:"relation",changes:{members:a},meta:{changeType:"relation-fix",theme:this._theme}}]}}class Ge extends xe{constructor(s,e,n,o=5,i){super(s,!0);m(this,"wayId");m(this,"_splitPointsCoordinates");m(this,"_meta");m(this,"_toleranceInMeters");m(this,"_withNewCoordinates");this.wayId=s,this._splitPointsCoordinates=e,this._toleranceInMeters=o,this._withNewCoordinates=i,this._meta={...n,changeType:"split"}}static SegmentSplitInfo(s){const e=[];let n=[];for(const o of s)n.push(o),o.doSplit&&(e.push(n),n=[o]);return e.push(n),e.filter(o=>o.length>0)}async CreateChangeDescriptions(s){const e=await z.DownloadObjectAsync(this.wayId),n=e.nodes,o=this.CalculateSplitCoordinates(e,this._toleranceInMeters);for(const d of o)d.originalIndex>=0?d.originalIndex=e.nodes[d.originalIndex]:d.originalIndex=s.getNewID();const i=Ge.SegmentSplitInfo(o);let u;for(const d of i){if(u===void 0){u=d;continue}d.length>u.length&&(u=d)}const a=[];for(const d of o)d.originalIndex>=0||a.push({type:"node",id:d.originalIndex,changes:{lon:d.lngLat[0],lat:d.lngLat[1]},meta:this._meta});const r=[],l=[];for(const d of i)if(d===u){const w=d.map(v=>v.originalIndex),p=d.map(v=>v.lngLat);a.push({type:"way",id:e.id,changes:{coordinates:p,nodes:w},meta:this._meta}),this._withNewCoordinates&&this._withNewCoordinates(p),r.push(e.id),l.push(w)}else{let w=s.getNewID();const p=[];for(const g in e.tags)e.tags.hasOwnProperty(g)&&(g.startsWith("_")||g==="id"||p.push({k:g,v:e.tags[g]}));const v=d.map(g=>g.originalIndex);if(v.length<=1){console.error("Got a segment with only one node - skipping");continue}a.push({type:"way",id:w,tags:p,changes:{coordinates:d.map(g=>g.lngLat),nodes:v},meta:this._meta}),r.push(w),l.push(v)}const f=await z.DownloadReferencingRelations(this.wayId);for(const d of f){const h=await new on({relation:d,allWayIdsInOrder:r,originalNodes:n,allWaysNodesInOrder:l,originalWayId:e.id},this._meta.theme).CreateChangeDescriptions(s);a.push(...h)}return a}CalculateSplitCoordinates(s,e=5){const n=s.asGeoJson(),o=s.coordinates.map(r=>[r[1],r[0]]),i=this._splitPointsCoordinates.map(r=>{let l=$.nearestPoint(n,r);return{coordinates:r,isSplitPoint:!0,dist:l.properties.dist,location:l.properties.location}});for(let r=0;r<o.length;r++){let l=o[r],f=$.nearestPoint(n,l);i.push({coordinates:l,isSplitPoint:!1,location:f.properties.location,originalIndex:r,dist:f.properties.dist})}i.sort((r,l)=>r.location-l.location);for(let r=i.length-2;r>=1;r--){const l=i[r];if(l.originalIndex!==void 0)continue;const f=i[r+1],d=i[r-1],h=f.location-l.location,w=l.location-d.location;if(h*1e3>e&&w*1e3>e)continue;let p=f;h>w&&(p=d),!(p.originalIndex===0||p.originalIndex===o.length)&&(p.isSplitPoint=!0,i.splice(r,1))}const u=[];let a=-1;for(const r of i){let l=r.originalIndex;l===void 0&&(l=a,a--);const f={originalIndex:l,lngLat:r.coordinates,doSplit:r.isSplitPoint};u.push(f)}return u}}const rn="split_point",ln="Layer rendering the little scissors for the minimap in the 'splitRoadWizard'",cn=1,un={osmTags:"_split_point=yes"},dn="Split point",fn="Split point",hn=[{location:["point","centroid"],icon:"circle:white;./assets/svg/scissors.svg",iconSize:"30,30,center"}],mn={id:rn,description:ln,minzoom:cn,source:un,name:dn,title:fn,mapRendering:hn},me=class extends C{constructor(s,e){const n=T.t.split,o=new I([]),i=new I(!1),u=new I(!1),a=new I(me.setupMapComponent(s,o,e)),r=new q(O.scissors_ui().SetStyle("height: 1.5rem; width: auto"),new B(n.splitAgain.Clone().SetClass("text-lg font-bold"),n.inviteToSplit.Clone().SetClass("text-lg font-bold"),i)),l=new Ne(r,n.loginToSplit.Clone(),e),f=new Ze(n.split.Clone(),async()=>{var k;i.setData(!0),u.setData(!1);const _=new Ge(s,o.data.map(A=>A.feature.geometry.coordinates),{theme:(k=e==null?void 0:e.layoutToUse)==null?void 0:k.id},5,A=>{e.allElements.ContainingFeatures.get(s).geometry.coordinates=A});await e.changes.applyAction(_),o.setData([]),a.setData(me.setupMapComponent(s,o,e)),ht.collapse()});f.SetClass("btn btn-primary mr-3");const d=new Ze(n.split.Clone(),void 0);d.SetClass("btn btn-disabled mr-3");const h=new B(d,f,o.map(_=>_.length===0)),w=T.t.general.cancel.Clone().SetClass("btn btn-secondary mr-3").onClick(()=>{o.setData([]),u.setData(!1)});w.SetClass("btn btn-secondary block");const p=new ue(n.splitTitle),v=new C([p,new E(a),new C([w,h]).SetClass("flex flex-row")]);v.SetClass("question");super([B.If(i,()=>n.hasBeenSplit.Clone().SetClass("font-bold thanks block w-full")),new B(v,l,u)]);m(this,"dialogIsOpened");this.dialogIsOpened=u;const g=this;r.onClick(()=>{u.setData(!0),g.ScrollIntoView()})}static setupMapComponent(s,e,n){const o=n.allElements.ContainingFeatures.get(s),i=zt.createMiniMap({background:n.backgroundLayer,allowMoving:!0,leafletOptions:{minZoom:14}});i.SetStyle("width: 100%; height: 24rem").SetClass("rounded-xl overflow-hidden"),i.installBounds(U.get(o).pad(.25),!1),new $t({features:De.fromGeojson([o]),layers:n.filteredLayers,leafletMap:i.leafletMap,zoomToFeatures:!0,state:n}),new ke({features:new De(e),leafletMap:i.leafletMap,zoomToFeatures:!1,layerToShow:me.splitLayerStyling,state:n});function u(a){const r=e.data.map((f,d)=>[f.feature,d]).filter(f=>$.distanceBetween(f[0].geometry.coordinates,a)<5).map(f=>f[1]).sort((f,d)=>f-d).reverse();if(r.length>0){for(const f of r)e.data.splice(f,1);e.ping();return}const l=$.nearestPoint(o,a);l.properties._split_point="yes",e.data.push({feature:l,freshness:new Date}),e.ping()}return i.leafletMap.addCallbackAndRunD(a=>a.on("click",r=>{u([r.latlng.lng,r.latlng.lat])})),i}};let ve=me;m(ve,"splitLayerStyling",new dt(mn,"(BUILTIN) SplitRoadWizard.ts",!0));class pn extends xe{constructor(s,e,n){super(s,!0);m(this,"_id");m(this,"_newLonLat");m(this,"_meta");if(!s.startsWith("node/"))throw"Invalid ID: only 'node/number' is accepted";this._id=Number(s.substring(5)),this._newLonLat=e,this._meta=n}async CreateChangeDescriptions(s){return[{changes:{lat:this._newLonLat[1],lon:this._newLonLat[0]},type:"node",id:this._id,meta:{changeType:"move",theme:this._meta.theme,specialMotivation:this._meta.reason}}]}}const Ue=class{static async Search(t){var n,o;const s=((o=(n=Se==null?void 0:Se.state)==null?void 0:n.currentBounds)==null?void 0:o.data)??U.global,e=Ue.host+`format=json&limit=1&viewbox=${s.getEast()},${s.getNorth()},${s.getWest()},${s.getSouth()}&accept-language=nl&q=`+t;return de.downloadJson(e)}};let Ce=Ue;m(Ce,"host","https://nominatim.openstreetmap.org/search?");class gn extends C{constructor(s){const e=O.search_ui().SetClass("w-8 h-8 full-rounded border-black float-right"),n=new I(T.t.general.search.search),o=new yt({placeholder:n.map(u=>u.textFor(Te.language.data),[Te.language]),value:new I(""),inputStyle:` background: transparent;
    border: none;
    font-size: large;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    color: var(--foreground-color);`});o.SetClass("relative float-left mt-0 ml-2"),o.SetStyle("width: calc(100% - 3em);height: 100%");super([o,e]);m(this,"_searchField");this.SetClass("block h-8"),this.SetStyle("background: var(--background-color); color: var(--foreground-color); pointer-evetns:all;");async function i(){var a;const u=o.GetValue().data;if(!(u===void 0||u==="")){o.GetValue().setData(""),n.setData(T.t.general.search.searching);try{const r=await Ce.Search(u);if(console.log("Search result",r),r.length==0){n.setData(T.t.general.search.nothing);return}const l=r[0],f=l.boundingbox,d=[[f[0],f[2]],[f[1],f[3]]];(a=s.selectedElement)==null||a.setData(void 0),pt.hash.setData(l.osm_type+"/"+l.osm_id),s.leafletMap.data.fitBounds(d),n.setData(T.t.general.search.search)}catch{o.GetValue().setData(""),n.setData(T.t.general.search.error)}}}o.enterPressed.addCallback(i),this._searchField=o,e.onClick(i)}focus(){this._searchField.focus()}}class wn extends B{constructor(t,s,e){const n=T.t.move;new B(n.loginToMove.SetClass("btn").onClick(()=>s.osmConnection.AttemptLogin()),void 0,s.featureSwitchUserbadge);const o=[];e.enableRelocation&&o.push({text:n.reasons.reasonRelocation,invitingText:n.inviteToMove.reasonRelocation,icon:O.relocation_svg(),changesetCommentValue:"relocated",lockBounds:!1,background:void 0,includeSearch:!0,startZoom:12,minZoom:6,eraseAddressFields:!0}),e.enableImproveAccuracy&&o.push({text:n.reasons.reasonInaccurate,invitingText:n.inviteToMove.reasonInaccurate,icon:O.crosshair_svg(),changesetCommentValue:"improve_accuracy",lockBounds:!0,includeSearch:!1,background:"photo",startZoom:17,minZoom:16,eraseAddressFields:!1});const i=new I("start"),u=new I(void 0);let a;if(o.length===1){const b=o[0];u.setData(b),a=new q(b.icon.SetStyle("height: 1.5rem; width: 1.5rem;"),T.T(b.invitingText)).onClick(()=>{i.setData("pick_location")})}else a=new q(O.move_ui().SetStyle("width: 1.5rem; height: 1.5rem"),n.inviteToMove.generic).onClick(()=>{i.setData("reason")});const r=new q(O.move_ui(),n.inviteToMoveAgain).onClick(()=>{i.setData("reason")}),l=new C(o.map(b=>new q(b.icon,b.text).onClick(()=>{u.setData(b),i.setData("pick_location")}))),f=new q(O.close_svg(),n.cancel).onClick(()=>i.setData("start")),[d,h]=$.centerpointCoordinates(t),w=u.map(b=>{if(b===void 0)return;const K=new I({lon:d,lat:h,zoom:(b==null?void 0:b.startZoom)??16});let J;typeof b.background=="string"?J=[b.background]:J=b.background;const Tt=Ut.SelectBestLayerAccordingTo(K,new I(J)).data,se=new Ot({minZoom:b.minZoom,centerLocation:K,mapBackground:new I(Tt),state:s});b.lockBounds&&se.installBounds(.05,!0);let Ve;b.includeSearch&&(Ve=new gn({leafletMap:se.leafletMap})),se.SetStyle("height: 17.5rem");const Qe=new q(O.move_confirm_svg(),n.confirmMove);Qe.onClick(async()=>{const oe=se.GetValue().data;await s.changes.applyAction(new pn(t.properties.id,[oe.lon,oe.lat],{reason:b.changesetCommentValue,theme:s.layoutToUse.id})),t.properties._lat=oe.lat,t.properties._lon=oe.lon,b.eraseAddressFields&&await s.changes.applyAction(new Pe(t.properties.id,new bt([new ae("addr:housenumber",""),new ae("addr:street",""),new ae("addr:city",""),new ae("addr:postcode","")]),t.properties,{changeType:"relocated",theme:s.layoutToUse.id})),s.allElements.getEventSourceById(g).ping(),i.setData("moved")});const It=n.zoomInFurther.SetClass("alert block m-6");return new C([Ve,se,new B(Qe,It,se.GetValue().map(oe=>oe.zoom>=19))]).SetClass("flex flex-col")}),p="p-2 md:p-4 m-2 border border-gray-400 rounded-xl flex flex-col",v=new Ne(new E(i.map(b=>{switch(b){case"start":return a;case"reason":return new C([n.whyMove.SetClass("text-lg font-bold"),l,f]).SetClass(p);case"pick_location":return new C([n.moveTitle.SetClass("text-lg font-bold"),new E(w),f]).SetClass(p);case"moved":return new C([n.pointIsMoved.SetClass("thanks"),r]).SetClass("flex flex-col")}})),void 0,s);let g=t.properties.id;const _=s.osmConnection._oauth_config.url;g.startsWith(_)&&(g=g.substring(_.length));const k=new I(void 0);g.startsWith("way")?k.setData(n.isWay):g.startsWith("relation")?k.setData(n.isRelation):g.indexOf("-")<0&&(z.DownloadReferencingWays(g).then(b=>{b.length>0&&(console.log("Got a referencing way, move not allowed"),k.setData(n.partOfAWay))}),z.DownloadReferencingRelations(g).then(b=>{b.length>0&&k.setData(n.partOfRelation)})),super(v,new C([O.move_not_allowed_svg().SetStyle("height: 2rem").SetClass("m-2"),new C([n.cannotBeMoved,new E(k).SetClass("subtle")]).SetClass("flex flex-col")]).SetClass("flex m-2 p-2 rounded-lg bg-gray-200"),k.map(b=>b===void 0));const A=this;i.addCallback(b=>{b!=="start"&&A.ScrollIntoView()})}}class Y extends ht{constructor(t,s,e,n){if(e===void 0)throw"State is undefined!";const o=e.featureSwitchShowAllQuestions.map(i=>i||e.showAllQuestionsAtOnce.data,[e.showAllQuestionsAtOnce]);if(super(()=>Y.GenerateTitleBar(t,s,e),()=>Y.GenerateContent(t,s,e,o),(n==null?void 0:n.hashToShow)??t.data.id??"item",n==null?void 0:n.isShown,n),s===void 0)throw"Undefined layerconfig"}static GenerateTitleBar(t,s,e){const n=new X(t,s.title??new ge("POI"),e).SetClass("break-words font-bold sm:p-0.5 md:p-1 sm:p-1.5 md:p-2 text-2xl"),o=new C(s.titleIcons.map(i=>new X(t,i,e,"block h-8 max-h-8 align-baseline box-content sm:p-0.5 titleicon"))).SetClass("flex flex-row flex-wrap pt-0.5 sm:pt-1 items-center mr-2");return new C([new C([n,o]).SetClass("flex flex-col sm:flex-row flex-grow justify-between")])}static GenerateContent(t,s,e,n){return new B(new C([O.delete_icon_svg().SetClass("w-8 h-8"),T.t.delete.isDeleted]).SetClass("flex justify-center font-bold items-center"),Y.GenerateMainContent(t,s,e,n),t.map(o=>o._deleted=="yes"))}static GenerateMainContent(t,s,e,n){var l,f;let o=new Map;const i=T.t.general,u=de.Dedup(s.tagRenderings.map(d=>d.group));if(((l=e==null?void 0:e.featureSwitchUserbadge)==null?void 0:l.data)??!0){const d=s.tagRenderings.filter(h=>h.id==="questions");for(const h of u){const w=s.tagRenderings.filter(g=>g.group===h),p=d.filter(g=>g.group===h)[0],v=new tn(e,{tagsSource:t,tagRenderings:w,units:s.units,showAllQuestionsAtOnce:((f=p==null?void 0:p.freeform)==null?void 0:f.helperArgs.showAllQuestions)??n});o.set(h,v)}}const a=s.tagRenderings.filter(d=>d.question!==void 0).length,r=[new E(t.map(d=>d[ae.newlyCreated.key]).map(d=>{if(d===void 0)return;const h=new Date(d);if((Date.now()-h.getTime())/1e3>=60*5)return;const p=[],v=new C([O.party_svg().SetClass("w-12 h-12 shrink-0 p-1 m-1 bg-white rounded-full block"),i.newlyCreated]).SetClass("flex w-full thanks content-center");return p.push(v),a>0&&p.push(i.feelFreeToSkip),new C(p).SetClass("pb-4 mb-4 border-b block border-black")}))];for(let d=0;d<u.length;d++){const h=u[d],w=s.tagRenderings.filter(g=>g.group===h),p=[],v="block w-full break-word text-default m-1 p-1 border-b border-gray-200 mb-2 pb-2";for(const g of w)if(g.question===null||g.id==="questions"){const _=o.get(g.group);if(o.delete(g.group),g.render!==void 0){_.SetClass("text-sm");const k=new X(t,g,e,g.group+" questions","",{specialViz:new Map([["questions",_]])}),A=new B(k,void 0,_.restingQuestions.map(b=>(b==null?void 0:b.length)>0));p.push(A)}else p.push(_)}else{let _=p.length===0&&d>0;const k=new Rt(t,g,s.units,e,{innerElementClasses:v});_&&k.SetClass("sticky top-0"),p.push(k)}r.push(...p)}return r.push(new B(new vt(()=>Y.createEditElements(o,s,t,e)),void 0,e.featureSwitchUserbadge)),new C(r).SetClass("block")}static createEditElements(t,s,e,n){let o=[];return t.forEach(i=>{o.push(i)}),s.allowMove&&o.push(new E(e.map(i=>i.id).map(i=>{const u=n.allElements.ContainingFeatures.get(i);return u===void 0?"This feature is not register in the state.allElements and cannot be moved":new wn(u,n,s.allowMove)})).SetClass("text-base")),s.deletion&&o.push(new E(e.map(i=>i.id).map(i=>new he(i,n,s.deletion))).SetClass("text-base")),s.allowSplit&&o.push(new E(e.map(i=>i.id).map(i=>new ve(i,n))).SetClass("text-base")),o.push(new E(n.osmConnection.userDetails.map(i=>i.csCount).map(i=>{if(!(i<=ce.userJourney.historyLinkVisible&&n.featureSwitchIsDebugging.data==!1&&n.featureSwitchIsTesting.data===!1))return new X(e,At.SharedTagRendering.get("last_edit"),n)},[n.featureSwitchIsDebugging,n.featureSwitchIsTesting]))),o.push(B.If(n.featureSwitchIsDebugging,()=>{const i=new ge({render:"{all_tags()}"},""),u=new ge({render:"{export_as_geojson()}"},""),a=new ge({render:"{open_in_iD()}"},"");return new C([new X(e,i,n),new X(e,u,n),new X(e,a,n),"This is layer "+s.id])})),new C(o).SetClass("flex flex-col")}}class _n{constructor(){m(this,"_name","enclosingFeatures");m(this,"_doc",["Gives a list of all features in the specified layers which fully contain this object. Returned features will always be (multi)polygons. (LineStrings and Points from the other layers are ignored)","","The result is a list of features: `{feat: Polygon}[]`","This function will never return the feature itself."].join(`
`));m(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for overlap)"])}_f(t,s){return(...e)=>{const n=[],o=U.get(s),i=new Set;i.add(s.properties.id);for(const u of e){const a=t.getFeaturesWithin(u,o);if(a!==void 0&&a.length!==0)for(const r of a)for(const l of r)i.has(l.properties.id)||(i.add(l.properties.id),!(l.geometry.type!=="Polygon"&&l.geometry.type!=="MultiPolygon")&&$.completelyWithin(s,l)&&n.push({feat:l}))}return n}}}class bn{constructor(){m(this,"_name","overlapWith");m(this,"_doc",["Gives a list of features from the specified layer which this feature (partly) overlaps with. A point which is embedded in the feature is detected as well.","If the current feature is a point, all features that this point is embeded in are given.","","The returned value is `{ feat: GeoJSONFeature, overlap: number}[]` where `overlap` is the overlapping surface are (in m²) for areas, the overlapping length (in meter) if the current feature is a line or `undefined` if the current feature is a point.","The resulting list is sorted in descending order by overlap. The feature with the most overlap will thus be the first in the list.","","For example to get all objects which overlap or embed from a layer, use `_contained_climbing_routes_properties=feat.overlapWith('climbing_route')`","","Also see [enclosingFeatures](#enclosingFeatures) which can be used to get all objects which fully contain this feature"].join(`
`));m(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for overlap)"])}_f(t,s){return(...e)=>{const n=[],o=new Set,i=U.get(s);for(const u of e){const a=t.getFeaturesWithin(u,i);if(a!==void 0&&a.length!==0)for(const r of a){const l=$.calculateOverlap(s,r);for(const f of l)o.has(f.feat.properties.id)||(o.add(f.feat.properties.id),n.push(f))}}return n.sort((u,a)=>a.overlap-u.overlap),n}}}class yn{constructor(){m(this,"_name","intersectionsWith");m(this,"_doc",`Gives the intersection points with selected features. Only works with (Multi)Polygons and LineStrings.

Returns a \`{feat: GeoJson, intersections: [number,number][]}\` where \`feat\` is the full, original feature. This list is in random order.

If the current feature is a point, this function will return an empty list.
Points from other layers are ignored - even if the points are parts of the current linestring.`);m(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for intersection)"])}_f(t,s){return(...e)=>{const n=[],o=U.get(s);for(const i of e){const u=t.getFeaturesWithin(i,o);if(u!==void 0&&u.length!==0)for(const a of u)for(const r of a){const l=$.LineIntersections(s,r);l.length!==0&&n.push({feat:r,intersections:l})}}return n}}}class vn{constructor(){m(this,"_name","distanceTo");m(this,"_doc","Calculates the distance between the feature and a specified point in meter. The input should either be a pair of coordinates, a geojson feature or the ID of an object");m(this,"_args",["feature OR featureID OR longitude","undefined OR latitude"])}_f(t,s){return(e,n)=>{if(e!==void 0){if(typeof e=="number")return $.distanceBetween([e,n],$.centerpointCoordinates(s));if(typeof e=="string"){const o=t.getFeatureById(e);if(o===void 0)return;e=o}return $.distanceBetween($.centerpointCoordinates(e),$.centerpointCoordinates(s))}}}}class Cn{constructor(){m(this,"_name","closest");m(this,"_doc","Given either a list of geojson features or a single layer name, gives the single object which is nearest to the feature. In the case of ways/polygons, only the centerpoint is considered. Returns a single geojson feature or undefined if nothing is found (or not yet loaded)");m(this,"_args",["list of features or a layer name or '*' to get all features"])}_f(t,s){return e=>{var n,o;return(o=(n=Fe.GetClosestNFeatures(t,s,e))==null?void 0:n[0])==null?void 0:o.feat}}}class Fe{constructor(){m(this,"_name","closestn");m(this,"_doc","Given either a list of geojson features or a single layer name, gives the n closest objects which are nearest to the feature (excluding the feature itself). In the case of ways/polygons, only the centerpoint is considered. Returns a list of `{feat: geojson, distance:number}` the empty list if nothing is found (or not yet loaded)\n\nIf a 'unique tag key' is given, the tag with this key will only appear once (e.g. if 'name' is given, all features will have a different name)");m(this,"_args",["list of features or layer name or '*' to get all features","amount of features","unique tag key (optional)","maxDistanceInMeters (optional)"])}static GetClosestNFeatures(t,s,e,n){const o=(n==null?void 0:n.maxFeatures)??1,i=(n==null?void 0:n.maxDistance)??500,u=n==null?void 0:n.uniqueTag;if(typeof e=="string"){const l=e,f=$.bbox($.buffer($.bbox(s),i));e=t.getFeaturesWithin(l,new U(f.geometry.coordinates))}else e=[e];if(e===void 0)return;const a=$.centerpointCoordinates(s);let r=[];for(const l of e)for(const f of l){if(f===s||f.properties.id===s.properties.id)continue;const d=$.distanceBetween($.centerpointCoordinates(f),a);if(d==null||isNaN(d))throw console.error("Could not calculate the distance between",s,"and",f),"Undefined distance!";if(d===0&&console.trace("Got a suspiciously zero distance between",f,"and self-feature",s),d>i)continue;if(r.length===0){r.push({feat:f,distance:d});continue}if(r.length>=o&&r[o-1].distance<d)continue;let h=r.length;for(let w=0;w<r.length;w++){const p=r[w];if(u!==void 0&&f.properties[u]!==void 0&&p.feat.properties[u]===f.properties[u]){h=-1,p.distance>d&&(r[w]={feat:f,distance:d});break}if(p.distance>d){if(h=w,u!==void 0){const v=f.properties[u];for(let g=w;g<r.length;g++)r[g].feat.properties[u]===v&&r.splice(g,1)}break}}h!=-1&&(h<o?(r.splice(h,0,{feat:f,distance:d}),r.length>=o&&r.splice(o,1)):r[h]={feat:f,distance:d})}return r}_f(t,s){return(e,n,o,i)=>{let u=Number(i);return isNaN(u)&&(u=void 0),Fe.GetClosestNFeatures(t,s,e,{maxFeatures:Number(n),uniqueTag:o,maxDistance:u})}}}class Sn{constructor(){m(this,"_name","memberships");m(this,"_doc","Gives a list of `{role: string, relation: Relation}`-objects, containing all the relations that this feature is part of. \n\nFor example: `_part_of_walking_routes=feat.memberships().map(r => r.relation.tags.name).join(';')`");m(this,"_args",[])}_f(t,s){return()=>t.memberships.knownRelations.data.get(s.properties.id)??[]}}class Dn{constructor(){m(this,"_name","get");m(this,"_doc","Gets the property of the feature, parses it (as JSON) and returns it. Might return 'undefined' if not defined, null, ...");m(this,"_args",["key"])}_f(t,s){return e=>{const n=s.properties[e];if(n!==void 0)try{const o=JSON.parse(n);return o===null?void 0:o}catch(o){console.warn("Could not parse property "+e+" due to: "+o+", the value is "+n);return}}}}const le=class{static FullPatchFeature(t,s){if(!s._is_patched){s._is_patched=!0;for(const e of le.allFuncs)s[e._name]=e._f(t,s)}}static HelpText(){const t=[];for(const s of le.allFuncs)t.push(new ue(s._name,3),s._doc,new we(s._args??[],!0));return new C([le.intro,new we(le.allFuncs.map(s=>`[${s._name}](#${s._name})`)),...t])}};let fe=le;m(fe,"intro",new C([new ue("Calculating tags with Javascript",2),"In some cases, it is useful to have some tags calculated based on other properties. Some useful tags are available by default (e.g. `lat`, `lon`, `_country`), as detailed above.","It is also possible to calculate your own tags - but this requires some javascript knowledge.","","Before proceeding, some warnings:",new we(["DO NOT DO THIS AS BEGINNER","**Only do this if all other techniques fail**  This should _not_ be done to create a rendering effect, only to calculate a specific value","**THIS MIGHT BE DISABLED WITHOUT ANY NOTICE ON UNOFFICIAL THEMES** As unofficial themes might be loaded from the internet, this is the equivalent of injecting arbitrary code into the client. It'll be disabled if abuse occurs."]),"To enable this feature,  add a field `calculatedTags` in the layer object, e.g.:","````",'"calculatedTags": [','    "_someKey=javascript-expression",','    "name=feat.properties.name ?? feat.properties.ref ?? feat.properties.operator",',`    "_distanceCloserThen3Km=feat.distanceTo( some_lon, some_lat) < 3 ? 'yes' : 'no'" `,"  ]","````","","The above code will be executed for every feature in the layer. The feature is accessible as `feat` and is an amended geojson object:",new we(["`area` contains the surface area (in square meters) of the object","`lat` and `lon` contain the latitude and longitude"]),"Some advanced functions are available on **feat** as well:"]).SetClass("flex-col").AsMarkdown()),m(fe,"allFuncs",[new vn,new bn,new _n,new yn,new Cn,new Fe,new Sn,new Dn]);const j=class{static addMetatags(t,s,e,n,o){var r,l;if(t===void 0||t.length===0)return;console.log("Recalculating metatags...");const i=[];for(const f of Vt.metatags)f.includesDates?((o==null?void 0:o.includeDates)??!0)&&i.push(f):((o==null?void 0:o.includeNonDates)??!0)&&i.push(f);const u=this.createRetaggingFunc(e,n);let a=!1;for(let f=0;f<t.length;f++){const d=t[f],h=d.feature,w=d.freshness;let p=!1,v=new Set(Object.getOwnPropertyNames(h.properties));for(const g of i)try{if(!g.keys.some(_=>h.properties[_]===void 0))continue;if(g.isLazy){if(!g.keys.some(_=>!v.has(_)))continue;if(p=!0,g.applyMetaTagsOnFeature(h,w,e,n),o!=null&&o.evaluateStrict)for(const _ of g.keys)h.properties[_]}else p=g.applyMetaTagsOnFeature(h,w,e,n)||p}catch(_){console.error("Could not calculate metatag for ",g.keys.join(","),":",_,_.stack)}if(u!==void 0){let g=!1;try{g=u(s,h)}catch(_){console.error(_)}p=p||g}p&&((l=(r=n==null?void 0:n.allElements)==null?void 0:r.getEventSourceById(h.properties.id))==null||l.ping(),a=!0)}return a}static createFunctionsForFeature(t,s){const e=[];for(const n of s){const o=n[0],i=n[1],u=n[2];if(i===void 0)continue;const a=l=>{try{let f=new Function("feat","return "+i+";")(l);return f!==void 0&&typeof f!="string"&&(f=JSON.stringify(f)),delete l.properties[o],l.properties[o]=f,f}catch(f){j.errorPrintCount<j.stopErrorOutputAt&&(console.warn("Could not calculate a "+(u?"strict ":"")+" calculated tag for key "+o+" defined by "+i+" (in layer"+t+`) due to 
`+f+`
. Are you the theme creator? Doublecheck your code. Note that the metatags might not be stable on new features`,f,f.stack),j.errorPrintCount++,j.errorPrintCount==j.stopErrorOutputAt&&console.error("Got ",j.stopErrorOutputAt," errors calculating this metatagging - stopping output now"));return}};if(u){e.push(a);continue}const r=l=>{delete l.properties[o],Object.defineProperty(l.properties,o,{configurable:!0,enumerable:!1,get:function(){return a(l)}})};e.push(r)}return e}static createRetaggingFunc(t,s){const e=t.calculatedTags;if(e===void 0||e.length===0)return;let n=j.retaggingFuncCache.get(t.id);return n===void 0&&(n=j.createFunctionsForFeature(t.id,e),j.retaggingFuncCache.set(t.id,n)),(o,i)=>{if(i.properties!==void 0){try{fe.FullPatchFeature(o,i);for(const a of n)a(i)}catch(a){console.error("Invalid syntax in calculated tags or some other error: ",a)}return!0}}}};let ie=j;m(ie,"errorPrintCount",0),m(ie,"stopErrorOutputAt",10),m(ie,"retaggingFuncCache",new Map);class Ke{constructor(t,s,e){m(this,"neededLayerBboxes",new Map);m(this,"source");m(this,"params");m(this,"state");m(this,"isDirty",new I(!1));this.state=s,this.source=t;const n=this;this.params={getFeatureById(o){return s.allElements.ContainingFeatures.get(o)},getFeaturesWithin(o,i){let u=n.neededLayerBboxes.get(o);return u===void 0?n.neededLayerBboxes.set(o,i):i.isContainedIn(u)||n.neededLayerBboxes.set(o,u.unionWith(i)),e.GetFeaturesWithin(o,i)},memberships:e.relationTracker},this.isDirty.stabilized(100).addCallback(o=>{o&&n.updateMetaTags()}),this.source.features.addCallbackAndRunD(o=>n.isDirty.setData(!0))}requestUpdate(){this.isDirty.setData(!0)}updateMetaTags(){const t=this.source.features.data;if(t.length===0){this.isDirty.setData(!1);return}ie.addMetatags(t,this.params,this.source.layer.layerDef,this.state),this.isDirty.setData(!1)}}class kn{constructor(t,s){m(this,"_state");m(this,"_featurePipeline");m(this,"_alreadyRegistered",new Set);m(this,"_notifiers",[]);if(this._featurePipeline=s,this._state=t,t.currentView!==void 0){const e=new Ke(t.currentView,this._state,this._featurePipeline);this._alreadyRegistered.add(t.currentView),this._notifiers.push(e),t.currentView.features.addCallback(n=>{console.debug("Requesting an update for currentView"),e.updateMetaTags()})}}registerSource(t,s=!1){if(t===void 0||this._alreadyRegistered.has(t))return;this._alreadyRegistered.add(t),this._notifiers.push(new Ke(t,this._state,this._featurePipeline));const e=this;t.features.addCallbackAndRunD(n=>{const o=t.layer.layerDef.id;for(const i of e._notifiers){const u=i.neededLayerBboxes.get(o);u!=null&&(t.bbox===void 0||u.overlapsWith(t.bbox))&&i.requestUpdate()}})}}class Tn extends Bt{constructor(s){super(s);m(this,"featurePipeline");m(this,"featureAggregator");m(this,"metatagRecalculator");m(this,"popups",new Map);const e=s==null?void 0:s.clustering;this.featureAggregator=_e.createHierarchy(this);const n=this.featureAggregator,o=this,i=[];function u(r){o.metatagRecalculator===void 0?i.push(r):o.metatagRecalculator.registerSource(r)}function a(r){n.addTile(r);const l=r.features.map(d=>U.bboxAroundAll(d.map(h=>U.get(h.feature)))),f=r.features.map(d=>{var _;const h=o.locationControl.data.zoom;if(!r.layer.isDisplayed.data)return!1;const w=o.currentBounds.data;if(w===void 0||!l.data.overlapsWith(w)||h<r.layer.layerDef.minzoom)return!1;if(h>e.maxZoom)return!0;if(d.length>e.minNeededElements)return!1;let[p,v,g]=Z.tile_from_index(r.tileIndex);if(p>=h){for(;p>h;)p--,v=Math.floor(v/2),g=Math.floor(g/2);if(((_=n.getTile(Z.tile_index(p,v,g)))==null?void 0:_.totalValue)>e.minNeededElements)return!1}return!0},[o.currentBounds,r.layer.isDisplayed,l]);new ke({features:r,leafletMap:o.leafletMap,layerToShow:r.layer.layerDef,doShowLayer:f,selectedElement:o.selectedElement,state:o,popup:(d,h)=>o.CreatePopup(d,h)})}this.featurePipeline=new Pt(a,this,{handleRawFeatureSource:u}),this.metatagRecalculator=new kn(this,this.featurePipeline),this.metatagRecalculator.registerSource(this.currentView,!0),i.forEach(r=>o.metatagRecalculator.registerSource(r)),new ye(pt.hash,this),this.AddClusteringToMap(this.leafletMap)}CreatePopup(s,e){if(this.popups.has(s.data.id))return this.popups.get(s.data.id);const n=new Y(s,e,this);return this.popups.set(s.data.id,n),n}AddClusteringToMap(s){const e=this.layoutToUse.clustering,n=this;new ke({features:this.featureAggregator.getCountsForZoom(e,this.locationControl,e.minNeededElements),leafletMap:s,layerToShow:be.styling,popup:this.featureSwitchIsDebugging.data?(o,i)=>new Y(o,i,n):void 0,state:this})}}class Se extends Tn{constructor(t){super(t)}}m(Se,"state");function In(c){let t,s,e;return s=new Ee({props:{construct:O.search_disable_ui()}}),{c(){t=x("span"),P(s.$$.fragment),D(t,"slot","image"),D(t,"class","svelte-1aqsasq")},m(n,o){M(n,t,o),L(s,t,null),e=!0},p:H,i(n){e||(y(s.$$.fragment,n),e=!0)},o(n){S(s.$$.fragment,n),e=!1},d(n){n&&F(t),N(s)}}}function xn(c){let t;return{c(){t=x("span"),t.textContent=`${c[1].noSearch.toString()}`,D(t,"slot","message"),D(t,"class","svelte-1aqsasq")},m(s,e){M(s,t,e)},p:H,d(s){s&&F(t)}}}function Mn(c){let t,s,e,n,o,i,u,a,r;return i=new pe({props:{$$slots:{message:[xn],image:[In]},$$scope:{ctx:c}}}),{c(){t=x("span"),s=x("h5"),s.textContent=`${c[1].noMatchingThemes.toString()}`,e=W(),n=x("button"),o=x("span"),P(i.$$.fragment),D(s,"class","svelte-1aqsasq"),D(o,"class","svelte-1aqsasq"),D(n,"class","svelte-1aqsasq"),D(t,"class","svelte-1aqsasq")},m(l,f){M(l,t,f),R(t,s),R(t,e),R(t,n),R(n,o),L(i,o,null),u=!0,a||(r=Lt(n,"click",c[2]),a=!0)},p(l,[f]){const d={};f&8&&(d.$$scope={dirty:f,ctx:l}),i.$set(d)},i(l){u||(y(i.$$.fragment,l),u=!0)},o(l){S(i.$$.fragment,l),u=!1},d(l){l&&F(t),N(i),a=!1,r()}}}function Fn(c,t,s){let{search:e}=t;const n=T.t.general.morescreen,o=()=>{e.setData("")};return c.$$set=i=>{"search"in i&&s(0,e=i.search)},[e,n,o]}class $n extends ee{constructor(t){super(),te(this,t,Fn,Mn,ne,{search:0})}}function On(c){let t,s;return t=new pe({props:{options:{url:"https://pietervdvn.github.io/mc/legacy/070/customGenerator.html"},$$slots:{message:[Bn],image:[An]},$$scope:{ctx:c}}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,n){const o={};n&8&&(o.$$scope={dirty:n,ctx:e}),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}function Rn(c){let t,s;return t=new pe({props:{options:{url:"https://github.com/pietervdvn/MapComplete/issues",newTab:!0},$$slots:{message:[Pn]},$$scope:{ctx:c}}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,n){const o={};n&8&&(o.$$scope={dirty:n,ctx:e}),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}function An(c){let t,s,e;return s=new Ee({props:{construct:O.pencil_ui()}}),{c(){t=x("span"),P(s.$$.fragment),D(t,"slot","image"),D(t,"class","h-11 w-11 mx-4 bg-red")},m(n,o){M(n,t,o),L(s,t,null),e=!0},p:H,i(n){e||(y(s.$$.fragment,n),e=!0)},o(n){S(s.$$.fragment,n),e=!1},d(n){n&&F(t),N(s)}}}function Bn(c){let t;return{c(){t=x("span"),t.textContent=`${c[2].createYourOwnTheme.toString()}`,D(t,"slot","message")},m(s,e){M(s,t,e)},p:H,d(s){s&&F(t)}}}function Pn(c){let t;return{c(){t=x("span"),t.textContent=`${c[2].requestATheme.toString()}`,D(t,"slot","message")},m(s,e){M(s,t,e)},p:H,d(s){s&&F(t)}}}function Ln(c){let t,s,e,n;const o=[Rn,On],i=[];function u(a,r){return a[1].csCount<ce.userJourney.themeGeneratorReadOnlyUnlock?0:1}return s=u(c),e=i[s]=o[s](c),{c(){t=x("div"),e.c()},m(a,r){M(a,t,r),i[s].m(t,null),n=!0},p(a,[r]){let l=s;s=u(a),s===l?i[s].p(a,r):(V(),S(i[l],1,1,()=>{i[l]=null}),Q(),e=i[s],e?e.p(a,r):(e=i[s]=o[s](a),e.c()),y(e,1),e.m(t,null))},i(a){n||(y(e),n=!0)},o(a){S(e),n=!1},d(a){a&&F(t),i[s].d()}}}function Nn(c,t,s){let e,n=H,o=()=>(n(),n=Le(i,a=>s(1,e=a)),i);c.$$.on_destroy.push(()=>n());let{userDetails:i}=t;o();const u=T.t.general.morescreen;return console.log(e.csCount<50),c.$$set=a=>{"userDetails"in a&&o(s(0,i=a.userDetails))},[i,e,u]}class St extends ee{constructor(t){super(),te(this,t,Nn,Ln,ne,{userDetails:0})}}function En(c){let t;return{c(){t=x("span"),t.textContent=`${c[0].button.toString()}`,D(t,"slot","message")},m(s,e){M(s,t,e)},p:H,d(s){s&&F(t)}}}function jn(c){let t,s,e,n,o,i,u;return s=new Ee({props:{construct:new ue(c[0].hook,4)}}),i=new pe({props:{options:{url:"./professional.html"},$$slots:{message:[En]},$$scope:{ctx:c}}}),{c(){t=x("div"),P(s.$$.fragment),e=W(),n=x("span"),n.textContent=`${c[0].hookMore.toString()}`,o=W(),P(i.$$.fragment),D(t,"class","svelte-1rzxcyx")},m(a,r){M(a,t,r),L(s,t,null),R(t,e),R(t,n),R(t,o),L(i,t,null),u=!0},p(a,[r]){const l={};r&2&&(l.$$scope={dirty:r,ctx:a}),i.$set(l)},i(a){u||(y(s.$$.fragment,a),y(i.$$.fragment,a),u=!0)},o(a){S(s.$$.fragment,a),S(i.$$.fragment,a),u=!1},d(a){a&&F(t),N(s),N(i)}}}function Gn(c){return[T.t.professional.indexPage]}class Dt extends ee{constructor(t){super(),te(this,t,Gn,jn,ne,{})}}const Xe="personal";function Ye(c){let t,s,e;return s=new pe({props:{options:{url:c[7](c[0],c[1],c[3])},$$slots:{message:[Wn],image:[qn]},$$scope:{ctx:c}}}),{c(){t=x("div"),P(s.$$.fragment),D(t,"class","svelte-1gmg4t2")},m(n,o){M(n,t,o),L(s,t,null),e=!0},p(n,o){const i={};o&11&&(i.options={url:n[7](n[0],n[1],n[3])}),o&305&&(i.$$scope={dirty:o,ctx:n}),s.$set(i)},i(n){e||(y(s.$$.fragment,n),e=!0)},o(n){S(s.$$.fragment,n),e=!1},d(n){n&&F(t),N(s)}}}function qn(c){let t,s;return{c(){t=x("img"),D(t,"slot","image"),He(t.src,s=c[0].icon)||D(t,"src",s),D(t,"class","block h-11 w-11 bg-red mx-4"),D(t,"alt","")},m(e,n){M(e,t,n)},p(e,n){n&1&&!He(t.src,s=e[0].icon)&&D(t,"src",s)},d(e){e&&F(t)}}}function Wn(c){let t,s,e,n,o,i,u;return{c(){t=x("span"),s=x("span"),e=x("span"),n=Ae(c[5]),o=W(),i=x("span"),u=Ae(c[4]),D(e,"class","svelte-1gmg4t2"),D(i,"class","svelte-1gmg4t2"),D(s,"class","svelte-1gmg4t2"),D(t,"slot","message"),D(t,"class","message svelte-1gmg4t2")},m(a,r){M(a,t,r),R(t,s),R(s,e),R(e,n),R(s,o),R(s,i),R(i,u)},p(a,r){r&32&&Be(n,a[5]),r&16&&Be(u,a[4])},d(a){a&&F(t)}}}function zn(c){let t,s,e=(c[0].id!==Xe||c[6].csCount>ce.userJourney.personalLayoutUnlock)&&Ye(c);return{c(){e&&e.c(),t=Me()},m(n,o){e&&e.m(n,o),M(n,t,o),s=!0},p(n,[o]){n[0].id!==Xe||n[6].csCount>ce.userJourney.personalLayoutUnlock?e?(e.p(n,o),o&65&&y(e,1)):(e=Ye(n),e.c(),y(e,1),e.m(t.parentNode,t)):e&&(V(),S(e,1,1,()=>{e=null}),Q())},i(n){s||(y(e),s=!0)},o(n){S(e),s=!1},d(n){e&&e.d(n),n&&F(t)}}}function Un(c,t,s){let e,n,o,i=H,u=()=>(i(),i=Le(l,h=>s(6,o=h)),l);c.$$.on_destroy.push(()=>i());let{theme:a}=t,{isCustom:r=!1}=t,{userDetails:l}=t;u();let{state:f}=t;function d(h,w,p){var A;if(h===void 0)return;if(h.id===void 0){console.error("ID is undefined for layout",h);return}if(h.id===((A=p==null?void 0:p.layoutToUse)==null?void 0:A.id))return;const v=p==null?void 0:p.locationControl;let g=window.location.pathname;g=g.substr(0,g.lastIndexOf("/")),g===""&&(g=".");let _=`${g}/${h.id.toLowerCase()}.html?`;(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(_=`${g}/theme.html?layout=${h.id}&`),w&&(_=`${g}/theme.html?userlayout=${h.id}&`);let k="";return h.definition!==void 0&&(k="#"+btoa(JSON.stringify(h.definition))),(v==null?void 0:v.map(b=>{const K=[["z",b==null?void 0:b.zoom],["lat",b==null?void 0:b.lat],["lon",b==null?void 0:b.lon]].filter(J=>J[1]!==void 0).map(J=>J[0]+"="+J[1]).join("&");return`${_}${K}${k}`}))??new gt(`${_}`)}return c.$$set=h=>{"theme"in h&&s(0,a=h.theme),"isCustom"in h&&s(1,r=h.isCustom),"userDetails"in h&&u(s(2,l=h.userDetails)),"state"in h&&s(3,f=h.state)},c.$$.update=()=>{c.$$.dirty&3&&s(5,e=new Ie(a.title,!r&&!a.mustHaveLanguage?"themes:"+a.id+".title":void 0).toString()),c.$$.dirty&1&&s(4,n=new Ie(a.shortDescription).toString())},[a,r,l,f,n,e,o,d]}class kt extends ee{constructor(t){super(),te(this,t,Un,zn,ne,{theme:0,isCustom:1,userDetails:2,state:3})}}function et(c,t,s){const e=c.slice();return e[10]=t[s],e}function tt(c,t,s){const e=c.slice();return e[10]=t[s],e}const Vn=c=>({}),nt=c=>({});function Qn(c){let t,s,e,n=(c[5]===void 0||c[5]==="")&&!c[2]&&st(c),o=c[6],i=[];for(let a=0;a<o.length;a+=1)i[a]=it(et(c,o,a));const u=a=>S(i[a],1,1,()=>{i[a]=null});return{c(){t=x("div"),n&&n.c(),s=W();for(let a=0;a<i.length;a+=1)i[a].c()},m(a,r){M(a,t,r),n&&n.m(t,null),R(t,s);for(let l=0;l<i.length;l+=1)i[l].m(t,null);e=!0},p(a,r){if((a[5]===void 0||a[5]==="")&&!a[2]?n?(n.p(a,r),r&36&&y(n,1)):(n=st(a),n.c(),y(n,1),n.m(t,s)):n&&(V(),S(n,1,1,()=>{n=null}),Q()),r&86){o=a[6];let l;for(l=0;l<o.length;l+=1){const f=et(a,o,l);i[l]?(i[l].p(f,r),y(i[l],1)):(i[l]=it(f),i[l].c(),y(i[l],1),i[l].m(t,null))}for(V(),l=o.length;l<i.length;l+=1)u(l);Q()}},i(a){if(!e){y(n);for(let r=0;r<o.length;r+=1)y(i[r]);e=!0}},o(a){S(n),i=i.filter(Boolean);for(let r=0;r<i.length;r+=1)S(i[r]);e=!1},d(a){a&&F(t),n&&n.d(),wt(i,a)}}}function Hn(c){let t,s,e,n=(c[5]===void 0||c[5]==="")&&!c[2]&&at(c),o=c[6],i=[];for(let a=0;a<o.length;a+=1)i[a]=lt(tt(c,o,a));const u=a=>S(i[a],1,1,()=>{i[a]=null});return{c(){t=x("div"),n&&n.c(),s=W();for(let a=0;a<i.length;a+=1)i[a].c();D(t,"class","md:grid md:grid-flow-row md:grid-cols-2 lg:grid-cols-3 gap-4")},m(a,r){M(a,t,r),n&&n.m(t,null),R(t,s);for(let l=0;l<i.length;l+=1)i[l].m(t,null);e=!0},p(a,r){if((a[5]===void 0||a[5]==="")&&!a[2]?n?(n.p(a,r),r&36&&y(n,1)):(n=at(a),n.c(),y(n,1),n.m(t,s)):n&&(V(),S(n,1,1,()=>{n=null}),Q()),r&86){o=a[6];let l;for(l=0;l<o.length;l+=1){const f=tt(a,o,l);i[l]?(i[l].p(f,r),y(i[l],1)):(i[l]=lt(f),i[l].c(),y(i[l],1),i[l].m(t,null))}for(V(),l=o.length;l<i.length;l+=1)u(l);Q()}},i(a){if(!e){y(n);for(let r=0;r<o.length;r+=1)y(i[r]);e=!0}},o(a){S(n),i=i.filter(Boolean);for(let r=0;r<i.length;r+=1)S(i[r]);e=!1},d(a){a&&F(t),n&&n.d(),wt(i,a)}}}function st(c){let t,s,e,n;return t=new St({props:{userDetails:c[1].osmConnection.userDetails}}),e=new Dt({}),{c(){P(t.$$.fragment),s=W(),P(e.$$.fragment)},m(o,i){L(t,o,i),M(o,s,i),L(e,o,i),n=!0},p(o,i){const u={};i&2&&(u.userDetails=o[1].osmConnection.userDetails),t.$set(u)},i(o){n||(y(t.$$.fragment,o),y(e.$$.fragment,o),n=!0)},o(o){S(t.$$.fragment,o),S(e.$$.fragment,o),n=!1},d(o){N(t,o),o&&F(s),N(e,o)}}}function ot(c){let t,s;return t=new kt({props:{theme:c[10],isCustom:c[2],userDetails:c[1].osmConnection.userDetails,state:c[1]}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,n){const o={};n&64&&(o.theme=e[10]),n&4&&(o.isCustom=e[2]),n&2&&(o.userDetails=e[1].osmConnection.userDetails),n&2&&(o.state=e[1]),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}function it(c){var n;let t,s,e=c[10]!==void 0&&!(c[4]&&((n=c[10])!=null&&n.hideFromOverview))&&ot(c);return{c(){e&&e.c(),t=Me()},m(o,i){e&&e.m(o,i),M(o,t,i),s=!0},p(o,i){var u;o[10]!==void 0&&!(o[4]&&((u=o[10])!=null&&u.hideFromOverview))?e?(e.p(o,i),i&80&&y(e,1)):(e=ot(o),e.c(),y(e,1),e.m(t.parentNode,t)):e&&(V(),S(e,1,1,()=>{e=null}),Q())},i(o){s||(y(e),s=!0)},o(o){S(e),s=!1},d(o){e&&e.d(o),o&&F(t)}}}function at(c){let t,s,e,n;return t=new St({props:{userDetails:c[1].osmConnection.userDetails}}),e=new Dt({}),{c(){P(t.$$.fragment),s=W(),P(e.$$.fragment)},m(o,i){L(t,o,i),M(o,s,i),L(e,o,i),n=!0},p(o,i){const u={};i&2&&(u.userDetails=o[1].osmConnection.userDetails),t.$set(u)},i(o){n||(y(t.$$.fragment,o),y(e.$$.fragment,o),n=!0)},o(o){S(t.$$.fragment,o),S(e.$$.fragment,o),n=!1},d(o){N(t,o),o&&F(s),N(e,o)}}}function rt(c){let t,s;return t=new kt({props:{theme:c[10],isCustom:c[2],userDetails:c[1].osmConnection.userDetails,state:c[1]}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,n){const o={};n&64&&(o.theme=e[10]),n&4&&(o.isCustom=e[2]),n&2&&(o.userDetails=e[1].osmConnection.userDetails),n&2&&(o.state=e[1]),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}function lt(c){var n;let t,s,e=c[10]!==void 0&&!(c[4]&&((n=c[10])!=null&&n.hideFromOverview))&&rt(c);return{c(){e&&e.c(),t=Me()},m(o,i){e&&e.m(o,i),M(o,t,i),s=!0},p(o,i){var u;o[10]!==void 0&&!(o[4]&&((u=o[10])!=null&&u.hideFromOverview))?e?(e.p(o,i),i&80&&y(e,1)):(e=rt(o),e.c(),y(e,1),e.m(t.parentNode,t)):e&&(V(),S(e,1,1,()=>{e=null}),Q())},i(o){s||(y(e),s=!0)},o(o){S(e),s=!1},d(o){e&&e.d(o),o&&F(t)}}}function ct(c){let t,s;return t=new $n({props:{search:c[0]}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,n){const o={};n&1&&(o.search=e[0]),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}function Jn(c){let t,s,e,n,o,i;const u=c[9].title,a=Nt(u,c,c[8],nt),r=[Hn,Qn],l=[];function f(h,w){return h[3]?0:1}e=f(c),n=l[e]=r[e](c);let d=c[6].length==0&&ct(c);return{c(){t=x("section"),a&&a.c(),s=W(),n.c(),o=W(),d&&d.c(),D(t,"class","svelte-1k9r5cn")},m(h,w){M(h,t,w),a&&a.m(t,null),R(t,s),l[e].m(t,null),R(t,o),d&&d.m(t,null),i=!0},p(h,[w]){a&&a.p&&(!i||w&256)&&Et(a,u,h,h[8],i?Gt(u,h[8],w,Vn):jt(h[8]),nt);let p=e;e=f(h),e===p?l[e].p(h,w):(V(),S(l[p],1,1,()=>{l[p]=null}),Q(),n=l[e],n?n.p(h,w):(n=l[e]=r[e](h),n.c()),y(n,1),n.m(t,o)),h[6].length==0?d?(d.p(h,w),w&64&&y(d,1)):(d=ct(h),d.c(),y(d,1),d.m(t,null)):d&&(V(),S(d,1,1,()=>{d=null}),Q())},i(h){i||(y(a,h),y(n),y(d),i=!0)},o(h){S(a,h),S(n),S(d),i=!1},d(h){h&&F(t),a&&a.d(h),l[e].d(),d&&d.d()}}}function Zn(c,t,s){let e,n,o=H,i=()=>(o(),o=Le(r,p=>s(5,n=p)),r);c.$$.on_destroy.push(()=>o());let{$$slots:u={},$$scope:a}=t,{search:r}=t;i();let{themes:l}=t,{state:f}=t,{isCustom:d=!1}=t,{onMainScreen:h=!0}=t,{hideThemes:w=!0}=t;return c.$$set=p=>{"search"in p&&i(s(0,r=p.search)),"themes"in p&&s(7,l=p.themes),"state"in p&&s(1,f=p.state),"isCustom"in p&&s(2,d=p.isCustom),"onMainScreen"in p&&s(3,h=p.onMainScreen),"hideThemes"in p&&s(4,w=p.hideThemes),"$$scope"in p&&s(8,a=p.$$scope)},c.$$.update=()=>{c.$$.dirty&161&&s(6,e=l.filter(p=>{var _;if(n===void 0||n==="")return!0;const v=n.toLocaleLowerCase();if(p.id.toLowerCase().indexOf(v)>=0)return!0;const g=[p.shortDescription,p.title,...p.keywords??[]];for(const k of g){if(k===void 0)continue;const A=k["*"]??k[Te.language.data];if(((_=A==null?void 0:A.toLowerCase())==null?void 0:_.indexOf(r))>=0)return!0}return!1}))},[r,f,d,h,w,n,e,l,a,u]}class qe extends ee{constructor(t){super(),te(this,t,Zn,Jn,ne,{search:0,themes:7,state:1,isCustom:2,onMainScreen:3,hideThemes:4})}}function Kn(c){let t,s,e,n=c[6].hiddenExplanation.Subs({hidden_discovered:c[3].length.toString(),total_hidden:c[4].length.toString()})+"",o;return{c(){t=x("h3"),t.textContent=`${c[6].previouslyHiddenTitle.toString()}`,s=W(),e=x("p"),o=Ae(n)},m(i,u){M(i,t,u),M(i,s,u),M(i,e,u),R(e,o)},p(i,u){u&8&&n!==(n=i[6].hiddenExplanation.Subs({hidden_discovered:i[3].length.toString(),total_hidden:i[4].length.toString()})+"")&&Be(o,n)},d(i){i&&F(t),i&&F(s),i&&F(e)}}}function Xn(c){let t,s;return t=new qe({props:{search:c[0],state:c[1],onMainScreen:c[2],themes:c[3],isCustom:!0,hideThemes:!1,$$slots:{title:[Kn]},$$scope:{ctx:c}}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,[n]){const o={};n&1&&(o.search=e[0]),n&2&&(o.state=e[1]),n&4&&(o.onMainScreen=e[2]),n&8&&(o.themes=e[3]),n&520&&(o.$$scope={dirty:n,ctx:e}),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}const ut="mapcomplete-hidden-theme-";function Yn(c,t,s){let e,n,o,{search:i}=t,{state:u}=t,{onMainScreen:a=!0}=t;const r=mt.filter(d=>d.hideFromOverview),l=u.osmConnection.preferencesHandler.preferences;_t(c,l,d=>s(8,o=d));const f=T.t.general.morescreen;return c.$$set=d=>{"search"in d&&s(0,i=d.search),"state"in d&&s(1,u=d.state),"onMainScreen"in d&&s(2,a=d.onMainScreen)},c.$$.update=()=>{c.$$.dirty&256&&s(7,e=de.NoNull(Object.keys(o).filter(d=>d.startsWith(ut)).map(d=>d.substring(ut.length,d.length-8)))),c.$$.dirty&128&&s(3,n=r.filter(d=>e.includes(d.id)))},[i,u,a,n,r,l,f,e,o]}class es extends ee{constructor(t){super(),te(this,t,Yn,Xn,ne,{search:0,state:1,onMainScreen:2})}}function ts(c){let t,s=c[4].customThemeIntro.toString()+"",e;return{c(){t=new Wt(!1),e=Me(),t.a=e},m(n,o){t.m(s,n,o),M(n,e,o)},p:H,d(n){n&&F(e),n&&t.d()}}}function ns(c){let t,s;return t=new qe({props:{search:c[0],state:c[1],onMainScreen:c[2],themes:c[3],isCustom:!0,hideThemes:!1,$$slots:{title:[ts]},$$scope:{ctx:c}}}),{c(){P(t.$$.fragment)},m(e,n){L(t,e,n),s=!0},p(e,[n]){const o={};n&1&&(o.search=e[0]),n&2&&(o.state=e[1]),n&4&&(o.onMainScreen=e[2]),n&8&&(o.themes=e[3]),n&256&&(o.$$scope={dirty:n,ctx:e}),t.$set(o)},i(e){s||(y(t.$$.fragment,e),s=!0)},o(e){S(t.$$.fragment,e),s=!1},d(e){N(t,e)}}}function ss(c,t,s){let e,n,{search:o}=t,{state:i}=t,{onMainScreen:u=!0}=t;const a=T.t.general,r=i.installedUserThemes,l=qt.ListStabilized(r);return _t(c,l,f=>s(6,n=f)),c.$$set=f=>{"search"in f&&s(0,o=f.search),"state"in f&&s(1,i=f.state),"onMainScreen"in f&&s(2,u=f.onMainScreen)},c.$$.update=()=>{c.$$.dirty&66&&s(3,e=de.NoNull(n.map(f=>i.GetUnofficialTheme(f))))},[o,i,u,e,a,l,n]}class os extends ee{constructor(t){super(),te(this,t,ss,ns,ne,{search:0,state:1,onMainScreen:2})}}const G=class extends C{constructor(t,s=!1){const e=T.t.general.morescreen,n=new yt({placeholder:e.searchForATheme});n.enterPressed.addCallbackD(i=>{i=i.toLowerCase(),i==="personal"&&(window.location.href=G.createUrlFor({id:"personal"},!1,t).data),(i==="bugs"||i==="issues")&&(window.location.href="https://github.com/pietervdvn/MapComplete/issues"),i==="source"&&(window.location.href="https://github.com/pietervdvn/MapComplete"),i==="docs"&&(window.location.href="https://github.com/pietervdvn/MapComplete/tree/develop/Docs"),(i==="osmcha"||i==="stats")&&(window.location.href=de.OsmChaLinkFor(7));const u=G.officialThemes.find(r=>r.hideFromOverview==!1&&r.id!=="personal"&&G.MatchesLayoutFunc(r)(i));u!==void 0&&(window.location.href=G.createUrlFor(u,!1,t).data);const a=G.officialThemes.find(r=>r.id!=="personal"&&G.MatchesLayoutFunc(r)(i));a!==void 0&&(window.location.href=G.createUrlFor(a,!1,t).data)}),s&&(n.focus(),document.addEventListener("keydown",function(i){i.ctrlKey&&i.code==="KeyF"&&(n.focus(),i.preventDefault())}));const o=new C([O.search_svg().SetClass("w-8"),n.SetClass("mr-4 w-full")]).SetClass("flex rounded-full border-2 border-black items-center my-2 w-1/2");super([new C([o]).SetClass("flex justify-center"),new Oe(qe,{state:t,onMainScreen:s,search:n.GetValue(),themes:G.officialThemes}),new Oe(es,{state:t,onMainScreen:s,search:n.GetValue()}),new Oe(os,{state:t,onMainScreen:s,search:n.GetValue()}),e.streetcomplete.Clone().SetClass("block text-base mx-10 my-3 mb-10")])}static createUrlFor(t,s,e){var a;if(t===void 0)return;if(t.id===void 0){console.error("ID is undefined for layout",t);return}if(t.id===((a=e==null?void 0:e.layoutToUse)==null?void 0:a.id))return;const n=e==null?void 0:e.locationControl;let o=window.location.pathname;o=o.substr(0,o.lastIndexOf("/")),o===""&&(o=".");let i=`${o}/${t.id.toLowerCase()}.html?`;(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(i=`${o}/theme.html?layout=${t.id}&`),s&&(i=`${o}/theme.html?userlayout=${t.id}&`);let u="";return t.definition!==void 0&&(u="#"+btoa(JSON.stringify(t.definition))),(n==null?void 0:n.map(r=>{const l=[["z",r==null?void 0:r.zoom],["lat",r==null?void 0:r.lat],["lon",r==null?void 0:r.lon]].filter(f=>f[1]!==void 0).map(f=>f[0]+"="+f[1]).join("&");return`${i}${l}${u}`}))??new gt(`${i}`)}static createLinkButton(t,s,e=!1){var i;const n=G.createUrlFor(s,e,t);let o=new C([new Ie(s.title,!e&&!s.mustHaveLanguage?"themes:"+s.id+".title":void 0),((i=new Ie(s.shortDescription))==null?void 0:i.SetClass("subtle"))??""]).SetClass("overflow-hidden flex flex-col");return t.layoutToUse===void 0&&(o=new C([o]).SetClass("flex flex-col justify-center h-24")),new q(s.icon,o,{url:n,newTab:!1})}static CreateProffessionalSerivesButton(){const t=T.t.professional.indexPage;return new C([new ue(t.hook,4),t.hookMore,new q(void 0,t.button,{url:"./professional.html"})]).SetClass("flex flex-col border border-gray-300 p-2 rounded-lg")}static MatchesLayoutFunc(t){return s=>{var n;if(s=s.toLocaleLowerCase(),t.id.toLowerCase().indexOf(s)>=0)return!0;const e=[t.shortDescription,t.title,...t.keywords??[]];for(const o of e){if(o===void 0)continue;const i=o["*"]??o[Te.language.data];if(((n=i==null?void 0:i.toLowerCase())==null?void 0:n.indexOf(s))>=0)return!0}return!1}}};let Re=G;m(Re,"officialThemes",mt);export{fe as E,Y as F,Re as M,Se as S,gn as a,ie as b,Tn as c};
