var Mt=Object.defineProperty;var $t=(u,t,n)=>t in u?Mt(u,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):u[t]=n;var m=(u,t,n)=>($t(u,typeof t!="symbol"?t+"":t,n),n);import{j as Te,d as dt,b as Ie,k as ft,O as Me,m as Pe,n as Fe,R as Ft,S as ht,o as Ot,p as Rt,T as X,q as we,E as At,r as Bt,s as Pt,F as Nt,t as mt}from"./theme_overview-edac4aa3.js";import{T as Z,B as U,G as F,C as ce}from"./BBox-c9a2fa1b.js";import{U as x,V as E,T as I,C as v,J as fe,S as O,M as Re,K as pt,a as ee,i as te,s as ne,h as M,j as W,D as B,_ as D,b as k,m as R,E as P,a0 as Lt,t as y,c as S,d as T,G as N,v as H,y as V,z as Q,w as Ne,e as ue,R as xe,a1 as He,a2 as Ae,a3 as Be,I as gt,f as Et,u as jt,p as Gt,q as qt,a4 as wt,a5 as _t,O as bt,X as Wt,a6 as zt,H as Oe}from"./SvelteUIElement-7f97ca15.js";import{e as z,c as yt,b as ae,L as Le,F as Je,j as Ze,M as Ut,i as vt,A as Vt,S as Qt}from"./ChartJs-6c59ad15.js";import{L as Ct,S as q,b as ge}from"./SubtleButton-74d1c735.js";import{T as A,a as de,L as _e}from"./List-07cd593f.js";import{T as Ee}from"./ToSvelte-a102890b.js";const re=class{constructor(t,n,e,s,o){m(this,"totalValue",0);m(this,"showCount",0);m(this,"hiddenCount",0);m(this,"features",new x(re.empty));m(this,"name");m(this,"_parent");m(this,"_root");m(this,"_z");m(this,"_x");m(this,"_y");m(this,"_tileIndex");m(this,"_counter");m(this,"_subtiles",[void 0,void 0,void 0,void 0]);m(this,"featuresStatic",[]);m(this,"featureProperties");m(this,"_state");m(this,"updateSignal",new x(void 0));this._parent=t,this._state=n,this._root=(t==null?void 0:t._root)??this,this._z=e,this._x=s,this._y=o,this._tileIndex=Z.tile_index(e,s,o),this.name="Count("+this._tileIndex+")";const i={id:""+this._tileIndex,tileId:""+this._tileIndex,count:"0",kilocount:"0",showCount:"0",totalCount:"0"};this.featureProperties=i;const r=new Date,c={type:"Feature",properties:i,geometry:{type:"Point",coordinates:Z.centerPointOf(e,s,o)}};this.featuresStatic.push({feature:c,freshness:r});const a=U.fromTile(e,s,o),l={type:"Feature",properties:i,geometry:{type:"Polygon",coordinates:[[[a.minLon,a.minLat],[a.minLon,a.maxLat],[a.maxLon,a.maxLat],[a.maxLon,a.minLat],[a.minLon,a.minLat]]]}};this.featuresStatic.push({feature:l,freshness:r})}static createHierarchy(t){return new re(void 0,t,0,0,0)}getTile(t){var c;if(t===this._tileIndex)return this;let[n,e,s]=Z.tile_from_index(t);for(;n-1>this._z;)e=Math.floor(e/2),s=Math.floor(s/2),n--;const o=e-2*this._x,r=(s-2*this._y)*2+o;return(c=this._subtiles[r])==null?void 0:c.getTile(t)}addTile(t){const n=this;if(t.tileIndex===this._tileIndex)this._counter===void 0&&(this._counter=new Ht(this._tileIndex),this._counter.countsPerLayer.addCallbackAndRun(e=>n.update())),this._counter.addTileCount(t);else{let[e,s,o]=Z.tile_from_index(t.tileIndex);for(;e-1>this._z;)s=Math.floor(s/2),o=Math.floor(o/2),e--;const i=s-2*this._x,c=(o-2*this._y)*2+i;this._subtiles[c]===void 0&&(this._subtiles[c]=new re(this,this._state,e,s,o)),this._subtiles[c].addTile(t)}this.updateSignal.setData(t)}getCountsForZoom(t,n,e=0){const s=this,o=[],i=n.map(r=>r.zoom).map(r=>{if(r-1>t.maxZoom)return o;const c=[];return s.visitSubTiles(a=>a.showCount<e?!1:a._z===r?(c.push(...a.features.data),!1):a._z<=r),c},[this.updateSignal.stabilized(500)]);return new Te(i)}update(){var i,r,c,a;const t=new Map;let n=0,e=0,s=0,o=new Map;for(const l of this._state.filteredLayers.data)o.set(l.layerDef.id,l);(c=(r=(i=this==null?void 0:this._counter)==null?void 0:i.countsPerLayer)==null?void 0:r.data)==null||c.forEach((l,f)=>{t.set("layer:"+f,l),n+=l,this.featureProperties["direct_layer:"+f]=l;const d=o.get(f);d.isDisplayed.data&&this._z>=d.layerDef.minzoom?s+=l:e+=l});for(const l of this._subtiles)if(l!==void 0){n+=l.totalValue,s+=l.showCount,e+=l.hiddenCount;for(const f in l.featureProperties)f.startsWith("layer:")&&t.set(f,(t.get(f)??0)+Number(l.featureProperties[f]??0))}this.totalValue=n,this.showCount=s,this.hiddenCount=e,(a=this._parent)==null||a.update(),n===0?this.features.setData(re.empty):(this.featureProperties.count=""+n,this.featureProperties.kilocount=""+Math.floor(n/1e3),this.featureProperties.showCount=""+s,this.featureProperties.totalCount=""+n,t.forEach((l,f)=>{this.featureProperties[f]=""+l}),this.features.data=this.featuresStatic,this.features.ping())}visitSubTiles(t){t(this)&&this._subtiles.forEach(e=>e==null?void 0:e.visitSubTiles(t))}};let be=re;m(be,"empty",[]);class Ht{constructor(t){m(this,"bbox");m(this,"tileIndex");m(this,"countsPerLayer",new x(new Map));m(this,"z");m(this,"x");m(this,"y");m(this,"registeredLayers",new Map);this.tileIndex=t,this.bbox=U.fromTileIndex(t);const[n,e,s]=Z.tile_from_index(t);this.z=n,this.x=e,this.y=s}addTileCount(t){const n=t.layer.layerDef;this.registeredLayers.set(n.id,n);const e=this;t.features.map(s=>{const o=t.layer.isDisplayed.data;e.countsPerLayer.data.set(n.id,o?s.length:0),e.countsPerLayer.ping()},[t.layer.isDisplayed])}}const Jt="cluster_style",Zt="The style for the clustering in all themes. Enable `debug=true` to peak into clustered tiles",Kt={osmTags:"tileId~*"},Xt="Clustered data",Yt=["all_tags"],en=[{label:{render:"<div class='rounded-full text-xl font-bold' style='width: 2rem; height: 2rem; background: white'>{showCount}</div>",mappings:[{if:"showCount>1000",then:"<div class='rounded-full text-xl font-bold flex flex-col' style='width: 2.5rem; height: 2.5rem; background: white'>{kilocount}K</div>"}]},location:["point"]},{color:{render:"#3c3",mappings:[{if:"showCount>200",then:"#f33"},{if:"showCount>100",then:"#c93"},{if:"showCount>50",then:"#cc3"}]},width:{render:"1"}}],tn={id:Jt,description:Zt,source:Kt,title:Xt,tagRenderings:Yt,mapRendering:en},We=class{constructor(t,n){const e=t.source,s=e.features.map(o=>{const i=e.bbox,[r,c,a]=Z.tile_from_index(e.tileIndex),l={type:"Feature",properties:{z:r,x:c,y:a,tileIndex:e.tileIndex,source:e.name,count:o.length,tileId:e.name+"/"+e.tileIndex},geometry:{type:"Polygon",coordinates:[[[i.minLon,i.minLat],[i.minLon,i.maxLat],[i.maxLon,i.maxLat],[i.maxLon,i.minLat],[i.minLon,i.minLat]]]}},f=F.centerpoint(l);return[l,f].map(d=>({feature:d,freshness:new Date}))});new Ie({layerToShow:We.styling,features:new Te(s),leafletMap:t.leafletMap,doShowLayer:t.doShowLayer,state:n})}};let ye=We;m(ye,"styling",new dt(tn,"ShowTileInfo",!0));const ze=class{constructor(t,n){m(this,"hash");m(this,"state");this.hash=t,this.state=n;const e=this;t.addCallback(()=>e.setSelectedElementFromHash()),this.initialLoad()}initialLoad(){const t=this.hash.data;t===void 0||t===""||t.indexOf("-")>=0||ze._no_trigger_on.has(t)||(t.startsWith("node")||t.startsWith("way")||t.startsWith("relation"))&&z.DownloadObjectAsync(t).then(n=>{try{console.log("Downloaded selected object from OSM-API for initial load: ",t);const e=n.asGeoJson();this.state.allElements.addOrGetElement(e),this.state.selectedElement.setData(e),this.zoomToSelectedFeature()}catch(e){console.error(e)}})}setSelectedElementFromHash(){var e;const t=this.state,n=this.hash.data;if(n===void 0||n==="")t.selectedElement.setData(void 0);else{const s=t.allElements.ContainingFeatures.get(n);if(s===void 0)return;const o=t.selectedElement.data;if(o===void 0){t.selectedElement.setData(s);return}if(((e=o.properties)==null?void 0:e.id)===s.properties.id)return;t.selectedElement.setData(s)}}zoomToSelectedFeature(){var o,i;const t=this.state.selectedElement.data;if(t===void 0)return;const n=F.centerpointCoordinates(t),e=this.state.locationControl;e.data.lon=n[0],e.data.lat=n[1];const s=Math.max(14,...((i=(o=this.state.layoutToUse)==null?void 0:o.layers)==null?void 0:i.map(r=>r.minzoomVisible))??[]);e.data.zoom<s&&(e.data.zoom=s),e.ping()}};let ve=ze;m(ve,"_no_trigger_on",new Set(["welcome","copyright","layers","new","filters","location_track","",void 0]));class nn extends E{constructor(n,e){const s=new x([]),o=e.tagsSource,i=e.units;e.showAllQuestionsAtOnce=e.showAllQuestionsAtOnce??!1;const r=e.tagRenderings.filter(d=>d.question!==void 0).filter(d=>d.question!==null);let c=()=>{};const a=r.map((d,h)=>new Ct(()=>new ft(o,d,n,{units:i,afterSave:()=>{s.ping(),c()},cancelButton:I.t.general.skip.Clone().SetClass("btn btn-secondary").onClick(()=>{s.data.push(h),s.ping(),c()})}))),l=I.t.general.skippedQuestions.onClick(()=>{s.setData([])});o.map(d=>{if(d!==void 0)for(let h=0;h<a.length;h++){let w=r[h];if(!(s.data.indexOf(h)>=0)&&!w.IsKnown(d)&&!(w.condition&&!w.condition.matchesProperties(d)))return h}},[s]);const f=o.map(d=>{if(d===void 0)return[];const h=[];for(let w=0;w<a.length;w++){let p=r[w];s.data.indexOf(w)>=0||p.IsKnown(d)||p.condition&&!p.condition.matchesProperties(d)||h.push(a[w])}return h},[s]);super(f.map(d=>{const h=n.osmConnection.apiIsOnline.data;if(h!=="online"&&h!=="unknown")return;const w=[];return e.showAllQuestionsAtOnce===!0||e.showAllQuestionsAtOnce.data?w.push(...f.data):w.push(d[0]),s.data.length>0&&w.push(l),new v(w).SetClass("block mb-8")},[n.osmConnection.apiIsOnline]));m(this,"skippedQuestions");m(this,"restingQuestions");this.skippedQuestions=s,this.restingQuestions=f,c=()=>this.ScrollIntoView()}}class sn extends Me{constructor(n,e,s,o){var i;super(n,!0);m(this,"_softDeletionTags");m(this,"meta");m(this,"_id");m(this,"_hardDelete");this._id=n,this._hardDelete=o,this.meta={...s,changeType:"deletion"},((i=e==null?void 0:e.usedKeys())==null?void 0:i.indexOf("fixme"))>=0?this._softDeletionTags=e:this._softDeletionTags=new yt(fe.NoNull([e,new ae("fixme",`A mapcomplete user marked this feature to be deleted (${s.specialMotivation})`)]))}async CreateChangeDescriptions(n,e){const s=e??await z.DownloadObjectAsync(this._id);return this._hardDelete?[{meta:this.meta,doDelete:!0,type:s.type,id:s.id}]:await new Pe(this._id,this._softDeletionTags,s.tags,{...this.meta,changeType:"soft-delete"}).CreateChangeDescriptions(n)}}class me extends A{constructor(t,n,e){const s=new on(t,n,e.neededChangesets),o=n.allElements.getEventSourceById(t),i=new x(!1),r=!!e.softDeletionTags,c=new x(!1);function a(_){var L,b,K;let $;_.retagTo!==void 0?$=new Pe(t,_.retagTo,o.data,{theme:((L=n==null?void 0:n.layoutToUse)==null?void 0:L.id)??"unkown",changeType:"special-delete"}):$=new sn(t,e.softDeletionTags,{theme:((b=n==null?void 0:n.layoutToUse)==null?void 0:b.id)??"unkown",specialMotivation:_.deleteReason},s.canBeDeleted.data.canBeDeleted),(K=n.changes)==null||K.applyAction($),i.setData(!0)}const l=I.t.delete,f=l.cancel.SetClass("block btn btn-secondary").onClick(()=>c.setData(!1)),d=new q(O.delete_icon_svg().SetStyle("width: 1.5rem; height: 1.5rem;"),l.delete).onClick(()=>{s.CheckDeleteability(!0),c.setData(!0)}),h=o.map(_=>_.id.indexOf("-")<0),w=me.constructMultipleChoice(e,o,n),p=new v([new de(new Fe(l.whyDelete,o,n).SetClass("question-text"),3),w,new v([me.constructExplanation(w.GetValue(),s,o,n),new v([f,me.constructConfirmButton(w.GetValue()).onClick(()=>a(w.GetValue().data))]).SetClass("flex justify-end flex-wrap-reverse")]).SetClass("flex mt-2 justify-between")]).SetClass("question"),C=new A(new A(new A(p,new q(O.envelope_ui(),l.readMessages),n.osmConnection.userDetails.map(_=>_.csCount>ce.userJourney.addNewPointWithUnreadMessagesUnlock||_.unreadMessages==0)),d,c),new E(s.canBeDeleted.map(_=>new v([O.delete_not_allowed_svg().SetStyle("height: 2rem; width: auto").SetClass("mr-2"),new v([l.cannotBeDeleted,_.reason.SetClass("subtle"),l.useSomethingElse.SetClass("subtle")]).SetClass("flex flex-col")]).SetClass("flex m-2 p-2 rounded-lg bg-gray-200 bg-gray-200"))),s.canBeDeleted.map(_=>r||_.canBeDeleted!==!1));super(new A(new v([O.delete_icon_svg().SetClass("h-16 w-16 p-2 m-2 block bg-gray-300 rounded-full"),l.isDeleted]).SetClass("flex m-2 rounded-full"),new Le(C,void 0,n),i),void 0,h);const g=this;c.addCallbackAndRunD(_=>{_&&g.ScrollIntoView()})}static constructConfirmButton(t){const n=I.t.delete,e=new v([O.delete_icon_ui().SetClass("w-6 h-6 mr-3 block"),n.delete]).SetClass("flex btn bg-red-500"),s=new v([O.delete_icon_ui().SetClass("w-6 h-6 mr-3 block"),n.delete]).SetClass("flex btn btn-disabled bg-red-200");return new A(e,s,t.map(o=>o!==void 0))}static constructExplanation(t,n,e,s){const o=I.t.delete;return new E(t.map(i=>{if(i===void 0)return o.explanations.selectReason.SetClass("subtle");const r=i.retagTo;if(r!==void 0)return new v([o.explanations.retagNoOtherThemes,ft.CreateTagExplanation(new x(r),e,s).SetClass("subtle")]);if(i.deleteReason!==void 0)return new E(n.canBeDeleted.map(({canBeDeleted:a,reason:l})=>a?o.explanations.hardDelete:o.explanations.softDelete.Subs({reason:l})))},[n.canBeDeleted])).SetClass("block")}static constructMultipleChoice(t,n,e){const s=[];for(const o of t.nonDeleteMappings)s.push(new Je(new Fe(o.then,n,e),{retagTo:o.if}));for(const o of t.deleteReasons??[])s.push(new Je(new Fe(o.explanation,n,e),{deleteReason:o.changesetMessage}));return new Ft(s,{selectFirstAsDefault:!1})}}class on{constructor(t,n,e){m(this,"canBeDeleted");m(this,"_id");m(this,"_allowDeletionAtChangesetCount");m(this,"_state");this._id=t,this._state=n,this._allowDeletionAtChangesetCount=e??Number.MAX_VALUE,this.canBeDeleted=new x({canBeDeleted:void 0,reason:I.t.delete.loading}),this.CheckDeleteability(!1)}CheckDeleteability(t){const n=I.t.delete,e=this._id,s=this.canBeDeleted,o=this;if(!e.startsWith("node")){this.canBeDeleted.setData({canBeDeleted:!1,reason:n.isntAPoint});return}const i=this._state.osmConnection.userDetails.map(h=>{if(h!==void 0)return h.loggedIn?h.csCount>=Math.min(ce.userJourney.deletePointsOfOthersUnlock,this._allowDeletionAtChangesetCount):!1}),r=new x(void 0),c=r.map(h=>{if(h==null)return null;const w=o._state.osmConnection.userDetails.data.uid;return!h.some(p=>p!==w)},[o._state.osmConnection.userDetails]),a=i.map(h=>{if(h===void 0)return!1;if(h===!0||(c.data===null&&t&&z.DownloadHistory(e).map(p=>p.map(C=>Number(C.tags["_last_edit:contributor:uid"]))).addCallbackAndRunD(p=>r.setData(p)),c.data===!0))return!0;if(c.data===!1)return!1},[c]),l=new x(null),f=new x(null);a.addCallbackAndRunD(h=>{if(h===!1)return s.setData({canBeDeleted:!1,reason:n.notEnoughExperience}),!0;if(t)return z.DownloadReferencingRelations(e).then(w=>{l.setData(w.length>0)}),z.DownloadReferencingWays(e).then(w=>{f.setData(w.length>0)}),!0}),l.map(h=>h===!0||f.data===!0?!0:f.data===null||h===null?null:f.data===!1&&h===!1?!1:null,[f]).addCallbackAndRun(h=>{h!=null&&(h?s.setData({canBeDeleted:!1,reason:n.partOfOthers}):s.setData({canBeDeleted:!0,reason:c.data===!0?n.onlyEditedByLoggedInUser:n.safeDelete}))})}}class je extends Me{constructor(n,e){super("relation/"+n.relation.id,!1);m(this,"_input");m(this,"_theme");this._input=n,this._theme=e}async targetNodeAt(n,e){const s=this._input.relation.members[n];if(s!==void 0){if(s.type==="node")return s.ref;if(s.type==="way"){const i=(await z.DownloadObjectAsync("way/"+s.ref)).nodes;return e?i[0]:i[i.length-1]}s.type}}}class an extends je{constructor(t,n){super(t,n)}async CreateChangeDescriptions(t){return this._input.relation.tags.type==="restriction"?new rn(this._input,this._theme).CreateChangeDescriptions(t):new St(this._input,this._theme).CreateChangeDescriptions(t)}}class rn extends je{constructor(t,n){super(t,n)}async CreateChangeDescriptions(t){const n=this._input.relation,e=n.members,s=e.filter(d=>d.type==="way"&&d.ref===this._input.originalWayId);s.length>1&&console.warn("Detected a turn restriction where this way has multiple occurances. This is an error");const o=s[0];if(o.role==="via")return new St(this._input,this._theme).CreateChangeDescriptions(t);let i=await this.targetNodeAt(e.indexOf(o),!0),r=await this.targetNodeAt(e.indexOf(o),!1),c=i??r;const a=this._input.allWaysNodesInOrder.map((d,h)=>({nodes:d,id:this._input.allWayIdsInOrder[h]})).filter(d=>{const h=d.nodes;return h[0]==c||h[h.length-1]==c})[0];if(a===void 0)return console.error("No common point found, this was a broken turn restriction!",n.id),[];const l=this._input.originalWayId;if(a.id===l)return console.log("Turn_restriction fixer: the original ID can be kept, nothing to do"),[];const f=n.members.map(d=>d.type==="way"&&d.ref===l?{ref:a.id,type:"way",role:d.role}:d);return[{type:"relation",id:n.id,changes:{members:f},meta:{theme:this._theme,changeType:"relation-fix:turn_restriction"}}]}}class St extends je{constructor(t,n){super(t,n)}async CreateChangeDescriptions(t){const n=this._input.originalWayId,e=this._input.relation,s=e.members,o=this._input.originalNodes,i=o[0],r=o[o.length-1],c=[];for(let a=0;a<s.length;a++){const l=s[a];if(l.type!=="way"||l.ref!==n){c.push(l);continue}const f=await this.targetNodeAt(a-1,!1),d=await this.targetNodeAt(a+1,!0);if((f===void 0||f===i)&&(d===void 0||d===r)){for(const g of this._input.allWayIdsInOrder)c.push({ref:g,type:"way",role:l.role});continue}if(f===void 0||f===r||(d===void 0||d===i)){for(let g=this._input.allWayIdsInOrder.length-1;g>=0;g--){const _=this._input.allWayIdsInOrder[g];c.push({ref:_,type:"way",role:l.role})}continue}for(const g of this._input.allWayIdsInOrder)c.push({ref:g,type:"way",role:l.role})}return[{id:e.id,type:"relation",changes:{members:c},meta:{changeType:"relation-fix",theme:this._theme}}]}}class Ge extends Me{constructor(n,e,s,o=5,i){super(n,!0);m(this,"wayId");m(this,"_splitPointsCoordinates");m(this,"_meta");m(this,"_toleranceInMeters");m(this,"_withNewCoordinates");this.wayId=n,this._splitPointsCoordinates=e,this._toleranceInMeters=o,this._withNewCoordinates=i,this._meta={...s,changeType:"split"}}static SegmentSplitInfo(n){const e=[];let s=[];for(const o of n)s.push(o),o.doSplit&&(e.push(s),s=[o]);return e.push(s),e.filter(o=>o.length>0)}async CreateChangeDescriptions(n){const e=await z.DownloadObjectAsync(this.wayId),s=e.nodes,o=this.CalculateSplitCoordinates(e,this._toleranceInMeters);for(const d of o)d.originalIndex>=0?d.originalIndex=e.nodes[d.originalIndex]:d.originalIndex=n.getNewID();const i=Ge.SegmentSplitInfo(o);let r;for(const d of i){if(r===void 0){r=d;continue}d.length>r.length&&(r=d)}const c=[];for(const d of o)d.originalIndex>=0||c.push({type:"node",id:d.originalIndex,changes:{lon:d.lngLat[0],lat:d.lngLat[1]},meta:this._meta});const a=[],l=[];for(const d of i)if(d===r){const w=d.map(C=>C.originalIndex),p=d.map(C=>C.lngLat);c.push({type:"way",id:e.id,changes:{coordinates:p,nodes:w},meta:this._meta}),this._withNewCoordinates&&this._withNewCoordinates(p),a.push(e.id),l.push(w)}else{let w=n.getNewID();const p=[];for(const g in e.tags)e.tags.hasOwnProperty(g)&&(g.startsWith("_")||g==="id"||p.push({k:g,v:e.tags[g]}));const C=d.map(g=>g.originalIndex);if(C.length<=1){console.error("Got a segment with only one node - skipping");continue}c.push({type:"way",id:w,tags:p,changes:{coordinates:d.map(g=>g.lngLat),nodes:C},meta:this._meta}),a.push(w),l.push(C)}const f=await z.DownloadReferencingRelations(this.wayId);for(const d of f){const h=await new an({relation:d,allWayIdsInOrder:a,originalNodes:s,allWaysNodesInOrder:l,originalWayId:e.id},this._meta.theme).CreateChangeDescriptions(n);c.push(...h)}return c}CalculateSplitCoordinates(n,e=5){const s=n.asGeoJson(),o=n.coordinates.map(a=>[a[1],a[0]]),i=this._splitPointsCoordinates.map(a=>{let l=F.nearestPoint(s,a);return{coordinates:a,isSplitPoint:!0,dist:l.properties.dist,location:l.properties.location}});for(let a=0;a<o.length;a++){let l=o[a],f=F.nearestPoint(s,l);i.push({coordinates:l,isSplitPoint:!1,location:f.properties.location,originalIndex:a,dist:f.properties.dist})}i.sort((a,l)=>a.location-l.location);for(let a=i.length-2;a>=1;a--){const l=i[a];if(l.originalIndex!==void 0)continue;const f=i[a+1],d=i[a-1],h=f.location-l.location,w=l.location-d.location;if(h*1e3>e&&w*1e3>e)continue;let p=f;h>w&&(p=d),!(p.originalIndex===0||p.originalIndex===o.length)&&(p.isSplitPoint=!0,i.splice(a,1))}const r=[];let c=-1;for(const a of i){let l=a.originalIndex;l===void 0&&(l=c,c--);const f={originalIndex:l,lngLat:a.coordinates,doSplit:a.isSplitPoint};r.push(f)}return r}}const ln="split_point",cn="Layer rendering the little scissors for the minimap in the 'splitRoadWizard'",un=1,dn={osmTags:"_split_point=yes"},fn="Split point",hn="Split point",mn=[{location:["point","centroid"],icon:"circle:white;./assets/svg/scissors.svg",iconSize:"30,30,center"}],pn={id:ln,description:cn,minzoom:un,source:dn,name:fn,title:hn,mapRendering:mn},pe=class extends v{constructor(n,e){const s=I.t.split,o=new x([]),i=new x(!1),r=new x(!1),c=new x(pe.setupMapComponent(n,o,e)),a=new q(O.scissors_ui().SetStyle("height: 1.5rem; width: auto"),new A(s.splitAgain.Clone().SetClass("text-lg font-bold"),s.inviteToSplit.Clone().SetClass("text-lg font-bold"),i)),l=new Le(a,s.loginToSplit.Clone(),e),f=new Ze(s.split.Clone(),async()=>{var $;i.setData(!0),r.setData(!1);const _=new Ge(n,o.data.map(L=>L.feature.geometry.coordinates),{theme:($=e==null?void 0:e.layoutToUse)==null?void 0:$.id},5,L=>{e.allElements.ContainingFeatures.get(n).geometry.coordinates=L});await e.changes.applyAction(_),o.setData([]),c.setData(pe.setupMapComponent(n,o,e)),ht.collapse()});f.SetClass("btn btn-primary mr-3");const d=new Ze(s.split.Clone(),void 0);d.SetClass("btn btn-disabled mr-3");const h=new A(d,f,o.map(_=>_.length===0)),w=I.t.general.cancel.Clone().SetClass("btn btn-secondary mr-3").onClick(()=>{o.setData([]),r.setData(!1)});w.SetClass("btn btn-secondary block");const p=new de(s.splitTitle),C=new v([p,new E(c),new v([w,h]).SetClass("flex flex-row")]);C.SetClass("question");super([A.If(i,()=>s.hasBeenSplit.Clone().SetClass("font-bold thanks block w-full")),new A(C,l,r)]);m(this,"dialogIsOpened");this.dialogIsOpened=r;const g=this;a.onClick(()=>{r.setData(!0),g.ScrollIntoView()})}static setupMapComponent(n,e,s){const o=s.allElements.ContainingFeatures.get(n),i=Ut.createMiniMap({background:s.backgroundLayer,allowMoving:!0,leafletOptions:{minZoom:14}});i.SetStyle("width: 100%; height: 24rem").SetClass("rounded-xl overflow-hidden"),i.installBounds(U.get(o).pad(.25),!1),new Ot({features:Te.fromGeojson([o]),layers:s.filteredLayers,leafletMap:i.leafletMap,zoomToFeatures:!0,state:s}),new Ie({features:new Te(e),leafletMap:i.leafletMap,zoomToFeatures:!1,layerToShow:pe.splitLayerStyling,state:s});function r(c){const a=e.data.map((f,d)=>[f.feature,d]).filter(f=>F.distanceBetween(f[0].geometry.coordinates,c)<5).map(f=>f[1]).sort((f,d)=>f-d).reverse();if(a.length>0){for(const f of a)e.data.splice(f,1);e.ping();return}const l=F.nearestPoint(o,c);l.properties._split_point="yes",e.data.push({feature:l,freshness:new Date}),e.ping()}return i.leafletMap.addCallbackAndRunD(c=>c.on("click",a=>{r([a.latlng.lng,a.latlng.lat])})),i}};let Ce=pe;m(Ce,"splitLayerStyling",new dt(pn,"(BUILTIN) SplitRoadWizard.ts",!0));class gn extends Me{constructor(n,e,s){super(n,!0);m(this,"_id");m(this,"_newLonLat");m(this,"_meta");if(!n.startsWith("node/"))throw"Invalid ID: only 'node/number' is accepted";this._id=Number(n.substring(5)),this._newLonLat=e,this._meta=s}async CreateChangeDescriptions(n){return[{changes:{lat:this._newLonLat[1],lon:this._newLonLat[0]},type:"node",id:this._id,meta:{changeType:"move",theme:this._meta.theme,specialMotivation:this._meta.reason}}]}}const Ue=class{static async Search(t){var s,o;const n=((o=(s=De==null?void 0:De.state)==null?void 0:s.currentBounds)==null?void 0:o.data)??U.global,e=Ue.host+`format=json&limit=1&viewbox=${n.getEast()},${n.getNorth()},${n.getWest()},${n.getSouth()}&accept-language=nl&q=`+t;return fe.downloadJson(e)}};let Se=Ue;m(Se,"host","https://nominatim.openstreetmap.org/search?");class wn extends v{constructor(n){const e=O.search_ui().SetClass("w-8 h-8 full-rounded border-black float-right"),s=new x(I.t.general.search.search),o=new vt({placeholder:s.map(r=>r.textFor(Re.language.data),[Re.language]),value:new x(""),inputStyle:` background: transparent;
    border: none;
    font-size: large;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    color: var(--foreground-color);`});o.SetClass("relative float-left mt-0 ml-2"),o.SetStyle("width: calc(100% - 3em);height: 100%");super([o,e]);m(this,"_searchField");this.SetClass("block h-8"),this.SetStyle("background: var(--background-color); color: var(--foreground-color); pointer-evetns:all;");async function i(){var c;const r=o.GetValue().data;if(!(r===void 0||r==="")){o.GetValue().setData(""),s.setData(I.t.general.search.searching);try{const a=await Se.Search(r);if(console.log("Search result",a),a.length==0){s.setData(I.t.general.search.nothing);return}const l=a[0],f=l.boundingbox,d=[[f[0],f[2]],[f[1],f[3]]];(c=n.selectedElement)==null||c.setData(void 0),pt.hash.setData(l.osm_type+"/"+l.osm_id),n.leafletMap.data.fitBounds(d),s.setData(I.t.general.search.search)}catch{o.GetValue().setData(""),s.setData(I.t.general.search.error)}}}o.enterPressed.addCallback(i),this._searchField=o,e.onClick(i)}focus(){this._searchField.focus()}}class _n extends A{constructor(t,n,e){const s=I.t.move;new A(s.loginToMove.SetClass("btn").onClick(()=>n.osmConnection.AttemptLogin()),void 0,n.featureSwitchUserbadge);const o=[];e.enableRelocation&&o.push({text:s.reasons.reasonRelocation,invitingText:s.inviteToMove.reasonRelocation,icon:O.relocation_svg(),changesetCommentValue:"relocated",lockBounds:!1,background:void 0,includeSearch:!0,startZoom:12,minZoom:6,eraseAddressFields:!0}),e.enableImproveAccuracy&&o.push({text:s.reasons.reasonInaccurate,invitingText:s.inviteToMove.reasonInaccurate,icon:O.crosshair_svg(),changesetCommentValue:"improve_accuracy",lockBounds:!0,includeSearch:!1,background:"photo",startZoom:17,minZoom:16,eraseAddressFields:!1});const i=new x("start"),r=new x(void 0);let c;if(o.length===1){const b=o[0];r.setData(b),c=new q(b.icon.SetStyle("height: 1.5rem; width: 1.5rem;"),I.T(b.invitingText)).onClick(()=>{i.setData("pick_location")})}else c=new q(O.move_ui().SetStyle("width: 1.5rem; height: 1.5rem"),s.inviteToMove.generic).onClick(()=>{i.setData("reason")});const a=new q(O.move_ui(),s.inviteToMoveAgain).onClick(()=>{i.setData("reason")}),l=new v(o.map(b=>new q(b.icon,b.text).onClick(()=>{r.setData(b),i.setData("pick_location")}))),f=new q(O.close_svg(),s.cancel).onClick(()=>i.setData("start")),[d,h]=F.centerpointCoordinates(t),w=r.map(b=>{if(b===void 0)return;const K=new x({lon:d,lat:h,zoom:(b==null?void 0:b.startZoom)??16});let J;typeof b.background=="string"?J=[b.background]:J=b.background;const It=Vt.SelectBestLayerAccordingTo(K,new x(J)).data,se=new Rt({minZoom:b.minZoom,centerLocation:K,mapBackground:new x(It),state:n});b.lockBounds&&se.installBounds(.05,!0);let Ve;b.includeSearch&&(Ve=new wn({leafletMap:se.leafletMap})),se.SetStyle("height: 17.5rem");const Qe=new q(O.move_confirm_svg(),s.confirmMove);Qe.onClick(async()=>{const oe=se.GetValue().data;await n.changes.applyAction(new gn(t.properties.id,[oe.lon,oe.lat],{reason:b.changesetCommentValue,theme:n.layoutToUse.id})),t.properties._lat=oe.lat,t.properties._lon=oe.lon,b.eraseAddressFields&&await n.changes.applyAction(new Pe(t.properties.id,new yt([new ae("addr:housenumber",""),new ae("addr:street",""),new ae("addr:city",""),new ae("addr:postcode","")]),t.properties,{changeType:"relocated",theme:n.layoutToUse.id})),n.allElements.getEventSourceById(g).ping(),i.setData("moved")});const xt=s.zoomInFurther.SetClass("alert block m-6");return new v([Ve,se,new A(Qe,xt,se.GetValue().map(oe=>oe.zoom>=19))]).SetClass("flex flex-col")}),p="p-2 md:p-4 m-2 border border-gray-400 rounded-xl flex flex-col",C=new Le(new E(i.map(b=>{switch(b){case"start":return c;case"reason":return new v([s.whyMove.SetClass("text-lg font-bold"),l,f]).SetClass(p);case"pick_location":return new v([s.moveTitle.SetClass("text-lg font-bold"),new E(w),f]).SetClass(p);case"moved":return new v([s.pointIsMoved.SetClass("thanks"),a]).SetClass("flex flex-col")}})),void 0,n);let g=t.properties.id;const _=n.osmConnection._oauth_config.url;g.startsWith(_)&&(g=g.substring(_.length));const $=new x(void 0);g.startsWith("way")?$.setData(s.isWay):g.startsWith("relation")?$.setData(s.isRelation):g.indexOf("-")<0&&(z.DownloadReferencingWays(g).then(b=>{b.length>0&&(console.log("Got a referencing way, move not allowed"),$.setData(s.partOfAWay))}),z.DownloadReferencingRelations(g).then(b=>{b.length>0&&$.setData(s.partOfRelation)})),super(C,new v([O.move_not_allowed_svg().SetStyle("height: 2rem").SetClass("m-2"),new v([s.cannotBeMoved,new E($).SetClass("subtle")]).SetClass("flex flex-col")]).SetClass("flex m-2 p-2 rounded-lg bg-gray-200"),$.map(b=>b===void 0));const L=this;i.addCallback(b=>{b!=="start"&&L.ScrollIntoView()})}}class Y extends ht{constructor(t,n,e,s){if(e===void 0)throw"State is undefined!";const o=e.featureSwitchShowAllQuestions.map(i=>i||e.showAllQuestionsAtOnce.data,[e.showAllQuestionsAtOnce]);if(super(()=>Y.GenerateTitleBar(t,n,e),()=>Y.GenerateContent(t,n,e,o),(s==null?void 0:s.hashToShow)??t.data.id??"item",s==null?void 0:s.isShown,s),n===void 0)throw"Undefined layerconfig"}static GenerateTitleBar(t,n,e){const s=new X(t,n.title??new we("POI"),e).SetClass("break-words font-bold sm:p-0.5 md:p-1 sm:p-1.5 md:p-2 text-2xl"),o=new v(n.titleIcons.map(i=>new X(t,i,e,"block h-8 max-h-8 align-baseline box-content sm:p-0.5 titleicon"))).SetClass("flex flex-row flex-wrap pt-0.5 sm:pt-1 items-center mr-2");return new v([new v([s,o]).SetClass("flex flex-col sm:flex-row flex-grow justify-between")])}static GenerateContent(t,n,e,s){return new A(new v([O.delete_icon_svg().SetClass("w-8 h-8"),I.t.delete.isDeleted]).SetClass("flex justify-center font-bold items-center"),Y.GenerateMainContent(t,n,e,s),t.map(o=>o._deleted=="yes"))}static GenerateMainContent(t,n,e,s){var l,f;let o=new Map;const i=I.t.general,r=fe.Dedup(n.tagRenderings.map(d=>d.group));if(((l=e==null?void 0:e.featureSwitchUserbadge)==null?void 0:l.data)??!0){const d=n.tagRenderings.filter(h=>h.id==="questions");for(const h of r){const w=n.tagRenderings.filter(g=>g.group===h),p=d.filter(g=>g.group===h)[0],C=new nn(e,{tagsSource:t,tagRenderings:w,units:n.units,showAllQuestionsAtOnce:((f=p==null?void 0:p.freeform)==null?void 0:f.helperArgs.showAllQuestions)??s});o.set(h,C)}}const c=n.tagRenderings.filter(d=>d.question!==void 0).length,a=[new E(t.map(d=>d[ae.newlyCreated.key]).map(d=>{if(d===void 0)return;const h=new Date(d);if((Date.now()-h.getTime())/1e3>=60*5)return;const p=[],C=new v([O.party_svg().SetClass("w-12 h-12 shrink-0 p-1 m-1 bg-white rounded-full block"),i.newlyCreated]).SetClass("flex w-full thanks content-center");return p.push(C),c>0&&p.push(i.feelFreeToSkip),new v(p).SetClass("pb-4 mb-4 border-b block border-black")}))];for(let d=0;d<r.length;d++){const h=r[d],w=n.tagRenderings.filter(g=>g.group===h),p=[],C="block w-full break-word text-default m-1 p-1 border-b border-gray-200 mb-2 pb-2";for(const g of w)if(g.question===null||g.id==="questions"){const _=o.get(g.group);if(o.delete(g.group),g.render!==void 0){_.SetClass("text-sm");const $=new X(t,g,e,g.group+" questions","",{specialViz:new Map([["questions",_]])}),L=new A($,void 0,_.restingQuestions.map(b=>(b==null?void 0:b.length)>0));p.push(L)}else p.push(_)}else{let _=p.length===0&&d>0;const $=new At(t,g,n.units,e,{innerElementClasses:C});_&&$.SetClass("sticky top-0"),p.push($)}a.push(...p)}return a.push(new A(new Ct(()=>Y.createEditElements(o,n,t,e)),void 0,e.featureSwitchUserbadge)),new v(a).SetClass("block")}static createEditElements(t,n,e,s){let o=[];return t.forEach(i=>{o.push(i)}),n.allowMove&&o.push(new E(e.map(i=>i.id).map(i=>{const r=s.allElements.ContainingFeatures.get(i);return r===void 0?"This feature is not register in the state.allElements and cannot be moved":new _n(r,s,n.allowMove)})).SetClass("text-base")),n.deletion&&o.push(new E(e.map(i=>i.id).map(i=>new me(i,s,n.deletion))).SetClass("text-base")),n.allowSplit&&o.push(new E(e.map(i=>i.id).map(i=>new Ce(i,s))).SetClass("text-base")),o.push(new E(s.osmConnection.userDetails.map(i=>i.csCount).map(i=>{if(!(i<=ce.userJourney.historyLinkVisible&&s.featureSwitchIsDebugging.data==!1&&s.featureSwitchIsTesting.data===!1))return new X(e,Bt.SharedTagRendering.get("last_edit"),s)},[s.featureSwitchIsDebugging,s.featureSwitchIsTesting]))),o.push(A.If(s.featureSwitchIsDebugging,()=>{const i=new we({render:"{all_tags()}"},""),r=new we({render:"{export_as_geojson()}"},""),c=new we({render:"{open_in_iD()}"},"");return new v([new X(e,i,s),new X(e,r,s),new X(e,c,s),"This is layer "+n.id])})),new v(o).SetClass("flex flex-col")}}class bn{constructor(){m(this,"_name","enclosingFeatures");m(this,"_doc",["Gives a list of all features in the specified layers which fully contain this object. Returned features will always be (multi)polygons. (LineStrings and Points from the other layers are ignored)","","The result is a list of features: `{feat: Polygon}[]`","This function will never return the feature itself."].join(`
`));m(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for overlap)"])}_f(t,n){return(...e)=>{const s=[],o=U.get(n),i=new Set;i.add(n.properties.id);for(const r of e){const c=t.getFeaturesWithin(r,o);if(c!==void 0&&c.length!==0)for(const a of c)for(const l of a)i.has(l.properties.id)||(i.add(l.properties.id),!(l.geometry.type!=="Polygon"&&l.geometry.type!=="MultiPolygon")&&F.completelyWithin(n,l)&&s.push({feat:l}))}return s}}}class yn{constructor(){m(this,"_name","overlapWith");m(this,"_doc",["Gives a list of features from the specified layer which this feature (partly) overlaps with. A point which is embedded in the feature is detected as well.","If the current feature is a point, all features that this point is embeded in are given.","","The returned value is `{ feat: GeoJSONFeature, overlap: number}[]` where `overlap` is the overlapping surface are (in mÂ²) for areas, the overlapping length (in meter) if the current feature is a line or `undefined` if the current feature is a point.","The resulting list is sorted in descending order by overlap. The feature with the most overlap will thus be the first in the list.","","For example to get all objects which overlap or embed from a layer, use `_contained_climbing_routes_properties=feat.overlapWith('climbing_route')`","","Also see [enclosingFeatures](#enclosingFeatures) which can be used to get all objects which fully contain this feature"].join(`
`));m(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for overlap)"])}_f(t,n){return(...e)=>{const s=[],o=new Set,i=U.get(n);for(const r of e){const c=t.getFeaturesWithin(r,i);if(c!==void 0&&c.length!==0)for(const a of c){const l=F.calculateOverlap(n,a);for(const f of l)o.has(f.feat.properties.id)||(o.add(f.feat.properties.id),s.push(f))}}return s.sort((r,c)=>c.overlap-r.overlap),s}}}class vn{constructor(){m(this,"_name","intersectionsWith");m(this,"_doc",`Gives the intersection points with selected features. Only works with (Multi)Polygons and LineStrings.

Returns a \`{feat: GeoJson, intersections: [number,number][]}\` where \`feat\` is the full, original feature. This list is in random order.

If the current feature is a point, this function will return an empty list.
Points from other layers are ignored - even if the points are parts of the current linestring.`);m(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for intersection)"])}_f(t,n){return(...e)=>{const s=[],o=U.get(n);for(const i of e){const r=t.getFeaturesWithin(i,o);if(r!==void 0&&r.length!==0)for(const c of r)for(const a of c){const l=F.LineIntersections(n,a);l.length!==0&&s.push({feat:a,intersections:l})}}return s}}}class Cn{constructor(){m(this,"_name","distanceTo");m(this,"_doc","Calculates the distance between the feature and a specified point in meter. The input should either be a pair of coordinates, a geojson feature or the ID of an object");m(this,"_args",["feature OR featureID OR longitude","undefined OR latitude"])}_f(t,n){return(e,s)=>{if(e!==void 0){if(typeof e=="number")return F.distanceBetween([e,s],F.centerpointCoordinates(n));if(typeof e=="string"){const o=t.getFeatureById(e);if(o===void 0)return;e=o}return F.distanceBetween(F.centerpointCoordinates(e),F.centerpointCoordinates(n))}}}}class Sn{constructor(){m(this,"_name","closest");m(this,"_doc","Given either a list of geojson features or a single layer name, gives the single object which is nearest to the feature. In the case of ways/polygons, only the centerpoint is considered. Returns a single geojson feature or undefined if nothing is found (or not yet loaded)");m(this,"_args",["list of features or a layer name or '*' to get all features"])}_f(t,n){return e=>{var s,o;return(o=(s=$e.GetClosestNFeatures(t,n,e))==null?void 0:s[0])==null?void 0:o.feat}}}class $e{constructor(){m(this,"_name","closestn");m(this,"_doc","Given either a list of geojson features or a single layer name, gives the n closest objects which are nearest to the feature (excluding the feature itself). In the case of ways/polygons, only the centerpoint is considered. Returns a list of `{feat: geojson, distance:number}` the empty list if nothing is found (or not yet loaded)\n\nIf a 'unique tag key' is given, the tag with this key will only appear once (e.g. if 'name' is given, all features will have a different name)");m(this,"_args",["list of features or layer name or '*' to get all features","amount of features","unique tag key (optional)","maxDistanceInMeters (optional)"])}static GetClosestNFeatures(t,n,e,s){const o=(s==null?void 0:s.maxFeatures)??1,i=(s==null?void 0:s.maxDistance)??500,r=s==null?void 0:s.uniqueTag;if(typeof e=="string"){const l=e,f=F.bbox(F.buffer(F.bbox(n),i));e=t.getFeaturesWithin(l,new U(f.geometry.coordinates))}else e=[e];if(e===void 0)return;const c=F.centerpointCoordinates(n);let a=[];for(const l of e)for(const f of l){if(f===n||f.properties.id===n.properties.id)continue;const d=F.distanceBetween(F.centerpointCoordinates(f),c);if(d==null||isNaN(d))throw console.error("Could not calculate the distance between",n,"and",f),"Undefined distance!";if(d===0&&console.trace("Got a suspiciously zero distance between",f,"and self-feature",n),d>i)continue;if(a.length===0){a.push({feat:f,distance:d});continue}if(a.length>=o&&a[o-1].distance<d)continue;let h=a.length;for(let w=0;w<a.length;w++){const p=a[w];if(r!==void 0&&f.properties[r]!==void 0&&p.feat.properties[r]===f.properties[r]){h=-1,p.distance>d&&(a[w]={feat:f,distance:d});break}if(p.distance>d){if(h=w,r!==void 0){const C=f.properties[r];for(let g=w;g<a.length;g++)a[g].feat.properties[r]===C&&a.splice(g,1)}break}}h!=-1&&(h<o?(a.splice(h,0,{feat:f,distance:d}),a.length>=o&&a.splice(o,1)):a[h]={feat:f,distance:d})}return a}_f(t,n){return(e,s,o,i)=>{let r=Number(i);return isNaN(r)&&(r=void 0),$e.GetClosestNFeatures(t,n,e,{maxFeatures:Number(s),uniqueTag:o,maxDistance:r})}}}class Dn{constructor(){m(this,"_name","memberships");m(this,"_doc","Gives a list of `{role: string, relation: Relation}`-objects, containing all the relations that this feature is part of. \n\nFor example: `_part_of_walking_routes=feat.memberships().map(r => r.relation.tags.name).join(';')`");m(this,"_args",[])}_f(t,n){return()=>t.memberships.knownRelations.data.get(n.properties.id)??[]}}class kn{constructor(){m(this,"_name","get");m(this,"_doc","Gets the property of the feature, parses it (as JSON) and returns it. Might return 'undefined' if not defined, null, ...");m(this,"_args",["key"])}_f(t,n){return e=>{const s=n.properties[e];if(s!==void 0)try{const o=JSON.parse(s);return o===null?void 0:o}catch(o){console.warn("Could not parse property "+e+" due to: "+o+", the value is "+s);return}}}}const le=class{static FullPatchFeature(t,n){if(!n._is_patched){n._is_patched=!0;for(const e of le.allFuncs)n[e._name]=e._f(t,n)}}static HelpText(){const t=[];for(const n of le.allFuncs)t.push(new de(n._name,3),n._doc,new _e(n._args??[],!0));return new v([le.intro,new _e(le.allFuncs.map(n=>`[${n._name}](#${n._name})`)),...t])}};let he=le;m(he,"intro",new v([new de("Calculating tags with Javascript",2),"In some cases, it is useful to have some tags calculated based on other properties. Some useful tags are available by default (e.g. `lat`, `lon`, `_country`), as detailed above.","It is also possible to calculate your own tags - but this requires some javascript knowledge.","","Before proceeding, some warnings:",new _e(["DO NOT DO THIS AS BEGINNER","**Only do this if all other techniques fail**  This should _not_ be done to create a rendering effect, only to calculate a specific value","**THIS MIGHT BE DISABLED WITHOUT ANY NOTICE ON UNOFFICIAL THEMES** As unofficial themes might be loaded from the internet, this is the equivalent of injecting arbitrary code into the client. It'll be disabled if abuse occurs."]),"To enable this feature,  add a field `calculatedTags` in the layer object, e.g.:","````",'"calculatedTags": [','    "_someKey=javascript-expression",','    "name=feat.properties.name ?? feat.properties.ref ?? feat.properties.operator",',`    "_distanceCloserThen3Km=feat.distanceTo( some_lon, some_lat) < 3 ? 'yes' : 'no'" `,"  ]","````","","The above code will be executed for every feature in the layer. The feature is accessible as `feat` and is an amended geojson object:",new _e(["`area` contains the surface area (in square meters) of the object","`lat` and `lon` contain the latitude and longitude"]),"Some advanced functions are available on **feat** as well:"]).SetClass("flex-col").AsMarkdown()),m(he,"allFuncs",[new Cn,new yn,new bn,new vn,new Sn,new $e,new Dn,new kn]);const j=class{static addMetatags(t,n,e,s,o){var a,l;if(t===void 0||t.length===0)return;console.log("Recalculating metatags...");const i=[];for(const f of Qt.metatags)f.includesDates?((o==null?void 0:o.includeDates)??!0)&&i.push(f):((o==null?void 0:o.includeNonDates)??!0)&&i.push(f);const r=this.createRetaggingFunc(e,s);let c=!1;for(let f=0;f<t.length;f++){const d=t[f],h=d.feature,w=d.freshness;let p=!1,C=new Set(Object.getOwnPropertyNames(h.properties));for(const g of i)try{if(!g.keys.some(_=>h.properties[_]===void 0))continue;if(g.isLazy){if(!g.keys.some(_=>!C.has(_)))continue;if(p=!0,g.applyMetaTagsOnFeature(h,w,e,s),o!=null&&o.evaluateStrict)for(const _ of g.keys)h.properties[_]}else p=g.applyMetaTagsOnFeature(h,w,e,s)||p}catch(_){console.error("Could not calculate metatag for ",g.keys.join(","),":",_,_.stack)}if(r!==void 0){let g=!1;try{g=r(n,h)}catch(_){console.error(_)}p=p||g}p&&((l=(a=s==null?void 0:s.allElements)==null?void 0:a.getEventSourceById(h.properties.id))==null||l.ping(),c=!0)}return c}static createFunctionsForFeature(t,n){const e=[];for(const s of n){const o=s[0],i=s[1],r=s[2];if(i===void 0)continue;const c=l=>{try{let f=new Function("feat","return "+i+";")(l);return f!==void 0&&typeof f!="string"&&(f=JSON.stringify(f)),delete l.properties[o],l.properties[o]=f,f}catch(f){j.errorPrintCount<j.stopErrorOutputAt&&(console.warn("Could not calculate a "+(r?"strict ":"")+" calculated tag for key "+o+" defined by "+i+" (in layer"+t+`) due to 
`+f+`
. Are you the theme creator? Doublecheck your code. Note that the metatags might not be stable on new features`,f,f.stack),j.errorPrintCount++,j.errorPrintCount==j.stopErrorOutputAt&&console.error("Got ",j.stopErrorOutputAt," errors calculating this metatagging - stopping output now"));return}};if(r){e.push(c);continue}const a=l=>{delete l.properties[o],Object.defineProperty(l.properties,o,{configurable:!0,enumerable:!1,get:function(){return c(l)}})};e.push(a)}return e}static createRetaggingFunc(t,n){const e=t.calculatedTags;if(e===void 0||e.length===0)return;let s=j.retaggingFuncCache.get(t.id);return s===void 0&&(s=j.createFunctionsForFeature(t.id,e),j.retaggingFuncCache.set(t.id,s)),(o,i)=>{if(i.properties!==void 0){try{he.FullPatchFeature(o,i);for(const c of s)c(i)}catch(c){console.error("Invalid syntax in calculated tags or some other error: ",c)}return!0}}}};let ie=j;m(ie,"errorPrintCount",0),m(ie,"stopErrorOutputAt",10),m(ie,"retaggingFuncCache",new Map);class Ke{constructor(t,n,e){m(this,"neededLayerBboxes",new Map);m(this,"source");m(this,"params");m(this,"state");m(this,"isDirty",new x(!1));this.state=n,this.source=t;const s=this;this.params={getFeatureById(o){return n.allElements.ContainingFeatures.get(o)},getFeaturesWithin(o,i){let r=s.neededLayerBboxes.get(o);return r===void 0?s.neededLayerBboxes.set(o,i):i.isContainedIn(r)||s.neededLayerBboxes.set(o,r.unionWith(i)),e.GetFeaturesWithin(o,i)},memberships:e.relationTracker},this.isDirty.stabilized(100).addCallback(o=>{o&&s.updateMetaTags()}),this.source.features.addCallbackAndRunD(o=>s.isDirty.setData(!0))}requestUpdate(){this.isDirty.setData(!0)}updateMetaTags(){const t=this.source.features.data;if(t.length===0){this.isDirty.setData(!1);return}ie.addMetatags(t,this.params,this.source.layer.layerDef,this.state),this.isDirty.setData(!1)}}class Tn{constructor(t,n){m(this,"_state");m(this,"_featurePipeline");m(this,"_alreadyRegistered",new Set);m(this,"_notifiers",[]);if(this._featurePipeline=n,this._state=t,t.currentView!==void 0){const e=new Ke(t.currentView,this._state,this._featurePipeline);this._alreadyRegistered.add(t.currentView),this._notifiers.push(e),t.currentView.features.addCallback(s=>{console.debug("Requesting an update for currentView"),e.updateMetaTags()})}}registerSource(t,n=!1){if(t===void 0||this._alreadyRegistered.has(t))return;this._alreadyRegistered.add(t),this._notifiers.push(new Ke(t,this._state,this._featurePipeline));const e=this;t.features.addCallbackAndRunD(s=>{const o=t.layer.layerDef.id;for(const i of e._notifiers){const r=i.neededLayerBboxes.get(o);r!=null&&(t.bbox===void 0||r.overlapsWith(t.bbox))&&i.requestUpdate()}})}}class In extends Pt{constructor(n){super(n);m(this,"featurePipeline");m(this,"featureAggregator");m(this,"metatagRecalculator");m(this,"popups",new Map);const e=n==null?void 0:n.clustering;this.featureAggregator=be.createHierarchy(this);const s=this.featureAggregator,o=this,i=[];function r(a){o.metatagRecalculator===void 0?i.push(a):o.metatagRecalculator.registerSource(a)}function c(a){s.addTile(a);const l=a.features.map(d=>U.bboxAroundAll(d.map(h=>U.get(h.feature)))),f=a.features.map(d=>{var _;const h=o.locationControl.data.zoom;if(!a.layer.isDisplayed.data)return!1;const w=o.currentBounds.data;if(w===void 0||!l.data.overlapsWith(w)||h<a.layer.layerDef.minzoom)return!1;if(h>e.maxZoom)return!0;if(d.length>e.minNeededElements)return!1;let[p,C,g]=Z.tile_from_index(a.tileIndex);if(p>=h){for(;p>h;)p--,C=Math.floor(C/2),g=Math.floor(g/2);if(((_=s.getTile(Z.tile_index(p,C,g)))==null?void 0:_.totalValue)>e.minNeededElements)return!1}return!0},[o.currentBounds,a.layer.isDisplayed,l]);new Ie({features:a,leafletMap:o.leafletMap,layerToShow:a.layer.layerDef,doShowLayer:f,selectedElement:o.selectedElement,state:o,popup:(d,h)=>o.CreatePopup(d,h)})}this.featurePipeline=new Nt(c,this,{handleRawFeatureSource:r}),this.metatagRecalculator=new Tn(this,this.featurePipeline),this.metatagRecalculator.registerSource(this.currentView,!0),i.forEach(a=>o.metatagRecalculator.registerSource(a)),new ve(pt.hash,this),this.AddClusteringToMap(this.leafletMap)}CreatePopup(n,e){if(this.popups.has(n.data.id))return this.popups.get(n.data.id);const s=new Y(n,e,this);return this.popups.set(n.data.id,s),s}AddClusteringToMap(n){const e=this.layoutToUse.clustering,s=this;new Ie({features:this.featureAggregator.getCountsForZoom(e,this.locationControl,e.minNeededElements),leafletMap:n,layerToShow:ye.styling,popup:this.featureSwitchIsDebugging.data?(o,i)=>new Y(o,i,s):void 0,state:this})}}class De extends In{constructor(t){super(t)}}m(De,"state");function xn(u){let t,n,e;return n=new Ee({props:{construct:O.search_disable_ui()}}),{c(){t=M("span"),B(n.$$.fragment),D(t,"slot","image"),D(t,"class","svelte-1aqsasq")},m(s,o){k(s,t,o),P(n,t,null),e=!0},p:H,i(s){e||(y(n.$$.fragment,s),e=!0)},o(s){S(n.$$.fragment,s),e=!1},d(s){s&&T(t),N(n)}}}function Mn(u){let t;return{c(){t=M("span"),t.textContent=`${u[1].noSearch.toString()}`,D(t,"slot","message"),D(t,"class","svelte-1aqsasq")},m(n,e){k(n,t,e)},p:H,d(n){n&&T(t)}}}function $n(u){let t,n,e,s,o,i,r,c,a;return i=new ge({props:{$$slots:{message:[Mn],image:[xn]},$$scope:{ctx:u}}}),{c(){t=M("span"),n=M("h5"),n.textContent=`${u[1].noMatchingThemes.toString()}`,e=W(),s=M("button"),o=M("span"),B(i.$$.fragment),D(n,"class","svelte-1aqsasq"),D(o,"class","svelte-1aqsasq"),D(s,"class","svelte-1aqsasq"),D(t,"class","svelte-1aqsasq")},m(l,f){k(l,t,f),R(t,n),R(t,e),R(t,s),R(s,o),P(i,o,null),r=!0,c||(a=Lt(s,"click",u[2]),c=!0)},p(l,[f]){const d={};f&8&&(d.$$scope={dirty:f,ctx:l}),i.$set(d)},i(l){r||(y(i.$$.fragment,l),r=!0)},o(l){S(i.$$.fragment,l),r=!1},d(l){l&&T(t),N(i),c=!1,a()}}}function Fn(u,t,n){let{search:e}=t;const s=I.t.general.morescreen,o=()=>{e.setData("")};return u.$$set=i=>{"search"in i&&n(0,e=i.search)},[e,s,o]}class On extends ee{constructor(t){super(),te(this,t,Fn,$n,ne,{search:0})}}function Rn(u){let t,n;return t=new ge({props:{options:{url:"https://pietervdvn.github.io/mc/legacy/070/customGenerator.html"},$$slots:{message:[Pn],image:[Bn]},$$scope:{ctx:u}}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,s){const o={};s&8&&(o.$$scope={dirty:s,ctx:e}),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}function An(u){let t,n;return t=new ge({props:{options:{url:"https://github.com/pietervdvn/MapComplete/issues",newTab:!0},$$slots:{message:[Nn]},$$scope:{ctx:u}}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,s){const o={};s&8&&(o.$$scope={dirty:s,ctx:e}),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}function Bn(u){let t,n,e;return n=new Ee({props:{construct:O.pencil_ui()}}),{c(){t=M("span"),B(n.$$.fragment),D(t,"slot","image"),D(t,"class","h-11 w-11 mx-4 bg-red")},m(s,o){k(s,t,o),P(n,t,null),e=!0},p:H,i(s){e||(y(n.$$.fragment,s),e=!0)},o(s){S(n.$$.fragment,s),e=!1},d(s){s&&T(t),N(n)}}}function Pn(u){let t;return{c(){t=M("span"),t.textContent=`${u[2].createYourOwnTheme.toString()}`,D(t,"slot","message")},m(n,e){k(n,t,e)},p:H,d(n){n&&T(t)}}}function Nn(u){let t;return{c(){t=M("span"),t.textContent=`${u[2].requestATheme.toString()}`,D(t,"slot","message")},m(n,e){k(n,t,e)},p:H,d(n){n&&T(t)}}}function Ln(u){let t,n,e,s;const o=[An,Rn],i=[];function r(c,a){return c[1].csCount<ce.userJourney.themeGeneratorReadOnlyUnlock?0:1}return n=r(u),e=i[n]=o[n](u),{c(){t=M("div"),e.c()},m(c,a){k(c,t,a),i[n].m(t,null),s=!0},p(c,[a]){let l=n;n=r(c),n===l?i[n].p(c,a):(V(),S(i[l],1,1,()=>{i[l]=null}),Q(),e=i[n],e?e.p(c,a):(e=i[n]=o[n](c),e.c()),y(e,1),e.m(t,null))},i(c){s||(y(e),s=!0)},o(c){S(e),s=!1},d(c){c&&T(t),i[n].d()}}}function En(u,t,n){let e,s=H,o=()=>(s(),s=Ne(i,c=>n(1,e=c)),i);u.$$.on_destroy.push(()=>s());let{userDetails:i}=t;o();const r=I.t.general.morescreen;return console.log(e.csCount<50),u.$$set=c=>{"userDetails"in c&&o(n(0,i=c.userDetails))},[i,e,r]}class Dt extends ee{constructor(t){super(),te(this,t,En,Ln,ne,{userDetails:0})}}function jn(u){let t;return{c(){t=M("span"),t.textContent=`${u[0].button.toString()}`,D(t,"slot","message")},m(n,e){k(n,t,e)},p:H,d(n){n&&T(t)}}}function Gn(u){let t,n,e,s,o,i,r;return n=new Ee({props:{construct:new de(u[0].hook,4)}}),i=new ge({props:{options:{url:"./professional.html"},$$slots:{message:[jn]},$$scope:{ctx:u}}}),{c(){t=M("div"),B(n.$$.fragment),e=W(),s=M("span"),s.textContent=`${u[0].hookMore.toString()}`,o=W(),B(i.$$.fragment),D(t,"class","svelte-1rzxcyx")},m(c,a){k(c,t,a),P(n,t,null),R(t,e),R(t,s),R(t,o),P(i,t,null),r=!0},p(c,[a]){const l={};a&2&&(l.$$scope={dirty:a,ctx:c}),i.$set(l)},i(c){r||(y(n.$$.fragment,c),y(i.$$.fragment,c),r=!0)},o(c){S(n.$$.fragment,c),S(i.$$.fragment,c),r=!1},d(c){c&&T(t),N(n),N(i)}}}function qn(u){return[I.t.professional.indexPage]}class kt extends ee{constructor(t){super(),te(this,t,qn,Gn,ne,{})}}const Xe="personal";function Ye(u){let t,n,e;return n=new ge({props:{options:{url:u[7](u[0],u[1],u[3])},$$slots:{message:[zn],image:[Wn]},$$scope:{ctx:u}}}),{c(){t=M("div"),B(n.$$.fragment),D(t,"class","svelte-1gmg4t2")},m(s,o){k(s,t,o),P(n,t,null),e=!0},p(s,o){const i={};o&11&&(i.options={url:s[7](s[0],s[1],s[3])}),o&305&&(i.$$scope={dirty:o,ctx:s}),n.$set(i)},i(s){e||(y(n.$$.fragment,s),e=!0)},o(s){S(n.$$.fragment,s),e=!1},d(s){s&&T(t),N(n)}}}function Wn(u){let t,n;return{c(){t=M("img"),D(t,"slot","image"),He(t.src,n=u[0].icon)||D(t,"src",n),D(t,"class","block h-11 w-11 bg-red mx-4"),D(t,"alt","")},m(e,s){k(e,t,s)},p(e,s){s&1&&!He(t.src,n=e[0].icon)&&D(t,"src",n)},d(e){e&&T(t)}}}function zn(u){let t,n,e,s,o,i,r;return{c(){t=M("span"),n=M("span"),e=M("span"),s=Ae(u[5]),o=W(),i=M("span"),r=Ae(u[4]),D(e,"class","svelte-1gmg4t2"),D(i,"class","svelte-1gmg4t2"),D(n,"class","svelte-1gmg4t2"),D(t,"slot","message"),D(t,"class","message svelte-1gmg4t2")},m(c,a){k(c,t,a),R(t,n),R(n,e),R(e,s),R(n,o),R(n,i),R(i,r)},p(c,a){a&32&&Be(s,c[5]),a&16&&Be(r,c[4])},d(c){c&&T(t)}}}function Un(u){let t,n,e=(u[0].id!==Xe||u[6].csCount>ce.userJourney.personalLayoutUnlock)&&Ye(u);return{c(){e&&e.c(),t=ue()},m(s,o){e&&e.m(s,o),k(s,t,o),n=!0},p(s,[o]){s[0].id!==Xe||s[6].csCount>ce.userJourney.personalLayoutUnlock?e?(e.p(s,o),o&65&&y(e,1)):(e=Ye(s),e.c(),y(e,1),e.m(t.parentNode,t)):e&&(V(),S(e,1,1,()=>{e=null}),Q())},i(s){n||(y(e),n=!0)},o(s){S(e),n=!1},d(s){e&&e.d(s),s&&T(t)}}}function Vn(u,t,n){let e,s,o,i=H,r=()=>(i(),i=Ne(l,h=>n(6,o=h)),l);u.$$.on_destroy.push(()=>i());let{theme:c}=t,{isCustom:a=!1}=t,{userDetails:l}=t;r();let{state:f}=t;function d(h,w,p){var L;if(h===void 0)return;if(h.id===void 0){console.error("ID is undefined for layout",h);return}if(h.id===((L=p==null?void 0:p.layoutToUse)==null?void 0:L.id))return;const C=p==null?void 0:p.locationControl;let g=window.location.pathname;g=g.substr(0,g.lastIndexOf("/")),g===""&&(g=".");let _=`${g}/${h.id.toLowerCase()}.html?`;(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(_=`${g}/theme.html?layout=${h.id}&`),w&&(_=`${g}/theme.html?userlayout=${h.id}&`);let $="";return h.definition!==void 0&&($="#"+btoa(JSON.stringify(h.definition))),(C==null?void 0:C.map(b=>{const K=[["z",b==null?void 0:b.zoom],["lat",b==null?void 0:b.lat],["lon",b==null?void 0:b.lon]].filter(J=>J[1]!==void 0).map(J=>J[0]+"="+J[1]).join("&");return`${_}${K}${$}`}))??new gt(`${_}`)}return u.$$set=h=>{"theme"in h&&n(0,c=h.theme),"isCustom"in h&&n(1,a=h.isCustom),"userDetails"in h&&r(n(2,l=h.userDetails)),"state"in h&&n(3,f=h.state)},u.$$.update=()=>{u.$$.dirty&3&&n(5,e=new xe(c.title,!a&&!c.mustHaveLanguage?"themes:"+c.id+".title":void 0).toString()),u.$$.dirty&1&&n(4,s=new xe(c.shortDescription).toString())},[c,a,l,f,s,e,o,d]}class Tt extends ee{constructor(t){super(),te(this,t,Vn,Un,ne,{theme:0,isCustom:1,userDetails:2,state:3})}}function et(u,t,n){const e=u.slice();return e[10]=t[n],e}function tt(u,t,n){const e=u.slice();return e[10]=t[n],e}const Qn=u=>({}),nt=u=>({});function Hn(u){let t,n,e=[],s=new Map,o,i=(u[5]===void 0||u[5]==="")&&!u[2]&&u[4]&&st(u),r=u[6];const c=a=>a[10].id;for(let a=0;a<r.length;a+=1){let l=et(u,r,a),f=c(l);s.set(f,e[a]=it(f,l))}return{c(){t=M("div"),i&&i.c(),n=W();for(let a=0;a<e.length;a+=1)e[a].c()},m(a,l){k(a,t,l),i&&i.m(t,null),R(t,n);for(let f=0;f<e.length;f+=1)e[f].m(t,null);o=!0},p(a,l){(a[5]===void 0||a[5]==="")&&!a[2]&&a[4]?i?(i.p(a,l),l&52&&y(i,1)):(i=st(a),i.c(),y(i,1),i.m(t,n)):i&&(V(),S(i,1,1,()=>{i=null}),Q()),l&86&&(r=a[6],V(),e=wt(e,l,c,1,a,r,s,t,_t,it,null,et),Q())},i(a){if(!o){y(i);for(let l=0;l<r.length;l+=1)y(e[l]);o=!0}},o(a){S(i);for(let l=0;l<e.length;l+=1)S(e[l]);o=!1},d(a){a&&T(t),i&&i.d();for(let l=0;l<e.length;l+=1)e[l].d()}}}function Jn(u){let t,n,e=[],s=new Map,o,i=(u[5]===void 0||u[5]==="")&&!u[2]&&u[4]&&at(u),r=u[6];const c=a=>a[10].id;for(let a=0;a<r.length;a+=1){let l=tt(u,r,a),f=c(l);s.set(f,e[a]=lt(f,l))}return{c(){t=M("div"),i&&i.c(),n=W();for(let a=0;a<e.length;a+=1)e[a].c();D(t,"class","md:grid md:grid-flow-row md:grid-cols-2 lg:grid-cols-3 gap-4")},m(a,l){k(a,t,l),i&&i.m(t,null),R(t,n);for(let f=0;f<e.length;f+=1)e[f].m(t,null);o=!0},p(a,l){(a[5]===void 0||a[5]==="")&&!a[2]&&a[4]?i?(i.p(a,l),l&52&&y(i,1)):(i=at(a),i.c(),y(i,1),i.m(t,n)):i&&(V(),S(i,1,1,()=>{i=null}),Q()),l&86&&(r=a[6],V(),e=wt(e,l,c,1,a,r,s,t,_t,lt,null,tt),Q())},i(a){if(!o){y(i);for(let l=0;l<r.length;l+=1)y(e[l]);o=!0}},o(a){S(i);for(let l=0;l<e.length;l+=1)S(e[l]);o=!1},d(a){a&&T(t),i&&i.d();for(let l=0;l<e.length;l+=1)e[l].d()}}}function st(u){let t,n,e,s;return t=new Dt({props:{userDetails:u[1].osmConnection.userDetails}}),e=new kt({}),{c(){B(t.$$.fragment),n=W(),B(e.$$.fragment)},m(o,i){P(t,o,i),k(o,n,i),P(e,o,i),s=!0},p(o,i){const r={};i&2&&(r.userDetails=o[1].osmConnection.userDetails),t.$set(r)},i(o){s||(y(t.$$.fragment,o),y(e.$$.fragment,o),s=!0)},o(o){S(t.$$.fragment,o),S(e.$$.fragment,o),s=!1},d(o){N(t,o),o&&T(n),N(e,o)}}}function ot(u){let t,n;return t=new Tt({props:{theme:u[10],isCustom:u[2],userDetails:u[1].osmConnection.userDetails,state:u[1]}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,s){const o={};s&64&&(o.theme=e[10]),s&4&&(o.isCustom=e[2]),s&2&&(o.userDetails=e[1].osmConnection.userDetails),s&2&&(o.state=e[1]),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}function it(u,t){var i;let n,e,s,o=t[10]!==void 0&&!(t[4]&&((i=t[10])!=null&&i.hideFromOverview))&&ot(t);return{key:u,first:null,c(){n=ue(),o&&o.c(),e=ue(),this.first=n},m(r,c){k(r,n,c),o&&o.m(r,c),k(r,e,c),s=!0},p(r,c){var a;t=r,t[10]!==void 0&&!(t[4]&&((a=t[10])!=null&&a.hideFromOverview))?o?(o.p(t,c),c&80&&y(o,1)):(o=ot(t),o.c(),y(o,1),o.m(e.parentNode,e)):o&&(V(),S(o,1,1,()=>{o=null}),Q())},i(r){s||(y(o),s=!0)},o(r){S(o),s=!1},d(r){r&&T(n),o&&o.d(r),r&&T(e)}}}function at(u){let t,n,e,s;return t=new Dt({props:{userDetails:u[1].osmConnection.userDetails}}),e=new kt({}),{c(){B(t.$$.fragment),n=W(),B(e.$$.fragment)},m(o,i){P(t,o,i),k(o,n,i),P(e,o,i),s=!0},p(o,i){const r={};i&2&&(r.userDetails=o[1].osmConnection.userDetails),t.$set(r)},i(o){s||(y(t.$$.fragment,o),y(e.$$.fragment,o),s=!0)},o(o){S(t.$$.fragment,o),S(e.$$.fragment,o),s=!1},d(o){N(t,o),o&&T(n),N(e,o)}}}function rt(u){let t,n;return t=new Tt({props:{theme:u[10],isCustom:u[2],userDetails:u[1].osmConnection.userDetails,state:u[1]}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,s){const o={};s&64&&(o.theme=e[10]),s&4&&(o.isCustom=e[2]),s&2&&(o.userDetails=e[1].osmConnection.userDetails),s&2&&(o.state=e[1]),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}function lt(u,t){var i;let n,e,s,o=t[10]!==void 0&&!(t[4]&&((i=t[10])!=null&&i.hideFromOverview))&&rt(t);return{key:u,first:null,c(){n=ue(),o&&o.c(),e=ue(),this.first=n},m(r,c){k(r,n,c),o&&o.m(r,c),k(r,e,c),s=!0},p(r,c){var a;t=r,t[10]!==void 0&&!(t[4]&&((a=t[10])!=null&&a.hideFromOverview))?o?(o.p(t,c),c&80&&y(o,1)):(o=rt(t),o.c(),y(o,1),o.m(e.parentNode,e)):o&&(V(),S(o,1,1,()=>{o=null}),Q())},i(r){s||(y(o),s=!0)},o(r){S(o),s=!1},d(r){r&&T(n),o&&o.d(r),r&&T(e)}}}function ct(u){let t,n;return t=new On({props:{search:u[0]}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,s){const o={};s&1&&(o.search=e[0]),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}function Zn(u){let t,n,e,s,o,i;const r=u[9].title,c=Et(r,u,u[8],nt),a=[Jn,Hn],l=[];function f(h,w){return h[3]?0:1}e=f(u),s=l[e]=a[e](u);let d=u[6].length==0&&ct(u);return{c(){t=M("section"),c&&c.c(),n=W(),s.c(),o=W(),d&&d.c(),D(t,"class","svelte-1k9r5cn")},m(h,w){k(h,t,w),c&&c.m(t,null),R(t,n),l[e].m(t,null),R(t,o),d&&d.m(t,null),i=!0},p(h,[w]){c&&c.p&&(!i||w&256)&&jt(c,r,h,h[8],i?qt(r,h[8],w,Qn):Gt(h[8]),nt);let p=e;e=f(h),e===p?l[e].p(h,w):(V(),S(l[p],1,1,()=>{l[p]=null}),Q(),s=l[e],s?s.p(h,w):(s=l[e]=a[e](h),s.c()),y(s,1),s.m(t,o)),h[6].length==0?d?(d.p(h,w),w&64&&y(d,1)):(d=ct(h),d.c(),y(d,1),d.m(t,null)):d&&(V(),S(d,1,1,()=>{d=null}),Q())},i(h){i||(y(c,h),y(s),y(d),i=!0)},o(h){S(c,h),S(s),S(d),i=!1},d(h){h&&T(t),c&&c.d(h),l[e].d(),d&&d.d()}}}function Kn(u,t,n){let e,s,o=H,i=()=>(o(),o=Ne(a,p=>n(5,s=p)),a);u.$$.on_destroy.push(()=>o());let{$$slots:r={},$$scope:c}=t,{search:a}=t;i();let{themes:l}=t,{state:f}=t,{isCustom:d=!1}=t,{onMainScreen:h=!0}=t,{hideThemes:w=!0}=t;return u.$$set=p=>{"search"in p&&i(n(0,a=p.search)),"themes"in p&&n(7,l=p.themes),"state"in p&&n(1,f=p.state),"isCustom"in p&&n(2,d=p.isCustom),"onMainScreen"in p&&n(3,h=p.onMainScreen),"hideThemes"in p&&n(4,w=p.hideThemes),"$$scope"in p&&n(8,c=p.$$scope)},u.$$.update=()=>{u.$$.dirty&160&&n(6,e=l.filter(p=>ke.MatchesLayout(p,s)))},[a,f,d,h,w,s,e,l,c,r]}class qe extends ee{constructor(t){super(),te(this,t,Kn,Zn,ne,{search:0,themes:7,state:1,isCustom:2,onMainScreen:3,hideThemes:4})}}function Xn(u){let t,n,e,s=u[6].hiddenExplanation.Subs({hidden_discovered:u[3].length.toString(),total_hidden:u[4].length.toString()})+"",o;return{c(){t=M("h3"),t.textContent=`${u[6].previouslyHiddenTitle.toString()}`,n=W(),e=M("p"),o=Ae(s)},m(i,r){k(i,t,r),k(i,n,r),k(i,e,r),R(e,o)},p(i,r){r&8&&s!==(s=i[6].hiddenExplanation.Subs({hidden_discovered:i[3].length.toString(),total_hidden:i[4].length.toString()})+"")&&Be(o,s)},d(i){i&&T(t),i&&T(n),i&&T(e)}}}function Yn(u){let t,n;return t=new qe({props:{search:u[0],state:u[1],onMainScreen:u[2],themes:u[3],isCustom:!1,hideThemes:!1,$$slots:{title:[Xn]},$$scope:{ctx:u}}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,[s]){const o={};s&1&&(o.search=e[0]),s&2&&(o.state=e[1]),s&4&&(o.onMainScreen=e[2]),s&8&&(o.themes=e[3]),s&520&&(o.$$scope={dirty:s,ctx:e}),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}const ut="mapcomplete-hidden-theme-";function es(u,t,n){let e,s,o,{search:i}=t,{state:r}=t,{onMainScreen:c=!0}=t;const a=mt.filter(d=>d.hideFromOverview),l=r.osmConnection.preferencesHandler.preferences;bt(u,l,d=>n(8,o=d));const f=I.t.general.morescreen;return u.$$set=d=>{"search"in d&&n(0,i=d.search),"state"in d&&n(1,r=d.state),"onMainScreen"in d&&n(2,c=d.onMainScreen)},u.$$.update=()=>{u.$$.dirty&256&&n(7,e=fe.NoNull(Object.keys(o).filter(d=>d.startsWith(ut)).map(d=>d.substring(ut.length,d.length-8)))),u.$$.dirty&128&&n(3,s=a.filter(d=>e.includes(d.id)))},[i,r,c,s,a,l,f,e,o]}class ts extends ee{constructor(t){super(),te(this,t,es,Yn,ne,{search:0,state:1,onMainScreen:2})}}function ns(u){let t,n=u[4].customThemeIntro.toString()+"",e;return{c(){t=new zt(!1),e=ue(),t.a=e},m(s,o){t.m(n,s,o),k(s,e,o)},p:H,d(s){s&&T(e),s&&t.d()}}}function ss(u){let t,n;return t=new qe({props:{search:u[0],state:u[1],onMainScreen:u[2],themes:u[3],isCustom:!0,hideThemes:!1,$$slots:{title:[ns]},$$scope:{ctx:u}}}),{c(){B(t.$$.fragment)},m(e,s){P(t,e,s),n=!0},p(e,[s]){const o={};s&1&&(o.search=e[0]),s&2&&(o.state=e[1]),s&4&&(o.onMainScreen=e[2]),s&8&&(o.themes=e[3]),s&256&&(o.$$scope={dirty:s,ctx:e}),t.$set(o)},i(e){n||(y(t.$$.fragment,e),n=!0)},o(e){S(t.$$.fragment,e),n=!1},d(e){N(t,e)}}}function os(u,t,n){let e,s,{search:o}=t,{state:i}=t,{onMainScreen:r=!0}=t;const c=I.t.general,a=i.installedUserThemes,l=Wt.ListStabilized(a);return bt(u,l,f=>n(6,s=f)),u.$$set=f=>{"search"in f&&n(0,o=f.search),"state"in f&&n(1,i=f.state),"onMainScreen"in f&&n(2,r=f.onMainScreen)},u.$$.update=()=>{u.$$.dirty&66&&n(3,e=fe.NoNull(s.map(f=>i.GetUnofficialTheme(f))))},[o,i,r,e,c,l,s]}class is extends ee{constructor(t){super(),te(this,t,os,ss,ne,{search:0,state:1,onMainScreen:2})}}const G=class extends v{constructor(t,n=!1){const e=I.t.general.morescreen,s=new vt({placeholder:e.searchForATheme});s.enterPressed.addCallbackD(i=>{i=i.toLowerCase(),i==="personal"&&(window.location.href=G.createUrlFor({id:"personal"},!1,t).data),(i==="bugs"||i==="issues")&&(window.location.href="https://github.com/pietervdvn/MapComplete/issues"),i==="source"&&(window.location.href="https://github.com/pietervdvn/MapComplete"),i==="docs"&&(window.location.href="https://github.com/pietervdvn/MapComplete/tree/develop/Docs"),(i==="osmcha"||i==="stats")&&(window.location.href=fe.OsmChaLinkFor(7));const r=G.officialThemes.find(a=>a.hideFromOverview==!1&&a.id!=="personal"&&G.MatchesLayout(a,i));r!==void 0&&(window.location.href=G.createUrlFor(r,!1,t).data);const c=G.officialThemes.find(a=>a.id!=="personal"&&G.MatchesLayout(a,i));c!==void 0&&(window.location.href=G.createUrlFor(c,!1,t).data)}),n&&(s.focus(),document.addEventListener("keydown",function(i){i.ctrlKey&&i.code==="KeyF"&&(s.focus(),i.preventDefault())}));const o=new v([O.search_svg().SetClass("w-8"),s.SetClass("mr-4 w-full")]).SetClass("flex rounded-full border-2 border-black items-center my-2 w-1/2");super([new v([o]).SetClass("flex justify-center"),new Oe(qe,{state:t,onMainScreen:n,search:s.GetValue(),themes:G.officialThemes}),new Oe(ts,{state:t,onMainScreen:n,search:s.GetValue()}),new Oe(is,{state:t,onMainScreen:n,search:s.GetValue()}),e.streetcomplete.Clone().SetClass("block text-base mx-10 my-3 mb-10")])}static createLinkButton(t,n,e=!1){var i;const s=G.createUrlFor(n,e,t);let o=new v([new xe(n.title,!e&&!n.mustHaveLanguage?"themes:"+n.id+".title":void 0),((i=new xe(n.shortDescription))==null?void 0:i.SetClass("subtle"))??""]).SetClass("overflow-hidden flex flex-col");return t.layoutToUse===void 0&&(o=new v([o]).SetClass("flex flex-col justify-center h-24")),new q(n.icon,o,{url:s,newTab:!1})}static CreateProffessionalSerivesButton(){const t=I.t.professional.indexPage;return new v([new de(t.hook,4),t.hookMore,new q(void 0,t.button,{url:"./professional.html"})]).SetClass("flex flex-col border border-gray-300 p-2 rounded-lg")}static MatchesLayout(t,n){var s;if(n===void 0||(n=n.toLocaleLowerCase(),n.length>3&&t.id.toLowerCase().indexOf(n)>=0))return!0;if(t.id==="personal")return!1;const e=[t.shortDescription,t.title,...t.keywords??[]];for(const o of e){if(o===void 0)continue;const i=o["*"]??o[Re.language.data];if(((s=i==null?void 0:i.toLowerCase())==null?void 0:s.indexOf(n))>=0)return!0}return!1}static createUrlFor(t,n,e){var c;if(t===void 0)return;if(t.id===void 0){console.error("ID is undefined for layout",t);return}if(t.id===((c=e==null?void 0:e.layoutToUse)==null?void 0:c.id))return;const s=e==null?void 0:e.locationControl;let o=window.location.pathname;o=o.substr(0,o.lastIndexOf("/")),o===""&&(o=".");let i=`${o}/${t.id.toLowerCase()}.html?`;(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(i=`${o}/theme.html?layout=${t.id}&`),n&&(i=`${o}/theme.html?userlayout=${t.id}&`);let r="";return t.definition!==void 0&&(r="#"+btoa(JSON.stringify(t.definition))),(s==null?void 0:s.map(a=>{const l=[["z",a==null?void 0:a.zoom],["lat",a==null?void 0:a.lat],["lon",a==null?void 0:a.lon]].filter(f=>f[1]!==void 0).map(f=>f[0]+"="+f[1]).join("&");return`${i}${l}${r}`}))??new gt(`${i}`)}};let ke=G;m(ke,"officialThemes",mt);export{he as E,Y as F,ke as M,De as S,wn as a,ie as b,In as c};
