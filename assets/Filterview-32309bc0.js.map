{"version":3,"file":"Filterview-32309bc0.js","sources":["../../src/UI/BigComponents/FilterviewWithFields.svelte","../../src/UI/BigComponents/Filterview.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import FilteredLayer from \"../../Models/FilteredLayer\"\n  import type { FilterConfigOption } from \"../../Models/ThemeConfig/FilterConfig\"\n  import Locale from \"../i18n/Locale\"\n  import ValidatedInput from \"../InputElement/ValidatedInput.svelte\"\n  import { UIEventSource } from \"../../Logic/UIEventSource\"\n  import { onDestroy } from \"svelte\"\n  import { Utils } from \"../../Utils\"\n  import type { ValidatorType } from \"../InputElement/Validators\"\n  import InputHelper from \"../InputElement/InputHelper.svelte\"\n  import { Translation } from \"../i18n/Translation\"\n  import Tr from \"../Base/Tr.svelte\"\n\n  export let filteredLayer: FilteredLayer\n  export let option: FilterConfigOption\n  export let id: string\n  let parts: ({ message: string } | { subs: string })[]\n  let language = Locale.language\n  $: {\n    const template = option.question.textFor($language)\n    parts = Utils.splitIntoSubstitutionParts(template)\n  }\n  let fieldValues: Record<string, UIEventSource<string>> = {}\n  let fieldTypes: Record<string, ValidatorType> = {}\n  let appliedFilter = <UIEventSource<string>>filteredLayer.appliedFilters.get(id)\n  let initialState: Record<string, string> = JSON.parse(appliedFilter?.data ?? \"{}\")\n\n  function setFields() {\n    const properties: Record<string, string> = {}\n    for (const key in fieldValues) {\n      const v = fieldValues[key].data\n      if (v === undefined) {\n        properties[key] = undefined\n      } else {\n        properties[key] = v\n      }\n    }\n    appliedFilter?.setData(FilteredLayer.fieldsToString(properties))\n  }\n\n  let firstValue: UIEventSource<string>\n  for (const field of option.fields) {\n    // A bit of cheating: the 'parts' will have '}' suffixed for fields\n    const src = new UIEventSource<string>(initialState[field.name] ?? \"\")\n    firstValue ??= src\n    fieldTypes[field.name] = field.type\n    console.log(field.name, \"-->\", field.type)\n    fieldValues[field.name] = src\n    onDestroy(\n      src.stabilized(200).addCallback(() => {\n        setFields()\n      })\n    )\n  }\n  let feedback: UIEventSource<Translation> = new UIEventSource<Translation>(undefined)\n</script>\n\n<div class=\"low-interaction p-1 rounded-2xl px-3\" class:interactive={$firstValue?.length > 0}>\n  {#each parts as part, i}\n    {#if part[\"subs\"]}\n      <!-- This is a field! -->\n      <span class=\"mx-1\">\n        <InputHelper value={fieldValues[part[\"subs\"]]} type={fieldTypes[part[\"subs\"]]}>\n          <ValidatedInput slot=\"fallback\" value={fieldValues[part[\"subs\"]]} type={fieldTypes[part[\"subs\"]]}\n                          {feedback} />\n        </InputHelper>\n      </span>\n    {:else}\n      {@html part[\"message\"]}\n    {/if}\n  {/each}\n  {#if $feedback}\n    <Tr cls=\"alert\" t={$feedback}/>\n  {/if}\n</div>\n","<script lang=\"ts\">\n  /**\n   * The FilterView shows the various options to enable/disable a single layer or to only show a subset of the data.\n   */\n  import type FilteredLayer from \"../../Models/FilteredLayer\"\n  import LayerConfig from \"../../Models/ThemeConfig/LayerConfig\"\n  import ToSvelte from \"../Base/ToSvelte.svelte\"\n  import Checkbox from \"../Base/Checkbox.svelte\"\n  import FilterConfig from \"../../Models/ThemeConfig/FilterConfig\"\n  import Dropdown from \"../Base/Dropdown.svelte\"\n  import { ImmutableStore, Store, UIEventSource } from \"../../Logic/UIEventSource\"\n  import FilterviewWithFields from \"./FilterviewWithFields.svelte\"\n  import Tr from \"../Base/Tr.svelte\"\n  import Translations from \"../i18n/Translations\"\n  import type { SpecialVisualizationState } from \"../SpecialVisualization\"\n\n  export let state: SpecialVisualizationState\n  export let filteredLayer: FilteredLayer\n  export let highlightedLayer: Store<string | undefined> = new ImmutableStore(undefined)\n  export let zoomlevel: Store<number> = new ImmutableStore(22)\n  let layer: LayerConfig = filteredLayer.layerDef\n  let isDisplayed: UIEventSource<boolean> = filteredLayer.isDisplayed\n\n  let isDebugging = state?.featureSwitches?.featureSwitchIsDebugging ?? new ImmutableStore(false)\n\n  /**\n   * Gets a UIEventSource as boolean for the given option, to be used with a checkbox\n   */\n  function getBooleanStateFor(option: FilterConfig): UIEventSource<boolean> {\n    const state = filteredLayer.appliedFilters.get(option.id)\n    return state.sync(\n      (f) => f === 0,\n      [],\n      (b) => (b ? 0 : undefined),\n    )\n  }\n\n  /**\n   * Gets a UIEventSource as number for the given option, to be used with a dropdown or radiobutton\n   */\n  function getStateFor(option: FilterConfig): UIEventSource<number | string> {\n    return filteredLayer.appliedFilters.get(option.id)\n  }\n</script>\n\n{#if filteredLayer.layerDef.name}\n  <div class:focus={$highlightedLayer === filteredLayer.layerDef.id} class=\"mb-1.5\">\n    <Checkbox selected={isDisplayed}>\n      <div class=\"no-image-background block h-6 w-6\" class:opacity-50={!$isDisplayed}>\n        <ToSvelte construct={() => layer.defaultIcon()} />\n      </div>\n\n      <Tr t={filteredLayer.layerDef.name} />\n\n      {#if $zoomlevel < layer.minzoom}\n        <span class=\"alert\">\n          <Tr t={Translations.t.general.layerSelection.zoomInToSeeThisLayer} />\n        </span>\n      {/if}\n    </Checkbox>\n\n    {#if $isDisplayed && filteredLayer.layerDef.filters?.length > 0}\n      <div id=\"subfilters\" class=\"ml-4 flex flex-col gap-y-1\">\n        {#each filteredLayer.layerDef.filters as filter}\n          <div>\n            <!-- There are three (and a half) modes of filters: a single checkbox, a radio button/dropdown or with searchable fields -->\n            {#if filter.options.length === 1 && filter.options[0].fields.length === 0}\n              <Checkbox selected={getBooleanStateFor(filter)}>\n                <Tr t={filter.options[0].question} />\n              </Checkbox>\n            {/if}\n\n            {#if filter.options.length === 1 && filter.options[0].fields.length > 0}\n              <FilterviewWithFields id={filter.id} {filteredLayer} option={filter.options[0]} />\n            {/if}\n\n            {#if filter.options.length > 1}\n              <Dropdown value={getStateFor(filter)}>\n                {#each filter.options as option, i}\n                  <option value={i}>\n                    {#if option.emoji}\n                      {option.emoji}\n                    {/if}\n                    <Tr t={option.question} />\n                  </option>\n                {/each}\n              </Dropdown>\n            {/if}\n          </div>\n        {/each}\n      </div>\n    {/if}\n  </div>\n{:else if $isDebugging}\n <div class=\"code\">\n  {layer.id} (no name)\n </div>\n{/if}\n"],"names":["raw_value","ctx","dirty","html_tag","insert","target","span","anchor","i","create_if_block","_a","div","each_blocks","filteredLayer","$$props","option","id","parts","language","Locale","fieldValues","fieldTypes","appliedFilter","initialState","setFields","properties","key","v","FilteredLayer","firstValue","field","src","UIEventSource","$$subscribe_firstValue","onDestroy","feedback","template","$language","$$invalidate","Utils","create_if_block_1","toggle_class","Translations","create_if_block_6","checkbox_changes","tr_changes","filterviewwithfields_changes","dropdown_changes","t_value","set_data","t","if_block","create_if_block_3","each_value_1","if_block0","create_if_block_5","if_block1","create_if_block_4","if_block2","create_if_block_2","state","highlightedLayer","ImmutableStore","zoomlevel","layer","isDisplayed","isDebugging","getBooleanStateFor","f","b","getStateFor","func"],"mappings":"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"}