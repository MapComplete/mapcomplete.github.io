var O=Object.defineProperty;var Q=(S,o,a)=>o in S?O(S,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):S[o]=a;var N=(S,o,a)=>(Q(S,typeof o!="symbol"?o+"":o,a),a);import{C as w,U as v,L as k,V as y,F as b,J as E,Q as j,S as P}from"./SvelteUIElement-99ed019b.js";import"./ToSvelte-5c9d4506.js";/* empty css                        *//* empty css                     *//* empty css                  */import{L as R,a as F,T as J,D as M}from"./List-cc3ee726.js";import{S as H}from"./SubtleButton-bcb2be40.js";import{q as K,V as z}from"./ChartJs-1c1cbe56.js";import{B as q,T as A}from"./BBox-258c9ed2.js";import{A as Y}from"./AllKnownLayouts-08272282.js";import{s as Z,F as X,n as B,M as $,t as ee,B as te}from"./theme_overview-4e8a56db.js";import"./_commonjsHelpers-edff4021.js";import"./defineProperty-bf1f4e26.js";import"./language_translations-f839c02d.js";const D=class extends w{constructor(o,a,C,x){const u=x.layer.id,c=x.tagRendering.id,e=k.GetParsed("automation-tile_state-"+u+"-"+c,{}),l=new v([]);if(a===void 0)throw"No tiles loaded - can not automate";D.openChangeset.addCallbackAndRun(t=>console.trace("Sync current open changeset to:",t));const r=e.map(t=>{for(const n of a)if(t[n]===void 0)return n});r.addCallback(t=>console.warn("Next tile to handle is",t));const s=new v([]),g=new y(r.map(t=>{if(t===void 0)return new b("All done!").SetClass("thanks");console.warn("Triggered map on nextTileToHandle",t);const n=new Date;return D.TileHandler(o,t,u,x.tagRendering,C,(d,p)=>{const f=(new Date().getTime()-n.getTime())/1e3;s.data.push(f),s.ping(),e.data[t]=d,e.ping(),p!==void 0&&(l.data.push(p),l.ping())})})),i=new y(e.map(t=>{let n=0;const d=new Map;for(const f in t){n++;const h=t[f];d.set(h,(d.get(h)??0)+1)}let p=0;s.data.forEach(f=>{p=p+f});let T=p/s.data.length;return new w(["Handled "+n+"/"+a.length+" tiles: ",new R(Array.from(d.keys()).map(f=>f+": "+d.get(f))),"Handling one tile needs "+Math.floor(T*100)/100+"s on average. Estimated time left: "+E.toHumanTime((a.length-n)*T)]).SetClass("flex flex-col")}));super([i,g,new H(void 0,"Clear fixed").onClick(()=>{const t=e.data;for(const n in t)t[n]==="fixed"&&delete t[n];e.ping()}),new y(l.map(t=>new R(t)))]),this.SetClass("flex flex-col")}static TileHandler(o,a,C,x,u,c){const e=new Z(o,{attemptLogin:!1});u.syncWith(e.changes.extraComment);const[l,m,r]=A.tile_from_index(a);e.locationControl.setData({zoom:l,lon:m,lat:r}),e.currentBounds.setData(q.fromTileIndex(a));let s=new v([]);const g=new X(t=>{t.layer.layerDef.id===C&&(s.data.push(t),s.ping())},e);e.locationControl.ping(),e.currentBounds.ping();const i=new v("");return g.runningQuery.map(async t=>{if(s.data.length===0){i.setData("No data loaded yet...");return}if(t){i.setData("Waiting for all layers to be loaded... Has "+s.data.length+" tiles already");return}if(s.data.length===0)return i.setData("No features found to apply the action"),c("empty"),!0;i.setData("Gathering applicable elements");let n=0,d=0,p=[];for(const T of s.data)for(const f of T.features.data){d++,d%10===0&&i.setData("Inspected "+d+" features, updated "+n+" features");const h=f.feature,I=x.GetRenderValue(h.properties),U=I.txt;p.push("<a href='https://openstreetmap.org/"+h.properties.id+"' target='_blank'>"+h.properties.id+"</a>: "+new B(I,new v(h.properties),void 0).ConstructElement().textContent);const W=E.NoNull(B.ExtractSpecialComponents(U).map(G=>G.special));for(const G of W){const _=G.func;_.supportsAutoAction===!0&&(await _.applyActionOn({layoutToUse:e.layoutToUse,changes:e.changes},e.allElements.getEventSourceById(h.properties.id),G.args),n++)}}return i.setData("Done! Inspected "+d+" features, updated "+n+" features"),d===0?(c("empty"),!0):(n===0?c("no-action","Inspected "+d+" elements: "+p.join("; ")):(e.osmConnection.AttemptLogin(),e.changes.flushChanges("handled tile automatically, time to flush!"),c("fixed","Updated "+n+" elements, inspected "+d+": "+p.join("; "))),!0)},[s]),new w([new F("Performing action for tile "+a,1),new y(i)]).SetClass("flex flex-col")}};let V=D;N(V,"openChangeset",new v(void 0));class L{constructor(){const o=new K({singlePage:!1,oauth_token:j.GetQueryParameter("oauth_token","OAuth token")});new w([new w([P.robot_svg().SetClass("w-24 h-24 p-4 rounded-full subtle-background"),new w([new F("MapComplete Automaton",1),"This page helps to automate certain tasks for a theme. Expert use only."]).SetClass("flex flex-col m-4")]).SetClass("flex"),new J(L.GenerateMainPanel(),new H(P.osm_logo_svg(),"Login to get started").onClick(()=>o.AttemptLogin()),o.isLoggedIn)]).SetClass("block p-4").AttachTo("main")}static GenerateMainPanel(){const o=new M("Select a theme",Array.from(ee).map(e=>({value:e.id,shown:e.id})));k.Get("automation-theme-id","missing_streets").syncWith(o.GetValue());const a=z.ForType("url").ConstructInputElement({placeholder:"Specifiy the path of the overview",inputStyle:"width: 100%"});a.SetClass("w-full"),k.Get("automation-tile_path").syncWith(a.GetValue(),!0);let C=a.GetValue().bind(e=>{if(e!==void 0)return v.FromPromiseWithErr(E.downloadJsonCached(e,1e3*60*60))});const x=14,u=C.map(e=>{if(e===void 0||e.error!==void 0)return;let l=[];const m=e.success;te.RegisterWhitelist(a.GetValue().data,m);const r=Number(m.zoom);for(const g in m){if(g==="zoom")continue;const i=Number(g),t=m[g];l.push(...t.map(n=>A.tile_index(r,i,n)))}console.log("Got ",l.length,"indexes");let s=new Set;for(const g of l){let[i,t,n]=A.tile_from_index(g);for(;i>x;)i--,t=Math.floor(t/2),n=Math.floor(n/2);s.add(A.tile_index(i,t,n))}return Array.from(s)}),c=z.ForType("text").ConstructInputElement();return k.Get("automaton-extra-comment").syncWith(c.GetValue()),new w([o,"Specify the path to a tile overview. This is a hosted .json of the format {x : [y0, y1, y2], x1: [y0, ...]} where x is a string and y are numbers",a,"Add an extra comment:",c,new y(c.GetValue().map(e=>"Your comment is "+((e==null?void 0:e.length)??0)+"/200 characters long")).SetClass("subtle"),new y(C.map(e=>e===void 0?"No path given or still loading...":e.error!==void 0?new b("Invalid URL or data: "+e.error).SetClass("alert"):new b("Loaded "+u.data.length+" tiles to automated over").SetClass("thanks"))),new y(o.GetValue().map(e=>Y.allKnownLayouts.get(e)).map(e=>{if(e===void 0)return new b("Select a valid layout");if(u.data===void 0||u.data.length===0)return"No tiles given";const l=[];for(const r of e.layers)for(const s of r.tagRenderings)s.group==="auto"&&l.push({layer:r,tagRendering:s});if(console.log("Automatable tag renderings:",l),l.length===0)return new b('This theme does not have any tagRendering with "group": "auto" set').SetClass("alert");const m=new M("Pick the action to automate",[{value:void 0,shown:"Pick an option"},...l.map(r=>({shown:r.layer.id+" - "+r.tagRendering.id,value:r}))]);return new w([m,new y(m.GetValue().map(r=>r===void 0?void 0:new V(e,u.data,c.GetValue(),r)))])},[u])).SetClass("flex flex-col")]).SetClass("flex flex-col")}}$.initialize();new L;
