var P=Object.defineProperty;var Z=(m,n,i)=>n in m?P(m,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):m[n]=i;var U=(m,n,i)=>(Z(m,typeof n!="symbol"?n+"":n,i),i);import"./modulepreload-polyfill-3cfb730f.js";import"./Liberapay-36dc6c1b.js";import{L as Q}from"./LayoutConfig-062f8cd9.js";import{Q as B,H as K,F as z,C as $,S as q}from"./tw-merge-238c90cb.js";import{F,O as N,E as G,D as J,e as X,B as Y,g as j,h as E,k as D,i as V,d as ee,c as te,j as ne,f as oe}from"./AllKnownLayouts-2ab724ba.js";import{U as x}from"./UIEventSource-0e3c8471.js";import{L as I}from"./LocalStorageSource-043832e4.js";import{g as re,l as ie,Z as _}from"./LayerConfig-4cbf5f75.js";import{C as W}from"./Constants-e04a0bc0.js";import{T as ae,a as se}from"./ThemeViewGUI-b14a85f4.js";import{S as le}from"./ValidatedInput-19c4f9b9.js";import{k as ce}from"./Add-2754ae9e.js";import"./index-e76d9885.js";import"./tw-join-70ce42f3.js";import"./TabbedGroup-bedd1a2b.js";import"./Marker-0fa4485b.js";import"./Loading-1de0e1dd.js";import"./Loading-f41a03ac.js";import"./Dropdown-0659530e.js";import"./OsmConnection-a5d02657.js";import"./XCircle-29c3e56d.js";import"./AccordionSingle-3246112f.js";import"./Community-11d26360.js";import"./Checkbox-9820d58c.js";import"./Filterview-d647d7d1.js";import"./PrivacyPolicy-f8313900.js";import"./BackButton-0f10285f.js";import"./Login-3e47847d.js";let k=(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en").substr(0,2);function H(m){var i;let n=0;for(const e of Array.from(m.children))((i=e.attributes.getNamedItem("lang"))==null?void 0:i.value)===k&&n++;n===0&&(k="en");for(const e of Array.from(m.children)){const p=e.attributes.getNamedItem("lang");if(p!==void 0){if(p.value===k){e.style.display="";continue}e.parentElement.removeChild(e)}}}H(document.getElementById("descriptions-while-loading"));H(document.getElementById("default-title"));var M={exports:{}};M.exports;(function(m){var n=function(){var i=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",g={};function S(t,o){if(!g[t]){g[t]={};for(var l=0;l<t.length;l++)g[t][t.charAt(l)]=l}return g[t][o]}var a={compressToBase64:function(t){if(t==null)return"";var o=a._compress(t,6,function(l){return e.charAt(l)});switch(o.length%4){default:case 0:return o;case 1:return o+"===";case 2:return o+"==";case 3:return o+"="}},decompressFromBase64:function(t){return t==null?"":t==""?null:a._decompress(t.length,32,function(o){return S(e,t.charAt(o))})},compressToUTF16:function(t){return t==null?"":a._compress(t,15,function(o){return i(o+32)})+" "},decompressFromUTF16:function(t){return t==null?"":t==""?null:a._decompress(t.length,16384,function(o){return t.charCodeAt(o)-32})},compressToUint8Array:function(t){for(var o=a.compress(t),l=new Uint8Array(o.length*2),s=0,c=o.length;s<c;s++){var v=o.charCodeAt(s);l[s*2]=v>>>8,l[s*2+1]=v%256}return l},decompressFromUint8Array:function(t){if(t==null)return a.decompress(t);for(var o=new Array(t.length/2),l=0,s=o.length;l<s;l++)o[l]=t[l*2]*256+t[l*2+1];var c=[];return o.forEach(function(v){c.push(i(v))}),a.decompress(c.join(""))},compressToEncodedURIComponent:function(t){return t==null?"":a._compress(t,6,function(o){return p.charAt(o)})},decompressFromEncodedURIComponent:function(t){return t==null?"":t==""?null:(t=t.replace(/ /g,"+"),a._decompress(t.length,32,function(o){return S(p,t.charAt(o))}))},compress:function(t){return a._compress(t,16,function(o){return i(o)})},_compress:function(t,o,l){if(t==null)return"";var s,c,v={},L={},b="",A="",y="",R=2,w=3,u=2,h=[],r=0,f=0,d;for(d=0;d<t.length;d+=1)if(b=t.charAt(d),Object.prototype.hasOwnProperty.call(v,b)||(v[b]=w++,L[b]=!0),A=y+b,Object.prototype.hasOwnProperty.call(v,A))y=A;else{if(Object.prototype.hasOwnProperty.call(L,y)){if(y.charCodeAt(0)<256){for(s=0;s<u;s++)r=r<<1,f==o-1?(f=0,h.push(l(r)),r=0):f++;for(c=y.charCodeAt(0),s=0;s<8;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1}else{for(c=1,s=0;s<u;s++)r=r<<1|c,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=0;for(c=y.charCodeAt(0),s=0;s<16;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1}R--,R==0&&(R=Math.pow(2,u),u++),delete L[y]}else for(c=v[y],s=0;s<u;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1;R--,R==0&&(R=Math.pow(2,u),u++),v[A]=w++,y=String(b)}if(y!==""){if(Object.prototype.hasOwnProperty.call(L,y)){if(y.charCodeAt(0)<256){for(s=0;s<u;s++)r=r<<1,f==o-1?(f=0,h.push(l(r)),r=0):f++;for(c=y.charCodeAt(0),s=0;s<8;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1}else{for(c=1,s=0;s<u;s++)r=r<<1|c,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=0;for(c=y.charCodeAt(0),s=0;s<16;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1}R--,R==0&&(R=Math.pow(2,u),u++),delete L[y]}else for(c=v[y],s=0;s<u;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1;R--,R==0&&(R=Math.pow(2,u),u++)}for(c=2,s=0;s<u;s++)r=r<<1|c&1,f==o-1?(f=0,h.push(l(r)),r=0):f++,c=c>>1;for(;;)if(r=r<<1,f==o-1){h.push(l(r));break}else f++;return h.join("")},decompress:function(t){return t==null?"":t==""?null:a._decompress(t.length,32768,function(o){return t.charCodeAt(o)})},_decompress:function(t,o,l){var s=[],c=4,v=4,L=3,b="",A=[],y,R,w,u,h,r,f,d={val:l(0),position:o,index:1};for(y=0;y<3;y+=1)s[y]=y;for(w=0,h=Math.pow(2,2),r=1;r!=h;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=o,d.val=l(d.index++)),w|=(u>0?1:0)*r,r<<=1;switch(w){case 0:for(w=0,h=Math.pow(2,8),r=1;r!=h;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=o,d.val=l(d.index++)),w|=(u>0?1:0)*r,r<<=1;f=i(w);break;case 1:for(w=0,h=Math.pow(2,16),r=1;r!=h;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=o,d.val=l(d.index++)),w|=(u>0?1:0)*r,r<<=1;f=i(w);break;case 2:return""}for(s[3]=f,R=f,A.push(f);;){if(d.index>t)return"";for(w=0,h=Math.pow(2,L),r=1;r!=h;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=o,d.val=l(d.index++)),w|=(u>0?1:0)*r,r<<=1;switch(f=w){case 0:for(w=0,h=Math.pow(2,8),r=1;r!=h;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=o,d.val=l(d.index++)),w|=(u>0?1:0)*r,r<<=1;s[v++]=i(w),f=v-1,c--;break;case 1:for(w=0,h=Math.pow(2,16),r=1;r!=h;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=o,d.val=l(d.index++)),w|=(u>0?1:0)*r,r<<=1;s[v++]=i(w),f=v-1,c--;break;case 2:return A.join("")}if(c==0&&(c=Math.pow(2,L),L++),s[f])b=s[f];else if(f===v)b=R+R.charAt(0);else return null;A.push(b),s[v++]=R+b.charAt(0),c--,R=b,c==0&&(c=Math.pow(2,L),L++)}}};return a}();m!=null&&(m.exports=n)})(M);var de=M.exports;const O=re(de);class fe extends J{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(n,i){var g,S;if(typeof n=="string"||n.builtin!==void 0)return n;i=i.enter(n.id);let e={...n};e.credits==="Not logged in"&&delete e.credits,e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags),(g=e.allowMove)!=null&&g.enableImproveAccuraccy&&(e.allowMove.enableImproveAccuracy=e.allowMove.enableImproveAccuraccy,delete e.allowMove.enableImproveAccuraccy);for(const a of e.presets??[]){const t=a.preciseInput;typeof t=="boolean"?delete a.preciseInput:t!==void 0&&(delete t.preferredBackground,a.snapToLayer=t.snapToLayer,delete t.snapToLayer,t.maxSnapDistance&&(a.maxSnapDistance=t.maxSnapDistance,delete t.maxSnapDistance),Object.keys(t).length==0&&delete a.preciseInput),typeof a.snapToLayer=="string"&&(a.snapToLayer=[a.snapToLayer])}if(e.tagRenderings!==void 0){let a=0;for(const t of e.tagRenderings)t&&(a++,!(typeof t=="string"||t.builtin!==void 0||t.rewrite!==void 0)&&t.id===void 0&&(t["#"]!==void 0?(t.id=t["#"],delete t["#"]):((S=t.freeform)==null?void 0:S.key)!==void 0?t.id=e.id+"-"+t.freeform.key:t.id="tr-"+a))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let a=["point"],t=e.wayHandling??0;if(t!==0&&(a=["point","centroid"]),e.icon??e.label!==void 0){const o={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:a,rotation:e.rotation};e.mapRendering.push(o)}if(t!==1){const o={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(o).length>0&&e.mapRendering.push(o)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;const p=e.source;p&&(delete p.isOsmCache,delete p.maxCacheAge,delete p.widenFactor);for(const a of e.mapRendering??[]){a.iconOverlays!==void 0&&(a.iconBadges=a.iconOverlays);for(const t of a.iconBadges??[])t.badge!==!0&&i.enters("iconBadges","badge").warn("Non-overlay element"),delete t.badge}if(e.mapRendering){const a=[],t=[];for(const o of e.mapRendering)o.location?a.push(o):t.push(o);e.pointRendering=a,e.lineRendering=t,delete e.mapRendering}for(const a of e.pointRendering??[]){const t=a;if(t.icon)try{let l=t.icon;Object.keys(l).length===1&&l.render!==void 0&&(l=l.render);const s=x.NoEmpty(l.split(";"));t.marker=s.map(c=>{if(c.startsWith("http"))return{icon:c};const[v,L]=c.split(":");return{icon:v,color:L}}),delete t.icon}catch{console.error("Could not handle icon in",n.id),t.marker=[{icon:t.icon}],delete t.icon}let o=t.iconSize;if(o&&(Object.keys(t.iconSize).length===1&&t.iconSize.render!==void 0&&(o=t.iconSize.render),typeof o=="string"&&["bottom","center","top"].some(l=>o.endsWith(l)))){const l=o.split(",").map(s=>s.toLowerCase().trim());t.anchor=l.pop(),t.iconSize=l.join(",")}}if(e.pointRendering)for(const a of e.pointRendering)for(const t in a)a[t]&&typeof a[t].render=="string"&&Object.keys(a[t]).length===1&&(a[t]=a[t].render);if(e.lineRendering)for(const a of e.lineRendering)for(const t in a)a[t]&&typeof a[t].render=="string"&&Object.keys(a[t]).length===1&&(a[t]=a[t].render);return e}}class me extends J{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(n,i){const e={...n};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return i.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=x.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class pe extends F{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new me,new N("layers",new G(new fe)))}}class ue extends F{constructor(n,i,e,p){super("Validates a theme and the contained layers",new X(n,i,e,p),new N("layers",new G(new Y(g=>W.added_by_default.indexOf(g.id)<0,new j(void 0,e,n,!1,!0)))))}}const T=class T{static getCustomDefinition(){const n=decodeURIComponent(T.loadCustomThemeParam.data);if(n.startsWith("http"))return n;if(n!=="false"){const i=K.hash.data;try{return JSON.parse(atob(i)),atob(i)}catch{return JSON.parse(x.UnMinify(O.decompressFromBase64(i))),x.UnMinify(O.decompressFromBase64(i))}}}static async expandRemoteLayers(n){if(!n.layers)return n;for(let i=0;i<n.layers.length;i++){const e=n.layers[i];if(typeof e=="string")try{new URL(e),console.log("Downloading remote layer "+e);const p=await x.downloadJson(e);n.layers[i]=p}catch{continue}}return n}static async GetLayout(){const n=decodeURIComponent(T.loadCustomThemeParam.data);if(n.startsWith("http"))return await T.LoadRemoteTheme(n);if(n!=="false")return await T.LoadLayoutFromHash(T.loadCustomThemeParam);let i;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(i=e,e.endsWith(".html")&&(i=e.substr(0,e.length-5)),console.log("Using layout",i)),i=B.GetQueryParameter("layout",i,"The layout to load into MapComplete").data;const p=i==null?void 0:i.toLowerCase(),g=oe.allKnownLayouts;if(g.size()==0)throw"Build failed or running, no layouts are known at all";if(g.getConfig(p)===void 0){const S=x.sortedByLevenshteinDistance(p,Array.from(g.keys()),t=>t).slice(0,3);throw`No builtin map theme with name ${i} exists. Perhaps you meant one of ${S.join(", ")}`}return g.get(p)}static async LoadLayoutFromHash(n){var a,t;let i=location.hash.substr(1),e;const p=I.Get("user-layout-"+((a=n.data)==null?void 0:a.replace(" ","_")));((t=p.data)==null?void 0:t.length)<10&&p.setData(void 0);const g=I.Get("last-loaded-user-layout");i.length<10?i=p.data??g.data:(console.log("Saving hash to local storage"),g.setData(i),p.setData(i));try{e=JSON.parse(atob(i))}catch{e=JSON.parse(x.UnMinify(O.decompressFromBase64(i)))}e=await this.expandRemoteLayers(e);const S=T.prepCustomTheme(e);return n.setData(S.id),S}static getSharedTagRenderings(){const n=new Map;for(const i of E.tagRenderings)n.set(i.id,i);return n}static getSharedTagRenderingOrder(){return E.tagRenderings.map(n=>n.id)}static prepCustomTheme(n,i,e){if(n.layers===void 0&&n.tagRenderings!==void 0){const a=n;let t=x.NoNull(a.pointRendering.flatMap(o=>o.marker).map(o=>{if(!o)return;const l=new _(o.icon).render.txt;if(o.color===void 0||l.startsWith("http:")||l.startsWith("https:"))return l;const s=new _(o.color).render.txt;return l+":"+s})).join(";");t||(t="./assets/svg/bug.svg"),n={id:n.id,description:n.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:t,title:n.name,layers:[n]}}const p=new Map;for(const a in D.layers){const t=D.layers[a];p.set(t.id,t)}const g={tagRenderings:T.getSharedTagRenderings(),tagRenderingOrder:T.getSharedTagRenderingOrder(),sharedLayers:p,publicLayers:new Set};n=new pe().convertStrict(n);const S=n;return n=new V(T._knownImages).convertStrict(n),n.enableNoteImports=n.enableNoteImports??!1,n=new ee(g).convertStrict(n),console.log("The layoutconfig is ",n),n.id=e??n.id,new te().convertStrict(n),new ue(new ne(new Set,()=>!0),"",!1).convertStrict(n),new Q(n,!1,{definitionRaw:JSON.stringify(S,null,"  "),definedAtUrl:i})}static async LoadRemoteTheme(n){console.log("Downloading map theme from ",n),new z(`Downloading the theme from the <a href="${n}">link</a>...`).AttachTo("maindiv");let i=await x.downloadJson(n),e=i.id;const p=new URL(n);return p.hostname==="localhost"||p.hostname==="127.0.0.1"||(e=n),console.log("Loaded remote link:",n),i=await this.expandRemoteLayers(i),T.prepCustomTheme(i,n,e)}};U(T,"_knownImages",new Set(Array.from(ie).map(n=>n.path))),U(T,"loadCustomThemeParam",B.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));let C=T;function he(){try{const m=document.createElement("canvas");return!!window.WebGLRenderingContext&&(m.getContext("webgl")||m.getContext("experimental-webgl"))}catch{return!1}}async function ge(m){return await x.waitFor(m),{layers:[]}}async function ye(){try{const m=new URL(W.SummaryServer).host,n=await Promise.any([x.downloadJson("https://"+m+"/summary/status.json"),ge(2500)]);return new Set(n.layers)}catch(m){return console.error("Could not get MVT available layers due to",m),new Set}}async function we(){try{if(!he())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[m,n]=await Promise.all([C.GetLayout(),await ye()]);n==null||n.delete("cycle_highways"),console.log("The available layers on server are",Array.from(n));const i=new ae(m,n),e=document.getElementById("maindiv"),p=Array.from(e.children);new se({target:e,props:{state:i}}),p.forEach(g=>e.removeChild(g)),Array.from(document.getElementsByClassName("delete-on-load")).forEach(g=>{g.parentElement.removeChild(g)})}catch(m){console.error("Error while initializing: ",m,m.stack);const n=C.getCustomDefinition();new $([new z(m.toString().split(`
`).join("<br/>")).SetClass("block alert"),(n==null?void 0:n.length)>0?new le(new q(ce),"Download the raw file").onClick(()=>x.offerContentsAsDownloadableFile(C.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}we().then(m=>{});
//# sourceMappingURL=theme-b545d264.js.map
