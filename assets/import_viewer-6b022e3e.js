var E=Object.defineProperty;var P=(w,e,o)=>e in w?E(w,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):w[e]=o;var L=(w,e,o)=>(P(w,typeof e!="symbol"?e+"":e,o),o);import{Q as G,V as v,U as _,a as I,F as g,T as B,C as f,S as m,L as V}from"./Translations-90cac94c.js";import{T as k}from"./List-2172953c.js";import{U as j}from"./UserRelatedState-dfc2f585.js";import{a as N,S as O,L as M}from"./SubtleButton-5b6b984d.js";import{C as U,T as C,D as J}from"./DropDown-c8388124.js";import{L as Q,a as z,c as R,V as W}from"./Button-78f4392c.js";import{L as q}from"./LeftIndex-02d3faa4.js";import{A as H,T as Y}from"./Toggleable-b2d965a0.js";import{T as K}from"./TableOfContents-5630cc68.js";import"./defineProperty-1d73cb61.js";import"./BackToIndex-c5cf329e.js";class X extends O{constructor(e){super(m.statistics_svg(),"Download statistics"),this.onClick(()=>{const o=[].concat(...e),l=["id","status","theme","date_created","date_closed","days_open","intro","...comments"],a=o.map(t=>{var r,n;return[t.props.id+"",t.status,t.theme,(r=t.props.date_created)==null?void 0:r.substr(0,t.props.date_created.length-3),((n=t.props.closed_at)==null?void 0:n.substr(0,t.props.closed_at.length-3))??"",JSON.stringify(t.intro),...t.props.comments.map(c=>JSON.stringify(c.user)+": "+JSON.stringify(c.text))]});I.offerContentsAsDownloadableFile([l,...a].map(t=>t.join(", ")).join(`
`),"mapcomplete_import_notes_overview.csv",{mimetype:"text/csv"})})}}class Z extends f{constructor(e,o){const l=W.ForType("text").ConstructInputElement(),a=new J("On which notes should an action be performed?",[{value:void 0,shown:"Pick an option..."},{value:{predicate:n=>n.status==="open",action:async n=>{const c=l.GetValue().data;e.osmConnection.closeNote(n.id,c)}},shown:"Add comment to every open note and close all notes"},{value:{predicate:n=>n.status==="open",action:async n=>{const c=l.GetValue().data;e.osmConnection.addCommentToNote(n.id,c)}},shown:"Add comment to every open note"}]),t=new _(void 0),r=new O(m.checkmark_svg(),"Apply action").onClick(async()=>{const{predicate:n,action:c}=a.GetValue().data;for(let d=0;d<o.length;d++){t.setData(d);const p=o[d];n(p)&&await c(p)}t.setData(o.length)});super([a,l.SetClass("w-full border border-black"),new C(new C(r,new C(new N(new v(t.map(n=>n===o.length?"All done!":"Handling note "+(n+1)+" out of "+o.length))),new f([m.checkmark_svg().SetClass("h-8"),"All done!"]).SetClass("thanks flex p-4"),t.map(n=>n<o.length)),t.map(n=>n===void 0)),new v(l.GetValue().map(n=>"Type a text of at least 15 characters to apply the action. Currently, there are "+((n==null?void 0:n.length)??0)+" characters")).SetClass("alert"),a.GetValue().map(n=>{var c,d;return n!==void 0&&((d=(c=l.GetValue())==null?void 0:c.data)==null?void 0:d.length)>15},[l.GetValue()])),new C(new g("Testmode enable").SetClass("alert"),void 0,e.featureSwitchIsTesting)])}}const D=class extends f{constructor(e,o){const l=e[0].props.comments[0].html,a=new z(["id","status","last comment","last modified by","actions"],e.map(t=>D.noteField(t,o)),{sortable:!0}).SetClass("zebra-table link-underline");super([new k("Mass apply an action on "+e.length+" notes below"),o!==void 0?new Z(o,e.map(t=>t.props)).SetClass("block"):void 0,a,new k("Example note",4),new g(l).SetClass("literal-code link-underline")]),this.SetClass("flex flex-col")}static noteField(e,o){var h;const l=new V(""+e.props.id,"https://openstreetmap.org/note/"+e.props.id,!0);let a="";const t=e.props.comments[e.props.comments.length-1],r=e.props.comments[e.props.comments.length-2];e.props.comments.length>1&&(a=t.text,a===void 0&&(r==null?void 0:r.uid)===t.uid&&(a=r.text));const n=y.icons[e.status]().SetClass("h-4 w-4 shrink-0"),c=new _(!1),d=new _(void 0),p=new M(()=>new f(this.individualActions.map(([u,S])=>u().onClick(async()=>{e.props.status==="closed"&&await o.osmConnection.reopenNote(e.props.id),await o.osmConnection.closeNote(e.props.id,S),d.setData(S)}).SetClass("h-8 w-8"))).SetClass("flex")),s=new v(d.map(u=>u===void 0?p:u)),i=C.If((h=o==null?void 0:o.osmConnection)==null?void 0:h.isLoggedIn,()=>new U(s,new R("edit...",()=>{console.log("Enabling..."),c.setData(!0)}),c));return[l,new f([n,e.status]).SetClass("flex"),a,new V(t.user,"https://www.openstreetmap.org/user/"+t.user,!0),i]}};let b=D;L(b,"individualActions",[[m.not_found_svg,"This feature does not exist"],[m.addSmall_svg,"imported"],[m.duplicate_svg,"Already mapped"]]);const x=class extends Y{constructor(e,o){e.sort((s,i)=>s.props.id-i.props.id);const{theme:l,intro:a,dateStr:t}=e[0],r=new Map;for(const s of e){const i=s.status,h=r.get(i)??0;r.set(i,h+1)}const n=(r.get("open")??0)+(r.get("has_comments")??0),c=[new g(t).SetClass("literal-code rounded-full"),new g(e.length+" total").SetClass("literal-code rounded-full ml-1 border-4 border-gray").onClick(()=>d.setData(void 0)),n===0?new f([m.party_svg().SetClass("h-6 m-1"),"All done!"]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border border-black"):new g(Math.round(100-100*n/e.length)+"%").SetClass("literal-code rounded-full ml-1")],d=new _(void 0);Object.keys(x.icons).forEach(s=>{const i=r.get(s);if(i===void 0)return;const h=new f([x.icons[s]().SetClass("h-6 m-1"),i+" "+s]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border border-black"),u=new f([x.icons[s]().SetClass("h-6 m-1"),i+" "+s]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border-4 border-black animate-pulse"),S=new U(u,h,d.sync(A=>A===s,[],(A,F)=>{if(A)return s;if(F!==s)return F})).ToggleOnClick();c.push(S)});const p=new b(e,o);super(new f([new k(l+": "+a,2),new f(c).SetClass("flex flex-wrap")]),new v(d.map(s=>s===void 0?p:new b(e.filter(i=>i.status===s),o))),{closeOnClick:!1})}};let y=x;L(y,"icons",{open:m.compass_svg,has_comments:m.speech_bubble_svg,imported:m.addSmall_svg,already_mapped:m.checkmark_svg,not_found:m.not_found_svg,closed:m.close_svg,invalid:m.invalid_svg});class T extends v{constructor(e,o){let l;e.uid!==void 0?l="https://api.openstreetmap.org/api/0.6/notes/search.json?user="+e.uid+"&closed=730&limit=10000&sort=created_at&q=%23import":l="https://api.openstreetmap.org/api/0.6/notes/search.json?display_name="+encodeURIComponent(e.display_name)+"&limit=10000&closed=730&sort=created_at&q="+encodeURIComponent(e.search??"#import");const a=_.FromPromiseWithErr(I.downloadJson(l));super(a.map(t=>{var i,h;if(t===void 0)return new N("Loading notes which mention '#import'");if(t.error!==void 0)return new g("Something went wrong: "+t.error).SetClass("alert");let r=t.success.features.map(u=>u.properties);e.uid&&(r=r.filter(u=>u.comments[0].uid===e.uid));const n=Array.from(T.SplitNotesIntoBatches(r).values()),c=n.map(u=>new y(u,o)),d=new H(c);let p=[];(h=(i=o==null?void 0:o.osmConnection)==null?void 0:i.isLoggedIn)!=null&&h.data&&(p=[new k(B.t.importInspector.title,1),new O(void 0,"Create a new batch of imports",{url:"import_helper.html"})]),p.push(d);const s=new f(p);return new q([new K(s,{noTopLevel:!0,maxDepth:1}).SetClass("subtle"),new X(n)],s)}))}static SplitNotesIntoBatches(e){const o=new Map,l="https://mapcomplete.osm.be/";for(const a of e){const t=a.comments[0].text.split(`
`),r=t.findIndex(i=>i.startsWith(l)&&i.endsWith("#import"));if(r<0)continue;let n=t[r].substr(l.length);n=n.substr(0,n.indexOf("."));const c=I.ParseDate(a.date_created),d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),p=n+t[0]+d;o.has(p)||o.set(p,[]);let s="open";if(a.closed_at!==void 0){const i=a.comments[a.comments.length-1].text.toLowerCase();i.indexOf("does not exist")>=0?s="not_found":i.indexOf("already mapped")>=0?s="already_mapped":i.indexOf("invalid")>=0||i.indexOf("incorrecto")>=0?s="invalid":["imported","erbij","toegevoegd","added"].some(h=>i.toLowerCase().indexOf(h)>=0)?s="imported":s="closed"}else a.comments.length>1&&(s="has_comments");o.get(p).push({props:a,intro:t[0],theme:n,dateStr:d,status:s})}return o}}class $ extends Q{constructor(){const e=new j(void 0),o=G.GetQueryParameter("user","","The username of the person whom you want to see the notes for"),l=G.GetQueryParameter("search","","A text that should be included in the first comment of the note to be shown");super(new v(e.osmConnection.userDetails.map(a=>{const t=o.data,r=l.data;return t!==""&&r!==""?new T({display_name:t,search:r},void 0):new T(a,e)},[o,l])),"Login to inspect your import flows",e)}}new $().AttachTo("main");
