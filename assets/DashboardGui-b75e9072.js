var Ge=Object.defineProperty;var Ee=(f,e,t)=>e in f?Ge(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var T=(f,e,t)=>(Ee(f,typeof e!="symbol"?e+"":e,t),t);import{M as Pe,S as q,F as X,a as fe}from"./MoreScreen-b7ea3c36.js";import{V as G,S as x,I as ne,F as P,C as S,T as D,a as I,U as M,b as pe,c as Oe,Q as ie,H as re}from"./Translations-75f9b429.js";import{L as me}from"./LanguagePicker-29d8ded1.js";import{T as _,C as Re}from"./DropDown-13f177d0.js";import{S as O,L as $,a as Ue,U as Be}from"./SubtleButton-11aede5a.js";import{L as he,H as j,T as le,M as Fe,B as Ne,V as Ve,A as je}from"./Button-47b726a8.js";import{A as ze,E as We,F as we,U as $e}from"./UserInformation-c73a1e0a.js";import{C as W,S as B,a as He,b as J,c as qe,d as ge,e as Je,f as ve,g as Ze,h as Qe,T as Ke,i as Xe}from"./theme_overview-fda7e1c7.js";import{C as F,G as ye,B as K,S as Ye,T as Se,R as et,O as tt,a as ce,l as nt}from"./UserRelatedState-364a74ac.js";import{T as E}from"./List-085c0309.js";import{B as ot}from"./BackToIndex-1f774bd2.js";class at extends G{constructor(e,t){t=t??{};let n="w-8 h-8 mr-2";t.size=="medium"?n="w-16 h-16 mr-4":t.size=="large"&&(n="w-32 h-32 mr-6"),super(e.userDetails.mapD(o=>{let a=x.person_svg().SetClass("rounded-full border border-black overflow-hidden");o.img&&(a=new ne(o.img));let s=new P(o.name).SetClass("font-bold");return t!=null&&t.firstLine&&(s=new S([t.firstLine,s]).SetClass("flex flex-col")),new S([a.SetClass("rounded-full "+n),s]).SetClass("flex items-center")}))}}class st extends S{constructor(e,t,n,o){var d;const a=D.t.general,s=n.layoutToUse,l=new me(s.language,a.pickLanguage.Clone()),i=new O(void 0,a.openTheMap.Clone().SetClass("text-xl font-bold w-full text-center")).onClick(()=>{e.setData(!1)}).SetClass("only-on-mobile"),c=new at(n.osmConnection,{firstLine:D.t.general.welcomeBack.Clone()});o!=null&&o.userInfoIsOpened&&c.onClick(()=>{o.userInfoIsOpened.setData(!0)});const u=new _(new he(c,new S([D.t.general.loginWithOpenStreetMap.SetClass("text-xl font-bold"),D.t.general.loginOnlyNeededToEdit.Clone().SetClass("font-bold")]).SetClass("flex flex-col"),n),void 0,n.featureSwitchUserbadge),r=s.layers.some(h=>{var v;return((v=h.presets)==null?void 0:v.length)>0});super([s.description.Clone().SetClass("block mb-4"),new S([a.welcomeExplanation.general,r?_.If(n.featureSwitchAddNew,()=>a.welcomeExplanation.addNew):void 0]).SetClass("flex flex-col mt-2"),i,u.SetClass("block mt-6 pt-2 md:border-t-2 border-dotted border-gray-400"),(d=s.descriptionTail)==null?void 0:d.Clone().SetClass("block mt-4"),l==null?void 0:l.SetClass("block mt-4 pb-8 border-b-2 border-dotted border-gray-400"),new ze(n),...s.CustomCodeSnippets()]),this.SetClass("link-underline")}}var Y={},it={get exports(){return Y},set exports(f){Y=f}};(function(f){var e=function(){var t=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",a={};function s(i,c){if(!a[i]){a[i]={};for(var u=0;u<i.length;u++)a[i][i.charAt(u)]=u}return a[i][c]}var l={compressToBase64:function(i){if(i==null)return"";var c=l._compress(i,6,function(u){return n.charAt(u)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(i){return i==null?"":i==""?null:l._decompress(i.length,32,function(c){return s(n,i.charAt(c))})},compressToUTF16:function(i){return i==null?"":l._compress(i,15,function(c){return t(c+32)})+" "},decompressFromUTF16:function(i){return i==null?"":i==""?null:l._decompress(i.length,16384,function(c){return i.charCodeAt(c)-32})},compressToUint8Array:function(i){for(var c=l.compress(i),u=new Uint8Array(c.length*2),r=0,d=c.length;r<d;r++){var h=c.charCodeAt(r);u[r*2]=h>>>8,u[r*2+1]=h%256}return u},decompressFromUint8Array:function(i){if(i==null)return l.decompress(i);for(var c=new Array(i.length/2),u=0,r=c.length;u<r;u++)c[u]=i[u*2]*256+i[u*2+1];var d=[];return c.forEach(function(h){d.push(t(h))}),l.decompress(d.join(""))},compressToEncodedURIComponent:function(i){return i==null?"":l._compress(i,6,function(c){return o.charAt(c)})},decompressFromEncodedURIComponent:function(i){return i==null?"":i==""?null:(i=i.replace(/ /g,"+"),l._decompress(i.length,32,function(c){return s(o,i.charAt(c))}))},compress:function(i){return l._compress(i,16,function(c){return t(c)})},_compress:function(i,c,u){if(i==null)return"";var r,d,h={},v={},C="",A="",b="",L=2,k=3,w=2,y=[],p=0,g=0,m;for(m=0;m<i.length;m+=1)if(C=i.charAt(m),Object.prototype.hasOwnProperty.call(h,C)||(h[C]=k++,v[C]=!0),A=b+C,Object.prototype.hasOwnProperty.call(h,A))b=A;else{if(Object.prototype.hasOwnProperty.call(v,b)){if(b.charCodeAt(0)<256){for(r=0;r<w;r++)p=p<<1,g==c-1?(g=0,y.push(u(p)),p=0):g++;for(d=b.charCodeAt(0),r=0;r<8;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1}else{for(d=1,r=0;r<w;r++)p=p<<1|d,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=0;for(d=b.charCodeAt(0),r=0;r<16;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1}L--,L==0&&(L=Math.pow(2,w),w++),delete v[b]}else for(d=h[b],r=0;r<w;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1;L--,L==0&&(L=Math.pow(2,w),w++),h[A]=k++,b=String(C)}if(b!==""){if(Object.prototype.hasOwnProperty.call(v,b)){if(b.charCodeAt(0)<256){for(r=0;r<w;r++)p=p<<1,g==c-1?(g=0,y.push(u(p)),p=0):g++;for(d=b.charCodeAt(0),r=0;r<8;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1}else{for(d=1,r=0;r<w;r++)p=p<<1|d,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=0;for(d=b.charCodeAt(0),r=0;r<16;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1}L--,L==0&&(L=Math.pow(2,w),w++),delete v[b]}else for(d=h[b],r=0;r<w;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1;L--,L==0&&(L=Math.pow(2,w),w++)}for(d=2,r=0;r<w;r++)p=p<<1|d&1,g==c-1?(g=0,y.push(u(p)),p=0):g++,d=d>>1;for(;;)if(p=p<<1,g==c-1){y.push(u(p));break}else g++;return y.join("")},decompress:function(i){return i==null?"":i==""?null:l._decompress(i.length,32768,function(c){return i.charCodeAt(c)})},_decompress:function(i,c,u){var r=[],d=4,h=4,v=3,C="",A=[],b,L,k,w,y,p,g,m={val:u(0),position:c,index:1};for(b=0;b<3;b+=1)r[b]=b;for(k=0,y=Math.pow(2,2),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=c,m.val=u(m.index++)),k|=(w>0?1:0)*p,p<<=1;switch(k){case 0:for(k=0,y=Math.pow(2,8),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=c,m.val=u(m.index++)),k|=(w>0?1:0)*p,p<<=1;g=t(k);break;case 1:for(k=0,y=Math.pow(2,16),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=c,m.val=u(m.index++)),k|=(w>0?1:0)*p,p<<=1;g=t(k);break;case 2:return""}for(r[3]=g,L=g,A.push(g);;){if(m.index>i)return"";for(k=0,y=Math.pow(2,v),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=c,m.val=u(m.index++)),k|=(w>0?1:0)*p,p<<=1;switch(g=k){case 0:for(k=0,y=Math.pow(2,8),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=c,m.val=u(m.index++)),k|=(w>0?1:0)*p,p<<=1;r[h++]=t(k),g=h-1,d--;break;case 1:for(k=0,y=Math.pow(2,16),p=1;p!=y;)w=m.val&m.position,m.position>>=1,m.position==0&&(m.position=c,m.val=u(m.index++)),k|=(w>0?1:0)*p,p<<=1;r[h++]=t(k),g=h-1,d--;break;case 2:return A.join("")}if(d==0&&(d=Math.pow(2,v),v++),r[g])C=r[g];else if(g===h)C=L+L.charAt(0);else return null;A.push(C),r[h++]=L+C.charAt(0),d--,L=C,d==0&&(d=Math.pow(2,v),v++)}}};return l}();f!=null&&(f.exports=e)})(it);class rt extends S{constructor(e){const t=e==null?void 0:e.layoutToUse,n=D.t.general.sharescreen,o=[],a=[],s=new W(n.fsIncludeCurrentLocation,!0);o.push(s);const l=e.locationControl;a.push(s.GetValue().map(w=>{var y,p,g;return l===void 0?null:w?[["z",(y=l.data)==null?void 0:y.zoom],["lat",(p=l.data)==null?void 0:p.lat],["lon",(g=l.data)==null?void 0:g.lon]].filter(m=>m[1]!==void 0).map(m=>m[0]+"="+m[1]).join("&"):null},[l]));function i(w){return w.isDisplayed.data?null:"layer-"+w.layerDef.id+"="+w.isDisplayed.data}const c=e.backgroundLayer,u=new G(c.map(w=>n.fsIncludeCurrentBackgroundMap.Subs({name:(w==null?void 0:w.name)??""}))),r=new W(u,!0);o.push(r),a.push(r.GetValue().map(w=>{var y;return w?"background="+((y=c.data)==null?void 0:y.id):null},[c]));const d=new W(n.fsIncludeCurrentLayers,!0);o.push(d),a.push(d.GetValue().map(w=>w?I.NoNull(e.filteredLayers.data.map(i)).join("&"):null,e.filteredLayers.data.map(w=>w.isDisplayed)));const h=[{urlName:"fs-userbadge",human:n.fsUserbadge},{urlName:"fs-search",human:n.fsSearch},{urlName:"fs-welcome-message",human:n.fsWelcomeMessage},{urlName:"fs-layers",human:n.fsLayers},{urlName:"fs-add-new",human:n.fsAddNew},{urlName:"fs-geolocation",human:n.fsGeolocation}];for(const w of h){const y=new W(D.W(w.human));o.push(y),a.push(y.GetValue().map(p=>p?null:`${w.urlName}=false`))}t.definitionRaw!==void 0&&a.push(new M("userlayout="+(t.definedAtUrl??t.id)));const v=new S(o).SetClass("flex flex-col"),C=(l??new M(void 0)).map(()=>{const w=window.location.host;let y=window.location.pathname;y=y.substr(0,y.lastIndexOf("/"));let p=t.id.toLowerCase();t.definitionRaw!==void 0&&(p="theme.html");let g=`https://${w}${y}/${p}`,m="";t.definedAtUrl===void 0&&t.definitionRaw!==void 0&&(m="#"+Y.compressToBase64(I.MinifyJSON(t.definitionRaw)));const N=I.NoEmpty(I.NoNull(a.map(Ie=>Ie.data)));return N.length===0?g+m:g+"?"+N.join("&")+m},a),A=new G(C.map(w=>{var y;return`<span class='literal-code iframe-code-block'>
                         &lt;iframe src="${w}" allow="geolocation" width="100%" height="100%" style="min-width: 250px; min-height: 250px" title="${((y=t.title)==null?void 0:y.txt)??"MapComplete"} with MapComplete"&gt;&lt;/iframe&gt
                    </span>`})),b=new M(""),L=new G(C.map(w=>`<input type="text" value=" ${w}" id="code-link--copyable" style="width:90%">`)).onClick(async()=>{var p,g;const w={title:((p=D.W(t.title))==null?void 0:p.ConstructElement().textContent)??"",text:((g=D.W(t.description))==null?void 0:g.ConstructElement().textContent)??"",url:C.data};function y(){const m=document.getElementById("code-link--copyable");m.select(),m.setSelectionRange(0,99999),document.execCommand("copy");const N=n.copiedToClipboard.Clone();N.SetClass("thanks"),b.setData(N)}try{navigator.share(w).then(()=>{const m=n.thanksForSharing.Clone();m.SetClass("thanks"),b.setData(m)},y).catch(y)}catch{y()}});let k;if(t.definitionRaw!==void 0){const w=new O(x.download_svg(),new S([n.downloadCustomTheme,n.downloadCustomThemeHelp.SetClass("subtle")]).onClick(()=>{I.offerContentsAsDownloadableFile(t.definitionRaw,t.id+".mapcomplete-theme-definition.json",{mimetype:"application/json"})}).SetClass("flex flex-col"));let y;if(t.definedAtUrl===void 0){const p=JSON.parse(t.definitionRaw);p.language=Object.keys(p.title),y=new O(x.pencil_svg(),"Edit this theme on the custom theme generator",{url:`https://pietervdvn.github.io/mc/legacy/070/customGenerator.html#${btoa(JSON.stringify(p))}`})}k=new S([w,y]).SetClass("flex flex-col")}super([n.intro,L,new G(b),k,n.addToHomeScreen,n.embedIntro,v,A]),this.SetClass("flex flex-col link-underline")}}class lt extends S{constructor(){const e=D.t.privacy;super([new E(e.title,2),e.intro,new E(e.trackingTitle),e.tracking,new E(e.geodataTitle),e.geodata,new E(e.editingTitle),e.editing,new E(e.miscCookiesTitle),e.miscCookies,new E(e.whileYoureHere),e.surveillance]),this.SetClass("link-underline")}}const V=class extends B{constructor(e,t,n,o){const a=n.layoutToUse;super(()=>a.title.Clone(),()=>V.GenerateContents(n,t,e,o),"welcome",e)}static ConstructBaseTabs(e,t,n,o){const a=[{header:`<img src='${e.layoutToUse.icon}'>`,content:new st(t,n,e,o)}];e.featureSwitchMoreQuests.data&&a.push({header:x.add_img,content:new S([D.t.general.morescreen.intro,new Pe(e)]).SetClass("flex flex-col")}),e.featureSwitchShareScreen.data&&a.push({header:x.share_img,content:new rt(e)});const s={header:x.eye_svg(),content:new lt};return a.push(s),a}static GenerateContents(e,t,n,o){const a=V.ConstructBaseTabs(e,n,t,o),s=[...V.ConstructBaseTabs(e,n,t,o)];return s.push({header:x.help,content:new S([D.t.general.aboutMapcomplete.Subs({osmcha_link:I.OsmChaLinkFor(7)}),"<br/>Version "+F.vNumber,j.generateDocumentationDynamic()]).SetClass("link-underline")}),a.forEach(l=>l.content.SetClass("p-4")),s.forEach(l=>l.content.SetClass("p-4")),new _(new le(s,t),new le(a,t),e.osmConnection.userDetails.map(l=>l.loggedIn&&l.csCount>=F.userJourney.mapCompleteHelpUnlock))}};let H=V;T(H,"MoreThemesTabIndex",1);class R extends S{constructor(e,t){super([e]),t!=null&&t.dontStyle||(e.SetClass("mapcontrol p-1"),this.SetClass("p-1")),this.SetClass("relative block rounded-full w-10 h-10 pointer-events-auto z-above-map subtle-background m-0.5 md:m-1"),this.SetStyle("box-shadow: 0 0 10px var(--shadow-color);")}}var ct=function(f,e){var t={};return Object.keys(f).forEach(function(n){t[n]=f[n]}),Object.keys(e).forEach(function(n){t[n]=e[n]}),t},ee={},dt={get exports(){return ee},set exports(f){ee=f}};(function(f){(function(){var e=["Point","LineString","Polygon"],t=["MultiPoint","MultiLineString","MultiPolygon"];function n(s){return t.indexOf(s.type)>-1?s.coordinates.map(function(l){var i={};return i.type=s.type.replace("Multi",""),i.coordinates=l,s.crs&&(i.crs=s.crs),i}):!1}function o(s){var l=s.every(function(r){return e.indexOf(r.type)>-1}),i=s[0].crs||0,c=s.every(function(r){var d=r.crs||0;return d==i});if(l&&c){var u={};return u.type="Multi"+s[0].type,u.coordinates=[],i!=0&&(u.crs=i),s.forEach(function(r){u.coordinates.push(r.coordinates)}),u}else return!1}var a={explode:n,implode:o};f.exports?f.exports=a:window&&(window.multigeojson=a)})()})(dt);var oe=ee;function Z(f,e,t,n){var o=f.map(function(s){return[(s[0]-t.x)/e,(t.y-s[1])/e]}),a=o.map(function(s){return n?s[0].toFixed(n)+","+s[1].toFixed(n):s[0]+","+s[1]});return a.join(" ")}function Ce(f,e,t,n){var o=n&&n.r?n.r:1,a=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1,s=Z([f.coordinates],e,t,n.precision);return a?[s]:["M"+s+" m"+-o+",0 a"+o+","+o+" 0 1,1 "+2*o+","+0+" a"+o+","+o+" 0 1,1 "+-2*o+","+0]}function ut(f,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,a=oe.explode(f).map(function(s){return Ce(s,e,t,n)[0]});return o?a:[a.join(" ")]}function xe(f,e,t,n){var o=Z(f.coordinates,e,t,n.precision),a="M"+o;return[a]}function ft(f,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,a=oe.explode(f).map(function(s){return xe(s,e,t,n)[0]});return o?a:[a.join(" ")]}function be(f,e,t,n){var o,a;o=Z(f.coordinates[0],e,t,n.precision),f.coordinates.length>1&&(a=f.coordinates.slice(1,f.coordinates.length));var s="M"+o;if(a)for(var l=0;l<a.length;l++)s+=" M"+Z(a[l],e,t,n.precision);return s+="Z",[s]}function pt(f,e,t,n){var o=n.hasOwnProperty("explode")?n.explode:!1,a=oe.explode(f).map(function(s){return be(s,e,t,n)[0]});return o?a:[a.join(" ").replace(/Z/g,"")+"Z"]}var mt={Point:Ce,MultiPoint:ut,LineString:xe,MultiLineString:ft,Polygon:be,MultiPolygon:pt},ae=ct,te=mt,z=function(f){this.options=f||{},this.viewportSize=this.options.viewportSize||{width:256,height:256},this.mapExtent=this.options.mapExtent||{left:-20037508342789244e-9,right:20037508342789244e-9,bottom:-20037508342789244e-9,top:20037508342789244e-9},this.res=this.calResolution(this.mapExtent,this.viewportSize,this.options.fitTo)};z.prototype.calResolution=function(f,e,t){var n=(f.right-f.left)/e.width,o=(f.top-f.bottom)/e.height;if(t){if(t.toLowerCase()==="width")return n;if(t.toLowerCase()==="height")return o;throw new Error('"fitTo" option should be "width" or "height" ')}else return Math.max(n,o)};z.prototype.convert=function(f,e){var t=ae(this.options,e||{}),n=[];if(f.type=="FeatureCollection")for(var o=0;o<f.features.length;o++)n=n.concat(this.convertFeature(f.features[o],t));else if(f.type=="Feature")n=this.convertFeature(f,t);else if(f.type=="GeometryCollection")for(var o=0;o<f.geometries.length;o++)n=n.concat(this.convertGeometry(f.geometries[o],t));else if(te[f.type])n=this.convertGeometry(f,t);else return;return t.callback&&t.callback.call(this,n),n};z.prototype.convertFeature=function(f,e){if(!(!f&&!f.geometry)){var t=ae(this.options,e||{});if(t.attributes&&t.attributes instanceof Array){var n=t.attributes;t.attributes=n.reduce(function(a,s){if(typeof s=="string"){var l,i=s.split(".").pop();try{l=de(f,s)}catch{l=!1}l&&(a[i]=l)}else if(typeof s=="object"&&s.type&&s.property)if(s.type==="dynamic"){var l,i=s.key?s.key:s.property.split(".").pop();try{l=de(f,s.property)}catch{l=!1}l&&(a[i]=l)}else s.type==="static"&&s.value&&(a[s.property]=s.value);return a},{})}else t.attributes=t.attributes||{};var o=t.attributes.id||f.id||(f.properties&&f.properties.id?f.properties.id:null);return o&&(t.attributes.id=o),this.convertGeometry(f.geometry,t)}};z.prototype.convertGeometry=function(f,e){if(te[f.type]){var t=ae(this.options,e||{}),n=t.output||"svg",o=te[f.type].call(this,f,this.res,{x:this.mapExtent.left,y:this.mapExtent.top},t),a,s;return n.toLowerCase()=="svg"?(a=o.map(function(l){return ht(l,f.type,t.attributes,t)}),s=a.map(function(l){return wt(l,f.type,t)}),s):o}else return};function ht(f,e,t,n){var o={},a=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1;(e=="Point"||e=="MultiPoint")&&a?(o.cx=f.split(",")[0],o.cy=f.split(",")[1],o.r=n&&n.r?n.r:"1"):(o={d:f},(e=="Polygon"||e=="MultiPolygon")&&o["fill-rule"]=="evenodd");for(var s in t)o[s]=t[s];return o}function wt(f,e,t){var n=t&&t.hasOwnProperty("pointAsCircle")?t.pointAsCircle:!1,o="<path";(e=="Point"||e=="MultiPoint")&&n&&(o="<circle");for(var a in f)o+=" "+a+'="'+f[a]+'"';return o+="/>",o}function de(f,e){function t(n,o,a,s){if(n.hasOwnProperty(o))return n[o];throw new Error(s.slice(0,a+1).join(".")+" is not a valid property path")}return e.split(".").reduce(t,f)}var gt=z,vt=gt,yt=function(f){return new vt(f)},St=yt;class U extends _{constructor(e){const t=D.t.general.download,n=e.layoutToUse.id,o=new He([t.includeMetaData]),a=o.GetValue().map(u=>u.length>0),s=new O(x.floppy_ui(),new S([t.downloadGeojson.SetClass("font-bold"),t.downloadGeoJsonHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const u=U.getCleanGeoJson(e,a.data);I.offerContentsAsDownloadableFile(JSON.stringify(u,null,"  "),`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.geojson`,{mimetype:"application/vnd.geo+json"})}),l=new O(x.floppy_ui(),new S([t.downloadCSV.SetClass("font-bold"),t.downloadCSVHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const u=U.getCleanGeoJson(e,a.data),r=ye.toCSV(u.features);I.offerContentsAsDownloadableFile(r,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.csv`,{mimetype:"text/csv"})}),i=new O(x.floppy_ui(),new S([t.downloadAsSvg.SetClass("font-bold"),t.downloadAsSvgHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const u=U.getCleanGeoJsonPerLayer(e,a.data),r=document.getElementById("leafletDiv"),d=U.asSvg(u,{layers:e.filteredLayers.data.map(h=>h.layerDef),mapExtent:e.currentBounds.data,width:r.offsetWidth,height:r.offsetHeight});I.offerContentsAsDownloadableFile(d,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.svg`,{mimetype:"image/svg+xml"})}),c=new S([new E(t.title),s,l,i,o,t.licenseInfo.SetClass("link-underline")]).SetClass("w-full flex flex-col border-4 border-gray-300 rounded-3xl p-4");super(c,t.noDataLoaded,e.featurePipeline.somethingLoaded)}static asSvg(e,t){var c,u,r;t=t??{};const n=t.width??1e3,o=t.height??1e3,a=t.unit??"px",s={left:-180,bottom:-90,right:180,top:90};if(t.mapExtent!==void 0){const d=t.mapExtent;s.left=d.minLon,s.right=d.maxLon,s.bottom=d.minLat,s.top=d.maxLat}const l=[];for(const d of Array.from(e.keys())){const h=e.get(d);if(h.length===0)continue;const v=(c=t==null?void 0:t.layers)==null?void 0:c.find(k=>k.id===d),C=v==null?void 0:v.lineRendering[0],A=St({viewportSize:{width:n,height:o},mapExtent:s,output:"svg",attributes:[{property:"style",type:"static",value:"fill:none;stroke-width:1"},{property:"properties.stroke",type:"dynamic",key:"stroke"}]});for(const k of h){const w=((r=(u=C==null?void 0:C.color)==null?void 0:u.GetRenderValue(k.properties))==null?void 0:r.txt)??"#ff0000",y=I.colorAsHex(I.color(w));k.properties.stroke=y}const b=A.convert({type:"FeatureCollection",features:h}),L=`    <g id="${d}" inkscape:groupmode="layer" inkscape:label="${d}">
`+b.map(k=>"        "+k).join(`
`)+`
    </g>`;l.push(L)}return`<svg width="${n}${a}" height="${o}${a}" viewBox="0 0 ${n} ${o}">`+`
`+l.join(`
`)+`
</svg>`}static getCleanGeoJson(e,t){const n=U.getCleanGeoJsonPerLayer(e,t);return{type:"FeatureCollection",features:[].concat(...Array.from(n.values()))}}static getCleanGeoJsonPerLayer(e,t){const n=new Map,o=e.filteredLayers.data.map(l=>l.layerDef.id),a=e.currentBounds.data,s=e.featurePipeline.GetAllFeaturesAndMetaWithin(a,new Set(o));e:for(const l of s){if(F.priviliged_layers.indexOf(l.layer)>=0)continue;const i=e.filteredLayers.data.find(r=>r.layerDef.id===l.layer);n.has(l.layer)||n.set(l.layer,[]);const c=n.get(l.layer),u=i.appliedFilters.data;for(const r of l.features){if(!a.overlapsWith(K.get(r)))continue;if(u!==void 0)for(let v of Array.from(u.keys())){const C=u.get(v);if((C==null?void 0:C.currentFilter)!==void 0&&!C.currentFilter.matchesProperties(r.properties))continue e}const d={type:r.type,geometry:{...r.geometry},properties:{...r.properties}};if(!t)for(const v in d.properties)v==="_lon"||v==="_lat"||v.startsWith("_")&&delete r.properties[v];const h=[].concat(Ye.metatags.filter(v=>v.includesDates).map(v=>v.keys));for(const v of h)delete r.properties[v];c.push(r)}}return n}}class Ct{constructor(e){T(this,"isRunning",new M(!0));T(this,"mapW",297);T(this,"mapH",210);T(this,"scaling",2);T(this,"freeDivId");T(this,"_layout");T(this,"_screenhotTaken",!1);this.freeDivId=e.freeDivId,this._layout=e.layout;const t=this,n=e.location.data,o={lat:n.lat,lon:n.lon,zoom:n.zoom+1},a=Fe.createMiniMap({location:new M(o),background:e.background,allowMoving:!1,onFullyLoaded:s=>window.setTimeout(()=>{if(!t._screenhotTaken)try{t.CreatePdf(a).then(()=>t.cleanup()).catch(()=>t.cleanup())}catch(l){console.error(l),t.cleanup()}},500)});a.SetStyle(`width: ${this.mapW*this.scaling}mm; height: ${this.mapH*this.scaling}mm;`),a.AttachTo(e.freeDivId),a.leafletMap.addCallbackAndRunD(s=>{const l=K.fromLeafletBounds(s.getBounds().pad(.2));e.features.GetTilesPerLayerWithin(l,i=>{i.layer.layerDef.minzoom>n.zoom||i.layer.layerDef.id.startsWith("note_import")||new J({features:i,leafletMap:a.leafletMap,layerToShow:i.layer.layerDef,doShowLayer:i.layer.isDisplayed,state:void 0})})}),q.state.AddAllOverlaysToMap(a.leafletMap)}cleanup(){new P("Screenshot taken!").AttachTo(this.freeDivId),this._screenhotTaken=!0}async CreatePdf(e){console.log("PDF creation started");const t=D.t.general.pdf,n=this._layout;let o=new We("landscape");const a=await e.TakeScreenshot();o.addImage(a,"PNG",0,0,this.mapW,this.mapH),o.setDrawColor(255,255,255),o.setFillColor(255,255,255),o.roundedRect(12,10,145,25,5,5,"FD"),o.setFontSize(20),o.textWithLink(n.title.txt,40,18.5,{maxWidth:125,url:window.location.href}),o.setFontSize(10),o.text(t.generatedWith.txt,40,23,{maxWidth:125});const s=q.state.backgroundLayer.data,l=new P(s.layer().getAttribution()??s.name).ConstructElement().textContent;o.textWithLink(t.attr.txt,40,26.5,{maxWidth:125,url:"https://www.openstreetmap.org/copyright"}),o.text(t.attrBackground.Subs({background:l}).txt,40,30);let i=new Date().toISOString().substr(0,16);o.setFontSize(7),o.text(t.versionInfo.Subs({version:F.vNumber,date:i}).txt,40,34,{maxWidth:125});let c=document.createElement("img");const u=n.icon,r=u.substring(u.lastIndexOf(".")+1);if(c.src=u,r.toLowerCase()==="svg"){new P("").AttachTo(this.freeDivId);const d=document.createElement("canvas"),h=d.getContext("2d");d.width=500,d.height=500,c.style.width="100%",c.style.height="100%",h.drawImage(c,0,0,500,500);const v=d.toDataURL("image/png");o.addImage(v,"png",15,12,20,20)}else try{o.addImage(c,r,15,12,20,20)}catch(d){console.error(d)}o.save(`MapComplete_${n.title.txt}_${i}.pdf`),this.isRunning.setData(!1)}}class Q extends B{constructor(e,t){super(Q.GenTitle,()=>Q.GeneratePanel(t),"downloads",e)}static GenTitle(){return D.t.general.download.title.Clone().SetClass("text-2xl break-words font-bold p-2")}static GeneratePanel(e){const t=new M(!1,"Pdf-is-exporting"),n=()=>{t.setData(!0),new Ct({freeDivId:"belowmap",background:e.backgroundLayer,location:e.locationControl,features:e.featurePipeline,layout:e.layoutToUse}).isRunning.addCallbackAndRun(u=>t.setData(u))},o=x.loading_svg().SetClass("animate-rotate"),a=D.t.general.download,s=new _(o,x.floppy_ui(),t),l=new _(a.exporting.Clone(),new S([a.downloadAsPdf.Clone().SetClass("font-bold"),a.downloadAsPdfHelper.Clone()]).SetClass("flex flex-col").onClick(()=>{n()}),t),i=new _(new O(s,l),void 0,e.featureSwitchExportAsPdf),c=new _(new U(e),void 0,e.featureSwitchEnableExport);return new S([i,c]).SetClass("flex flex-col")}}class xt extends S{constructor(e,t){var u,r;const n=(u=e.currentView)==null?void 0:u.layer,o=new _(new $(()=>{const d=e.currentView.features.map(v=>{var C;return(C=v[0])==null?void 0:C.feature}),h=new G(d.map(v=>{var L;const C=x.checkbox_empty_svg();if(v===void 0)return C;const A={...v.properties,button:"yes"},b=(L=n.layerDef.mapRendering[0])==null?void 0:L.GetSimpleIcon(new M(A));return b===void 0?C:b})).SetClass("inline-block w-full h-full");return d.map(v=>{if(v===void 0)return;const C=e.allElements.getEventSourceById(v.properties.id);return new X(C,n.layerDef,e,{hashToShow:"currentview",isShown:t.currentViewControlIsOpened})}),new R(h)}).onClick(()=>{t.currentViewControlIsOpened.setData(!0)}),void 0,new M(n!==void 0&&((r=n==null?void 0:n.layerDef)==null?void 0:r.tagRenderings)!==null));new Q(t.downloadControlIsOpened,e);const a=new R(x.download_svg()).onClick(()=>t.downloadControlIsOpened.setData(!0)),s=new _(a,void 0,e.featureSwitchEnableExport.map(d=>d||e.featureSwitchExportAsPdf.data,[e.featureSwitchExportAsPdf]));new B(()=>D.t.general.layerSelection.title.Clone(),()=>new we(e.filteredLayers,e.overlayToggles,e).SetClass("block p-1"),"filters",t.filterViewIsOpened);const l=new R(x.layers_svg()).onClick(()=>t.filterViewIsOpened.setData(!0));e.featureSwitchFilter.addCallbackAndRun(d=>{j.RegisterHotkey({nomod:"B"},D.t.hotkeyDocumentation.openLayersPanel,()=>{t.filterViewIsOpened.setData(!t.filterViewIsOpened.data)})});const i=new _(l,void 0,e.featureSwitchFilter),c=new _(new Ne(e,e.backgroundLayer,{enableHotkeys:!0}),void 0,e.featureSwitchBackgroundSelection);super([o,i,s,c]),this.SetClass("flex flex-col")}}class se extends G{constructor(t,n){const o=(n==null?void 0:n.value)??new M("0");super(t.map(a=>{const s=Object.keys(a);return s.sort((l,i)=>{const c=Number(l),u=Number(i);return isNaN(c)||isNaN(u)?l<i?-1:1:c-u}),se.constructPicker(s,o)}));T(this,"_value");this._value=o}static constructPicker(t,n){let o=new qe(0,t.length-1,{vertical:!0});const a="flex border-2 border-blue-500 w-10 h-10 place-content-center items-center border-box";o.SetClass("flex elevator w-10").SetStyle(`height: ${2.5*t.length}rem; background: #00000000`);const s=t.map((i,c)=>new Re(new P(i).SetClass("font-bold active bg-subtle "+a),new P(i).SetClass("normal-background "+a),o.GetValue().sync(u=>u===c,[],u=>u?c:o.GetValue().data)).ToggleOnClick().SetClass("flex w-10 h-10"));s.reverse();const l=new S([new S(s),o]);return l.SetClass("flex flex-row overflow-hidden"),o.GetValue().addCallbackD(i=>{t!==void 0&&t[i]!=null&&n.setData(t[i])}),n.addCallbackAndRunD(i=>{const c=t.findIndex(u=>u===i);o.GetValue().setData(c)}),l}GetValue(){return this._value}IsValid(t){return!1}}class bt extends S{constructor(e){const t=e.currentBounds.map(s=>{if(s===void 0)return{};const c=[].concat(...e.featurePipeline.GetAllFeaturesAndMetaWithin(s).map(r=>r.features)).filter(r=>K.get(r).overlapsWith(s)).map(r=>r.properties.level),u={0:0};for(const r of c){r===void 0&&u[0]++;for(const d of Se.LevelsParser(r))u[d]=(u[d]??0)+1}return u}),n=new se(t);e.globalFilters.data.push({filter:{currentFilter:void 0,state:void 0},id:"level",onNewPoint:void 0});const o=t.map(s=>!(e.locationControl.data.zoom<=16||Object.keys(s).length==1),[e.locationControl]);function a(){console.log("Updating levels filter to ",n.GetValue().data," is shown:",o.data);const s=e.globalFilters.data.find(u=>u.id==="level");if(!o.data){s.filter={state:"*",currentFilter:void 0},s.onNewPoint=void 0,e.globalFilters.ping();return}const l=n.GetValue().data;if(l===void 0)return;let i=new et("level",new RegExp("(^|;)"+l+"(;|$)"));l==="0"&&(i=new tt([i,new ce("level","")])),s.filter={state:l,currentFilter:i};const c=D.t.general.levelSelection;s.onNewPoint={confirmAddNew:c.confirmLevel.PartialSubs({level:l}),safetyCheck:c.addNewOnLevel.Subs({level:l}),tags:[new ce("level",l)]},e.globalFilters.ping()}o.addCallbackAndRun(s=>{console.log("Is level selector shown?",s),a(),s?n.RemoveClass("invisible"):n.SetClass("invisible")}),t.addCallbackAndRun(s=>{if(!o.data)return;const l=n.GetValue();if(!(s[l.data]===void 0||s[l.data]===0))return;let i=0,c;for(const u in s){const r=s[u];(c===void 0||i<r)&&(c=u,i=r)}console.log("Force switching to a different level:",c,"as it has",i,"elements on that floor",s,"(old level: "+l.data+")"),l.setData(c)}),n.GetValue().addCallback(s=>a()),super([n])}}class kt extends G{constructor(e,t){var l;const n=new M(void 0),o=n.map(i=>i===void 0?!1:(new Date().getTime()-i.getTime())/1e3<=3),a=e==null?void 0:e.geolocationState;super((l=a==null?void 0:a.permission)==null?void 0:l.map(i=>i==="denied"?x.location_refused_svg():a.isLocked.data?x.location_locked_svg():a.currentGPSLocation.data===void 0?i==="prompt"?x.location_empty_svg():(e.mapHasMoved.data?x.location_empty_svg():x.location_svg()).SetClass("cursor-wait").SetStyle("animation: spin 4s linear infinite;"):o.data?x.location_unlocked_svg():x.location_svg(),[a.currentGPSLocation,a.isLocked,e.mapHasMoved,o]));async function s(){if(a.permission.data!=="granted"&&a.currentGPSLocation.data===void 0&&await a.requestPermission(),a.isLocked.data===!0){a.isLocked.setData(!1);return}if(a.currentGPSLocation.data===void 0)return;const i=a.currentGPSLocation.data,c=t.currentBounds.data.contains([i.longitude,i.latitude]);if(e.MoveMapToCurrentLocation(),c){const u=t.locationControl.data;t.locationControl.setData({...u,zoom:u.zoom+3})}if(o.data){a.isLocked.setData(!0),n.setData(void 0);return}n.setData(new Date)}this.onClick(s),j.RegisterHotkey({nomod:"L"},D.t.hotkeyDocumentation.geolocate,s),n.addCallbackAndRunD(i=>{window.setTimeout(()=>{o.data&&n.ping()},500)})}}class Dt extends S{constructor(e,t){const n=_.If(e.featureSwitchGeolocation,()=>new R(new kt(t,e),{dontStyle:!0}).SetClass("p-1")),o=new R(x.plus_svg()).onClick(()=>{e.locationControl.data.zoom++,e.locationControl.ping()}),a=new R(x.min_svg()).onClick(()=>{e.locationControl.data.zoom--,e.locationControl.ping()}),s=new bt(e);super([s,o,a,n].map(l=>l.SetClass("m-0.5 md:m-1"))),this.SetClass("flex flex-col items-center")}}class Lt extends G{constructor(e){const t=e.featurePipeline,n=D.t.centerMessage,o=t.runningQuery.map(a=>a?{el:new Ue(n.loadingData)}:t.sufficientlyZoomed.data?t.timeout.data>0?{el:n.retrying.Subs({count:""+t.timeout.data})}:{el:n.ready,isDone:!0}:{el:n.zoomIn},[t.timeout,t.sufficientlyZoomed,e.locationControl]);super(o.map(a=>a.el)),this.SetClass("flex justify-center rounded-3xl bg-white text-xl font-bold pointer-events-none p-4"),this.SetStyle("transition: opacity 750ms linear"),o.addCallbackAndRun(a=>{a.isDone??!1?this.SetStyle("transition: opacity 750ms linear; opacity: 0"):this.SetStyle("transition: opacity 750ms linear; opacity: 0.75")})}}const ke="home_location",De="Meta layer showing the home location of the user. The home location can be set in the [profile settings](https://www.openstreetmap.org/profile/edit) of OpenStreetMap.",Le=0,Te={osmTags:"user:home=yes",maxCacheAge:0},Me=[{icon:{render:"circle:white;./assets/svg/home.svg"},iconSize:{render:"20,20,center"},location:["point","centroid"]}],Tt={id:ke,description:De,minzoom:Le,source:Te,mapRendering:Me},_e=Object.freeze(Object.defineProperty({__proto__:null,default:Tt,description:De,id:ke,mapRendering:Me,minzoom:Le,source:Te},Symbol.toStringTag,{value:"Module"}));class Mt extends _{constructor(e,t,n){var u;const o=D.t.notes,a=new M(!1);n.LastClickLocation.addCallbackAndRun(r=>a.setData(!1));const s=Ve.ForType("text").ConstructInputElement({value:pe.Get("note-text")});s.SetClass("border rounded-sm border-grey-500");const l=new O(x.addSmall_svg().SetClass("max-h-7"),o.createNote);l.onClick(async()=>{var C,A,b,L,k,w,y,p,g,m;let r=s.GetValue().data;if(r===void 0||r==="")return;r+=`

 #MapComplete #`+((C=n==null?void 0:n.layoutToUse)==null?void 0:C.id);const d=n.LastClickLocation.data,h=await((A=n==null?void 0:n.osmConnection)==null?void 0:A.openNote(d.lat,d.lon,r)),v={type:"Feature",geometry:{type:"Point",coordinates:[d.lon,d.lat]},properties:{id:""+h.id,date_created:new Date().toISOString(),_first_comment:r,comments:JSON.stringify([{text:r,html:r,user:(k=(L=(b=n.osmConnection)==null?void 0:b.userDetails)==null?void 0:L.data)==null?void 0:k.name,uid:(p=(y=(w=n.osmConnection)==null?void 0:w.userDetails)==null?void 0:y.data)==null?void 0:p.uid}])}};(g=n==null?void 0:n.featurePipeline)==null||g.InjectNewPoint(v),(m=n.selectedElement)==null||m.setData(v),s.GetValue().setData(""),a.setData(!0)});const i=new S([new E(o.createNoteTitle),o.createNoteIntro,s,new S([new _(void 0,o.warnAnonymous.SetClass("alert"),(u=n==null?void 0:n.osmConnection)==null?void 0:u.isLoggedIn),new _(l,o.textNeeded.SetClass("alert"),s.GetValue().map(r=>(r==null?void 0:r.length)>3))]).SetClass("flex justify-end items-center")]).SetClass("flex flex-col border-2 border-black rounded-xl p-4"),c=new _(new _(o.isCreated.SetClass("thanks"),i,a),void 0,new M(!0));super(new _(new S([o.noteLayerHasFilters.SetClass("alert"),new O(x.filter_svg(),o.disableAllNoteFilters).onClick(()=>{const r=e.appliedFilters.data;for(const d of Array.from(r.keys()))r.set(d,void 0);e.appliedFilters.ping(),t.setData(!1)})]).SetClass("flex flex-col"),c,e.appliedFilters.map(r=>(console.log("Applied filters for notes are: ",r),Array.from(r.values()).some(d=>(d==null?void 0:d.currentFilter)!==void 0)))),new S([o.noteLayerNotEnabled.SetClass("alert"),new O(x.layers_svg(),o.noteLayerDoEnable).onClick(()=>{e.isDisplayed.setData(!0),t.setData(!1)})]).SetClass("flex flex-col"),e.isDisplayed)}}class _t extends S{constructor(e){const t=new G(e.map(o=>{const a=[];let s;for(const i of o){const c=i.layerDef;if(!(c.name===void 0&&!i.isDisplayed.data))for(const u of i.layerDef.presets){const r=Se.KVtoProperties(u.tags),d=c.mapRendering[0].GenerateLeafletStyle(new M(r),!1).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;");a.push(d),s===void 0&&(s=c.mapRendering[0].GenerateLeafletStyle(new M(r),!1).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;"))}}if(a.length===0)return;if(a.length===1)return a[0];a.push(s);const l=new S(a).SetClass("flex");return l.SetClass("slide min-w-min").SetStyle("animation: slide "+a.length+"s linear infinite;"),l})),n=D.t.general.add.addNewMapLabel.Clone().SetClass("block center absolute text-sm min-w-min pl-1 pr-1 bg-gray-400 rounded-3xl text-white opacity-65 whitespace-nowrap").SetStyle("top: 65px; transform: translateX(-50%)");super([new S([x.add_pin_svg().SetClass("absolute").SetStyle("width: 50px; filter: drop-shadow(grey 0 0 10px"),new S([t]).SetStyle("width: 50px").SetClass("absolute p-1 rounded-full overflow-hidden"),x.addSmall_svg().SetClass("absolute animate-pulse").SetStyle("width: 30px; left: 30px; top: 35px;")]).SetClass("absolute"),new S([n]).SetStyle("position: absolute; left: 50%")]),this.SetClass("block relative")}}class ue extends Be{constructor(t,n){super();T(this,"_config");T(this,"state");this.state=t,this._config=n}InnerRender(){var u,r,d,h,v;if(this._config===void 0)return;const t=this._config,n=window!==window.top;if((u=t.requirements)!=null&&u.has("iframe")&&!n||(r=t.requirements)!=null&&r.has("no-iframe")&&n)return;let o;const a=((d=this.state.layoutToUse)==null?void 0:d.id)??"",s=window.location.host,l=this.state.locationControl.map(C=>{const A={...C,theme:a,basepath:s,language:Oe.language.data};return I.SubstituteKeys(t.href,A)});let i=x.pop_out_ui();t.icon!==void 0&&(i=new ne(t.icon).SetClass("h-6"));let c;return t.text===void 0?c=D.t.general.screenToSmall.Subs({theme:this.state.layoutToUse.title}):c=t.text.Clone(),o=new O(i,c,{url:l,newTab:t.newTab}),(h=t.requirements)!=null&&h.has("no-welcome-message")&&(o=new _(void 0,o,this.state.featureSwitchWelcomeMessage)),(v=t.requirements)!=null&&v.has("welcome-message")&&(o=new _(o,void 0,this.state.featureSwitchWelcomeMessage)),o}}class At{constructor(e,t){T(this,"geolocationState");T(this,"_state");T(this,"mapHasMoved",new M(!1));this.geolocationState=e,this._state=t;const n=t.locationControl;let o=this,a=new Date;n.addCallbackD(l=>{if(!(new Date().getTime()-a.getTime()<250))return o.mapHasMoved.setData(!0),!0}),(ie.wasInitialized("lat")||ie.wasInitialized("lon"))&&this.mapHasMoved.setData(!0),this.geolocationState.currentGPSLocation.addCallbackAndRunD(l=>{var c;const i=(new Date().getTime()-((c=e.requestMoment.data)==null?void 0:c.getTime()))/1e3;if(this.mapHasMoved.data||(console.log("Moving the map to an initial location; time since last request is",i),i<F.zoomToLocationTimeout&&o.MoveMapToCurrentLocation()),this.geolocationState.isLocked.data){o.MoveMapToCurrentLocation();return}}),e.isLocked.map(l=>{var i,c,u,r,d,h;l?(u=(c=(i=t.leafletMap)==null?void 0:i.data)==null?void 0:c.dragging)==null||u.disable():(h=(d=(r=t.leafletMap)==null?void 0:r.data)==null?void 0:d.dragging)==null||h.enable()},[t.leafletMap]),this.CopyGeolocationIntoMapstate()}MoveMapToCurrentLocation(){const e=this.geolocationState.currentGPSLocation.data,t=this._state.locationControl,n=this._state;if(n.selectedElement.data!==void 0)return;if(e.latitude===0&&e.longitude===0){console.debug("Not moving to GPS-location: it is null island");return}const o=n.layoutToUse.lockLocation;o&&o!==!0&&!new K(o).contains([e.longitude,e.latitude])||(t.setData({zoom:t.data.zoom,lon:e.longitude,lat:e.latitude}),this.mapHasMoved.setData(!0))}CopyGeolocationIntoMapstate(){const e=this._state;this.geolocationState.currentGPSLocation.addCallbackAndRun(t=>{var o,a;if(t===void 0)return;const n={type:"Feature",properties:{id:"gps","user:location":"yes",date:new Date().toISOString(),...t},geometry:{type:"Point",coordinates:[t.longitude,t.latitude]}};(a=(o=e.currentUserLocation)==null?void 0:o.features)==null||a.setData([{feature:n,freshness:new Date}])})}}class It{constructor(){T(this,"permission",new M("prompt"));T(this,"requestMoment",new M(void 0));T(this,"isLocked",new M(!1));T(this,"currentGPSLocation",new M(void 0));T(this,"_previousLocationGrant",pe.Get("geolocation-permissions"));T(this,"_grantedThisSession",new M(!1));const e=this;this.permission.addCallbackAndRunD(async t=>{t==="granted"&&(e._previousLocationGrant.setData("true"),e._grantedThisSession.setData(!0)),t==="prompt"&&e._grantedThisSession.data&&(e._previousLocationGrant.setData("false"),e.permission.setData("denied"),e.currentGPSLocation.setData(void 0),console.warn("Detected a downgrade in permissions!")),t==="denied"&&e._previousLocationGrant.setData("false")}),console.log("Previous location grant:",this._previousLocationGrant.data),this._previousLocationGrant.data==="true"&&(this._previousLocationGrant.setData("false"),console.log("Requesting access to GPS as this was previously granted"),this.requestPermission()),window.geolocation_state=this}async startWatching(){const e=this;navigator.geolocation.watchPosition(function(t){e.currentGPSLocation.setData(t.coords),e._previousLocationGrant.setData("true")},function(){console.warn("Could not get location with navigator.geolocation")},{enableHighAccuracy:!0})}requestPermission(){var e;if(typeof navigator>"u"){this.permission.setData("denied");return}if(!(this.permission.data!=="prompt"&&this.permission.data!=="requested")){this.requestMoment.setData(new Date),this.permission.setData("requested");try{(e=navigator==null?void 0:navigator.permissions)==null||e.query({name:"geolocation"}).then(t=>{console.log("Status update: received geolocation permission is ",t.state),this.permission.setData(t.state);const n=this;t.onchange=function(){n.permission.setData(t.state)},this.permission.setData("requested"),n.startWatching()}).catch(t=>console.error("Could not get geopermission",t))}catch(t){console.error("Could not get permission:",t)}}}}class Wt{constructor(e,t){T(this,"guiState");T(this,"state");T(this,"geolocationHandler");this.state=e,this.guiState=t,this.state.featureSwitchGeolocation.data&&(this.geolocationHandler=new At(new It,e))}setup(){this.SetupUIElements(),this.SetupMap(),B.ActivateCurrent(),this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&I.LoadCustomCss(this.state.layoutToUse.customCss),j.RegisterHotkey({shift:"O"},D.t.hotkeyDocumentation.selectMapnik,()=>{this.state.backgroundLayer.setData(je.osmCarto)}),I.downloadJson("./service-worker-version").then(e=>console.log("Service worker",e)).catch(e=>console.log("Service worker not active"))}setupClickDialogOnMap(e,t){const n=t.layoutToUse.layers.some(l=>l.presets.length>0),o=t.filteredLayers.data.filter(l=>l.layerDef.id==="note")[0];let a;o!==void 0&&(a=l=>new Mt(o,l,t));function s(){if(!n&&a===void 0)return;const l=new M(!1),i=new B(()=>n?D.t.general.add.title:D.t.notes.createNoteTitle,({resetScrollSignal:u})=>{let r;n&&(r=new ve(l,u,e,t));let d;return o!==void 0&&(d=a(l)),new S([r,d]).SetClass("flex flex-col font-lg text-lg")},"new",l);i.isShown.addCallback(u=>{u||t.LastClickLocation.setData(void 0)});let c;!n&&a!==void 0&&(c=new S([x.note_svg().SetClass("absolute bottom-0").SetStyle("height: 40px"),x.addSmall_svg().SetClass("absolute w-6 animate-pulse").SetStyle("right: 10px; bottom: -8px;")]).SetClass("block relative h-full").SetStyle("left: calc( 50% - 15px )")),Ze.construct(t,i,n?new _t(t.filteredLayers):c),t.LastClickLocation.addCallbackAndRunD(u=>{B.collapse()})}o!==void 0?s():t.featureSwitchAddNew.addCallbackAndRunD(l=>{if(l)return s(),!0})}SetupMap(){if(I.runningFromConsole)return;const e=this.state,t=this.guiState;e.mainMapObject.SetClass("w-full h-full").AttachTo("leafletDiv"),this.setupClickDialogOnMap(t.filterViewIsOpened,e),new J({leafletMap:e.leafletMap,layerToShow:new ge(_e,"home_location",!0),features:e.homeLocation,state:e});const n=e.filteredLayers.data.filter(o=>o.layerDef.id==="selected_element")[0];new J({leafletMap:e.leafletMap,layerToShow:n.layerDef,features:e.selectedElementsLayer,state:e}),e.leafletMap.addCallbackAndRunD(o=>(e.selectedElement.ping(),q.state.locationControl.ping(),!0))}SetupUIElements(){var c,u;const e=this.state,t=this.guiState,n=this,o=_.If(e.featureSwitchUserbadge,()=>{new $e(e,{isOpened:t.userInfoIsOpened,userInfoFocusedQuestion:t.userInfoFocusedQuestion});const r=new R(new G(e.osmConnection.userDetails.map(d=>(d==null?void 0:d.img)===void 0?x.person_ui().SetClass("mt-1 block"):new ne(d==null?void 0:d.img))).SetClass("block rounded-full overflow-hidden"),{dontStyle:!0}).onClick(()=>{n.guiState.userInfoIsOpened.setData(!0)});return new he(r,D.t.general.loginWithOpenStreetMap,e)}),a=_.If(e.featureSwitchExtraLinkEnabled,()=>new ue(e,e.layoutToUse.extraLink)),s=_.If(e.featureSwitchWelcomeMessage,()=>n.InitWelcomeMessage()),l=_.If(e.featureSwitchIsTesting,()=>new P("TESTING").SetClass("alert m-2 border-2 border-black"));new B(()=>D.t.general.attribution.attributionTitle,()=>new Je(e),"copyright",t.copyrightViewIsOpened);const i=new R(x.copyright_svg()).onClick(()=>t.copyrightViewIsOpened.setData(!0));new S([s,o,i,a,l]).SetClass("flex flex-col").AttachTo("top-left"),new S([new ue(e,{...e.layoutToUse.extraLink,newTab:!0,requirements:new Set})]).SetClass("flex items-center justify-center normal-background h-full").AttachTo("on-small-screen"),new S([_.If(e.featureSwitchSearch,()=>{const r=new fe(e).SetClass("shadow rounded-full h-min w-full overflow-hidden sm:max-w-sm pointer-events-auto");return j.RegisterHotkey({ctrl:"F"},D.t.hotkeyDocumentation.selectSearch,()=>{r.focus()}),r})]).AttachTo("top-right"),new xt(e,t).AttachTo("bottom-left"),new Dt(e,this.geolocationHandler).AttachTo("bottom-right"),new Lt(e).AttachTo("centermessage"),(u=(c=document==null?void 0:document.getElementById("centermessage"))==null?void 0:c.classList)==null||u.add("pointer-events-none")}InitWelcomeMessage(){const e=this.guiState.welcomeMessageIsOpened;new H(e,this.guiState.welcomeMessageOpenedTab,this.state,this.guiState);const t=new R(x.help_svg());t.onClick(()=>e.setData(!0));const n=new Date().getTime();return this.state.locationControl.addCallback(()=>{if(!(new Date().getTime()-n<15*1e3))return e.setData(!1),!0}),this.state.selectedElement.addCallbackAndRunD(o=>{e.setData(!1)}),t.SetClass("pointer-events-auto")}}class Ae{static Implement(){Qe.implementation=Ae.AddToMap}static AddToMap(e,t,n=void 0){t.map(o=>{if(o===void 0)return;const a=nt.tileLayer(e.source,{attribution:"",maxZoom:e.maxzoom,minZoom:e.minzoom,wmts:!1});n===void 0&&a.addTo(o),n==null||n.addCallbackAndRunD(s=>{s?a.addTo(o):o.removeLayer(a)})})}}class $t{constructor(e,t){T(this,"state");T(this,"currentView",new M(void 0));T(this,"singleElementCache",{});this.state=e}viewSelector(e,t,n,o){const a=this.currentView,s={title:t,contents:n};return e.SetClass("pl-1 pr-1 rounded-md"),e.onClick(()=>{a.setData(s)}),re.hash.addCallbackAndRunD(l=>{l===o&&a.setData(s)}),a.addCallbackAndRunD(l=>{l==s?(e.SetClass("bg-unsubtle"),re.hash.setData(o)):e.RemoveClass("bg-unsubtle")}),e}singleElementView(e,t,n){if(this.singleElementCache[e.properties.id]!==void 0)return this.singleElementCache[e.properties.id];const o=this.state.allElements.getEventSourceById(e.properties.id),a=new S([new E(new Ke(o,t.title,this.state),4),n<900?Math.floor(n)+"m away":I.Round(n/1e3)+"km away"]).SetClass("flex justify-between");return this.singleElementCache[e.properties.id]=this.viewSelector(a,new $(()=>X.GenerateTitleBar(o,t,this.state)),new $(()=>X.GenerateContent(o,t,this.state)))}mainElementsView(e){const t=this;return e===void 0?new P("Initializing"):e.length==0?new P("No elements in view"):new S(e.map(n=>t.singleElementView(n.element,n.layer,n.distance)))}documentationButtonFor(e){var t,n;return this.viewSelector(D.W(((t=e.name)==null?void 0:t.Clone())??e.id),new S(["Documentation about ",((n=e.name)==null?void 0:n.Clone())??e.id]),e.GenerateDocumentation([]),"documentation-"+e.id)}allDocumentationButtons(){const e=this.state.layoutToUse.layers.filter(t=>F.priviliged_layers.indexOf(t.id)<0).filter(t=>!t.id.startsWith("note_import_"));return e.length===1?this.documentationButtonFor(e[0]):this.viewSelector(new P("Documentation"),"Documentation",new S(e.map(t=>this.documentationButtonFor(t).SetClass("flex flex-col"))))}setup(){const e=this.state;this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&I.LoadCustomCss(this.state.layoutToUse.customCss);const t=this.SetupMap();I.downloadJson("./service-worker-version").then(h=>console.log("Service worker",h)).catch(h=>console.log("Service worker not active")),document.getElementById("centermessage").classList.add("hidden");const n={};for(const h of e.layoutToUse.layers)n[h.id]=h;const o=this,a=new M([]);function s(){const h=[o.state.locationControl.data.lon,o.state.locationControl.data.lon],v=o.state.featurePipeline.getAllVisibleElementsWithmeta(o.state.currentBounds.data).map(C=>{const A=ye.distanceBetween(C.center,h);return{...C,distance:A}});v.sort((C,A)=>C.distance-A.distance),a.setData(v)}t.bounds.addCallbackAndRun(s),e.featurePipeline.newDataLoadedSignal.addCallback(s),e.filteredLayers.addCallbackAndRun(h=>{for(const v of h)v.isDisplayed.addCallback(s),v.appliedFilters.addCallback(s)});const l=new $(()=>new we(e.filteredLayers,e.overlayToggles,e)),i=new S([e.layoutToUse.description,e.layoutToUse.descriptionTail]);o.currentView.setData({title:e.layoutToUse.title,contents:i});const c=new M(!1);c.addCallback(h=>o.currentView.setData({title:"filters",contents:l}));const u=new M(!1),r=new ve(new M(!0),new M(void 0),c,e,e.locationControl),d="Add a missing point";this.currentView.addCallbackAndRunD(h=>{u.setData(h.contents===r)}),u.addCallbackAndRun(h=>{h?o.currentView.data.contents!==r&&o.currentView.setData({title:d,contents:r}):o.currentView.data.contents===r&&o.currentView.setData(void 0)}),new S([new S([this.viewSelector(new E(e.layoutToUse.title.Clone(),2),e.layoutToUse.title.Clone(),i,"welcome"),t.SetClass("w-full h-64 shrink-0 rounded-lg"),new fe(e),this.viewSelector(new E(new G(a.map(h=>"There are "+(h==null?void 0:h.length)+" elements in view"))),"Statistics",new Xe(a,this.state),"statistics"),this.viewSelector(new P("Filter"),"Filters",l,"filters"),this.viewSelector(new S(["Add a missing point"]),d,r),new G(a.map(h=>this.mainElementsView(h).SetClass("block m-2"))).SetClass("block shrink-2 overflow-x-auto h-full border-2 border-subtle rounded-lg"),this.allDocumentationButtons(),new me(Object.keys(e.layoutToUse.title.translations)).SetClass("mt-2"),new ot]).SetClass("w-1/2 lg:w-1/4 m-4 flex flex-col shrink-0 grow-0"),new G(this.currentView.map(({title:h,contents:v})=>new S([new E(D.W(h),2).SetClass("shrink-0 border-b-4 border-subtle"),D.W(v).SetClass("shrink-2 overflow-y-auto block")]).SetClass("flex flex-col h-full"))).SetClass("w-1/2 lg:w-3/4 m-4 p-2 border-2 border-subtle rounded-xl m-4 ml-0 mr-8 shrink-0 grow-0")]).SetClass("flex h-full").AttachTo("leafletDiv")}SetupMap(){const e=this.state;return new J({leafletMap:e.leafletMap,layerToShow:new ge(_e,"home_location",!0),features:e.homeLocation,state:e}),e.leafletMap.addCallbackAndRunD(t=>(e.selectedElement.ping(),q.state.locationControl.ping(),!0)),e.mainMapObject}}export{$t as D,Ae as S,Wt as a,Y as l};
