var P=Object.defineProperty;var U=(g,e,o)=>e in g?P(g,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):g[e]=o;var D=(g,e,o)=>(U(g,typeof e!="symbol"?e+"":e,o),o);import{C as f,S as h,F as b,L as V,U as T,V as C,Q as N,a as L,T as j}from"./Translations-1a5c9548.js";import{T as A}from"./List-1044a854.js";import{U as J}from"./UserRelatedState-0b2706d9.js";import{L as Q,S as F,a as E}from"./SubtleButton-1e8af95b.js";import{T as _,C as M,D as z}from"./DropDown-fc230c3e.js";import{a as W,c as q,V as H,C as B,L as R}from"./ChartJs-a70d85f0.js";import{T as Y,A as Z,L as K}from"./LeftIndex-48476df3.js";import{T as X}from"./TableOfContents-408e4615.js";import"./defineProperty-4278880f.js";import"./BackToIndex-2ccf3b2e.js";class $ extends F{constructor(e){super(h.statistics_svg(),"Download statistics"),this.onClick(()=>{const o=[].concat(...e),i=["id","status","theme","date_created","date_closed","days_open","intro","...comments"],l=o.map(s=>{var a,n;return[s.props.id+"",s.status,s.theme,(a=s.props.date_created)==null?void 0:a.substr(0,s.props.date_created.length-3),((n=s.props.closed_at)==null?void 0:n.substr(0,s.props.closed_at.length-3))??"",JSON.stringify(s.intro),...s.props.comments.map(c=>JSON.stringify(c.user)+": "+JSON.stringify(c.text))]});L.offerContentsAsDownloadableFile([i,...l].map(s=>s.join(", ")).join(`
`),"mapcomplete_import_notes_overview.csv",{mimetype:"text/csv"})})}}class ee extends f{constructor(e,o){const i=H.ForType("text").ConstructInputElement(),l=new z("On which notes should an action be performed?",[{value:void 0,shown:"Pick an option..."},{value:{predicate:n=>n.status==="open",action:async n=>{const c=i.GetValue().data;e.osmConnection.closeNote(n.id,c)}},shown:"Add comment to every open note and close all notes"},{value:{predicate:n=>n.status==="open",action:async n=>{const c=i.GetValue().data;e.osmConnection.addCommentToNote(n.id,c)}},shown:"Add comment to every open note"}]),s=new T(void 0),a=new F(h.checkmark_svg(),"Apply action").onClick(async()=>{const{predicate:n,action:c}=l.GetValue().data;for(let d=0;d<o.length;d++){s.setData(d);const m=o[d];n(m)&&await c(m)}s.setData(o.length)});super([l,i.SetClass("w-full border border-black"),new _(new _(a,new _(new E(new C(s.map(n=>n===o.length?"All done!":"Handling note "+(n+1)+" out of "+o.length))),new f([h.checkmark_svg().SetClass("h-8"),"All done!"]).SetClass("thanks flex p-4"),s.map(n=>n<o.length)),s.map(n=>n===void 0)),new C(i.GetValue().map(n=>"Type a text of at least 15 characters to apply the action. Currently, there are "+((n==null?void 0:n.length)??0)+" characters")).SetClass("alert"),l.GetValue().map(n=>{var c,d;return n!==void 0&&((d=(c=i.GetValue())==null?void 0:c.data)==null?void 0:d.length)>15},[i.GetValue()])),new _(new b("Testmode enable").SetClass("alert"),void 0,e.featureSwitchIsTesting)])}}class I extends f{constructor(e){if(e.length===0){super([]);return}let o=new Date(e[0].dateStr);for(const t of e){const r=new Date(t.dateStr);r<o&&(o=r)}const l=(new Date().getTime()-o.getTime())/(1e3*60*60*24),s={dates:[],is_open:[]},a={};for(const t of e){const r=t.props.comments.at(-1).user;a[r]===void 0&&(a[r]=[])}for(let t=-1;t<l;t++){const r=new Date(o.getTime()+864e5*t);let u=0;for(const p in a)a[p].push(0);for(const p of e)if(!(new Date(p.dateStr)>r))if(p.props.closed_at===void 0)u++;else if(new Date(p.props.closed_at.substring(0,10)).getTime()>r.getTime())u++;else{const v=p.props.comments.at(-1).user,y=a[v];y[y.length-1]+=1}s.dates.push(new Date(o.getTime()+t*1e3*60*60*24).toISOString().substring(0,10)),s.is_open.push(u)}const c={labels:s.dates.map(t=>""+t),datasets:[{label:"Total open",data:s.is_open,fill:!1,borderColor:"rgb(75, 192, 192)",tension:.1}]};function d(){return Math.floor(Math.random()*256)}for(const t in a)a[t].at(-1)<=10||c.datasets.push({label:"Closed by "+t,data:a[t],fill:!1,borderColor:"rgba("+d()+","+d()+","+d()+")",tension:.1});const m=Object.keys(a);m.sort((t,r)=>a[r].at(-1)-a[t].at(-1)),super([new B({type:"line",data:c,options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}}),new B({type:"doughnut",data:{labels:m,datasets:[{label:"Closed by",data:m.map(t=>a[t].at(-1)),backgroundColor:m.map(t=>"rgba("+d()+","+d()+","+d()+")")}]}}).SetClass("h-16")]),this.SetClass("block w-full h-64 border border-red")}}const G=class extends f{constructor(e,o){const i=e[0].props.comments[0].html,l=new W(["id","status","last comment","last modified by","actions"],e.map(s=>G.noteField(s,o)),{sortable:!0}).SetClass("zebra-table link-underline");super([new A("Mass apply an action on "+e.length+" notes below"),o!==void 0?new ee(o,e.map(s=>s.props)).SetClass("block"):void 0,l,new A("Example note",4),new b(i).SetClass("literal-code link-underline")]),this.SetClass("flex flex-col")}static noteField(e,o){var u;const i=new V(""+e.props.id,"https://openstreetmap.org/note/"+e.props.id,!0);let l="";const s=e.props.comments[e.props.comments.length-1],a=e.props.comments[e.props.comments.length-2];e.props.comments.length>1&&(l=s.text,l===void 0&&(a==null?void 0:a.uid)===s.uid&&(l=a.text));const n=x.icons[e.status]().SetClass("h-4 w-4 shrink-0"),c=new T(!1),d=new T(void 0),m=new Q(()=>new f(this.individualActions.map(([p,w])=>p().onClick(async()=>{e.props.status==="closed"&&await o.osmConnection.reopenNote(e.props.id),await o.osmConnection.closeNote(e.props.id,w),d.setData(w)}).SetClass("h-8 w-8"))).SetClass("flex")),t=new C(d.map(p=>p===void 0?m:p)),r=_.If((u=o==null?void 0:o.osmConnection)==null?void 0:u.isLoggedIn,()=>new M(t,new q("edit...",()=>{console.log("Enabling..."),c.setData(!0)}),c));return[i,new f([n,e.status]).SetClass("flex"),l,new V(s.user,"https://www.openstreetmap.org/user/"+s.user,!0),r]}};let S=G;D(S,"individualActions",[[h.not_found_svg,"This feature does not exist"],[h.addSmall_svg,"imported"],[h.duplicate_svg,"Already mapped"]]);const k=class extends Y{constructor(e,o){e.sort((t,r)=>t.props.id-r.props.id);const{theme:i,intro:l,dateStr:s}=e[0],a=new Map;for(const t of e){const r=t.status,u=a.get(r)??0;a.set(r,u+1)}const n=(a.get("open")??0)+(a.get("has_comments")??0),c=[new b(s).SetClass("literal-code rounded-full"),new b(e.length+" total").SetClass("literal-code rounded-full ml-1 border-4 border-gray").onClick(()=>d.setData(void 0)),n===0?new f([h.party_svg().SetClass("h-6 m-1"),"All done!"]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border border-black"):new b(Math.round(100-100*n/e.length)+"%").SetClass("literal-code rounded-full ml-1")],d=new T(void 0);Object.keys(k.icons).forEach(t=>{const r=a.get(t);if(r===void 0)return;const u=new f([k.icons[t]().SetClass("h-6 m-1"),r+" "+t]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border border-black"),p=new f([k.icons[t]().SetClass("h-6 m-1"),r+" "+t]).SetClass("flex ml-1 mb-1 pl-1 pr-3 items-center rounded-full border-4 border-black animate-pulse"),w=new M(p,u,d.sync(v=>v===t,[],(v,y)=>{if(v)return t;if(y!==t)return y})).ToggleOnClick();c.push(w)});const m=new f([new S(e,o),new I(e)]);super(new f([new A(i+": "+l,2),new f(c).SetClass("flex flex-wrap")]),new C(d.map(t=>{if(t===void 0)return m;const r=e.filter(u=>u.status===t);return new f([new S(r,o),new I(r)])})),{closeOnClick:!1})}};let x=k;D(x,"icons",{open:h.compass_svg,has_comments:h.speech_bubble_svg,imported:h.addSmall_svg,already_mapped:h.checkmark_svg,not_found:h.not_found_svg,closed:h.close_svg,invalid:h.invalid_svg});class O extends C{constructor(e,o){let i;e.uid!==void 0?i="https://api.openstreetmap.org/api/0.6/notes/search.json?user="+e.uid+"&closed=730&limit=10000&sort=created_at&q=%23import":(i="https://api.openstreetmap.org/api/0.6/notes/search.json?display_name="+encodeURIComponent(e.display_name)+"&limit=10000&closed=730&sort=created_at&q=",e.search!==""?i+=e.search:i+="#import");const l=T.FromPromiseWithErr(L.downloadJson(i));super(l.map(s=>{var r,u;if(s===void 0)return new E("Loading notes which mention '#import'");if(s.error!==void 0)return new b("Something went wrong: "+s.error).SetClass("alert");let a=s.success.features.map(p=>p.properties);if(e.uid&&(a=a.filter(p=>p.comments[0].uid===e.uid)),e.display_name!==void 0){const p=e.display_name;a=a.filter(w=>w.comments[0].user===p)}const n=Array.from(O.SplitNotesIntoBatches(a).values()),c=n.map(p=>new x(p,o)),d=new Z(c);let m=[];(u=(r=o==null?void 0:o.osmConnection)==null?void 0:r.isLoggedIn)!=null&&u.data&&(m=[new A(j.t.importInspector.title,1),new F(void 0,"Create a new batch of imports",{url:"import_helper.html"})]),m.push(d),m.push(new f([new A("Statistics for all notes"),new I([].concat(...n))]));const t=new f(m);return new K([new X(t,{noTopLevel:!0,maxDepth:1}).SetClass("subtle"),new $(n)],t)}))}static SplitNotesIntoBatches(e){const o=new Map,i="https://mapcomplete.osm.be/";for(const l of e){const s=l.comments[0].text.split(`
`),a=s.findIndex(r=>r.startsWith(i)&&r.endsWith("#import"));if(a<0)continue;let n=s[a].substr(i.length);n=n.substr(0,n.indexOf("."));const c=L.ParseDate(l.date_created),d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),m=n+s[0]+d;o.has(m)||o.set(m,[]);let t="open";if(l.closed_at!==void 0){const r=l.comments[l.comments.length-1].text.toLowerCase();r.indexOf("does not exist")>=0?t="not_found":r.indexOf("already mapped")>=0?t="already_mapped":r.indexOf("invalid")>=0||r.indexOf("incorrecto")>=0?t="invalid":["imported","erbij","toegevoegd","added","openstreetmap.org/changeset"].some(u=>r.toLowerCase().indexOf(u)>=0)?t="imported":t="closed"}else l.comments.length>1&&(t="has_comments");o.get(m).push({props:l,intro:s[0],theme:n,dateStr:d,status:t})}return o}}class te extends R{constructor(){const e=new J(void 0),o=N.GetQueryParameter("user","","The username of the person whom you want to see the notes for"),i=N.GetQueryParameter("search","","A text that should be included in the first comment of the note to be shown");super(new C(e.osmConnection.userDetails.map(l=>{const s=o.data,a=i.data;return s!==""||a!==""?new O({display_name:s,search:a},void 0):new O(l,e)},[o,i])),"Login to inspect your import flows",e)}}new te().AttachTo("main");
