var U=Object.defineProperty;var E=(r,t,a)=>t in r?U(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a;var h=(r,t,a)=>(E(r,typeof t!="symbol"?t+"":t,a),a);import"./modulepreload-polyfill-3cfb730f.js";import"./Pencil-59ee67f1.js";import{T as B}from"./ThemeConfig-ba3e5a66.js";import{Q as v,F as L,C as N,S as D}from"./tw-merge-66414870.js";import{F as S,O as C,E as I,D as A,e as F,B as P,g as z,h as R,k as b,i as M,d as W,c as V,j as G,f as J}from"./AllKnownLayouts-803ba9e7.js";import{U as m}from"./UIEventSource-64bbdd19.js";import{l as Q,a3 as T}from"./Searchbar-07f5cc49.js";import{C as w}from"./Constants-823bf632.js";import{T as H,a as $}from"./ThemeViewGUI-c4c102f9.js";import{S as K}from"./InputHelper-640cf901.js";import{A as Z}from"./SelectedElementView-f3dac0c1.js";import"./RasterLayerProperties-357e6e36.js";import"./index-34c7dc31.js";import"./LocalStorageSource-c3dcf760.js";import"./tw-join-70ce42f3.js";import"./FloatOver-5bd5c15d.js";import"./OsmConnection-fa95ab3c.js";import"./Marker-bd0d2463.js";import"./Loading-aa985c94.js";import"./Dropdown-8b54df95.js";import"./PrivacyPolicy-6de19d84.js";import"./Community-b145c89c.js";import"./AccordionSingle-1c573f1a.js";import"./Checkbox-9bedbe7a.js";import"./Filterview-ca8c96f2.js";import"./BackButton-c24e0e32.js";import"./Login-c68ac5fb.js";let y=(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en").substr(0,2);function k(r){var a;let t=0;for(const e of Array.from(r.children))((a=e.attributes.getNamedItem("lang"))==null?void 0:a.value)===y&&t++;t===0&&(y="en");for(const e of Array.from(r.children)){const i=e.attributes.getNamedItem("lang");if(i!==void 0){if(i.value===y){e.style.display="";continue}e.parentElement.removeChild(e)}}}k(document.getElementById("descriptions-while-loading"));k(document.getElementById("default-title"));class q extends A{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(t,a){var l,g;if(typeof t=="string"||t.builtin!==void 0)return t;a=a.enter(t.id);let e={...t};e.credits==="Not logged in"&&delete e.credits,e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags),(l=e.allowMove)!=null&&l.enableImproveAccuraccy&&(e.allowMove.enableImproveAccuracy=e.allowMove.enableImproveAccuraccy,delete e.allowMove.enableImproveAccuraccy);for(const o of e.presets??[]){const n=o.preciseInput;typeof n=="boolean"?delete o.preciseInput:n!==void 0&&(delete n.preferredBackground,o.snapToLayer=n.snapToLayer,delete n.snapToLayer,n.maxSnapDistance&&(o.maxSnapDistance=n.maxSnapDistance,delete n.maxSnapDistance),Object.keys(n).length==0&&delete o.preciseInput),typeof o.snapToLayer=="string"&&(o.snapToLayer=[o.snapToLayer])}if(e.tagRenderings!==void 0){let o=0;for(const n of e.tagRenderings)n&&(o++,!(typeof n=="string"||n.builtin!==void 0||n.rewrite!==void 0)&&n.id===void 0&&(n["#"]!==void 0?(n.id=n["#"],delete n["#"]):((g=n.freeform)==null?void 0:g.key)!==void 0?n.id=e.id+"-"+n.freeform.key:n.id="tr-"+o))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let o=["point"],n=e.wayHandling??0;if(n!==0&&(o=["point","centroid"]),e.icon??e.label!==void 0){const s={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:o,rotation:e.rotation};e.mapRendering.push(s)}if(n!==1){const s={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(s).length>0&&e.mapRendering.push(s)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;const i=e.source;i&&(delete i.isOsmCache,delete i.maxCacheAge,delete i.widenFactor);for(const o of e.mapRendering??[]){o.iconOverlays!==void 0&&(o.iconBadges=o.iconOverlays);for(const n of o.iconBadges??[])n.badge!==!0&&a.enters("iconBadges","badge").warn("Non-overlay element"),delete n.badge}if(e.mapRendering){const o=[],n=[];for(const s of e.mapRendering)s.location?o.push(s):n.push(s);e.pointRendering=o,e.lineRendering=n,delete e.mapRendering}for(const o of e.pointRendering??[]){const n=o;if(n.icon)try{let d=n.icon;Object.keys(d).length===1&&d.render!==void 0&&(d=d.render);const p=m.NoEmpty(d.split(";"));n.marker=p.map(u=>{if(u.startsWith("http"))return{icon:u};const[x,O]=u.split(":");return{icon:x,color:O}}),delete n.icon}catch{console.error("Could not handle icon in",t.id),n.marker=[{icon:n.icon}],delete n.icon}let s=n.iconSize;if(s&&(Object.keys(n.iconSize).length===1&&n.iconSize.render!==void 0&&(s=n.iconSize.render),typeof s=="string"&&["bottom","center","top"].some(d=>s.endsWith(d)))){const d=s.split(",").map(p=>p.toLowerCase().trim());n.anchor=d.pop(),n.iconSize=d.join(",")}}if(e.pointRendering)for(const o of e.pointRendering)for(const n in o)o[n]&&typeof o[n].render=="string"&&Object.keys(o[n]).length===1&&(o[n]=o[n].render);if(e.lineRendering)for(const o of e.lineRendering)for(const n in o)o[n]&&typeof o[n].render=="string"&&Object.keys(o[n]).length===1&&(o[n]=o[n].render);return e}}class X extends A{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(t,a){const e={...t};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return a.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=m.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class Y extends S{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new X,new C("layers",new I(new q)))}}class _ extends S{constructor(t,a,e,i){super("Validates a theme and the contained layers",new F(t,a,e,i),new C("layers",new I(new P(l=>w.added_by_default.indexOf(l.id)<0,new z(void 0,e,t,!1,!0)))))}}const c=class c{static getCustomDefinition(){const t=decodeURIComponent(c.loadCustomThemeParam.data);if(t.startsWith("http"))return t}static async expandRemoteLayers(t){if(!t.layers)return t;for(let a=0;a<t.layers.length;a++){const e=t.layers[a];if(typeof e=="string")try{new URL(e),console.log("Downloading remote layer "+e),t.layers[a]=await m.downloadJson(e)}catch{continue}}return t}static async getTheme(){const t=decodeURIComponent(c.loadCustomThemeParam.data);if(t.startsWith("http"))return await c.LoadRemoteTheme(t);let a;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(a=e,e.endsWith(".html")&&(a=e.substr(0,e.length-5)),console.log("Using layout",a)),a=v.GetQueryParameter("layout",a,"The layout to load into MapComplete").data;const i=a==null?void 0:a.toLowerCase(),l=J.allKnownLayouts;if(l.size()==0)throw"Build failed or running, no layouts are known at all";if(l.getConfig(i)===void 0){const g=m.sortedByLevenshteinDistance(i,Array.from(l.keys()),n=>n).slice(0,3);throw`No builtin map theme with name ${a} exists. Perhaps you meant one of ${g.join(", ")}`}return l.get(i)}static getSharedTagRenderings(){const t=new Map;for(const a of R.tagRenderings)t.set(a.id,a);return t}static getSharedTagRenderingOrder(){return R.tagRenderings.map(t=>t.id)}static prepCustomTheme(t,a,e){if(t.layers===void 0&&t.tagRenderings!==void 0){const o=t;let n=m.NoNull(o.pointRendering.flatMap(s=>s.marker).map(s=>{if(!s)return;const d=new T(s.icon).render.txt;if(s.color===void 0||d.startsWith("http:")||d.startsWith("https:"))return d;const p=new T(s.color).render.txt;return d+":"+p})).join(";");n||(n="./assets/svg/bug.svg"),t={id:t.id,description:t.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:n,title:t.name,layers:[t]}}const i=new Map;for(const o in b.layers){const n=b.layers[o];i.set(n.id,n)}const l={tagRenderings:c.getSharedTagRenderings(),tagRenderingOrder:c.getSharedTagRenderingOrder(),sharedLayers:i,publicLayers:new Set};t=new Y().convertStrict(t);const g=t;return t=new M(c._knownImages).convertStrict(t),t.enableNoteImports=t.enableNoteImports??!1,t=new W(l).convertStrict(t),console.log("The layoutconfig is ",t),t.id=e??t.id,new V().convertStrict(t),new _(new G(new Set,()=>!0),"",!1).convertStrict(t),new B(t,!1,{definitionRaw:JSON.stringify(g,null,"  "),definedAtUrl:a})}static async LoadRemoteTheme(t){console.log("Downloading map theme from ",t),new L(`Downloading the theme from the <a href="${t}">link</a>...`).AttachTo("maindiv");let a=await m.downloadJson(t),e=a.id;const i=new URL(t);return i.hostname==="localhost"||i.hostname==="127.0.0.1"||(e=t),console.log("Loaded remote link:",t),a=await this.expandRemoteLayers(a),c.prepCustomTheme(a,t,e)}};h(c,"_knownImages",new Set(Array.from(Q).map(t=>t.path))),h(c,"loadCustomThemeParam",v.GetQueryParameter("userlayout","false","If the parameter is an URL, it should point to a .json of a theme which will be loaded and used"));let f=c;function j(){try{const r=document.createElement("canvas");return!!window.WebGLRenderingContext&&(r.getContext("webgl")||r.getContext("experimental-webgl"))}catch{return!1}}async function ee(r){return await m.waitFor(r),{layers:[]}}async function te(){if(!w.SummaryServer)return new Set;try{const r=new URL(w.SummaryServer).host,t=await Promise.any([m.downloadJson("https://"+r+"/summary/status.json"),ee(2500)]);return new Set(t.layers)}catch(r){return console.error("Could not get MVT available layers due to",r),new Set}}async function ne(){try{if(!j())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[r,t]=await Promise.all([f.getTheme(),await te()]);t==null||t.delete("cycle_highways"),console.log("The available layers on server are",Array.from(t));const a=new H(r,t),e=document.getElementById("maindiv"),i=Array.from(e.children);new $({target:e,props:{state:a}}),i.forEach(l=>e.removeChild(l)),Array.from(document.getElementsByClassName("delete-on-load")).forEach(l=>{l.parentElement.removeChild(l)})}catch(r){console.error("Error while initializing: ",r,r.stack);const t=f.getCustomDefinition();new N([new L(r.toString().split(`
`).join("<br/>")).SetClass("block alert"),(t==null?void 0:t.length)>0?new K(new D(Z),"Download the raw file").onClick(()=>m.offerContentsAsDownloadableFile(f.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}ne().then(r=>{});
//# sourceMappingURL=theme-142feda3.js.map
