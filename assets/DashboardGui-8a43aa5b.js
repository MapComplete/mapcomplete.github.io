var Ee=Object.defineProperty;var Pe=(f,e,t)=>e in f?Ee(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var M=(f,e,t)=>(Pe(f,typeof e!="symbol"?e+"":e,t),t);import{M as Oe,S as q,F as X,a as fe}from"./MoreScreen-79a4c83f.js";import{V as G,S as b,I as ne,F as P,C as S,T as D,a as I,U as _,b as pe,c as Re,Q as ie,H as re}from"./Translations-204b72d6.js";import{L as me}from"./LanguagePicker-375e9476.js";import{T as A,C as Ue}from"./DropDown-11af8a18.js";import{S as O,L as V,a as Be,U as Fe}from"./SubtleButton-3d57095f.js";import{L as he,H as z,T as le,M as Ne,B as Ve,V as je,A as ze}from"./Button-76503958.js";import{U as We,A as He,E as $e,F as we,a as qe}from"./UserInformation-5e6c430a.js";import{C as H,S as B,a as ge,b as Je,c as J,d as Ze,e as ve,f as ye,g as Qe,h as Ke,T as Xe,i as Ye}from"./theme_overview-6da55627.js";import{C as F,G as Se,B as K,S as et,T as Ce,R as tt,O as nt,a as ce,l as ot}from"./UserRelatedState-81b0438d.js";import{T as E}from"./List-3dda29de.js";import{B as at}from"./BackToIndex-e2aa9893.js";class st extends G{constructor(e,t){t=t??{};let n="w-8 h-8 mr-2";t.size=="medium"?n="w-16 h-16 mr-4":t.size=="large"&&(n="w-32 h-32 mr-6"),super(e.userDetails.mapD(o=>{let a=b.person_svg().SetClass("rounded-full border border-black overflow-hidden");o.img&&(a=new ne(o.img));let s=new P(o.name).SetClass("font-bold");return t!=null&&t.firstLine&&(s=new S([t.firstLine,s]).SetClass("flex flex-col")),new S([a.SetClass("rounded-full "+n),s]).SetClass("flex items-center")}))}}class it extends S{constructor(e,t,n,o){var u;const a=D.t.general,s=n.layoutToUse,i=new me(s.language,a.pickLanguage.Clone()),l=new O(void 0,a.openTheMap.Clone().SetClass("text-xl font-bold w-full text-center")).onClick(()=>{e.setData(!1)}).SetClass("only-on-mobile"),c=new st(n.osmConnection,{firstLine:D.t.general.welcomeBack.Clone()});o!=null&&o.userInfoIsOpened&&c.onClick(()=>{o.userInfoIsOpened.setData(!0)});const d=new A(new he(c,new S([D.t.general.loginWithOpenStreetMap.SetClass("text-xl font-bold"),D.t.general.loginOnlyNeededToEdit.Clone().SetClass("font-bold")]).SetClass("flex flex-col"),n),void 0,n.featureSwitchUserbadge),r=s.layers.some(m=>{var y;return((y=m.presets)==null?void 0:y.length)>0});super([s.description.Clone().SetClass("block mb-4"),new We,new S([a.welcomeExplanation.general,r?A.If(n.featureSwitchAddNew,()=>a.welcomeExplanation.addNew):void 0]).SetClass("flex flex-col mt-2"),l,d.SetClass("block mt-6 pt-2 md:border-t-2 border-dotted border-gray-400"),(u=s.descriptionTail)==null?void 0:u.Clone().SetClass("block mt-4"),i==null?void 0:i.SetClass("block mt-4 pb-8 border-b-2 border-dotted border-gray-400"),new He(n),...s.CustomCodeSnippets()]),this.SetClass("link-underline")}}var Y={},rt={get exports(){return Y},set exports(f){Y=f}};(function(f){var e=function(){var t=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",a={};function s(l,c){if(!a[l]){a[l]={};for(var d=0;d<l.length;d++)a[l][l.charAt(d)]=d}return a[l][c]}var i={compressToBase64:function(l){if(l==null)return"";var c=i._compress(l,6,function(d){return n.charAt(d)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(l){return l==null?"":l==""?null:i._decompress(l.length,32,function(c){return s(n,l.charAt(c))})},compressToUTF16:function(l){return l==null?"":i._compress(l,15,function(c){return t(c+32)})+" "},decompressFromUTF16:function(l){return l==null?"":l==""?null:i._decompress(l.length,16384,function(c){return l.charCodeAt(c)-32})},compressToUint8Array:function(l){for(var c=i.compress(l),d=new Uint8Array(c.length*2),r=0,u=c.length;r<u;r++){var m=c.charCodeAt(r);d[r*2]=m>>>8,d[r*2+1]=m%256}return d},decompressFromUint8Array:function(l){if(l==null)return i.decompress(l);for(var c=new Array(l.length/2),d=0,r=c.length;d<r;d++)c[d]=l[d*2]*256+l[d*2+1];var u=[];return c.forEach(function(m){u.push(t(m))}),i.decompress(u.join(""))},compressToEncodedURIComponent:function(l){return l==null?"":i._compress(l,6,function(c){return o.charAt(c)})},decompressFromEncodedURIComponent:function(l){return l==null?"":l==""?null:(l=l.replace(/ /g,"+"),i._decompress(l.length,32,function(c){return s(o,l.charAt(c))}))},compress:function(l){return i._compress(l,16,function(c){return t(c)})},_compress:function(l,c,d){if(l==null)return"";var r,u,m={},y={},C="",L="",k="",T=2,x=3,w=2,v=[],p=0,g=0,h;for(h=0;h<l.length;h+=1)if(C=l.charAt(h),Object.prototype.hasOwnProperty.call(m,C)||(m[C]=x++,y[C]=!0),L=k+C,Object.prototype.hasOwnProperty.call(m,L))k=L;else{if(Object.prototype.hasOwnProperty.call(y,k)){if(k.charCodeAt(0)<256){for(r=0;r<w;r++)p=p<<1,g==c-1?(g=0,v.push(d(p)),p=0):g++;for(u=k.charCodeAt(0),r=0;r<8;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1}else{for(u=1,r=0;r<w;r++)p=p<<1|u,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=0;for(u=k.charCodeAt(0),r=0;r<16;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1}T--,T==0&&(T=Math.pow(2,w),w++),delete y[k]}else for(u=m[k],r=0;r<w;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1;T--,T==0&&(T=Math.pow(2,w),w++),m[L]=x++,k=String(C)}if(k!==""){if(Object.prototype.hasOwnProperty.call(y,k)){if(k.charCodeAt(0)<256){for(r=0;r<w;r++)p=p<<1,g==c-1?(g=0,v.push(d(p)),p=0):g++;for(u=k.charCodeAt(0),r=0;r<8;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1}else{for(u=1,r=0;r<w;r++)p=p<<1|u,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=0;for(u=k.charCodeAt(0),r=0;r<16;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1}T--,T==0&&(T=Math.pow(2,w),w++),delete y[k]}else for(u=m[k],r=0;r<w;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1;T--,T==0&&(T=Math.pow(2,w),w++)}for(u=2,r=0;r<w;r++)p=p<<1|u&1,g==c-1?(g=0,v.push(d(p)),p=0):g++,u=u>>1;for(;;)if(p=p<<1,g==c-1){v.push(d(p));break}else g++;return v.join("")},decompress:function(l){return l==null?"":l==""?null:i._decompress(l.length,32768,function(c){return l.charCodeAt(c)})},_decompress:function(l,c,d){var r=[],u=4,m=4,y=3,C="",L=[],k,T,x,w,v,p,g,h={val:d(0),position:c,index:1};for(k=0;k<3;k+=1)r[k]=k;for(x=0,v=Math.pow(2,2),p=1;p!=v;)w=h.val&h.position,h.position>>=1,h.position==0&&(h.position=c,h.val=d(h.index++)),x|=(w>0?1:0)*p,p<<=1;switch(x){case 0:for(x=0,v=Math.pow(2,8),p=1;p!=v;)w=h.val&h.position,h.position>>=1,h.position==0&&(h.position=c,h.val=d(h.index++)),x|=(w>0?1:0)*p,p<<=1;g=t(x);break;case 1:for(x=0,v=Math.pow(2,16),p=1;p!=v;)w=h.val&h.position,h.position>>=1,h.position==0&&(h.position=c,h.val=d(h.index++)),x|=(w>0?1:0)*p,p<<=1;g=t(x);break;case 2:return""}for(r[3]=g,T=g,L.push(g);;){if(h.index>l)return"";for(x=0,v=Math.pow(2,y),p=1;p!=v;)w=h.val&h.position,h.position>>=1,h.position==0&&(h.position=c,h.val=d(h.index++)),x|=(w>0?1:0)*p,p<<=1;switch(g=x){case 0:for(x=0,v=Math.pow(2,8),p=1;p!=v;)w=h.val&h.position,h.position>>=1,h.position==0&&(h.position=c,h.val=d(h.index++)),x|=(w>0?1:0)*p,p<<=1;r[m++]=t(x),g=m-1,u--;break;case 1:for(x=0,v=Math.pow(2,16),p=1;p!=v;)w=h.val&h.position,h.position>>=1,h.position==0&&(h.position=c,h.val=d(h.index++)),x|=(w>0?1:0)*p,p<<=1;r[m++]=t(x),g=m-1,u--;break;case 2:return L.join("")}if(u==0&&(u=Math.pow(2,y),y++),r[g])C=r[g];else if(g===m)C=T+T.charAt(0);else return null;L.push(C),r[m++]=T+C.charAt(0),u--,T=C,u==0&&(u=Math.pow(2,y),y++)}}};return i}();f!=null&&(f.exports=e)})(rt);class lt extends S{constructor(e){const t=e==null?void 0:e.layoutToUse,n=D.t.general.sharescreen,o=[],a=[],s=new H(n.fsIncludeCurrentLocation,!0);o.push(s);const i=e.locationControl;a.push(s.GetValue().map(w=>{var v,p,g;return i===void 0?null:w?[["z",(v=i.data)==null?void 0:v.zoom],["lat",(p=i.data)==null?void 0:p.lat],["lon",(g=i.data)==null?void 0:g.lon]].filter(h=>h[1]!==void 0).map(h=>h[0]+"="+h[1]).join("&"):null},[i]));function l(w){return w.isDisplayed.data?null:"layer-"+w.layerDef.id+"="+w.isDisplayed.data}const c=e.backgroundLayer,d=new G(c.map(w=>n.fsIncludeCurrentBackgroundMap.Subs({name:(w==null?void 0:w.name)??""}))),r=new H(d,!0);o.push(r),a.push(r.GetValue().map(w=>{var v;return w?"background="+((v=c.data)==null?void 0:v.id):null},[c]));const u=new H(n.fsIncludeCurrentLayers,!0);o.push(u),a.push(u.GetValue().map(w=>w?I.NoNull(e.filteredLayers.data.map(l)).join("&"):null,e.filteredLayers.data.map(w=>w.isDisplayed)));const m=[{urlName:"fs-userbadge",human:n.fsUserbadge},{urlName:"fs-search",human:n.fsSearch},{urlName:"fs-welcome-message",human:n.fsWelcomeMessage},{urlName:"fs-layers",human:n.fsLayers},{urlName:"fs-add-new",human:n.fsAddNew},{urlName:"fs-geolocation",human:n.fsGeolocation}];for(const w of m){const v=new H(D.W(w.human));o.push(v),a.push(v.GetValue().map(p=>p?null:`${w.urlName}=false`))}t.definitionRaw!==void 0&&a.push(new _("userlayout="+(t.definedAtUrl??t.id)));const y=new S(o).SetClass("flex flex-col"),C=(i??new _(void 0)).map(()=>{const w=window.location.host;let v=window.location.pathname;v=v.substr(0,v.lastIndexOf("/"));let p=t.id.toLowerCase();t.definitionRaw!==void 0&&(p="theme.html");let g=`https://${w}${v}/${p}`,h="";t.definedAtUrl===void 0&&t.definitionRaw!==void 0&&(h="#"+Y.compressToBase64(I.MinifyJSON(t.definitionRaw)));const N=I.NoEmpty(I.NoNull(a.map(Ge=>Ge.data)));return N.length===0?g+h:g+"?"+N.join("&")+h},a),L=new G(C.map(w=>{var v;return`<span class='literal-code iframe-code-block'>
                         &lt;iframe src="${w}" allow="geolocation" width="100%" height="100%" style="min-width: 250px; min-height: 250px" title="${((v=t.title)==null?void 0:v.txt)??"MapComplete"} with MapComplete"&gt;&lt;/iframe&gt
                    </span>`})),k=new _(""),T=new G(C.map(w=>`<input type="text" value=" ${w}" id="code-link--copyable" style="width:90%">`)).onClick(async()=>{var p,g;const w={title:((p=D.W(t.title))==null?void 0:p.ConstructElement().textContent)??"",text:((g=D.W(t.description))==null?void 0:g.ConstructElement().textContent)??"",url:C.data};function v(){const h=document.getElementById("code-link--copyable");h.select(),h.setSelectionRange(0,99999),document.execCommand("copy");const N=n.copiedToClipboard.Clone();N.SetClass("thanks"),k.setData(N)}try{navigator.share(w).then(()=>{const h=n.thanksForSharing.Clone();h.SetClass("thanks"),k.setData(h)},v).catch(v)}catch{v()}});let x;if(t.definitionRaw!==void 0){const w=new O(b.download_svg(),new S([n.downloadCustomTheme,n.downloadCustomThemeHelp.SetClass("subtle")]).onClick(()=>{I.offerContentsAsDownloadableFile(t.definitionRaw,t.id+".mapcomplete-theme-definition.json",{mimetype:"application/json"})}).SetClass("flex flex-col"));let v;if(t.definedAtUrl===void 0){const p=JSON.parse(t.definitionRaw);p.language=Object.keys(p.title),v=new O(b.pencil_svg(),"Edit this theme on the custom theme generator",{url:`https://pietervdvn.github.io/mc/legacy/070/customGenerator.html#${btoa(JSON.stringify(p))}`})}x=new S([w,v]).SetClass("flex flex-col")}super([n.intro,T,new G(k),x,n.addToHomeScreen,n.embedIntro,y,L]),this.SetClass("flex flex-col link-underline")}}class ct extends S{constructor(){const e=D.t.privacy;super([new E(e.title,2),e.intro,new E(e.trackingTitle),e.tracking,new E(e.geodataTitle),e.geodata,new E(e.editingTitle),e.editing,new E(e.miscCookiesTitle),e.miscCookies,new E(e.whileYoureHere),e.surveillance]),this.SetClass("link-underline")}}const j=class extends B{constructor(e,t,n,o){const a=n.layoutToUse;super(()=>a.title.Clone(),()=>j.GenerateContents(n,t,e,o),"welcome",e)}static ConstructBaseTabs(e,t,n,o){const a=[{header:`<img src='${e.layoutToUse.icon}'>`,content:new it(t,n,e,o)}];e.featureSwitchMoreQuests.data&&a.push({header:b.add_img,content:new S([D.t.general.morescreen.intro,new Oe(e)]).SetClass("flex flex-col")}),e.featureSwitchShareScreen.data&&a.push({header:b.share_img,content:new lt(e)});const s={header:b.copyright_svg(),content:new S([D.t.general.openStreetMapIntro.SetClass("link-underline"),new ge(e)])};a.push(s);const i={header:b.eye_svg(),content:new ct};return a.push(i),a}static GenerateContents(e,t,n,o){const a=j.ConstructBaseTabs(e,n,t,o),s=[...j.ConstructBaseTabs(e,n,t,o)];return s.push({header:b.help,content:new S([D.t.general.aboutMapcomplete.Subs({osmcha_link:I.OsmChaLinkFor(7)}),"<br/>Version "+F.vNumber,z.generateDocumentationDynamic()]).SetClass("link-underline")}),a.forEach(i=>i.content.SetClass("p-4")),s.forEach(i=>i.content.SetClass("p-4")),new A(new le(s,t),new le(a,t),e.osmConnection.userDetails.map(i=>i.loggedIn&&i.csCount>=F.userJourney.mapCompleteHelpUnlock))}};let $=j;M($,"MoreThemesTabIndex",1);class R extends S{constructor(e,t){super([e]),t!=null&&t.dontStyle||(e.SetClass("mapcontrol p-1"),this.SetClass("p-1")),this.SetClass("relative block rounded-full w-10 h-10 pointer-events-auto z-above-map subtle-background m-0.5 md:m-1"),this.SetStyle("box-shadow: 0 0 10px var(--shadow-color);")}}var dt=function(f,e){var t={};return Object.keys(f).forEach(function(n){t[n]=f[n]}),Object.keys(e).forEach(function(n){t[n]=e[n]}),t},ee={},ut={get exports(){return ee},set exports(f){ee=f}};(function(f){(function(){var e=["Point","LineString","Polygon"],t=["MultiPoint","MultiLineString","MultiPolygon"];function n(s){return t.indexOf(s.type)>-1?s.coordinates.map(function(i){var l={};return l.type=s.type.replace("Multi",""),l.coordinates=i,s.crs&&(l.crs=s.crs),l}):!1}function o(s){var i=s.every(function(r){return e.indexOf(r.type)>-1}),l=s[0].crs||0,c=s.every(function(r){var u=r.crs||0;return u==l});if(i&&c){var d={};return d.type="Multi"+s[0].type,d.coordinates=[],l!=0&&(d.crs=l),s.forEach(function(r){d.coordinates.push(r.coordinates)}),d}else return!1}var a={explode:n,implode:o};f.exports?f.exports=a:window&&(window.multigeojson=a)})()})(ut);var oe=ee;function Z(f,e,t,n){var o=f.map(function(s){return[(s[0]-t.x)/e,(t.y-s[1])/e]}),a=o.map(function(s){return n?s[0].toFixed(n)+","+s[1].toFixed(n):s[0]+","+s[1]});return a.join(" ")}function xe(f,e,t,n){var o=n&&n.r?n.r:1,a=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1,s=Z([f.coordinates],e,t,n.precision);return a?[s]:["M"+s+" m"+-o+",0 a"+o+","+o+" 0 1,1 "+2*o+","+0+" a"+o+","+o+" 0 1,1 "+-2*o+","+0]}function ft(f,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,a=oe.explode(f).map(function(s){return xe(s,e,t,n)[0]});return o?a:[a.join(" ")]}function be(f,e,t,n){var o=Z(f.coordinates,e,t,n.precision),a="M"+o;return[a]}function pt(f,e,t,n){var o=n&&n.hasOwnProperty("explode")?n.explode:!1,a=oe.explode(f).map(function(s){return be(s,e,t,n)[0]});return o?a:[a.join(" ")]}function ke(f,e,t,n){var o,a;o=Z(f.coordinates[0],e,t,n.precision),f.coordinates.length>1&&(a=f.coordinates.slice(1,f.coordinates.length));var s="M"+o;if(a)for(var i=0;i<a.length;i++)s+=" M"+Z(a[i],e,t,n.precision);return s+="Z",[s]}function mt(f,e,t,n){var o=n.hasOwnProperty("explode")?n.explode:!1,a=oe.explode(f).map(function(s){return ke(s,e,t,n)[0]});return o?a:[a.join(" ").replace(/Z/g,"")+"Z"]}var ht={Point:xe,MultiPoint:ft,LineString:be,MultiLineString:pt,Polygon:ke,MultiPolygon:mt},ae=dt,te=ht,W=function(f){this.options=f||{},this.viewportSize=this.options.viewportSize||{width:256,height:256},this.mapExtent=this.options.mapExtent||{left:-20037508342789244e-9,right:20037508342789244e-9,bottom:-20037508342789244e-9,top:20037508342789244e-9},this.res=this.calResolution(this.mapExtent,this.viewportSize,this.options.fitTo)};W.prototype.calResolution=function(f,e,t){var n=(f.right-f.left)/e.width,o=(f.top-f.bottom)/e.height;if(t){if(t.toLowerCase()==="width")return n;if(t.toLowerCase()==="height")return o;throw new Error('"fitTo" option should be "width" or "height" ')}else return Math.max(n,o)};W.prototype.convert=function(f,e){var t=ae(this.options,e||{}),n=[];if(f.type=="FeatureCollection")for(var o=0;o<f.features.length;o++)n=n.concat(this.convertFeature(f.features[o],t));else if(f.type=="Feature")n=this.convertFeature(f,t);else if(f.type=="GeometryCollection")for(var o=0;o<f.geometries.length;o++)n=n.concat(this.convertGeometry(f.geometries[o],t));else if(te[f.type])n=this.convertGeometry(f,t);else return;return t.callback&&t.callback.call(this,n),n};W.prototype.convertFeature=function(f,e){if(!(!f&&!f.geometry)){var t=ae(this.options,e||{});if(t.attributes&&t.attributes instanceof Array){var n=t.attributes;t.attributes=n.reduce(function(a,s){if(typeof s=="string"){var i,l=s.split(".").pop();try{i=de(f,s)}catch{i=!1}i&&(a[l]=i)}else if(typeof s=="object"&&s.type&&s.property)if(s.type==="dynamic"){var i,l=s.key?s.key:s.property.split(".").pop();try{i=de(f,s.property)}catch{i=!1}i&&(a[l]=i)}else s.type==="static"&&s.value&&(a[s.property]=s.value);return a},{})}else t.attributes=t.attributes||{};var o=t.attributes.id||f.id||(f.properties&&f.properties.id?f.properties.id:null);return o&&(t.attributes.id=o),this.convertGeometry(f.geometry,t)}};W.prototype.convertGeometry=function(f,e){if(te[f.type]){var t=ae(this.options,e||{}),n=t.output||"svg",o=te[f.type].call(this,f,this.res,{x:this.mapExtent.left,y:this.mapExtent.top},t),a,s;return n.toLowerCase()=="svg"?(a=o.map(function(i){return wt(i,f.type,t.attributes,t)}),s=a.map(function(i){return gt(i,f.type,t)}),s):o}else return};function wt(f,e,t,n){var o={},a=n&&n.hasOwnProperty("pointAsCircle")?n.pointAsCircle:!1;(e=="Point"||e=="MultiPoint")&&a?(o.cx=f.split(",")[0],o.cy=f.split(",")[1],o.r=n&&n.r?n.r:"1"):(o={d:f},(e=="Polygon"||e=="MultiPolygon")&&o["fill-rule"]=="evenodd");for(var s in t)o[s]=t[s];return o}function gt(f,e,t){var n=t&&t.hasOwnProperty("pointAsCircle")?t.pointAsCircle:!1,o="<path";(e=="Point"||e=="MultiPoint")&&n&&(o="<circle");for(var a in f)o+=" "+a+'="'+f[a]+'"';return o+="/>",o}function de(f,e){function t(n,o,a,s){if(n.hasOwnProperty(o))return n[o];throw new Error(s.slice(0,a+1).join(".")+" is not a valid property path")}return e.split(".").reduce(t,f)}var vt=W,yt=vt,St=function(f){return new yt(f)},Ct=St;class U extends A{constructor(e){const t=D.t.general.download,n=e.layoutToUse.id,o=new Je([t.includeMetaData]),a=o.GetValue().map(d=>d.length>0),s=new O(b.floppy_ui(),new S([t.downloadGeojson.SetClass("font-bold"),t.downloadGeoJsonHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const d=U.getCleanGeoJson(e,a.data);I.offerContentsAsDownloadableFile(JSON.stringify(d,null,"  "),`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.geojson`,{mimetype:"application/vnd.geo+json"})}),i=new O(b.floppy_ui(),new S([t.downloadCSV.SetClass("font-bold"),t.downloadCSVHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const d=U.getCleanGeoJson(e,a.data),r=Se.toCSV(d.features);I.offerContentsAsDownloadableFile(r,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.csv`,{mimetype:"text/csv"})}),l=new O(b.floppy_ui(),new S([t.downloadAsSvg.SetClass("font-bold"),t.downloadAsSvgHelper]).SetClass("flex flex-col")).OnClickWithLoading(t.exporting,async()=>{const d=U.getCleanGeoJsonPerLayer(e,a.data),r=document.getElementById("leafletDiv"),u=U.asSvg(d,{layers:e.filteredLayers.data.map(m=>m.layerDef),mapExtent:e.currentBounds.data,width:r.offsetWidth,height:r.offsetHeight});I.offerContentsAsDownloadableFile(u,`MapComplete_${n}_export_${new Date().toISOString().substr(0,19)}.svg`,{mimetype:"image/svg+xml"})}),c=new S([new E(t.title),s,i,l,o,t.licenseInfo.SetClass("link-underline")]).SetClass("w-full flex flex-col border-4 border-gray-300 rounded-3xl p-4");super(c,t.noDataLoaded,e.featurePipeline.somethingLoaded)}static asSvg(e,t){var c,d,r;t=t??{};const n=t.width??1e3,o=t.height??1e3,a=t.unit??"px",s={left:-180,bottom:-90,right:180,top:90};if(t.mapExtent!==void 0){const u=t.mapExtent;s.left=u.minLon,s.right=u.maxLon,s.bottom=u.minLat,s.top=u.maxLat}const i=[];for(const u of Array.from(e.keys())){const m=e.get(u);if(m.length===0)continue;const y=(c=t==null?void 0:t.layers)==null?void 0:c.find(x=>x.id===u),C=y==null?void 0:y.lineRendering[0],L=Ct({viewportSize:{width:n,height:o},mapExtent:s,output:"svg",attributes:[{property:"style",type:"static",value:"fill:none;stroke-width:1"},{property:"properties.stroke",type:"dynamic",key:"stroke"}]});for(const x of m){const w=((r=(d=C==null?void 0:C.color)==null?void 0:d.GetRenderValue(x.properties))==null?void 0:r.txt)??"#ff0000",v=I.colorAsHex(I.color(w));x.properties.stroke=v}const k=L.convert({type:"FeatureCollection",features:m}),T=`    <g id="${u}" inkscape:groupmode="layer" inkscape:label="${u}">
`+k.map(x=>"        "+x).join(`
`)+`
    </g>`;i.push(T)}return`<svg width="${n}${a}" height="${o}${a}" viewBox="0 0 ${n} ${o}">`+`
`+i.join(`
`)+`
</svg>`}static getCleanGeoJson(e,t){const n=U.getCleanGeoJsonPerLayer(e,t);return{type:"FeatureCollection",features:[].concat(...Array.from(n.values()))}}static getCleanGeoJsonPerLayer(e,t){const n=new Map,o=e.filteredLayers.data.map(i=>i.layerDef.id),a=e.currentBounds.data,s=e.featurePipeline.GetAllFeaturesAndMetaWithin(a,new Set(o));e:for(const i of s){if(F.priviliged_layers.indexOf(i.layer)>=0)continue;const l=e.filteredLayers.data.find(r=>r.layerDef.id===i.layer);n.has(i.layer)||n.set(i.layer,[]);const c=n.get(i.layer),d=l.appliedFilters.data;for(const r of i.features){if(!a.overlapsWith(K.get(r)))continue;if(d!==void 0)for(let y of Array.from(d.keys())){const C=d.get(y);if((C==null?void 0:C.currentFilter)!==void 0&&!C.currentFilter.matchesProperties(r.properties))continue e}const u={type:r.type,geometry:{...r.geometry},properties:{...r.properties}};if(!t)for(const y in u.properties)y==="_lon"||y==="_lat"||y.startsWith("_")&&delete r.properties[y];const m=[].concat(et.metatags.filter(y=>y.includesDates).map(y=>y.keys));for(const y of m)delete r.properties[y];c.push(r)}}return n}}class xt{constructor(e){M(this,"isRunning",new _(!0));M(this,"mapW",297);M(this,"mapH",210);M(this,"scaling",2);M(this,"freeDivId");M(this,"_layout");M(this,"_screenhotTaken",!1);this.freeDivId=e.freeDivId,this._layout=e.layout;const t=this,n=e.location.data,o={lat:n.lat,lon:n.lon,zoom:n.zoom+1},a=Ne.createMiniMap({location:new _(o),background:e.background,allowMoving:!1,onFullyLoaded:s=>window.setTimeout(()=>{if(!t._screenhotTaken)try{t.CreatePdf(a).then(()=>t.cleanup()).catch(()=>t.cleanup())}catch(i){console.error(i),t.cleanup()}},500)});a.SetStyle(`width: ${this.mapW*this.scaling}mm; height: ${this.mapH*this.scaling}mm;`),a.AttachTo(e.freeDivId),a.leafletMap.addCallbackAndRunD(s=>{const i=K.fromLeafletBounds(s.getBounds().pad(.2));e.features.GetTilesPerLayerWithin(i,l=>{l.layer.layerDef.minzoom>n.zoom||l.layer.layerDef.id.startsWith("note_import")||new J({features:l,leafletMap:a.leafletMap,layerToShow:l.layer.layerDef,doShowLayer:l.layer.isDisplayed,state:void 0})})}),q.state.AddAllOverlaysToMap(a.leafletMap)}cleanup(){new P("Screenshot taken!").AttachTo(this.freeDivId),this._screenhotTaken=!0}async CreatePdf(e){console.log("PDF creation started");const t=D.t.general.pdf,n=this._layout;let o=new $e("landscape");const a=await e.TakeScreenshot();o.addImage(a,"PNG",0,0,this.mapW,this.mapH),o.setDrawColor(255,255,255),o.setFillColor(255,255,255),o.roundedRect(12,10,145,25,5,5,"FD"),o.setFontSize(20),o.textWithLink(n.title.txt,40,18.5,{maxWidth:125,url:window.location.href}),o.setFontSize(10),o.text(t.generatedWith.txt,40,23,{maxWidth:125});const s=q.state.backgroundLayer.data,i=new P(s.layer().getAttribution()??s.name).ConstructElement().textContent;o.textWithLink(t.attr.txt,40,26.5,{maxWidth:125,url:"https://www.openstreetmap.org/copyright"}),o.text(t.attrBackground.Subs({background:i}).txt,40,30);let l=new Date().toISOString().substr(0,16);o.setFontSize(7),o.text(t.versionInfo.Subs({version:F.vNumber,date:l}).txt,40,34,{maxWidth:125});let c=document.createElement("img");const d=n.icon,r=d.substring(d.lastIndexOf(".")+1);if(c.src=d,r.toLowerCase()==="svg"){new P("").AttachTo(this.freeDivId);const u=document.createElement("canvas"),m=u.getContext("2d");u.width=500,u.height=500,c.style.width="100%",c.style.height="100%",m.drawImage(c,0,0,500,500);const y=u.toDataURL("image/png");o.addImage(y,"png",15,12,20,20)}else try{o.addImage(c,r,15,12,20,20)}catch(u){console.error(u)}o.save(`MapComplete_${n.title.txt}_${l}.pdf`),this.isRunning.setData(!1)}}class Q extends B{constructor(e,t){super(Q.GenTitle,()=>Q.GeneratePanel(t),"downloads",e)}static GenTitle(){return D.t.general.download.title.Clone().SetClass("text-2xl break-words font-bold p-2")}static GeneratePanel(e){const t=new _(!1,"Pdf-is-exporting"),n=()=>{t.setData(!0),new xt({freeDivId:"belowmap",background:e.backgroundLayer,location:e.locationControl,features:e.featurePipeline,layout:e.layoutToUse}).isRunning.addCallbackAndRun(d=>t.setData(d))},o=b.loading_svg().SetClass("animate-rotate"),a=D.t.general.download,s=new A(o,b.floppy_ui(),t),i=new A(a.exporting.Clone(),new S([a.downloadAsPdf.Clone().SetClass("font-bold"),a.downloadAsPdfHelper.Clone()]).SetClass("flex flex-col").onClick(()=>{n()}),t),l=new A(new O(s,i),void 0,e.featureSwitchExportAsPdf),c=new A(new U(e),void 0,e.featureSwitchEnableExport);return new S([l,c]).SetClass("flex flex-col")}}class bt extends S{constructor(e,t){var r,u;const n=(r=e.currentView)==null?void 0:r.layer,o=new A(new V(()=>{const m=e.currentView.features.map(C=>{var L;return(L=C[0])==null?void 0:L.feature}),y=new G(m.map(C=>{var x;const L=b.checkbox_empty_svg();if(C===void 0)return L;const k={...C.properties,button:"yes"},T=(x=n.layerDef.mapRendering[0])==null?void 0:x.GetSimpleIcon(new _(k));return T===void 0?L:T})).SetClass("inline-block w-full h-full");return m.map(C=>{if(C===void 0)return;const L=e.allElements.getEventSourceById(C.properties.id);return new X(L,n.layerDef,e,{hashToShow:"currentview",isShown:t.currentViewControlIsOpened})}),new R(y)}).onClick(()=>{t.currentViewControlIsOpened.setData(!0)}),void 0,new _(n!==void 0&&((u=n==null?void 0:n.layerDef)==null?void 0:u.tagRenderings)!==null));new Q(t.downloadControlIsOpened,e);const a=new R(b.download_svg()).onClick(()=>t.downloadControlIsOpened.setData(!0)),s=new A(a,void 0,e.featureSwitchEnableExport.map(m=>m||e.featureSwitchExportAsPdf.data,[e.featureSwitchExportAsPdf]));new B(()=>D.t.general.layerSelection.title.Clone(),()=>new we(e.filteredLayers,e.overlayToggles,e).SetClass("block p-1"),"filters",t.filterViewIsOpened);const i=new R(b.layers_svg()).onClick(()=>t.filterViewIsOpened.setData(!0));e.featureSwitchFilter.addCallbackAndRun(m=>{z.RegisterHotkey({nomod:"B"},D.t.hotkeyDocumentation.openLayersPanel,()=>{t.filterViewIsOpened.setData(!t.filterViewIsOpened.data)})});const l=new A(i,void 0,e.featureSwitchFilter),c=new A(new Ve(e,e.backgroundLayer,{enableHotkeys:!0}),void 0,e.featureSwitchBackgroundSelection),d=new A(void 0,new V(()=>(new B(()=>D.t.general.attribution.attributionTitle,()=>new ge(e),"copyright",t.copyrightViewIsOpened),new R(b.copyright_svg()).onClick(()=>t.copyrightViewIsOpened.setData(!0)))),e.featureSwitchWelcomeMessage);super([o,l,s,d,c]),this.SetClass("flex flex-col")}}class se extends G{constructor(t,n){const o=(n==null?void 0:n.value)??new _("0");super(t.map(a=>{const s=Object.keys(a);return s.sort((i,l)=>{const c=Number(i),d=Number(l);return isNaN(c)||isNaN(d)?i<l?-1:1:c-d}),se.constructPicker(s,o)}));M(this,"_value");this._value=o}static constructPicker(t,n){let o=new Ze(0,t.length-1,{vertical:!0});const a="flex border-2 border-blue-500 w-10 h-10 place-content-center items-center border-box";o.SetClass("flex elevator w-10").SetStyle(`height: ${2.5*t.length}rem; background: #00000000`);const s=t.map((l,c)=>new Ue(new P(l).SetClass("font-bold active bg-subtle "+a),new P(l).SetClass("normal-background "+a),o.GetValue().sync(d=>d===c,[],d=>d?c:o.GetValue().data)).ToggleOnClick().SetClass("flex w-10 h-10"));s.reverse();const i=new S([new S(s),o]);return i.SetClass("flex flex-row overflow-hidden"),o.GetValue().addCallbackD(l=>{t!==void 0&&t[l]!=null&&n.setData(t[l])}),n.addCallbackAndRunD(l=>{const c=t.findIndex(d=>d===l);o.GetValue().setData(c)}),i}GetValue(){return this._value}IsValid(t){return!1}}class kt extends S{constructor(e){const t=e.currentBounds.map(s=>{if(s===void 0)return{};const c=[].concat(...e.featurePipeline.GetAllFeaturesAndMetaWithin(s).map(r=>r.features)).filter(r=>K.get(r).overlapsWith(s)).map(r=>r.properties.level),d={0:0};for(const r of c){r===void 0&&d[0]++;for(const u of Ce.LevelsParser(r))d[u]=(d[u]??0)+1}return d}),n=new se(t);e.globalFilters.data.push({filter:{currentFilter:void 0,state:void 0},id:"level",onNewPoint:void 0});const o=t.map(s=>!(e.locationControl.data.zoom<=16||Object.keys(s).length==1),[e.locationControl]);function a(){console.log("Updating levels filter to ",n.GetValue().data," is shown:",o.data);const s=e.globalFilters.data.find(d=>d.id==="level");if(!o.data){s.filter={state:"*",currentFilter:void 0},s.onNewPoint=void 0,e.globalFilters.ping();return}const i=n.GetValue().data;if(i===void 0)return;let l=new tt("level",new RegExp("(^|;)"+i+"(;|$)"));i==="0"&&(l=new nt([l,new ce("level","")])),s.filter={state:i,currentFilter:l};const c=D.t.general.levelSelection;s.onNewPoint={confirmAddNew:c.confirmLevel.PartialSubs({level:i}),safetyCheck:c.addNewOnLevel.Subs({level:i}),tags:[new ce("level",i)]},e.globalFilters.ping()}o.addCallbackAndRun(s=>{console.log("Is level selector shown?",s),a(),s?n.RemoveClass("invisible"):n.SetClass("invisible")}),t.addCallbackAndRun(s=>{if(!o.data)return;const i=n.GetValue();if(!(s[i.data]===void 0||s[i.data]===0))return;let l=0,c;for(const d in s){const r=s[d];(c===void 0||l<r)&&(c=d,l=r)}console.log("Force switching to a different level:",c,"as it has",l,"elements on that floor",s,"(old level: "+i.data+")"),i.setData(c)}),n.GetValue().addCallback(s=>a()),super([n])}}class Dt extends G{constructor(e,t){const n=new _(void 0),o=n.map(i=>i===void 0?!1:(new Date().getTime()-i.getTime())/1e3<=3),a=e.geolocationState;super(a.permission.map(i=>i==="denied"?b.location_refused_svg():a.isLocked.data?b.location_locked_svg():a.currentGPSLocation.data===void 0?i==="prompt"?b.location_empty_svg():(e.mapHasMoved.data?b.location_empty_svg():b.location_svg()).SetClass("cursor-wait").SetStyle("animation: spin 4s linear infinite;"):o.data?b.location_unlocked_svg():b.location_svg(),[a.currentGPSLocation,a.isLocked,e.mapHasMoved,o]));async function s(){if(a.permission.data!=="granted"&&a.currentGPSLocation.data===void 0&&await a.requestPermission(),a.isLocked.data===!0){a.isLocked.setData(!1);return}if(a.currentGPSLocation.data===void 0)return;const i=a.currentGPSLocation.data,l=t.currentBounds.data.contains([i.longitude,i.latitude]);if(e.MoveMapToCurrentLocation(),l){const c=t.locationControl.data;t.locationControl.setData({...c,zoom:c.zoom+3})}if(o.data){a.isLocked.setData(!0),n.setData(void 0);return}n.setData(new Date)}this.onClick(s),z.RegisterHotkey({nomod:"L"},D.t.hotkeyDocumentation.geolocate,s),n.addCallbackAndRunD(i=>{window.setTimeout(()=>{o.data&&n.ping()},500)})}}class Lt extends S{constructor(e,t){const n=new A(new R(new Dt(t,e),{dontStyle:!0}).SetClass("p-1"),void 0,e.featureSwitchGeolocation),o=new R(b.plus_svg()).onClick(()=>{e.locationControl.data.zoom++,e.locationControl.ping()}),a=new R(b.min_svg()).onClick(()=>{e.locationControl.data.zoom--,e.locationControl.ping()}),s=new kt(e);super([s,o,a,n].map(i=>i.SetClass("m-0.5 md:m-1"))),this.SetClass("flex flex-col items-center")}}class Tt extends G{constructor(e){const t=e.featurePipeline,n=D.t.centerMessage,o=t.runningQuery.map(a=>a?{el:new Be(n.loadingData)}:t.sufficientlyZoomed.data?t.timeout.data>0?{el:n.retrying.Subs({count:""+t.timeout.data})}:{el:n.ready,isDone:!0}:{el:n.zoomIn},[t.timeout,t.sufficientlyZoomed,e.locationControl]);super(o.map(a=>a.el)),this.SetClass("flex justify-center rounded-3xl bg-white text-xl font-bold pointer-events-none p-4"),this.SetStyle("transition: opacity 750ms linear"),o.addCallbackAndRun(a=>{a.isDone??!1?this.SetStyle("transition: opacity 750ms linear; opacity: 0"):this.SetStyle("transition: opacity 750ms linear; opacity: 0.75")})}}const De="home_location",Le="Meta layer showing the home location of the user. The home location can be set in the [profile settings](https://www.openstreetmap.org/profile/edit) of OpenStreetMap.",Te=0,Me={osmTags:"user:home=yes",maxCacheAge:0},_e=[{icon:{render:"circle:white;./assets/svg/home.svg"},iconSize:{render:"20,20,center"},location:["point","centroid"]}],Mt={id:De,description:Le,minzoom:Te,source:Me,mapRendering:_e},Ae=Object.freeze(Object.defineProperty({__proto__:null,default:Mt,description:Le,id:De,mapRendering:_e,minzoom:Te,source:Me},Symbol.toStringTag,{value:"Module"}));class _t extends A{constructor(e,t,n){var d;const o=D.t.notes,a=new _(!1);n.LastClickLocation.addCallbackAndRun(r=>a.setData(!1));const s=je.ForType("text").ConstructInputElement({value:pe.Get("note-text")});s.SetClass("border rounded-sm border-grey-500");const i=new O(b.addSmall_svg().SetClass("max-h-7"),o.createNote);i.onClick(async()=>{var C,L,k,T,x,w,v,p,g,h;let r=s.GetValue().data;if(r===void 0||r==="")return;r+=`

 #MapComplete #`+((C=n==null?void 0:n.layoutToUse)==null?void 0:C.id);const u=n.LastClickLocation.data,m=await((L=n==null?void 0:n.osmConnection)==null?void 0:L.openNote(u.lat,u.lon,r)),y={type:"Feature",geometry:{type:"Point",coordinates:[u.lon,u.lat]},properties:{id:""+m.id,date_created:new Date().toISOString(),_first_comment:r,comments:JSON.stringify([{text:r,html:r,user:(x=(T=(k=n.osmConnection)==null?void 0:k.userDetails)==null?void 0:T.data)==null?void 0:x.name,uid:(p=(v=(w=n.osmConnection)==null?void 0:w.userDetails)==null?void 0:v.data)==null?void 0:p.uid}])}};(g=n==null?void 0:n.featurePipeline)==null||g.InjectNewPoint(y),(h=n.selectedElement)==null||h.setData(y),s.GetValue().setData(""),a.setData(!0)});const l=new S([new E(o.createNoteTitle),o.createNoteIntro,s,new S([new A(void 0,o.warnAnonymous.SetClass("alert"),(d=n==null?void 0:n.osmConnection)==null?void 0:d.isLoggedIn),new A(i,o.textNeeded.SetClass("alert"),s.GetValue().map(r=>(r==null?void 0:r.length)>3))]).SetClass("flex justify-end items-center")]).SetClass("flex flex-col border-2 border-black rounded-xl p-4"),c=new A(new A(o.isCreated.SetClass("thanks"),l,a),void 0,new _(!0));super(new A(new S([o.noteLayerHasFilters.SetClass("alert"),new O(b.filter_svg(),o.disableAllNoteFilters).onClick(()=>{const r=e.appliedFilters.data;for(const u of Array.from(r.keys()))r.set(u,void 0);e.appliedFilters.ping(),t.setData(!1)})]).SetClass("flex flex-col"),c,e.appliedFilters.map(r=>(console.log("Applied filters for notes are: ",r),Array.from(r.values()).some(u=>(u==null?void 0:u.currentFilter)!==void 0)))),new S([o.noteLayerNotEnabled.SetClass("alert"),new O(b.layers_svg(),o.noteLayerDoEnable).onClick(()=>{e.isDisplayed.setData(!0),t.setData(!1)})]).SetClass("flex flex-col"),e.isDisplayed)}}class At extends S{constructor(e){const t=new G(e.map(o=>{const a=[];let s;for(const l of o){const c=l.layerDef;if(!(c.name===void 0&&!l.isDisplayed.data))for(const d of l.layerDef.presets){const r=Ce.KVtoProperties(d.tags),u=c.mapRendering[0].GenerateLeafletStyle(new _(r),!1).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;");a.push(u),s===void 0&&(s=c.mapRendering[0].GenerateLeafletStyle(new _(r),!1).html.SetClass("block relative").SetStyle("width: 42px; height: 42px;"))}}if(a.length===0)return;if(a.length===1)return a[0];a.push(s);const i=new S(a).SetClass("flex");return i.SetClass("slide min-w-min").SetStyle("animation: slide "+a.length+"s linear infinite;"),i})),n=D.t.general.add.addNewMapLabel.Clone().SetClass("block center absolute text-sm min-w-min pl-1 pr-1 bg-gray-400 rounded-3xl text-white opacity-65 whitespace-nowrap").SetStyle("top: 65px; transform: translateX(-50%)");super([new S([b.add_pin_svg().SetClass("absolute").SetStyle("width: 50px; filter: drop-shadow(grey 0 0 10px"),new S([t]).SetStyle("width: 50px").SetClass("absolute p-1 rounded-full overflow-hidden"),b.addSmall_svg().SetClass("absolute animate-pulse").SetStyle("width: 30px; left: 30px; top: 35px;")]).SetClass("absolute"),new S([n]).SetStyle("position: absolute; left: 50%")]),this.SetClass("block relative")}}class ue extends Fe{constructor(t,n){super();M(this,"_config");M(this,"state");this.state=t,this._config=n}InnerRender(){var d,r,u,m,y;if(this._config===void 0)return;const t=this._config,n=window!==window.top;if((d=t.requirements)!=null&&d.has("iframe")&&!n||(r=t.requirements)!=null&&r.has("no-iframe")&&n)return;let o;const a=((u=this.state.layoutToUse)==null?void 0:u.id)??"",s=window.location.host,i=this.state.locationControl.map(C=>{const L={...C,theme:a,basepath:s,language:Re.language.data};return I.SubstituteKeys(t.href,L)});let l=b.pop_out_ui();t.icon!==void 0&&(l=new ne(t.icon).SetClass("h-6"));let c;return t.text===void 0?c=D.t.general.screenToSmall.Subs({theme:this.state.layoutToUse.title}):c=t.text.Clone(),o=new O(l,c,{url:i,newTab:t.newTab}),(m=t.requirements)!=null&&m.has("no-welcome-message")&&(o=new A(void 0,o,this.state.featureSwitchWelcomeMessage)),(y=t.requirements)!=null&&y.has("welcome-message")&&(o=new A(o,void 0,this.state.featureSwitchWelcomeMessage)),o}}class It{constructor(e,t){M(this,"geolocationState");M(this,"_state");M(this,"mapHasMoved",new _(!1));this.geolocationState=e,this._state=t;const n=t.locationControl;let o=this,a=new Date;n.addCallbackD(i=>{if(!(new Date().getTime()-a.getTime()<250))return o.mapHasMoved.setData(!0),!0}),(ie.wasInitialized("lat")||ie.wasInitialized("lon"))&&this.mapHasMoved.setData(!0),this.geolocationState.currentGPSLocation.addCallbackAndRunD(i=>{var c;const l=(new Date().getTime()-((c=e.requestMoment.data)==null?void 0:c.getTime()))/1e3;if(this.mapHasMoved.data||(console.log("Moving the map to an initial location; time since last request is",l),l<F.zoomToLocationTimeout&&o.MoveMapToCurrentLocation()),this.geolocationState.isLocked.data){o.MoveMapToCurrentLocation();return}}),e.isLocked.map(i=>{var l,c,d,r,u,m;i?(d=(c=(l=t.leafletMap)==null?void 0:l.data)==null?void 0:c.dragging)==null||d.disable():(m=(u=(r=t.leafletMap)==null?void 0:r.data)==null?void 0:u.dragging)==null||m.enable()},[t.leafletMap]),this.CopyGeolocationIntoMapstate()}MoveMapToCurrentLocation(){const e=this.geolocationState.currentGPSLocation.data,t=this._state.locationControl,n=this._state;if(n.selectedElement.data!==void 0)return;if(e.latitude===0&&e.longitude===0){console.debug("Not moving to GPS-location: it is null island");return}const o=n.layoutToUse.lockLocation;o&&o!==!0&&!new K(o).contains([e.longitude,e.latitude])||(t.setData({zoom:t.data.zoom,lon:e.longitude,lat:e.latitude}),this.mapHasMoved.setData(!0))}CopyGeolocationIntoMapstate(){const e=this._state;this.geolocationState.currentGPSLocation.addCallbackAndRun(t=>{var o,a;if(t===void 0)return;const n={type:"Feature",properties:{id:"gps","user:location":"yes",date:new Date().toISOString(),...t},geometry:{type:"Point",coordinates:[t.longitude,t.latitude]}};(a=(o=e.currentUserLocation)==null?void 0:o.features)==null||a.setData([{feature:n,freshness:new Date}])})}}class Gt{constructor(){M(this,"permission",new _("prompt"));M(this,"requestMoment",new _(void 0));M(this,"isLocked",new _(!1));M(this,"currentGPSLocation",new _(void 0));M(this,"_previousLocationGrant",pe.Get("geolocation-permissions"));M(this,"_grantedThisSession",new _(!1));const e=this;this.permission.addCallbackAndRunD(async t=>{t==="granted"&&(e._previousLocationGrant.setData("true"),e._grantedThisSession.setData(!0)),t==="prompt"&&e._grantedThisSession.data&&(e._previousLocationGrant.setData("false"),e.permission.setData("denied"),e.currentGPSLocation.setData(void 0),console.warn("Detected a downgrade in permissions!")),t==="denied"&&e._previousLocationGrant.setData("false")}),console.log("Previous location grant:",this._previousLocationGrant.data),this._previousLocationGrant.data==="true"&&(this._previousLocationGrant.setData("false"),console.log("Requesting access to GPS as this was previously granted"),this.requestPermission()),window.geolocation_state=this}async startWatching(){const e=this;navigator.geolocation.watchPosition(function(t){e.currentGPSLocation.setData(t.coords),e._previousLocationGrant.setData("true")},function(){console.warn("Could not get location with navigator.geolocation")},{enableHighAccuracy:!0})}requestPermission(){var e;if(typeof navigator>"u"){this.permission.setData("denied");return}if(!(this.permission.data!=="prompt"&&this.permission.data!=="requested")){this.requestMoment.setData(new Date),this.permission.setData("requested");try{(e=navigator==null?void 0:navigator.permissions)==null||e.query({name:"geolocation"}).then(t=>{console.log("Status update: received geolocation permission is ",t.state),this.permission.setData(t.state);const n=this;t.onchange=function(){n.permission.setData(t.state)},this.permission.setData("requested"),n.startWatching()}).catch(t=>console.error("Could not get geopermission",t))}catch(t){console.error("Could not get permission:",t)}}}}class Ht{constructor(e,t){M(this,"guiState");M(this,"state");M(this,"geolocationHandler");this.state=e,this.guiState=t,this.state.featureSwitchGeolocation.data&&(this.geolocationHandler=new It(new Gt,e))}setup(){this.SetupUIElements(),this.SetupMap(),B.ActivateCurrent(),this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&I.LoadCustomCss(this.state.layoutToUse.customCss),z.RegisterHotkey({shift:"O"},D.t.hotkeyDocumentation.selectMapnik,()=>{this.state.backgroundLayer.setData(ze.osmCarto)}),I.downloadJson("./service-worker-version").then(e=>console.log("Service worker",e)).catch(e=>console.log("Service worker not active"))}setupClickDialogOnMap(e,t){const n=t.layoutToUse.layers.some(i=>i.presets.length>0),o=t.filteredLayers.data.filter(i=>i.layerDef.id==="note")[0];let a;o!==void 0&&(a=i=>new _t(o,i,t));function s(){if(!n&&a===void 0)return;const i=new _(!1),l=new B(()=>n?D.t.general.add.title:D.t.notes.createNoteTitle,({resetScrollSignal:d})=>{let r;n&&(r=new ye(i,d,e,t));let u;return o!==void 0&&(u=a(i)),new S([r,u]).SetClass("flex flex-col font-lg text-lg")},"new",i);l.isShown.addCallback(d=>{d||t.LastClickLocation.setData(void 0)});let c;!n&&a!==void 0&&(c=new S([b.note_svg().SetClass("absolute bottom-0").SetStyle("height: 40px"),b.addSmall_svg().SetClass("absolute w-6 animate-pulse").SetStyle("right: 10px; bottom: -8px;")]).SetClass("block relative h-full").SetStyle("left: calc( 50% - 15px )")),Qe.construct(t,l,n?new At(t.filteredLayers):c),t.LastClickLocation.addCallbackAndRunD(d=>{B.collapse()})}o!==void 0?s():t.featureSwitchAddNew.addCallbackAndRunD(i=>{if(i)return s(),!0})}SetupMap(){if(I.runningFromConsole)return;const e=this.state,t=this.guiState;e.mainMapObject.SetClass("w-full h-full").AttachTo("leafletDiv"),this.setupClickDialogOnMap(t.filterViewIsOpened,e),new J({leafletMap:e.leafletMap,layerToShow:new ve(Ae,"home_location",!0),features:e.homeLocation,state:e});const n=e.filteredLayers.data.filter(o=>o.layerDef.id==="selected_element")[0];new J({leafletMap:e.leafletMap,layerToShow:n.layerDef,features:e.selectedElementsLayer,state:e}),e.leafletMap.addCallbackAndRunD(o=>(e.selectedElement.ping(),q.state.locationControl.ping(),!0))}SetupUIElements(){var l,c;const e=this.state,t=this.guiState,n=this,o=A.If(e.featureSwitchUserbadge,()=>{new qe(e,{isOpened:t.userInfoIsOpened,userInfoFocusedQuestion:t.userInfoFocusedQuestion});const d=new R(new G(e.osmConnection.userDetails.map(r=>(r==null?void 0:r.img)===void 0?b.person_ui().SetClass("mt-1 block"):new ne(r==null?void 0:r.img))).SetClass("block rounded-full overflow-hidden"),{dontStyle:!0}).onClick(()=>{n.guiState.userInfoIsOpened.setData(!0)});return new he(d,D.t.general.loginWithOpenStreetMap,e)}),a=A.If(e.featureSwitchExtraLinkEnabled,()=>new ue(e,e.layoutToUse.extraLink)),s=A.If(e.featureSwitchWelcomeMessage,()=>n.InitWelcomeMessage()),i=A.If(e.featureSwitchIsTesting,()=>new P("TESTING").SetClass("alert m-2 border-2 border-black"));new S([s,o,a,i]).SetClass("flex flex-col").AttachTo("top-left"),new S([new ue(e,{...e.layoutToUse.extraLink,newTab:!0,requirements:new Set})]).SetClass("flex items-center justify-center normal-background h-full").AttachTo("on-small-screen"),new S([A.If(e.featureSwitchSearch,()=>{const d=new fe(e).SetClass("shadow rounded-full h-min w-full overflow-hidden sm:max-w-sm pointer-events-auto");return z.RegisterHotkey({ctrl:"F"},D.t.hotkeyDocumentation.selectSearch,()=>{d.focus()}),d})]).AttachTo("top-right"),new bt(e,t).AttachTo("bottom-left"),new Lt(e,this.geolocationHandler).AttachTo("bottom-right"),new Tt(e).AttachTo("centermessage"),(c=(l=document==null?void 0:document.getElementById("centermessage"))==null?void 0:l.classList)==null||c.add("pointer-events-none")}InitWelcomeMessage(){const e=this.guiState.welcomeMessageIsOpened;new $(e,this.guiState.welcomeMessageOpenedTab,this.state,this.guiState);const t=new R(b.help_svg());t.onClick(()=>e.setData(!0));const n=new Date().getTime();return this.state.locationControl.addCallback(()=>{if(!(new Date().getTime()-n<15*1e3))return e.setData(!1),!0}),this.state.selectedElement.addCallbackAndRunD(o=>{e.setData(!1)}),t.SetClass("pointer-events-auto")}}class Ie{static Implement(){Ke.implementation=Ie.AddToMap}static AddToMap(e,t,n=void 0){t.map(o=>{if(o===void 0)return;const a=ot.tileLayer(e.source,{attribution:"",maxZoom:e.maxzoom,minZoom:e.minzoom,wmts:!1});n===void 0&&a.addTo(o),n==null||n.addCallbackAndRunD(s=>{s?a.addTo(o):o.removeLayer(a)})})}}class $t{constructor(e,t){M(this,"state");M(this,"currentView",new _(void 0));M(this,"singleElementCache",{});this.state=e}viewSelector(e,t,n,o){const a=this.currentView,s={title:t,contents:n};return e.SetClass("pl-1 pr-1 rounded-md"),e.onClick(()=>{a.setData(s)}),re.hash.addCallbackAndRunD(i=>{i===o&&a.setData(s)}),a.addCallbackAndRunD(i=>{i==s?(e.SetClass("bg-unsubtle"),re.hash.setData(o)):e.RemoveClass("bg-unsubtle")}),e}singleElementView(e,t,n){if(this.singleElementCache[e.properties.id]!==void 0)return this.singleElementCache[e.properties.id];const o=this.state.allElements.getEventSourceById(e.properties.id),a=new S([new E(new Xe(o,t.title,this.state),4),n<900?Math.floor(n)+"m away":I.Round(n/1e3)+"km away"]).SetClass("flex justify-between");return this.singleElementCache[e.properties.id]=this.viewSelector(a,new V(()=>X.GenerateTitleBar(o,t,this.state)),new V(()=>X.GenerateContent(o,t,this.state)))}mainElementsView(e){const t=this;return e===void 0?new P("Initializing"):e.length==0?new P("No elements in view"):new S(e.map(n=>t.singleElementView(n.element,n.layer,n.distance)))}documentationButtonFor(e){var t,n;return this.viewSelector(D.W(((t=e.name)==null?void 0:t.Clone())??e.id),new S(["Documentation about ",((n=e.name)==null?void 0:n.Clone())??e.id]),e.GenerateDocumentation([]),"documentation-"+e.id)}allDocumentationButtons(){const e=this.state.layoutToUse.layers.filter(t=>F.priviliged_layers.indexOf(t.id)<0).filter(t=>!t.id.startsWith("note_import_"));return e.length===1?this.documentationButtonFor(e[0]):this.viewSelector(new P("Documentation"),"Documentation",new S(e.map(t=>this.documentationButtonFor(t).SetClass("flex flex-col"))))}setup(){const e=this.state;this.state.layoutToUse.customCss!==void 0&&window.location.pathname.indexOf("index")>=0&&I.LoadCustomCss(this.state.layoutToUse.customCss);const t=this.SetupMap();I.downloadJson("./service-worker-version").then(m=>console.log("Service worker",m)).catch(m=>console.log("Service worker not active")),document.getElementById("centermessage").classList.add("hidden");const n={};for(const m of e.layoutToUse.layers)n[m.id]=m;const o=this,a=new _([]);function s(){const m=[o.state.locationControl.data.lon,o.state.locationControl.data.lon],y=o.state.featurePipeline.getAllVisibleElementsWithmeta(o.state.currentBounds.data).map(C=>{const L=Se.distanceBetween(C.center,m);return{...C,distance:L}});y.sort((C,L)=>C.distance-L.distance),a.setData(y)}t.bounds.addCallbackAndRun(s),e.featurePipeline.newDataLoadedSignal.addCallback(s),e.filteredLayers.addCallbackAndRun(m=>{for(const y of m)y.isDisplayed.addCallback(s),y.appliedFilters.addCallback(s)});const i=new V(()=>new we(e.filteredLayers,e.overlayToggles,e)),l=new S([e.layoutToUse.description,e.layoutToUse.descriptionTail]);o.currentView.setData({title:e.layoutToUse.title,contents:l});const c=new _(!1);c.addCallback(m=>o.currentView.setData({title:"filters",contents:i}));const d=new _(!1),r=new ye(new _(!0),new _(void 0),c,e,e.locationControl),u="Add a missing point";this.currentView.addCallbackAndRunD(m=>{d.setData(m.contents===r)}),d.addCallbackAndRun(m=>{m?o.currentView.data.contents!==r&&o.currentView.setData({title:u,contents:r}):o.currentView.data.contents===r&&o.currentView.setData(void 0)}),new S([new S([this.viewSelector(new E(e.layoutToUse.title.Clone(),2),e.layoutToUse.title.Clone(),l,"welcome"),t.SetClass("w-full h-64 shrink-0 rounded-lg"),new fe(e),this.viewSelector(new E(new G(a.map(m=>"There are "+(m==null?void 0:m.length)+" elements in view"))),"Statistics",new Ye(a,this.state),"statistics"),this.viewSelector(new P("Filter"),"Filters",i,"filters"),this.viewSelector(new S(["Add a missing point"]),u,r),new G(a.map(m=>this.mainElementsView(m).SetClass("block m-2"))).SetClass("block shrink-2 overflow-x-auto h-full border-2 border-subtle rounded-lg"),this.allDocumentationButtons(),new me(Object.keys(e.layoutToUse.title.translations)).SetClass("mt-2"),new at]).SetClass("w-1/2 lg:w-1/4 m-4 flex flex-col shrink-0 grow-0"),new G(this.currentView.map(({title:m,contents:y})=>new S([new E(D.W(m),2).SetClass("shrink-0 border-b-4 border-subtle"),D.W(y).SetClass("shrink-2 overflow-y-auto block")]).SetClass("flex flex-col h-full"))).SetClass("w-1/2 lg:w-3/4 m-4 p-2 border-2 border-subtle rounded-xl m-4 ml-0 mr-8 shrink-0 grow-0")]).SetClass("flex h-full").AttachTo("leafletDiv")}SetupMap(){const e=this.state;return new J({leafletMap:e.leafletMap,layerToShow:new ve(Ae,"home_location",!0),features:e.homeLocation,state:e}),e.leafletMap.addCallbackAndRunD(t=>(e.selectedElement.ping(),q.state.locationControl.ping(),!0)),e.mainMapObject}}export{$t as D,Ie as S,Ht as a,Y as l};
