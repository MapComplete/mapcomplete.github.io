var Ee=Object.defineProperty;var Ge=(C,s,t)=>s in C?Ee(C,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):C[s]=t;var h=(C,s,t)=>(Ge(C,typeof s!="symbol"?s+"":s,t),t);import{j as ie,d as Te,b as ae,k as Fe,O as le,l as pe,m as ue,R as je,S as Me,n as We,o as Ve,T as P,p as K,E as ze,q as Ue,r as qe,F as Qe,t as _e}from"./theme_overview-a81098f4.js";import{c as B,B as R,G as D,d as A,A as Le,a as V,C as Z,S as $e}from"./UserRelatedState-ad04653d.js";import{U as _,V as F,T as x,C as y,a as q,S as k,c as re,H as Oe,d as He,f as xe,g as Je}from"./Translations-893ea4c9.js";import{L as Ae,S as M}from"./SubtleButton-39cdd5de.js";import{T}from"./DropDown-3aad007c.js";import{L as me,F as De,c as ke,M as Ze,b as Re,A as Ke}from"./ChartJs-153ab1fc.js";import{T as E,L as Y}from"./List-95529323.js";const z=class{constructor(s,t,e,n,o){h(this,"totalValue",0);h(this,"showCount",0);h(this,"hiddenCount",0);h(this,"features",new _(z.empty));h(this,"name");h(this,"_parent");h(this,"_root");h(this,"_z");h(this,"_x");h(this,"_y");h(this,"_tileIndex");h(this,"_counter");h(this,"_subtiles",[void 0,void 0,void 0,void 0]);h(this,"featuresStatic",[]);h(this,"featureProperties");h(this,"_state");h(this,"updateSignal",new _(void 0));this._parent=s,this._state=t,this._root=(s==null?void 0:s._root)??this,this._z=e,this._x=n,this._y=o,this._tileIndex=B.tile_index(e,n,o),this.name="Count("+this._tileIndex+")";const i={id:""+this._tileIndex,tileId:""+this._tileIndex,count:"0",kilocount:"0",showCount:"0",totalCount:"0"};this.featureProperties=i;const u=new Date,r={type:"Feature",properties:i,geometry:{type:"Point",coordinates:B.centerPointOf(e,n,o)}};this.featuresStatic.push({feature:r,freshness:u});const a=R.fromTile(e,n,o),l={type:"Feature",properties:i,geometry:{type:"Polygon",coordinates:[[[a.minLon,a.minLat],[a.minLon,a.maxLat],[a.maxLon,a.maxLat],[a.maxLon,a.minLat],[a.minLon,a.minLat]]]}};this.featuresStatic.push({feature:l,freshness:u})}static createHierarchy(s){return new z(void 0,s,0,0,0)}getTile(s){var r;if(s===this._tileIndex)return this;let[t,e,n]=B.tile_from_index(s);for(;t-1>this._z;)e=Math.floor(e/2),n=Math.floor(n/2),t--;const o=e-2*this._x,u=(n-2*this._y)*2+o;return(r=this._subtiles[u])==null?void 0:r.getTile(s)}addTile(s){const t=this;if(s.tileIndex===this._tileIndex)this._counter===void 0&&(this._counter=new Ye(this._tileIndex),this._counter.countsPerLayer.addCallbackAndRun(e=>t.update())),this._counter.addTileCount(s);else{let[e,n,o]=B.tile_from_index(s.tileIndex);for(;e-1>this._z;)n=Math.floor(n/2),o=Math.floor(o/2),e--;const i=n-2*this._x,r=(o-2*this._y)*2+i;this._subtiles[r]===void 0&&(this._subtiles[r]=new z(this,this._state,e,n,o)),this._subtiles[r].addTile(s)}this.updateSignal.setData(s)}getCountsForZoom(s,t,e=0){const n=this,o=[],i=t.map(u=>u.zoom).map(u=>{if(u-1>s.maxZoom)return o;const r=[];return n.visitSubTiles(a=>a.showCount<e?!1:a._z===u?(r.push(...a.features.data),!1):a._z<=u),r},[this.updateSignal.stabilized(500)]);return new ie(i)}update(){var i,u,r,a;const s=new Map;let t=0,e=0,n=0,o=new Map;for(const l of this._state.filteredLayers.data)o.set(l.layerDef.id,l);(r=(u=(i=this==null?void 0:this._counter)==null?void 0:i.countsPerLayer)==null?void 0:u.data)==null||r.forEach((l,c)=>{s.set("layer:"+c,l),t+=l,this.featureProperties["direct_layer:"+c]=l;const d=o.get(c);d.isDisplayed.data&&this._z>=d.layerDef.minzoom?n+=l:e+=l});for(const l of this._subtiles)if(l!==void 0){t+=l.totalValue,n+=l.showCount,e+=l.hiddenCount;for(const c in l.featureProperties)c.startsWith("layer:")&&s.set(c,(s.get(c)??0)+Number(l.featureProperties[c]??0))}this.totalValue=t,this.showCount=n,this.hiddenCount=e,(a=this._parent)==null||a.update(),t===0?this.features.setData(z.empty):(this.featureProperties.count=""+t,this.featureProperties.kilocount=""+Math.floor(t/1e3),this.featureProperties.showCount=""+n,this.featureProperties.totalCount=""+t,s.forEach((l,c)=>{this.featureProperties[c]=""+l}),this.features.data=this.featuresStatic,this.features.ping())}visitSubTiles(s){s(this)&&this._subtiles.forEach(e=>e==null?void 0:e.visitSubTiles(s))}};let X=z;h(X,"empty",[]);class Ye{constructor(s){h(this,"bbox");h(this,"tileIndex");h(this,"countsPerLayer",new _(new Map));h(this,"z");h(this,"x");h(this,"y");h(this,"registeredLayers",new Map);this.tileIndex=s,this.bbox=R.fromTileIndex(s);const[t,e,n]=B.tile_from_index(s);this.z=t,this.x=e,this.y=n}addTileCount(s){const t=s.layer.layerDef;this.registeredLayers.set(t.id,t);const e=this;s.features.map(n=>{const o=s.layer.isDisplayed.data;e.countsPerLayer.data.set(t.id,o?n.length:0),e.countsPerLayer.ping()},[s.layer.isDisplayed])}}const Xe="cluster_style",et="The style for the clustering in all themes. Enable `debug=true` to peak into clustered tiles",tt={osmTags:"tileId~*"},nt="Clustered data",st=["all_tags"],ot=[{label:{render:"<div class='rounded-full text-xl font-bold' style='width: 2rem; height: 2rem; background: white'>{showCount}</div>",mappings:[{if:"showCount>1000",then:"<div class='rounded-full text-xl font-bold flex flex-col' style='width: 2.5rem; height: 2.5rem; background: white'>{kilocount}K</div>"}]},location:["point"]},{color:{render:"#3c3",mappings:[{if:"showCount>200",then:"#f33"},{if:"showCount>100",then:"#c93"},{if:"showCount>50",then:"#cc3"}]},width:{render:"1"}}],it={id:Xe,description:et,source:tt,title:nt,tagRenderings:st,mapRendering:ot},ye=class{constructor(s,t){const e=s.source,n=e.features.map(o=>{const i=e.bbox,[u,r,a]=B.tile_from_index(e.tileIndex),l={type:"Feature",properties:{z:u,x:r,y:a,tileIndex:e.tileIndex,source:e.name,count:o.length,tileId:e.name+"/"+e.tileIndex},geometry:{type:"Polygon",coordinates:[[[i.minLon,i.minLat],[i.minLon,i.maxLat],[i.maxLon,i.maxLat],[i.maxLon,i.minLat],[i.minLon,i.minLat]]]}},c=D.centerpoint(l);return[l,c].map(d=>({feature:d,freshness:new Date}))});new ae({layerToShow:ye.styling,features:new ie(n),leafletMap:s.leafletMap,doShowLayer:s.doShowLayer,state:t})}};let ee=ye;h(ee,"styling",new Te(it,"ShowTileInfo",!0));const be=class{constructor(s,t){h(this,"hash");h(this,"state");this.hash=s,this.state=t;const e=this;s.addCallback(()=>e.setSelectedElementFromHash()),this.initialLoad()}initialLoad(){const s=this.hash.data;s===void 0||s===""||s.indexOf("-")>=0||be._no_trigger_on.has(s)||(s.startsWith("node")||s.startsWith("way")||s.startsWith("relation"))&&A.DownloadObjectAsync(s).then(t=>{try{console.log("Downloaded selected object from OSM-API for initial load: ",s);const e=t.asGeoJson();this.state.allElements.addOrGetElement(e),this.state.selectedElement.setData(e),this.zoomToSelectedFeature()}catch(e){console.error(e)}})}setSelectedElementFromHash(){var e;const s=this.state,t=this.hash.data;if(t===void 0||t==="")s.selectedElement.setData(void 0);else{const n=s.allElements.ContainingFeatures.get(t);if(n===void 0)return;const o=s.selectedElement.data;if(o===void 0){s.selectedElement.setData(n);return}if(((e=o.properties)==null?void 0:e.id)===n.properties.id)return;s.selectedElement.setData(n)}}zoomToSelectedFeature(){var o,i;const s=this.state.selectedElement.data;if(s===void 0)return;const t=D.centerpointCoordinates(s),e=this.state.locationControl;e.data.lon=t[0],e.data.lat=t[1];const n=Math.max(14,...((i=(o=this.state.layoutToUse)==null?void 0:o.layers)==null?void 0:i.map(u=>u.minzoomVisible))??[]);e.data.zoom<n&&(e.data.zoom=n),e.ping()}};let te=be;h(te,"_no_trigger_on",new Set(["welcome","copyright","layers","new","filters","location_track","",void 0]));class at extends F{constructor(t,e){const n=new _([]),o=e.tagsSource,i=e.units;e.showAllQuestionsAtOnce=e.showAllQuestionsAtOnce??!1;const u=e.tagRenderings.filter(d=>d.question!==void 0).filter(d=>d.question!==null);let r=()=>{};const a=u.map((d,f)=>new Ae(()=>new Fe(o,d,t,{units:i,afterSave:()=>{n.ping(),r()},cancelButton:x.t.general.skip.Clone().SetClass("btn btn-secondary").onClick(()=>{n.data.push(f),n.ping(),r()})}))),l=x.t.general.skippedQuestions.onClick(()=>{n.setData([])});o.map(d=>{if(d!==void 0)for(let f=0;f<a.length;f++){let m=u[f];if(!(n.data.indexOf(f)>=0)&&!m.IsKnown(d)&&!(m.condition&&!m.condition.matchesProperties(d)))return f}},[n]);const c=o.map(d=>{if(d===void 0)return[];const f=[];for(let m=0;m<a.length;m++){let g=u[m];n.data.indexOf(m)>=0||g.IsKnown(d)||g.condition&&!g.condition.matchesProperties(d)||f.push(a[m])}return f},[n]);super(c.map(d=>{const f=t.osmConnection.apiIsOnline.data;if(f!=="online"&&f!=="unknown")return;const m=[];return e.showAllQuestionsAtOnce===!0||e.showAllQuestionsAtOnce.data?m.push(...c.data):m.push(d[0]),n.data.length>0&&m.push(l),new y(m).SetClass("block mb-8")},[t.osmConnection.apiIsOnline]));h(this,"skippedQuestions");h(this,"restingQuestions");this.skippedQuestions=n,this.restingQuestions=c,r=()=>this.ScrollIntoView()}}class rt extends le{constructor(t,e,n,o){var i;super(t,!0);h(this,"_softDeletionTags");h(this,"meta");h(this,"_id");h(this,"_hardDelete");this._id=t,this._hardDelete=o,this.meta={...n,changeType:"deletion"},((i=e==null?void 0:e.usedKeys())==null?void 0:i.indexOf("fixme"))>=0?this._softDeletionTags=e:this._softDeletionTags=new Le(q.NoNull([e,new V("fixme",`A mapcomplete user marked this feature to be deleted (${n.specialMotivation})`)]))}async CreateChangeDescriptions(t,e){const n=e??await A.DownloadObjectAsync(this._id);return this._hardDelete?[{meta:this.meta,doDelete:!0,type:n.type,id:n.id}]:await new pe(this._id,this._softDeletionTags,n.tags,{...this.meta,changeType:"soft-delete"}).CreateChangeDescriptions(t)}}class H extends T{constructor(s,t,e){const n=new lt(s,t,e.neededChangesets),o=t.allElements.getEventSourceById(s),i=new _(!1),u=!!e.softDeletionTags,r=new _(!1);function a(w){var O,b,Q;let I;w.retagTo!==void 0?I=new pe(s,w.retagTo,o.data,{theme:((O=t==null?void 0:t.layoutToUse)==null?void 0:O.id)??"unkown",changeType:"special-delete"}):I=new rt(s,e.softDeletionTags,{theme:((b=t==null?void 0:t.layoutToUse)==null?void 0:b.id)??"unkown",specialMotivation:w.deleteReason},n.canBeDeleted.data.canBeDeleted),(Q=t.changes)==null||Q.applyAction(I),i.setData(!0)}const l=x.t.delete,c=l.cancel.SetClass("block btn btn-secondary").onClick(()=>r.setData(!1)),d=new M(k.delete_icon_svg().SetStyle("width: 1.5rem; height: 1.5rem;"),l.delete).onClick(()=>{n.CheckDeleteability(!0),r.setData(!0)}),f=o.map(w=>w.id.indexOf("-")<0),m=H.constructMultipleChoice(e,o,t),g=new y([new E(new ue(l.whyDelete,o,t).SetClass("question-text"),3),m,new y([H.constructExplanation(m.GetValue(),n,o,t),new y([c,H.constructConfirmButton(m.GetValue()).onClick(()=>a(m.GetValue().data))]).SetClass("flex justify-end flex-wrap-reverse")]).SetClass("flex mt-2 justify-between")]).SetClass("question"),v=new T(new T(new T(g,new M(k.envelope_ui(),l.readMessages),t.osmConnection.userDetails.map(w=>w.csCount>Z.userJourney.addNewPointWithUnreadMessagesUnlock||w.unreadMessages==0)),d,r),new F(n.canBeDeleted.map(w=>new y([k.delete_not_allowed_svg().SetStyle("height: 2rem; width: auto").SetClass("mr-2"),new y([l.cannotBeDeleted,w.reason.SetClass("subtle"),l.useSomethingElse.SetClass("subtle")]).SetClass("flex flex-col")]).SetClass("flex m-2 p-2 rounded-lg bg-gray-200 bg-gray-200"))),n.canBeDeleted.map(w=>u||w.canBeDeleted!==!1));super(new T(new y([k.delete_icon_svg().SetClass("h-16 w-16 p-2 m-2 block bg-gray-300 rounded-full"),l.isDeleted]).SetClass("flex m-2 rounded-full"),new me(v,void 0,t),i),void 0,f);const p=this;r.addCallbackAndRunD(w=>{w&&p.ScrollIntoView()})}static constructConfirmButton(s){const t=x.t.delete,e=new y([k.delete_icon_ui().SetClass("w-6 h-6 mr-3 block"),t.delete]).SetClass("flex btn bg-red-500"),n=new y([k.delete_icon_ui().SetClass("w-6 h-6 mr-3 block"),t.delete]).SetClass("flex btn btn-disabled bg-red-200");return new T(e,n,s.map(o=>o!==void 0))}static constructExplanation(s,t,e,n){const o=x.t.delete;return new F(s.map(i=>{if(i===void 0)return o.explanations.selectReason.SetClass("subtle");const u=i.retagTo;if(u!==void 0)return new y([o.explanations.retagNoOtherThemes,Fe.CreateTagExplanation(new _(u),e,n).SetClass("subtle")]);if(i.deleteReason!==void 0)return new F(t.canBeDeleted.map(({canBeDeleted:a,reason:l})=>a?o.explanations.hardDelete:o.explanations.softDelete.Subs({reason:l})))},[t.canBeDeleted])).SetClass("block")}static constructMultipleChoice(s,t,e){const n=[];for(const o of s.nonDeleteMappings)n.push(new De(new ue(o.then,t,e),{retagTo:o.if}));for(const o of s.deleteReasons??[])n.push(new De(new ue(o.explanation,t,e),{deleteReason:o.changesetMessage}));return new je(n,{selectFirstAsDefault:!1})}}class lt{constructor(s,t,e){h(this,"canBeDeleted");h(this,"_id");h(this,"_allowDeletionAtChangesetCount");h(this,"_state");this._id=s,this._state=t,this._allowDeletionAtChangesetCount=e??Number.MAX_VALUE,this.canBeDeleted=new _({canBeDeleted:void 0,reason:x.t.delete.loading}),this.CheckDeleteability(!1)}CheckDeleteability(s){const t=x.t.delete,e=this._id,n=this.canBeDeleted,o=this;if(!e.startsWith("node")){this.canBeDeleted.setData({canBeDeleted:!1,reason:t.isntAPoint});return}const i=this._state.osmConnection.userDetails.map(f=>{if(f!==void 0)return f.loggedIn?f.csCount>=Math.min(Z.userJourney.deletePointsOfOthersUnlock,this._allowDeletionAtChangesetCount):!1}),u=new _(void 0),r=u.map(f=>{if(f==null)return null;const m=o._state.osmConnection.userDetails.data.uid;return!f.some(g=>g!==m)},[o._state.osmConnection.userDetails]),a=i.map(f=>{if(f===void 0)return!1;if(f===!0||(r.data===null&&s&&A.DownloadHistory(e).map(g=>g.map(v=>Number(v.tags["_last_edit:contributor:uid"]))).addCallbackAndRunD(g=>u.setData(g)),r.data===!0))return!0;if(r.data===!1)return!1},[r]),l=new _(null),c=new _(null);a.addCallbackAndRunD(f=>{if(f===!1)return n.setData({canBeDeleted:!1,reason:t.notEnoughExperience}),!0;if(s)return A.DownloadReferencingRelations(e).then(m=>{l.setData(m.length>0)}),A.DownloadReferencingWays(e).then(m=>{c.setData(m.length>0)}),!0}),l.map(f=>f===!0||c.data===!0?!0:c.data===null||f===null?null:c.data===!1&&f===!1?!1:null,[c]).addCallbackAndRun(f=>{f!=null&&(f?n.setData({canBeDeleted:!1,reason:t.partOfOthers}):n.setData({canBeDeleted:!0,reason:r.data===!0?t.onlyEditedByLoggedInUser:t.safeDelete}))})}}class ge extends le{constructor(t,e){super("relation/"+t.relation.id,!1);h(this,"_input");h(this,"_theme");this._input=t,this._theme=e}async targetNodeAt(t,e){const n=this._input.relation.members[t];if(n!==void 0){if(n.type==="node")return n.ref;if(n.type==="way"){const i=(await A.DownloadObjectAsync("way/"+n.ref)).nodes;return e?i[0]:i[i.length-1]}n.type}}}class ct extends ge{constructor(s,t){super(s,t)}async CreateChangeDescriptions(s){return this._input.relation.tags.type==="restriction"?new dt(this._input,this._theme).CreateChangeDescriptions(s):new Be(this._input,this._theme).CreateChangeDescriptions(s)}}class dt extends ge{constructor(s,t){super(s,t)}async CreateChangeDescriptions(s){const t=this._input.relation,e=t.members,n=e.filter(d=>d.type==="way"&&d.ref===this._input.originalWayId);n.length>1&&console.warn("Detected a turn restriction where this way has multiple occurances. This is an error");const o=n[0];if(o.role==="via")return new Be(this._input,this._theme).CreateChangeDescriptions(s);let i=await this.targetNodeAt(e.indexOf(o),!0),u=await this.targetNodeAt(e.indexOf(o),!1),r=i??u;const a=this._input.allWaysNodesInOrder.map((d,f)=>({nodes:d,id:this._input.allWayIdsInOrder[f]})).filter(d=>{const f=d.nodes;return f[0]==r||f[f.length-1]==r})[0];if(a===void 0)return console.error("No common point found, this was a broken turn restriction!",t.id),[];const l=this._input.originalWayId;if(a.id===l)return console.log("Turn_restriction fixer: the original ID can be kept, nothing to do"),[];const c=t.members.map(d=>d.type==="way"&&d.ref===l?{ref:a.id,type:"way",role:d.role}:d);return[{type:"relation",id:t.id,changes:{members:c},meta:{theme:this._theme,changeType:"relation-fix:turn_restriction"}}]}}class Be extends ge{constructor(s,t){super(s,t)}async CreateChangeDescriptions(s){const t=this._input.originalWayId,e=this._input.relation,n=e.members,o=this._input.originalNodes,i=o[0],u=o[o.length-1],r=[];for(let a=0;a<n.length;a++){const l=n[a];if(l.type!=="way"||l.ref!==t){r.push(l);continue}const c=await this.targetNodeAt(a-1,!1),d=await this.targetNodeAt(a+1,!0);if((c===void 0||c===i)&&(d===void 0||d===u)){for(const p of this._input.allWayIdsInOrder)r.push({ref:p,type:"way",role:l.role});continue}if(c===void 0||c===u||(d===void 0||d===i)){for(let p=this._input.allWayIdsInOrder.length-1;p>=0;p--){const w=this._input.allWayIdsInOrder[p];r.push({ref:w,type:"way",role:l.role})}continue}for(const p of this._input.allWayIdsInOrder)r.push({ref:p,type:"way",role:l.role})}return[{id:e.id,type:"relation",changes:{members:r},meta:{changeType:"relation-fix",theme:this._theme}}]}}class we extends le{constructor(t,e,n,o=5,i){super(t,!0);h(this,"wayId");h(this,"_splitPointsCoordinates");h(this,"_meta");h(this,"_toleranceInMeters");h(this,"_withNewCoordinates");this.wayId=t,this._splitPointsCoordinates=e,this._toleranceInMeters=o,this._withNewCoordinates=i,this._meta={...n,changeType:"split"}}static SegmentSplitInfo(t){const e=[];let n=[];for(const o of t)n.push(o),o.doSplit&&(e.push(n),n=[o]);return e.push(n),e.filter(o=>o.length>0)}async CreateChangeDescriptions(t){const e=await A.DownloadObjectAsync(this.wayId),n=e.nodes,o=this.CalculateSplitCoordinates(e,this._toleranceInMeters);for(const d of o)d.originalIndex>=0?d.originalIndex=e.nodes[d.originalIndex]:d.originalIndex=t.getNewID();const i=we.SegmentSplitInfo(o);let u;for(const d of i){if(u===void 0){u=d;continue}d.length>u.length&&(u=d)}const r=[];for(const d of o)d.originalIndex>=0||r.push({type:"node",id:d.originalIndex,changes:{lon:d.lngLat[0],lat:d.lngLat[1]},meta:this._meta});const a=[],l=[];for(const d of i)if(d===u){const m=d.map(v=>v.originalIndex),g=d.map(v=>v.lngLat);r.push({type:"way",id:e.id,changes:{coordinates:g,nodes:m},meta:this._meta}),this._withNewCoordinates&&this._withNewCoordinates(g),a.push(e.id),l.push(m)}else{let m=t.getNewID();const g=[];for(const p in e.tags)e.tags.hasOwnProperty(p)&&(p.startsWith("_")||p==="id"||g.push({k:p,v:e.tags[p]}));const v=d.map(p=>p.originalIndex);if(v.length<=1){console.error("Got a segment with only one node - skipping");continue}r.push({type:"way",id:m,tags:g,changes:{coordinates:d.map(p=>p.lngLat),nodes:v},meta:this._meta}),a.push(m),l.push(v)}const c=await A.DownloadReferencingRelations(this.wayId);for(const d of c){const f=await new ct({relation:d,allWayIdsInOrder:a,originalNodes:n,allWaysNodesInOrder:l,originalWayId:e.id},this._meta.theme).CreateChangeDescriptions(t);r.push(...f)}return r}CalculateSplitCoordinates(t,e=5){const n=t.asGeoJson(),o=t.coordinates.map(a=>[a[1],a[0]]),i=this._splitPointsCoordinates.map(a=>{let l=D.nearestPoint(n,a);return{coordinates:a,isSplitPoint:!0,dist:l.properties.dist,location:l.properties.location}});for(let a=0;a<o.length;a++){let l=o[a],c=D.nearestPoint(n,l);i.push({coordinates:l,isSplitPoint:!1,location:c.properties.location,originalIndex:a,dist:c.properties.dist})}i.sort((a,l)=>a.location-l.location);for(let a=i.length-2;a>=1;a--){const l=i[a];if(l.originalIndex!==void 0)continue;const c=i[a+1],d=i[a-1],f=c.location-l.location,m=l.location-d.location;if(f*1e3>e&&m*1e3>e)continue;let g=c;f>m&&(g=d),!(g.originalIndex===0||g.originalIndex===o.length)&&(g.isSplitPoint=!0,i.splice(a,1))}const u=[];let r=-1;for(const a of i){let l=a.originalIndex;l===void 0&&(l=r,r--);const c={originalIndex:l,lngLat:a.coordinates,doSplit:a.isSplitPoint};u.push(c)}return u}}const ut="split_point",ht="Layer rendering the little scissors for the minimap in the 'splitRoadWizard'",ft=1,pt={osmTags:"_split_point=yes"},mt="Split point",gt="Split point",wt=[{location:["point","centroid"],icon:"circle:white;./assets/svg/scissors.svg",iconSize:"30,30,center"}],yt={id:ut,description:ht,minzoom:ft,source:pt,name:mt,title:gt,mapRendering:wt},J=class extends y{constructor(t,e){const n=x.t.split,o=new _([]),i=new _(!1),u=new _(!1),r=new _(J.setupMapComponent(t,o,e)),a=new M(k.scissors_ui().SetStyle("height: 1.5rem; width: auto"),new T(n.splitAgain.Clone().SetClass("text-lg font-bold"),n.inviteToSplit.Clone().SetClass("text-lg font-bold"),i)),l=new me(a,n.loginToSplit.Clone(),e),c=new ke(n.split.Clone(),async()=>{var I;i.setData(!0),u.setData(!1);const w=new we(t,o.data.map(O=>O.feature.geometry.coordinates),{theme:(I=e==null?void 0:e.layoutToUse)==null?void 0:I.id},5,O=>{e.allElements.ContainingFeatures.get(t).geometry.coordinates=O});await e.changes.applyAction(w),o.setData([]),r.setData(J.setupMapComponent(t,o,e)),Me.collapse()});c.SetClass("btn btn-primary mr-3");const d=new ke(n.split.Clone(),void 0);d.SetClass("btn btn-disabled mr-3");const f=new T(d,c,o.map(w=>w.length===0)),m=x.t.general.cancel.Clone().SetClass("btn btn-secondary mr-3").onClick(()=>{o.setData([]),u.setData(!1)});m.SetClass("btn btn-secondary block");const g=new E(n.splitTitle),v=new y([g,new F(r),new y([m,f]).SetClass("flex flex-row")]);v.SetClass("question");super([T.If(i,()=>n.hasBeenSplit.Clone().SetClass("font-bold thanks block w-full")),new T(v,l,u)]);h(this,"dialogIsOpened");this.dialogIsOpened=u;const p=this;a.onClick(()=>{u.setData(!0),p.ScrollIntoView()})}static setupMapComponent(t,e,n){const o=n.allElements.ContainingFeatures.get(t),i=Ze.createMiniMap({background:n.backgroundLayer,allowMoving:!0,leafletOptions:{minZoom:14}});i.SetStyle("width: 100%; height: 24rem").SetClass("rounded-xl overflow-hidden"),i.installBounds(R.get(o).pad(.25),!1),new We({features:ie.fromGeojson([o]),layers:n.filteredLayers,leafletMap:i.leafletMap,zoomToFeatures:!0,state:n}),new ae({features:new ie(e),leafletMap:i.leafletMap,zoomToFeatures:!1,layerToShow:J.splitLayerStyling,state:n});function u(r){const a=e.data.map((c,d)=>[c.feature,d]).filter(c=>D.distanceBetween(c[0].geometry.coordinates,r)<5).map(c=>c[1]).sort((c,d)=>c-d).reverse();if(a.length>0){for(const c of a)e.data.splice(c,1);e.ping();return}const l=D.nearestPoint(o,r);l.properties._split_point="yes",e.data.push({feature:l,freshness:new Date}),e.ping()}return i.leafletMap.addCallbackAndRunD(r=>r.on("click",a=>{u([a.latlng.lng,a.latlng.lat])})),i}};let ne=J;h(ne,"splitLayerStyling",new Te(yt,"(BUILTIN) SplitRoadWizard.ts",!0));class bt extends le{constructor(t,e,n){super(t,!0);h(this,"_id");h(this,"_newLonLat");h(this,"_meta");if(!t.startsWith("node/"))throw"Invalid ID: only 'node/number' is accepted";this._id=Number(t.substring(5)),this._newLonLat=e,this._meta=n}async CreateChangeDescriptions(t){return[{changes:{lat:this._newLonLat[1],lon:this._newLonLat[0]},type:"node",id:this._id,meta:{changeType:"move",theme:this._meta.theme,specialMotivation:this._meta.reason}}]}}const ve=class{static async Search(s){var n,o;const t=((o=(n=oe==null?void 0:oe.state)==null?void 0:n.currentBounds)==null?void 0:o.data)??R.global,e=ve.host+`format=json&limit=1&viewbox=${t.getEast()},${t.getNorth()},${t.getWest()},${t.getSouth()}&accept-language=nl&q=`+s;return q.downloadJson(e)}};let se=ve;h(se,"host","https://nominatim.openstreetmap.org/search?");class vt extends y{constructor(t){const e=k.search_ui().SetClass("w-8 h-8 full-rounded border-black float-right"),n=new _(x.t.general.search.search),o=new Re({placeholder:n.map(u=>u.textFor(re.language.data),[re.language]),value:new _(""),inputStyle:` background: transparent;
    border: none;
    font-size: large;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    color: var(--foreground-color);`});o.SetClass("relative float-left mt-0 ml-2"),o.SetStyle("width: calc(100% - 3em);height: 100%");super([o,e]);h(this,"_searchField");this.SetClass("block h-8"),this.SetStyle("background: var(--background-color); color: var(--foreground-color); pointer-evetns:all;");async function i(){var r;const u=o.GetValue().data;if(!(u===void 0||u==="")){o.GetValue().setData(""),n.setData(x.t.general.search.searching);try{const a=await se.Search(u);if(console.log("Search result",a),a.length==0){n.setData(x.t.general.search.nothing);return}const l=a[0],c=l.boundingbox,d=[[c[0],c[2]],[c[1],c[3]]];(r=t.selectedElement)==null||r.setData(void 0),Oe.hash.setData(l.osm_type+"/"+l.osm_id),t.leafletMap.data.fitBounds(d),n.setData(x.t.general.search.search)}catch{o.GetValue().setData(""),n.setData(x.t.general.search.error)}}}o.enterPressed.addCallback(i),this._searchField=o,e.onClick(i)}focus(){this._searchField.focus()}}class Ct extends T{constructor(s,t,e){const n=x.t.move;new T(n.loginToMove.SetClass("btn").onClick(()=>t.osmConnection.AttemptLogin()),void 0,t.featureSwitchUserbadge);const o=[];e.enableRelocation&&o.push({text:n.reasons.reasonRelocation,invitingText:n.inviteToMove.reasonRelocation,icon:k.relocation_svg(),changesetCommentValue:"relocated",lockBounds:!1,background:void 0,includeSearch:!0,startZoom:12,minZoom:6,eraseAddressFields:!0}),e.enableImproveAccuracy&&o.push({text:n.reasons.reasonInaccurate,invitingText:n.inviteToMove.reasonInaccurate,icon:k.crosshair_svg(),changesetCommentValue:"improve_accuracy",lockBounds:!0,includeSearch:!1,background:"photo",startZoom:17,minZoom:16,eraseAddressFields:!1});const i=new _("start"),u=new _(void 0);let r;if(o.length===1){const b=o[0];u.setData(b),r=new M(b.icon.SetStyle("height: 1.5rem; width: 1.5rem;"),x.T(b.invitingText)).onClick(()=>{i.setData("pick_location")})}else r=new M(k.move_ui().SetStyle("width: 1.5rem; height: 1.5rem"),n.inviteToMove.generic).onClick(()=>{i.setData("reason")});const a=new M(k.move_ui(),n.inviteToMoveAgain).onClick(()=>{i.setData("reason")}),l=new y(o.map(b=>new M(b.icon,b.text).onClick(()=>{u.setData(b),i.setData("pick_location")}))),c=new M(k.close_svg(),n.cancel).onClick(()=>i.setData("start")),[d,f]=D.centerpointCoordinates(s),m=u.map(b=>{if(b===void 0)return;const Q=new _({lon:d,lat:f,zoom:(b==null?void 0:b.startZoom)??16});let de;typeof b.background=="string"?de=[b.background]:de=b.background;const Pe=Ke.SelectBestLayerAccordingTo(Q,new _(de)).data,G=new Ve({minZoom:b.minZoom,centerLocation:Q,mapBackground:new _(Pe),state:t});b.lockBounds&&G.installBounds(.05,!0);let Ce;b.includeSearch&&(Ce=new vt({leafletMap:G.leafletMap})),G.SetStyle("height: 17.5rem");const Se=new M(k.move_confirm_svg(),n.confirmMove);Se.onClick(async()=>{const j=G.GetValue().data;await t.changes.applyAction(new bt(s.properties.id,[j.lon,j.lat],{reason:b.changesetCommentValue,theme:t.layoutToUse.id})),s.properties._lat=j.lat,s.properties._lon=j.lon,b.eraseAddressFields&&await t.changes.applyAction(new pe(s.properties.id,new Le([new V("addr:housenumber",""),new V("addr:street",""),new V("addr:city",""),new V("addr:postcode","")]),s.properties,{changeType:"relocated",theme:t.layoutToUse.id})),t.allElements.getEventSourceById(p).ping(),i.setData("moved")});const Ne=n.zoomInFurther.SetClass("alert block m-6");return new y([Ce,G,new T(Se,Ne,G.GetValue().map(j=>j.zoom>=19))]).SetClass("flex flex-col")}),g="p-2 md:p-4 m-2 border border-gray-400 rounded-xl flex flex-col",v=new me(new F(i.map(b=>{switch(b){case"start":return r;case"reason":return new y([n.whyMove.SetClass("text-lg font-bold"),l,c]).SetClass(g);case"pick_location":return new y([n.moveTitle.SetClass("text-lg font-bold"),new F(m),c]).SetClass(g);case"moved":return new y([n.pointIsMoved.SetClass("thanks"),a]).SetClass("flex flex-col")}})),void 0,t);let p=s.properties.id;const w=t.osmConnection._oauth_config.url;p.startsWith(w)&&(p=p.substring(w.length));const I=new _(void 0);p.startsWith("way")?I.setData(n.isWay):p.startsWith("relation")?I.setData(n.isRelation):p.indexOf("-")<0&&(A.DownloadReferencingWays(p).then(b=>{b.length>0&&(console.log("Got a referencing way, move not allowed"),I.setData(n.partOfAWay))}),A.DownloadReferencingRelations(p).then(b=>{b.length>0&&I.setData(n.partOfRelation)})),super(v,new y([k.move_not_allowed_svg().SetStyle("height: 2rem").SetClass("m-2"),new y([n.cannotBeMoved,new F(I).SetClass("subtle")]).SetClass("flex flex-col")]).SetClass("flex m-2 p-2 rounded-lg bg-gray-200"),I.map(b=>b===void 0));const O=this;i.addCallback(b=>{b!=="start"&&O.ScrollIntoView()})}}class N extends Me{constructor(s,t,e,n){if(e===void 0)throw"State is undefined!";const o=e.featureSwitchShowAllQuestions.map(i=>i||e.showAllQuestionsAtOnce.data,[e.showAllQuestionsAtOnce]);if(super(()=>N.GenerateTitleBar(s,t,e),()=>N.GenerateContent(s,t,e,o),(n==null?void 0:n.hashToShow)??s.data.id??"item",n==null?void 0:n.isShown,n),t===void 0)throw"Undefined layerconfig"}static GenerateTitleBar(s,t,e){const n=new P(s,t.title??new K("POI"),e).SetClass("break-words font-bold sm:p-0.5 md:p-1 sm:p-1.5 md:p-2 text-2xl"),o=new y(t.titleIcons.map(i=>new P(s,i,e,"block h-8 max-h-8 align-baseline box-content sm:p-0.5 titleicon"))).SetClass("flex flex-row flex-wrap pt-0.5 sm:pt-1 items-center mr-2");return new y([new y([n,o]).SetClass("flex flex-col sm:flex-row flex-grow justify-between")])}static GenerateContent(s,t,e,n){return new T(new y([k.delete_icon_svg().SetClass("w-8 h-8"),x.t.delete.isDeleted]).SetClass("flex justify-center font-bold items-center"),N.GenerateMainContent(s,t,e,n),s.map(o=>o._deleted=="yes"))}static GenerateMainContent(s,t,e,n){var l,c;let o=new Map;const i=x.t.general,u=q.Dedup(t.tagRenderings.map(d=>d.group));if(((l=e==null?void 0:e.featureSwitchUserbadge)==null?void 0:l.data)??!0){const d=t.tagRenderings.filter(f=>f.id==="questions");for(const f of u){const m=t.tagRenderings.filter(p=>p.group===f),g=d.filter(p=>p.group===f)[0],v=new at(e,{tagsSource:s,tagRenderings:m,units:t.units,showAllQuestionsAtOnce:((c=g==null?void 0:g.freeform)==null?void 0:c.helperArgs.showAllQuestions)??n});o.set(f,v)}}const r=t.tagRenderings.filter(d=>d.question!==void 0).length,a=[new F(s.map(d=>d[V.newlyCreated.key]).map(d=>{if(d===void 0)return;const f=new Date(d);if((Date.now()-f.getTime())/1e3>=60*5)return;const g=[],v=new y([k.party_svg().SetClass("w-12 h-12 shrink-0 p-1 m-1 bg-white rounded-full block"),i.newlyCreated]).SetClass("flex w-full thanks content-center");return g.push(v),r>0&&g.push(i.feelFreeToSkip),new y(g).SetClass("pb-4 mb-4 border-b block border-black")}))];for(let d=0;d<u.length;d++){const f=u[d],m=t.tagRenderings.filter(p=>p.group===f),g=[],v="block w-full break-word text-default m-1 p-1 border-b border-gray-200 mb-2 pb-2";for(const p of m)if(p.question===null||p.id==="questions"){const w=o.get(p.group);if(o.delete(p.group),p.render!==void 0){w.SetClass("text-sm");const I=new P(s,p,e,p.group+" questions","",{specialViz:new Map([["questions",w]])}),O=new T(I,void 0,w.restingQuestions.map(b=>(b==null?void 0:b.length)>0));g.push(O)}else g.push(w)}else{let w=g.length===0&&d>0;const I=new ze(s,p,t.units,e,{innerElementClasses:v});w&&I.SetClass("sticky top-0"),g.push(I)}a.push(...g)}return a.push(new T(new Ae(()=>N.createEditElements(o,t,s,e)),void 0,e.featureSwitchUserbadge)),new y(a).SetClass("block")}static createEditElements(s,t,e,n){let o=[];return s.forEach(i=>{o.push(i)}),t.allowMove&&o.push(new F(e.map(i=>i.id).map(i=>{const u=n.allElements.ContainingFeatures.get(i);return u===void 0?"This feature is not register in the state.allElements and cannot be moved":new Ct(u,n,t.allowMove)})).SetClass("text-base")),t.deletion&&o.push(new F(e.map(i=>i.id).map(i=>new H(i,n,t.deletion))).SetClass("text-base")),t.allowSplit&&o.push(new F(e.map(i=>i.id).map(i=>new ne(i,n))).SetClass("text-base")),o.push(new F(n.osmConnection.userDetails.map(i=>i.csCount).map(i=>{if(!(i<=Z.userJourney.historyLinkVisible&&n.featureSwitchIsDebugging.data==!1&&n.featureSwitchIsTesting.data===!1))return new P(e,Ue.SharedTagRendering.get("last_edit"),n)},[n.featureSwitchIsDebugging,n.featureSwitchIsTesting]))),o.push(T.If(n.featureSwitchIsDebugging,()=>{const i=new K({render:"{all_tags()}"},""),u=new K({render:"{export_as_geojson()}"},""),r=new K({render:"{open_in_iD()}"},"");return new y([new P(e,i,n),new P(e,u,n),new P(e,r,n),"This is layer "+t.id])})),new y(o).SetClass("flex flex-col")}}class St{constructor(){h(this,"_name","enclosingFeatures");h(this,"_doc",["Gives a list of all features in the specified layers which fully contain this object. Returned features will always be (multi)polygons. (LineStrings and Points from the other layers are ignored)","","The result is a list of features: `{feat: Polygon}[]`","This function will never return the feature itself."].join(`
`));h(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for overlap)"])}_f(s,t){return(...e)=>{const n=[],o=R.get(t),i=new Set;i.add(t.properties.id);for(const u of e){const r=s.getFeaturesWithin(u,o);if(r!==void 0&&r.length!==0)for(const a of r)for(const l of a)i.has(l.properties.id)||(i.add(l.properties.id),!(l.geometry.type!=="Polygon"&&l.geometry.type!=="MultiPolygon")&&D.completelyWithin(t,l)&&n.push({feat:l}))}return n}}}class _t{constructor(){h(this,"_name","overlapWith");h(this,"_doc",["Gives a list of features from the specified layer which this feature (partly) overlaps with. A point which is embedded in the feature is detected as well.","If the current feature is a point, all features that this point is embeded in are given.","","The returned value is `{ feat: GeoJSONFeature, overlap: number}[]` where `overlap` is the overlapping surface are (in mÂ²) for areas, the overlapping length (in meter) if the current feature is a line or `undefined` if the current feature is a point.","The resulting list is sorted in descending order by overlap. The feature with the most overlap will thus be the first in the list.","","For example to get all objects which overlap or embed from a layer, use `_contained_climbing_routes_properties=feat.overlapWith('climbing_route')`","","Also see [enclosingFeatures](#enclosingFeatures) which can be used to get all objects which fully contain this feature"].join(`
`));h(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for overlap)"])}_f(s,t){return(...e)=>{const n=[],o=new Set,i=R.get(t);for(const u of e){const r=s.getFeaturesWithin(u,i);if(r!==void 0&&r.length!==0)for(const a of r){const l=D.calculateOverlap(t,a);for(const c of l)o.has(c.feat.properties.id)||(o.add(c.feat.properties.id),n.push(c))}}return n.sort((u,r)=>r.overlap-u.overlap),n}}}class xt{constructor(){h(this,"_name","intersectionsWith");h(this,"_doc",`Gives the intersection points with selected features. Only works with (Multi)Polygons and LineStrings.

Returns a \`{feat: GeoJson, intersections: [number,number][]}\` where \`feat\` is the full, original feature. This list is in random order.

If the current feature is a point, this function will return an empty list.
Points from other layers are ignored - even if the points are parts of the current linestring.`);h(this,"_args",["...layerIds - one or more layer ids of the layer from which every feature is checked for intersection)"])}_f(s,t){return(...e)=>{const n=[],o=R.get(t);for(const i of e){const u=s.getFeaturesWithin(i,o);if(u!==void 0&&u.length!==0)for(const r of u)for(const a of r){const l=D.LineIntersections(t,a);l.length!==0&&n.push({feat:a,intersections:l})}}return n}}}class Dt{constructor(){h(this,"_name","distanceTo");h(this,"_doc","Calculates the distance between the feature and a specified point in meter. The input should either be a pair of coordinates, a geojson feature or the ID of an object");h(this,"_args",["feature OR featureID OR longitude","undefined OR latitude"])}_f(s,t){return(e,n)=>{if(e!==void 0){if(typeof e=="number")return D.distanceBetween([e,n],D.centerpointCoordinates(t));if(typeof e=="string"){const o=s.getFeatureById(e);if(o===void 0)return;e=o}return D.distanceBetween(D.centerpointCoordinates(e),D.centerpointCoordinates(t))}}}}class kt{constructor(){h(this,"_name","closest");h(this,"_doc","Given either a list of geojson features or a single layer name, gives the single object which is nearest to the feature. In the case of ways/polygons, only the centerpoint is considered. Returns a single geojson feature or undefined if nothing is found (or not yet loaded)");h(this,"_args",["list of features or a layer name or '*' to get all features"])}_f(s,t){return e=>{var n,o;return(o=(n=ce.GetClosestNFeatures(s,t,e))==null?void 0:n[0])==null?void 0:o.feat}}}class ce{constructor(){h(this,"_name","closestn");h(this,"_doc","Given either a list of geojson features or a single layer name, gives the n closest objects which are nearest to the feature (excluding the feature itself). In the case of ways/polygons, only the centerpoint is considered. Returns a list of `{feat: geojson, distance:number}` the empty list if nothing is found (or not yet loaded)\n\nIf a 'unique tag key' is given, the tag with this key will only appear once (e.g. if 'name' is given, all features will have a different name)");h(this,"_args",["list of features or layer name or '*' to get all features","amount of features","unique tag key (optional)","maxDistanceInMeters (optional)"])}static GetClosestNFeatures(s,t,e,n){const o=(n==null?void 0:n.maxFeatures)??1,i=(n==null?void 0:n.maxDistance)??500,u=n==null?void 0:n.uniqueTag;if(typeof e=="string"){const l=e,c=D.bbox(D.buffer(D.bbox(t),i));e=s.getFeaturesWithin(l,new R(c.geometry.coordinates))}else e=[e];if(e===void 0)return;const r=D.centerpointCoordinates(t);let a=[];for(const l of e)for(const c of l){if(c===t||c.properties.id===t.properties.id)continue;const d=D.distanceBetween(D.centerpointCoordinates(c),r);if(d==null||isNaN(d))throw console.error("Could not calculate the distance between",t,"and",c),"Undefined distance!";if(d===0&&console.trace("Got a suspiciously zero distance between",c,"and self-feature",t),d>i)continue;if(a.length===0){a.push({feat:c,distance:d});continue}if(a.length>=o&&a[o-1].distance<d)continue;let f=a.length;for(let m=0;m<a.length;m++){const g=a[m];if(u!==void 0&&c.properties[u]!==void 0&&g.feat.properties[u]===c.properties[u]){f=-1,g.distance>d&&(a[m]={feat:c,distance:d});break}if(g.distance>d){if(f=m,u!==void 0){const v=c.properties[u];for(let p=m;p<a.length;p++)a[p].feat.properties[u]===v&&a.splice(p,1)}break}}f!=-1&&(f<o?(a.splice(f,0,{feat:c,distance:d}),a.length>=o&&a.splice(o,1)):a[f]={feat:c,distance:d})}return a}_f(s,t){return(e,n,o,i)=>{let u=Number(i);return isNaN(u)&&(u=void 0),ce.GetClosestNFeatures(s,t,e,{maxFeatures:Number(n),uniqueTag:o,maxDistance:u})}}}class It{constructor(){h(this,"_name","memberships");h(this,"_doc","Gives a list of `{role: string, relation: Relation}`-objects, containing all the relations that this feature is part of. \n\nFor example: `_part_of_walking_routes=feat.memberships().map(r => r.relation.tags.name).join(';')`");h(this,"_args",[])}_f(s,t){return()=>s.memberships.knownRelations.data.get(t.properties.id)??[]}}class Tt{constructor(){h(this,"_name","get");h(this,"_doc","Gets the property of the feature, parses it (as JSON) and returns it. Might return 'undefined' if not defined, null, ...");h(this,"_args",["key"])}_f(s,t){return e=>{const n=t.properties[e];if(n!==void 0)try{const o=JSON.parse(n);return o===null?void 0:o}catch(o){console.warn("Could not parse property "+e+" due to: "+o+", the value is "+n);return}}}}const U=class{static FullPatchFeature(s,t){if(!t._is_patched){t._is_patched=!0;for(const e of U.allFuncs)t[e._name]=e._f(s,t)}}static HelpText(){const s=[];for(const t of U.allFuncs)s.push(new E(t._name,3),t._doc,new Y(t._args??[],!0));return new y([U.intro,new Y(U.allFuncs.map(t=>`[${t._name}](#${t._name})`)),...s])}};let $=U;h($,"intro",new y([new E("Calculating tags with Javascript",2),"In some cases, it is useful to have some tags calculated based on other properties. Some useful tags are available by default (e.g. `lat`, `lon`, `_country`), as detailed above.","It is also possible to calculate your own tags - but this requires some javascript knowledge.","","Before proceeding, some warnings:",new Y(["DO NOT DO THIS AS BEGINNER","**Only do this if all other techniques fail**  This should _not_ be done to create a rendering effect, only to calculate a specific value","**THIS MIGHT BE DISABLED WITHOUT ANY NOTICE ON UNOFFICIAL THEMES** As unofficial themes might be loaded from the internet, this is the equivalent of injecting arbitrary code into the client. It'll be disabled if abuse occurs."]),"To enable this feature,  add a field `calculatedTags` in the layer object, e.g.:","````",'"calculatedTags": [','    "_someKey=javascript-expression",','    "name=feat.properties.name ?? feat.properties.ref ?? feat.properties.operator",',`    "_distanceCloserThen3Km=feat.distanceTo( some_lon, some_lat) < 3 ? 'yes' : 'no'" `,"  ]","````","","The above code will be executed for every feature in the layer. The feature is accessible as `feat` and is an amended geojson object:",new Y(["`area` contains the surface area (in square meters) of the object","`lat` and `lon` contain the latitude and longitude"]),"Some advanced functions are available on **feat** as well:"]).SetClass("flex-col").AsMarkdown()),h($,"allFuncs",[new Dt,new _t,new St,new xt,new kt,new ce,new It,new Tt]);const L=class{static addMetatags(s,t,e,n,o){var a,l;if(s===void 0||s.length===0)return;console.log("Recalculating metatags...");const i=[];for(const c of $e.metatags)c.includesDates?((o==null?void 0:o.includeDates)??!0)&&i.push(c):((o==null?void 0:o.includeNonDates)??!0)&&i.push(c);const u=this.createRetaggingFunc(e,n);let r=!1;for(let c=0;c<s.length;c++){const d=s[c],f=d.feature,m=d.freshness;let g=!1,v=new Set(Object.getOwnPropertyNames(f.properties));for(const p of i)try{if(!p.keys.some(w=>f.properties[w]===void 0))continue;if(p.isLazy){if(!p.keys.some(w=>!v.has(w)))continue;if(g=!0,p.applyMetaTagsOnFeature(f,m,e,n),o!=null&&o.evaluateStrict)for(const w of p.keys)f.properties[w]}else g=p.applyMetaTagsOnFeature(f,m,e,n)||g}catch(w){console.error("Could not calculate metatag for ",p.keys.join(","),":",w,w.stack)}if(u!==void 0){let p=!1;try{p=u(t,f)}catch(w){console.error(w)}g=g||p}g&&((l=(a=n==null?void 0:n.allElements)==null?void 0:a.getEventSourceById(f.properties.id))==null||l.ping(),r=!0)}return r}static createFunctionsForFeature(s,t){const e=[];for(const n of t){const o=n[0],i=n[1],u=n[2];if(i===void 0)continue;const r=l=>{try{let c=new Function("feat","return "+i+";")(l);return c!==void 0&&typeof c!="string"&&(c=JSON.stringify(c)),delete l.properties[o],l.properties[o]=c,c}catch(c){L.errorPrintCount<L.stopErrorOutputAt&&(console.warn("Could not calculate a "+(u?"strict ":"")+" calculated tag for key "+o+" defined by "+i+" (in layer"+s+`) due to 
`+c+`
. Are you the theme creator? Doublecheck your code. Note that the metatags might not be stable on new features`,c,c.stack),L.errorPrintCount++,L.errorPrintCount==L.stopErrorOutputAt&&console.error("Got ",L.stopErrorOutputAt," errors calculating this metatagging - stopping output now"));return}};if(u){e.push(r);continue}const a=l=>{delete l.properties[o],Object.defineProperty(l.properties,o,{configurable:!0,enumerable:!1,get:function(){return r(l)}})};e.push(a)}return e}static createRetaggingFunc(s,t){const e=s.calculatedTags;if(e===void 0||e.length===0)return;let n=L.retaggingFuncCache.get(s.id);return n===void 0&&(n=L.createFunctionsForFeature(s.id,e),L.retaggingFuncCache.set(s.id,n)),(o,i)=>{if(i.properties!==void 0){try{$.FullPatchFeature(o,i);for(const r of n)r(i)}catch(r){console.error("Invalid syntax in calculated tags or some other error: ",r)}return!0}}}};let W=L;h(W,"errorPrintCount",0),h(W,"stopErrorOutputAt",10),h(W,"retaggingFuncCache",new Map);class Ie{constructor(s,t,e){h(this,"neededLayerBboxes",new Map);h(this,"source");h(this,"params");h(this,"state");h(this,"isDirty",new _(!1));this.state=t,this.source=s;const n=this;this.params={getFeatureById(o){return t.allElements.ContainingFeatures.get(o)},getFeaturesWithin(o,i){let u=n.neededLayerBboxes.get(o);return u===void 0?n.neededLayerBboxes.set(o,i):i.isContainedIn(u)||n.neededLayerBboxes.set(o,u.unionWith(i)),e.GetFeaturesWithin(o,i)},memberships:e.relationTracker},this.isDirty.stabilized(100).addCallback(o=>{o&&n.updateMetaTags()}),this.source.features.addCallbackAndRunD(o=>n.isDirty.setData(!0))}requestUpdate(){this.isDirty.setData(!0)}updateMetaTags(){const s=this.source.features.data;if(s.length===0){this.isDirty.setData(!1);return}W.addMetatags(s,this.params,this.source.layer.layerDef,this.state),this.isDirty.setData(!1)}}class Ft{constructor(s,t){h(this,"_state");h(this,"_featurePipeline");h(this,"_alreadyRegistered",new Set);h(this,"_notifiers",[]);if(this._featurePipeline=t,this._state=s,s.currentView!==void 0){const e=new Ie(s.currentView,this._state,this._featurePipeline);this._alreadyRegistered.add(s.currentView),this._notifiers.push(e),s.currentView.features.addCallback(n=>{console.debug("Requesting an update for currentView"),e.updateMetaTags()})}}registerSource(s,t=!1){if(s===void 0||this._alreadyRegistered.has(s))return;this._alreadyRegistered.add(s),this._notifiers.push(new Ie(s,this._state,this._featurePipeline));const e=this;s.features.addCallbackAndRunD(n=>{const o=s.layer.layerDef.id;for(const i of e._notifiers){const u=i.neededLayerBboxes.get(o);u!=null&&(s.bbox===void 0||u.overlapsWith(s.bbox))&&i.requestUpdate()}})}}class Mt extends qe{constructor(t){super(t);h(this,"featurePipeline");h(this,"featureAggregator");h(this,"metatagRecalculator");h(this,"popups",new Map);const e=t==null?void 0:t.clustering;this.featureAggregator=X.createHierarchy(this);const n=this.featureAggregator,o=this,i=[];function u(a){o.metatagRecalculator===void 0?i.push(a):o.metatagRecalculator.registerSource(a)}function r(a){n.addTile(a);const l=a.features.map(d=>R.bboxAroundAll(d.map(f=>R.get(f.feature)))),c=a.features.map(d=>{var w;const f=o.locationControl.data.zoom;if(!a.layer.isDisplayed.data)return!1;const m=o.currentBounds.data;if(m===void 0||!l.data.overlapsWith(m)||f<a.layer.layerDef.minzoom)return!1;if(f>e.maxZoom)return!0;if(d.length>e.minNeededElements)return!1;let[g,v,p]=B.tile_from_index(a.tileIndex);if(g>=f){for(;g>f;)g--,v=Math.floor(v/2),p=Math.floor(p/2);if(((w=n.getTile(B.tile_index(g,v,p)))==null?void 0:w.totalValue)>e.minNeededElements)return!1}return!0},[o.currentBounds,a.layer.isDisplayed,l]);new ae({features:a,leafletMap:o.leafletMap,layerToShow:a.layer.layerDef,doShowLayer:c,selectedElement:o.selectedElement,state:o,popup:(d,f)=>o.CreatePopup(d,f)})}this.featurePipeline=new Qe(r,this,{handleRawFeatureSource:u}),this.metatagRecalculator=new Ft(this,this.featurePipeline),this.metatagRecalculator.registerSource(this.currentView,!0),i.forEach(a=>o.metatagRecalculator.registerSource(a)),new te(Oe.hash,this),this.AddClusteringToMap(this.leafletMap)}CreatePopup(t,e){if(this.popups.has(t.data.id))return this.popups.get(t.data.id);const n=new N(t,e,this);return this.popups.set(t.data.id,n),n}AddClusteringToMap(t){const e=this.layoutToUse.clustering,n=this;new ae({features:this.featureAggregator.getCountsForZoom(e,this.locationControl,e.minNeededElements),leafletMap:t,layerToShow:ee.styling,popup:this.featureSwitchIsDebugging.data?(o,i)=>new N(o,i,n):void 0,state:this})}}class oe extends Mt{constructor(s){super(s)}}h(oe,"state");class he extends F{constructor(s,t,e){s=q.NoNull(s),super(t.map(n=>{if(n===void 0||n==="")return new y(s.map(i=>i.element)).SetClass((e==null?void 0:e.innerClasses)??"");const o=s.filter(i=>(i==null?void 0:i.predicate)!==void 0&&i.predicate(n));return o.length===0?e==null?void 0:e.onEmpty:new y(o.map(i=>i.element)).SetClass((e==null?void 0:e.innerClasses)??"")},[re.language]))}}const S=class extends y{constructor(s,t=!1){const e=x.t.general.morescreen;let n="",o="";t&&(n="h-32 min-h-32 max-h-32 text-ellipsis overflow-hidden",o="md:grid md:grid-flow-row md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-g4 gap-4");const i=new Re({placeholder:e.searchForATheme});i.enterPressed.addCallbackD(r=>{r=r.toLowerCase(),r==="personal"&&(window.location.href=S.createUrlFor({id:"personal"},!1,s).data),(r==="bugs"||r==="issues")&&(window.location.href="https://github.com/pietervdvn/MapComplete/issues"),r==="source"&&(window.location.href="https://github.com/pietervdvn/MapComplete"),r==="docs"&&(window.location.href="https://github.com/pietervdvn/MapComplete/tree/develop/Docs"),(r==="osmcha"||r==="stats")&&(window.location.href=q.OsmChaLinkFor(7));const a=S.officialThemes.find(c=>c.hideFromOverview==!1&&c.id!=="personal"&&S.MatchesLayoutFunc(c)(r));a!==void 0&&(window.location.href=S.createUrlFor(a,!1,s).data);const l=S.officialThemes.find(c=>c.id!=="personal"&&S.MatchesLayoutFunc(c)(r));l!==void 0&&(window.location.href=S.createUrlFor(l,!1,s).data)}),t&&(i.focus(),document.addEventListener("keydown",function(r){r.ctrlKey&&r.code==="KeyF"&&(i.focus(),r.preventDefault())}));const u=new y([k.search_svg().SetClass("w-8"),i.SetClass("mr-4 w-full")]).SetClass("flex rounded-full border-2 border-black items-center my-2 w-1/2");super([new y([u]).SetClass("flex justify-center"),S.createOfficialThemesList(s,n,o,i.GetValue()),S.createPreviouslyVistedHiddenList(s,n,o,i.GetValue()),S.createUnofficialThemeList(n,s,o,i.GetValue()),e.streetcomplete.Clone().SetClass("block text-base mx-10 my-3 mb-10")])}static NothingFound(s){const t=x.t.general.morescreen;return new y([new E(t.noMatchingThemes,5).SetClass("w-max font-bold"),new M(k.search_disable_ui(),t.noSearch,{imgSize:"h-6"}).SetClass("h-12 w-max").onClick(()=>s.setData(""))]).SetClass("flex flex-col items-center w-full")}static createUrlFor(s,t,e){var r;if(s===void 0)return;if(s.id===void 0){console.error("ID is undefined for layout",s);return}if(s.id===((r=e==null?void 0:e.layoutToUse)==null?void 0:r.id))return;const n=e==null?void 0:e.locationControl;let o=window.location.pathname;o=o.substr(0,o.lastIndexOf("/")),o===""&&(o=".");let i=`${o}/${s.id.toLowerCase()}.html?`;(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(i=`${o}/theme.html?layout=${s.id}&`),t&&(i=`${o}/theme.html?userlayout=${s.id}&`);let u="";return s.definition!==void 0&&(u="#"+btoa(JSON.stringify(s.definition))),(n==null?void 0:n.map(a=>{const l=[["z",a==null?void 0:a.zoom],["lat",a==null?void 0:a.lat],["lon",a==null?void 0:a.lon]].filter(c=>c[1]!==void 0).map(c=>c[0]+"="+c[1]).join("&");return`${i}${l}${u}`}))??new He(`${i}`)}static createLinkButton(s,t,e=!1){var i;const n=S.createUrlFor(t,e,s);let o=new y([new xe(t.title,!e&&!t.mustHaveLanguage?"themes:"+t.id+".title":void 0),((i=new xe(t.shortDescription))==null?void 0:i.SetClass("subtle"))??""]).SetClass("overflow-hidden flex flex-col");return s.layoutToUse===void 0&&(o=new y([o]).SetClass("flex flex-col justify-center h-24")),new M(t.icon,o,{url:n,newTab:!1})}static CreateProffessionalSerivesButton(){const s=x.t.professional.indexPage;return new y([new E(s.hook,4),s.hookMore,new M(void 0,s.button,{url:"./professional.html"})]).SetClass("flex flex-col border border-gray-300 p-2 rounded-lg")}static createUnofficialThemeList(s,t,e,n){var o=t.installedUserThemes,i=Je.ListStabilized(o);return new F(i.map(u=>{const r=[];for(const a of u){const l=t.GetUnofficialTheme(a);if(l===void 0)continue;const c=S.createLinkButton(t,l,!0);c!==void 0&&r.push({element:c.SetClass(s),predicate:d=>a.toLowerCase().indexOf(d)>=0})}if(!(r.length<=0))return new y([x.t.general.customThemeIntro,new he(r,n,{innerClasses:e,onEmpty:S.NothingFound(n)})])}))}static createPreviouslyVistedHiddenList(s,t,e,n){const o=x.t.general.morescreen,i="mapcomplete-hidden-theme-",u=_e.filter(a=>a.hideFromOverview),r=u.length;return new T(new F(s.osmConnection.preferencesHandler.preferences.map(a=>{const l=new Set(q.NoNull(Object.keys(a).filter(f=>f.startsWith(i)).map(f=>f.substring(i.length,f.length-8))));if(l.size===0)return;const c=u.filter(f=>l.has(f.id)).map(f=>{var m;return{element:(m=S.createLinkButton(s,f))==null?void 0:m.SetClass(t),predicate:S.MatchesLayoutFunc(f)}}),d=new he(c,n,{innerClasses:e,onEmpty:S.NothingFound(n)});return new y([new E(o.previouslyHiddenTitle),o.hiddenExplanation.Subs({hidden_discovered:""+l.size,total_hidden:""+r}),d])})).SetClass("flex flex-col"),void 0,s.osmConnection.isLoggedIn)}static MatchesLayoutFunc(s){return t=>{var n;if(t=t.toLocaleLowerCase(),s.id.toLowerCase().indexOf(t)>=0)return!0;const e=[s.shortDescription,s.title,...s.keywords??[]];for(const o of e){if(o===void 0)continue;const i=o["*"]??o[re.language.data];if(((n=i==null?void 0:i.toLowerCase())==null?void 0:n.indexOf(t))>=0)return!0}return!1}}static createOfficialThemesList(s,t,e,n){let o=S.officialThemes.map(r=>{var l;if(r===void 0){console.trace("Layout is undefined");return}if(r.hideFromOverview)return;const a=(l=S.createLinkButton(s,r))==null?void 0:l.SetClass(t);return r.id==="personal"?{element:new F(s.osmConnection.userDetails.map(d=>d.csCount).map(d=>{if(!(d<Z.userJourney.personalLayoutUnlock))return a}))}:{element:a,predicate:S.MatchesLayoutFunc(r)}});const i=S.CreateProffessionalSerivesButton(),u=S.createCustomGeneratorButton(s);return o.splice(0,0,{element:u},{element:i}),new he(o,n,{innerClasses:e,onEmpty:S.NothingFound(n)})}static createCustomGeneratorButton(s){const t=x.t.general.morescreen;return new F(s.osmConnection.userDetails.map(e=>e.csCount<Z.userJourney.themeGeneratorReadOnlyUnlock?new M(null,t.requestATheme.Clone(),{url:"https://github.com/pietervdvn/MapComplete/issues",newTab:!0}):new M(k.pencil_ui(),t.createYourOwnTheme.Clone(),{url:"https://pietervdvn.github.io/mc/legacy/070/customGenerator.html",newTab:!1})))}};let fe=S;h(fe,"officialThemes",_e);export{$ as E,N as F,fe as M,oe as S,vt as a,W as b,Mt as c};
